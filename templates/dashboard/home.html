{% extends "base.html" %}
{% load humanize %}

{# -- Ensure active_tab exists for base/header logic -- #}
{% with "dashboard" as active_tab %}{% endwith %}

{% block title %}Dashboard · {{ request.business.name|default:"Your business" }}{% endblock %}
{% block header_title %}Dashboard{% endblock %}

{% block content %}
<section class="container py-3" style="max-width:1100px">

  {# ========= Precompute URLs safely (no 500s on missing names) ========= #}
  {# Choose business #}
  {% url 'tenants:choose_business' as choose_biz_url %}
  {% if not choose_biz_url %}{% url 'tenants:choose' as choose_biz_url %}{% endif %}

  {# Add product (try a few likely names) #}
  {% url 'inventory:product_new' as product_new_url %}
  {% if not product_new_url %}{% url 'inventory:product_create' as product_new_url %}{% endif %}
  {% if not product_new_url %}{% url 'inventory:product_add' as product_new_url %}{% endif %}
  {% if not product_new_url %}{% url 'inventory:products_new' as product_new_url %}{% endif %}

  {# Stock In: prefer new "scan_in", then namespaced/legacy "stock_in" #}
  {% url 'inventory:scan_in' as stock_in_url %}
  {% if not stock_in_url %}{% url 'inventory:stock_in' as stock_in_url %}{% endif %}
  {% if not stock_in_url %}{% url 'stock_in' as stock_in_url %}{% endif %}

  {# Agents review #}
  {% url 'tenants:manager_review_agents' as agents_review_url %}
  {% if not agents_review_url %}{% url 'tenants:agents_review' as agents_review_url %}{% endif %}

  {# Inventory dashboard (try new + legacy; last fallback to stock list) #}
  {% url 'inventory:inventory_dashboard' as inv_dash_url %}
  {% if not inv_dash_url %}{% url 'inventory:dashboard' as inv_dash_url %}{% endif %}
  {% if not inv_dash_url %}{% url 'inventory:stock_list' as inv_dash_url %}{% endif %}

  {# ======= Header: Active business badge ======= #}
  <div class="d-flex align-items-center gap-2 mb-3">
    {% if request.business %}
      <span class="badge text-bg-light">Active: {{ request.business.name }}</span>
    {% else %}
      <a class="badge text-bg-warning text-decoration-none" href="{{ choose_biz_url|default:'#' }}">
        No active business · Set up
      </a>
    {% endif %}
    <div class="ms-auto">
      {% if request.user.is_staff %}
        <a class="btn btn-sm btn-outline-secondary" href="{{ choose_biz_url|default:'#' }}">Switch business</a>
      {% endif %}
    </div>
  </div>

  {# ======= Global dashboard filter (Today / 7d / All / Choose date) ======= #}
  <div class="card shadow-sm mb-3">
    <div class="card-body py-2">
      <form id="dashFilter" class="d-flex flex-wrap align-items-center gap-2" autocomplete="off">
        <label for="dashPeriod" class="text-muted small mb-0">Filter</label>

        {% with p=request.GET.period|default_if_none:"" d=request.GET.date|default_if_none:"" %}
        <select id="dashPeriod" name="period" class="form-select form-select-sm" style="width:auto; min-width: 170px;">
          <option value="today" {% if p == "today" %}selected{% endif %}>Today</option>
          <option value="7d"    {% if p == "7d" or p == "" and not d %}selected{% endif %}>Last 7 days</option>
          <option value="all"   {% if p == "all" %}selected{% endif %}>All time</option>
          <option value="date"  {% if p == "date" or d %}selected{% endif %}>Choose date…</option>
        </select>

        <input
          type="date"
          id="dashDate"
          name="date"
          class="form-control form-control-sm"
          style="width:auto; display:{% if p == 'date' or d %}inline-block{% else %}none{% endif %};"
          value="{{ d }}"
        />

        <button type="submit" class="btn btn-primary btn-sm">Apply</button>
        <a class="btn btn-outline-secondary btn-sm" href="{{ request.path }}">Reset</a>

        <input type="hidden" id="dashPeriodCurrent" value="{{ p|default:'7d' }}">
        {% endwith %}
      </form>
    </div>
  </div>

  {% if first_run %}
    <!-- First-run checklist -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="mb-2">Welcome to {{ request.business.name|default:"your business" }}</h5>
        <p class="text-muted mb-4">Let’s set up your store. Do these in order:</p>
        <div class="row g-3">
          <div class="col-md-4">
            <a class="btn btn-primary w-100" href="{{ product_new_url|default:'#' }}">1) Add your first product</a>
          </div>
          <div class="col-md-4">
            <a class="btn btn-outline-primary w-100" href="{{ stock_in_url|default:'#' }}">2) Stock in items</a>
          </div>
          <div class="col-md-4">
            <a class="btn btn-outline-primary w-100" href="{{ agents_review_url|default:'#' }}">3) Invite/approve agents</a>
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <!-- KPI tiles -->
    <div class="row g-3 mb-3">
      <div class="col-6 col-md-3">
        <div class="card shadow-sm"><div class="card-body">
          <div class="text-muted small">Products</div>
          <div class="fs-4 fw-bold">{{ products_count|default:0|intcomma }}</div>
        </div></div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card shadow-sm"><div class="card-body">
          <div class="text-muted small">Items in stock</div>
          <div class="fs-4 fw-bold">{{ stock_count|default:0|intcomma }}</div>
        </div></div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card shadow-sm"><div class="card-body">
          <div class="text-muted small">Warehouses</div>
          <div class="fs-4 fw-bold">{{ warehouses_count|default:0|intcomma }}</div>
        </div></div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card shadow-sm"><div class="card-body">
          <div class="text-muted small">Sales (MTD)</div>
          <div class="fs-4 fw-bold">{{ sold_mtd_count|default:0|intcomma }}</div>
        </div></div>
      </div>
    </div>

    <!-- Quick actions -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="d-flex flex-wrap gap-2">
          <a class="btn btn-primary" href="{{ stock_in_url|default:'#' }}"><i class="bi bi-box-arrow-in-down"></i> Stock In</a>
          <a class="btn btn-outline-primary" href="{{ inv_dash_url|default:'#' }}"><i class="bi bi-columns-gap"></i> Inventory Dashboard</a>
          <a class="btn btn-outline-primary" href="{{ agents_review_url|default:'#' }}"><i class="bi bi-people"></i> Agents</a>
        </div>
      </div>
    </div>

    <!-- Simple KPI card -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">KPIs · {{ kpis.scope|default:"" }}</h6>
        </div>
        <div class="row g-3">
          <div class="col-6 col-md-3">
            <div class="p-3 border rounded">
              <div class="text-muted small">Today</div>
              <div class="fw-bold">{{ kpis.today.total|default:0|floatformat:0|intcomma }}</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="p-3 border rounded">
              <div class="text-muted small">MTD</div>
              <div class="fw-bold">{{ kpis.month.total|default:0|floatformat:0|intcomma }}</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="p-3 border rounded">
              <div class="text-muted small">Avg Ticket</div>
              <div class="fw-bold">{{ kpis.month.avg|default:0|floatformat:0 }}</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="p-3 border rounded">
              <div class="text-muted small">All-time</div>
              <div class="fw-bold">{{ kpis.all.total|default:0|floatformat:0|intcomma }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

</section>

<script>
(function () {
  const sel  = document.getElementById('dashPeriod');
  const date = document.getElementById('dashDate');
  const form = document.getElementById('dashFilter');

  function toggleDate() {
    if (!sel || !date) return;
    if (sel.value === 'date') {
      date.style.display = 'inline-block';
      if (!date.value) {
        const t = new Date();
        const mm = String(t.getMonth()+1).padStart(2,'0');
        const dd = String(t.getDate()).padStart(2,'0');
        date.value = `${t.getFullYear()}-${mm}-${dd}`;
      }
      date.focus();
    } else {
      date.style.display = 'none';
    }
  }

  if (sel) sel.addEventListener('change', toggleDate);
  toggleDate();

  if (form) {
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const url = new URL(window.location.href);
      url.searchParams.set('period', sel.value || '7d');
      if (sel.value === 'date') {
        if (!date.value) { alert('Pick a date.'); return; }
        url.searchParams.set('date', date.value);
      } else {
        url.searchParams.delete('date');
      }
      window.location.assign(url.toString());
    });
  }
})();
</script>
{% endblock %}
