{% extends "base.html" %}
{% load static %}
{% block title %}Scan IN · Inventory{% endblock %}

{% block extra_css %}
<style>
  /* ===== Layout helpers (safe even if tokens.css already defines these) ===== */
  .page{margin:0 auto;max-width:1120px;padding:clamp(12px,4vw,24px)}
  .vstack{display:flex;flex-direction:column;gap:.75rem}
  .hstack{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}

  /* ===== Theme-aware primitives ===== */
  :root{
    --bg: var(--bg, #ffffff);
    --fg: var(--fg, #0f172a);
    --border: var(--border, #e2e8f0);
    --card: var(--card, #ffffff);
    --accent: var(--accent, #2563eb);
    --onAccent: var(--onAccent, #ffffff);
    --danger: var(--danger, #ef4444);
    --scanline: #00ff5a; /* neon green */
  }
  body{background:var(--bg);color:var(--fg)}

  /* ===== Form layout ===== */
  .form{display:grid;gap:14px;max-width:880px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width: 640px){ .row{grid-template-columns:1fr} }

  /* ===== Field & control styling ===== */
  .field{
    position:relative;background:var(--card);border:1px solid var(--border);
    border-radius:12px;display:flex;align-items:center
  }
  .field > input,.field > select,.field > .form-control{
    flex:1;background:transparent;color:var(--fg);border:0;padding:12px 14px;
    outline:none;font-size:16px;width:100%;min-height:44px;
  }
  label{font-weight:600;margin-bottom:6px;display:inline-block}

  /* ===== Buttons ===== */
  .btn{
    appearance:none;border:1px solid var(--border);color:var(--fg);
    background:var(--card);border-radius:10px;padding:10px 14px;
    cursor:pointer;font-weight:600;font-size:14px;min-height:44px
  }
  .btn:hover{filter:brightness(1.05)}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn-primary{background:var(--accent);color:var(--onAccent);border-color:transparent}
  .btn-secondary{background:var(--card)}
  .btn-sky{
    background:linear-gradient(135deg,#38bdf8,#0ea5e9);
    color:#052c3b;border-color:#075985
  }

  /* ===== Misc UI ===== */
  .hint{font-size:12px;opacity:.8}
  .help-error{font-size:12px;color:#ef4444}
  .help-error[hidden]{display:none}
  .pill{font-size:12px;color:#0b3b2b;background:rgba(56,189,248,.12);border:1px solid rgba(56,189,248,.35);padding:4px 8px;border-radius:999px}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:var(--card);border:1px solid var(--border);color:var(--fg);padding:2px 6px;border-radius:6px}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  /* ===== Camera shell + overlay scanline ===== */
  #cameraBox{margin-top:8px;display:none;background:var(--card);border:1px dashed var(--border);border-radius:14px;padding:12px}
  .scan-shell{position:relative;border-radius:14px;overflow:hidden;background:#000}
  #camera{width:100%;max-height:360px;min-height:220px;background:#000}

  .scan-overlay{position:absolute;inset:0;pointer-events:none}
  .scan-frame{
    position:absolute; inset:10% 8%;
    border:2px solid rgba(255,255,255,.25);
    border-radius:12px;
    box-shadow: inset 0 0 0 9999px rgba(0,0,0,.20);
  }
  .scanline{
    position:absolute; left:8%; right:8%; height:2px; border-radius:2px;
    background:linear-gradient(90deg, transparent, var(--scanline), transparent);
    box-shadow:0 0 10px var(--scanline), 0 0 20px rgba(0,255,90,.6);
    animation: sweep 2.0s linear infinite alternate;
  }
  .scanline.paused{ animation-play-state: paused; }
  @keyframes sweep { from{ top:10%; } to{ top:90%; } }

  /* Toast */
  .toast{
    position:fixed;right:18px;bottom:18px;min-width:240px;
    background:var(--card);border:1px solid var(--border);color:var(--fg);
    border-radius:12px;padding:12px 14px;box-shadow:0 10px 25px rgba(0,0,0,.25);
    display:none;z-index:1000
  }
  .toast.ok{border-color:rgba(16,185,129,.45)}
  .toast.err{border-color:rgba(239,68,68,.55)}
</style>
{% endblock %}

{% block body %}
{% include "_topbar.html" %}
<main class="page vstack">
  <section aria-labelledby="scanin" class="vstack">
    <h1 id="scanin" style="margin:0 0 .25rem">Scan IN · Inventory</h1>
    <p class="hint" style="margin:0 0 1rem">
      Paste or scan the <strong>IMEI</strong>. Scanners typically “type” digits then send <span class="kbd">Enter</span>.
    </p>

    <form method="post" novalidate class="form" data-validate>
      {% csrf_token %}
      {% if form.non_field_errors %}<div class="help-error">{{ form.non_field_errors }}</div>{% endif %}

      <!-- IMEI -->
      <div>
        <label for="id_imei">IMEI</label>
        <div class="field">
          {{ form.imei }}
        </div>
        {% if form.imei.errors %}<div class="help-error">{{ form.imei.errors|striptags }}</div>{% endif %}
        <div id="imeiHelp" class="help-error" hidden>Enter a valid IMEI (exactly 15 digits).</div>
        <div class="flex" style="margin-top:6px">
          <button type="button" id="pasteBtn" class="btn btn-secondary">Paste from Clipboard</button>
          <button type="button" id="camToggle" class="btn btn-sky">Start Camera</button>
          <span class="pill">Shortcut: <span class="kbd">Enter</span> submits</span>
          <span class="pill">Focus: <span class="kbd">F2</span></span>
        </div>

        <!-- Camera / barcode area -->
        <div id="cameraBox" aria-live="polite">
          <div class="hint" style="margin-bottom:8px">Allow camera access if prompted.</div>

          <div class="scan-shell">
            <div id="camera"></div>
            <div class="scan-overlay">
              <div class="scan-frame"></div>
              <div class="scanline" id="scanline"></div>
            </div>
          </div>

          <div class="flex" style="margin-top:10px">
            <select id="cameraSelect" class="btn"></select>
            <button type="button" id="camStop" class="btn">Stop Camera</button>
          </div>
        </div>
      </div>

      <!-- Product / Location -->
      <div class="row">
        <div>
          <label for="id_product">Product</label>
          <div class="field">{{ form.product }}</div>
          {% if form.product.errors %}<div class="help-error">{{ form.product.errors|striptags }}</div>{% endif %}
          <div class="hint">Pick the exact model. <em>Order price auto-fills from catalog.</em></div>
        </div>
        <div>
          <label for="id_location">Location</label>
          <div class="field">{{ form.location }}</div>
          {% if form.location.errors %}<div class="help-error">{{ form.location.errors|striptags }}</div>{% endif %}
          <div class="hint">Defaults to your home store if set.</div>
        </div>
      </div>

      <!-- Order price / Received date -->
      <div class="row">
        <div>
          <label for="id_order_price">Order price</label>
          <div class="field">{{ form.order_price }}</div>
          {% if form.order_price.errors %}<div class="help-error">{{ form.order_price.errors|striptags }}</div>{% endif %}
          <div class="hint" id="orderPriceHint">Will auto-fill if a default exists for this model.</div>
        </div>

        <div>
          <label for="id_received_at">Received date</label>
          <div class="field">{{ form.received_at }}</div>
          {% if form.received_at.errors %}<div class="help-error">{{ form.received_at.errors|striptags }}</div>{% endif %}
          <div class="hint">If empty, we’ll set today automatically.</div>
        </div>
      </div>

      <!-- Assign toggle -->
      <div class="hstack">
        <label style="display:flex;align-items:center;gap:10px;">
          {{ form.assigned_to_me }} Assign this device to me
        </label>
        {% if form.assigned_to_me.errors %}<div class="help-error">{{ form.assigned_to_me.errors|striptags }}</div>{% endif %}
        {% if user.is_staff %}
          <span class="pill">Note: admin/staff accounts can’t hold stock — this toggle will be ignored.</span>
        {% endif %}
      </div>

      <!-- Actions -->
      <div class="hstack" style="margin-top:.25rem">
        <button type="submit" id="submitBtn" class="btn btn-primary" disabled>Save</button>
        <a class="btn btn-secondary" href="{% url 'inventory:stock_list' %}">Cancel</a>
      </div>
    </form>
  </section>
</main>

<!-- Toast -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- QuaggaJS for barcode scanning -->
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<script>
  // Elements
  const form      = document.querySelector('form[data-validate]');
  const imeiEl    = document.getElementById('id_imei');
  const prodEl    = document.getElementById('id_product');
  const locEl     = document.getElementById('id_location');
  const orderEl   = document.getElementById('id_order_price');
  const recvEl    = document.getElementById('id_received_at');
  const submitBtn = document.getElementById('submitBtn');
  const pasteBtn  = document.getElementById('pasteBtn');
  const camToggle = document.getElementById('camToggle');
  const camStop   = document.getElementById('camStop');
  const camBox    = document.getElementById('cameraBox');
  const camNode   = document.getElementById('camera');
  const camSelect = document.getElementById('cameraSelect');
  const toast     = document.getElementById('toast');
  const scanLine  = document.getElementById('scanline');
  const orderPriceHint = document.getElementById('orderPriceHint');

  // Helpers
  function showToast(msg, ok=true){
    toast.textContent = msg;
    toast.className = 'toast ' + (ok ? 'ok' : 'err');
    toast.style.display = 'block';
    setTimeout(()=> toast.style.display = 'none', 3000);
  }
  function digitsOnly(s){ return (s||'').replace(/\D/g,''); }
  function looksLikeIMEI(s){
    s = digitsOnly(s);
    return /^\d{15}$/.test(s); // exactly 15 digits
  }
  function valOrZeroFloat(el){
    const v = (el && el.value || '').trim();
    if(v === '') return 0;
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function updateValidity(){
    // IMEI helper (optional unless your form enforces it)
    if (imeiEl){
      const hasValue = (imeiEl.value || '').length > 0;
      const good = looksLikeIMEI(imeiEl.value || '');
      const help = document.getElementById('imeiHelp');
      if (help) help.hidden = (!hasValue || good);
    }
    // Enable when product & location selected and order price is a number >= 0
    const ok =
      (!!(prodEl && prodEl.value)) &&
      (!!(locEl && locEl.value)) &&
      (orderEl && orderEl.value !== '' && !Number.isNaN(Number(orderEl.value)));
    submitBtn && (submitBtn.disabled = !ok);
  }

  // Autofill: default order price from catalog (inventory.api_order_price/<id>/)
  let manualPrice = false; // set when user edits price

  function setOrderHint(text){
    if(orderPriceHint){ orderPriceHint.textContent = text; }
  }

  async function autofillOrderPrice(force=false){
    if(!prodEl || !prodEl.value) return;
    try{
      const res = await fetch(`/inventory/api/order-price/${prodEl.value}/`, {headers:{'Accept':'application/json'}});
      const data = await res.json();
      const price = (data && data.price != null) ? Number(data.price) : null;

      if(price != null){
        if (orderEl){
          // Only fill if user hasn't typed OR force is true OR field is 0/blank
          const isBlankOrZero = (orderEl.value === '' || Number(orderEl.value) === 0);
          if (force || !manualPrice || isBlankOrZero){
            orderEl.value = price.toFixed(2);
            manualPrice = false; // reset to catalog state
          }
        }
        setOrderHint('Auto-filled from default order price catalog. You can override.');
      }else{
        setOrderHint('No default price set for this model yet. Enter one manually.');
      }
    }catch{
      // silent; keep whatever the user has
      setOrderHint('Could not fetch default price (offline?). Enter manually.');
    }finally{
      updateValidity();
    }
  }

  // Wire up basic UX + numeric constraints
  if (imeiEl) {
    try{
      imeiEl.setAttribute('inputmode','numeric');
      imeiEl.setAttribute('maxlength','15');
      imeiEl.setAttribute('autocomplete','off');
    }catch(_){}
    imeiEl.addEventListener('input', (e)=>{
      const v = digitsOnly(e.target.value);
      const pos = e.target.selectionStart;
      e.target.value = v.slice(0, 15);
      try{ e.target.setSelectionRange(pos, pos);}catch(_){}
      updateValidity();
    });
    imeiEl.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); if(submitBtn && !submitBtn.disabled){ form.submit(); } }
    });
  }

  if (orderEl){
    orderEl.setAttribute('inputmode', 'decimal');
    orderEl.addEventListener('input', ()=>{
      manualPrice = true; // user touched price; stop auto-overwrite
      // guard against negative values
      if (Number(orderEl.value) < 0) orderEl.value = '0';
      updateValidity();
    });
  }

  if (recvEl){
    // If empty on load, set to today (yyyy-mm-dd)
    const v = (recvEl.value || '').trim();
    if(!v){
      try{
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth()+1).padStart(2,'0');
        const dd = String(today.getDate()).padStart(2,'0');
        recvEl.value = `${yyyy}-${mm}-${dd}`;
      }catch(_){}
    }
  }

  if (prodEl) {
    prodEl.addEventListener('change', ()=>{
      manualPrice = false;   // new product → allow autofill
      autofillOrderPrice(false);
      updateValidity();
    });
  }
  if (locEl) locEl.addEventListener('change', updateValidity);

  document.addEventListener('keydown', (e)=>{ if(e.key==='F2'){ e.preventDefault(); imeiEl && imeiEl.focus(); }});
  window.addEventListener('load', ()=>{
    imeiEl && imeiEl.focus();
    // initial checks + attempt autofill if a product is preselected
    updateValidity();
    if (prodEl && prodEl.value){ autofillOrderPrice(false); }
  });

  // Clipboard helper
  pasteBtn && pasteBtn.addEventListener('click', async ()=>{
    try{
      const txt = await navigator.clipboard.readText();
      if(!txt){ showToast('Clipboard is empty.', false); return; }
      if (imeiEl){
        imeiEl.value = digitsOnly(txt).slice(0,15);
        updateValidity();
        if(looksLikeIMEI(imeiEl.value) && submitBtn && !submitBtn.disabled){ form.submit(); }
        else { showToast('Pasted. Press Save to submit.', true); }
      }
    }catch{
      showToast('Clipboard blocked. Paste manually (Ctrl+V).', false);
      imeiEl && imeiEl.focus();
    }
  });

  // ===== Camera / QuaggaJS (with animated scanline) =====
  let quaggaRunning = false;
  let lastDetected = '';

  async function listCameras(){
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d=> d.kind==='videoinput');
      if (camSelect){
        camSelect.innerHTML = '';
        cams.forEach((c,i)=>{
          const opt = document.createElement('option');
          opt.value = c.deviceId; opt.textContent = c.label || `Camera ${i+1}`;
          camSelect.appendChild(opt);
        });
      }
      return cams;
    }catch{return [];}
  }

  function pauseScanline(ms=900){
    if(!scanLine) return;
    scanLine.classList.add('paused');
    setTimeout(()=> scanLine.classList.remove('paused'), ms);
  }

  function startQuagga(deviceId){
    if(quaggaRunning || !window.Quagga) return;
    Quagga.init({
      inputStream: {
        type: 'LiveStream',
        target: camNode,
        constraints: {
          facingMode: 'environment',
          deviceId: deviceId || undefined,
          width:{ideal:1280}, height:{ideal:720}
        }
      },
      decoder: {
        readers: ['code_128_reader','ean_reader','ean_8_reader','code_39_reader','upc_reader','upc_e_reader']
      },
      locate: true,
      numOfWorkers: navigator.hardwareConcurrency ? Math.min(4, navigator.hardwareConcurrency) : 2
    }, (err)=>{
      if(err){ showToast('Camera init failed. Check permissions / HTTPS.', false); return; }
      Quagga.start(); quaggaRunning = true;
    });

    Quagga.onDetected((result)=>{
      const code = (result && result.codeResult && result.codeResult.code) || '';
      if(!code || code===lastDetected) return;
      lastDetected = code;

      const numeric = digitsOnly(code);
      if(imeiEl){
        imeiEl.value = numeric.slice(0, 15);
        updateValidity();

        pauseScanline(); // pause the sweep briefly on successful read

        if(looksLikeIMEI(imeiEl.value) && submitBtn && !submitBtn.disabled){
          showToast('Scanned IMEI: ' + imeiEl.value, true);
          form.submit();
        }else{
          showToast('Scanned, but not a 15-digit IMEI.', false);
        }
      }
    });
  }

  function stopQuagga(){
    if(!quaggaRunning || !window.Quagga) return;
    Quagga.stop(); quaggaRunning=false;
  }

  camToggle && camToggle.addEventListener('click', async ()=>{
    if(!camBox) return;
    if(camBox.style.display==='none' || camBox.style.display===''){
      camBox.style.display='block';
      const cams = await listCameras();
      startQuagga(cams[0] && cams[0].deviceId);
      camToggle.textContent='Restart Camera';
    }else{
      stopQuagga();
      startQuagga((camSelect && camSelect.value) || undefined);
    }
  });

  camStop && camStop.addEventListener('click', ()=>{
    stopQuagga();
    if (camBox) camBox.style.display='none';
    if (camToggle) camToggle.textContent='Start Camera';
  });
</script>
{% endblock %}
