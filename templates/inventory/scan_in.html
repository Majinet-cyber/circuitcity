{% extends "base.html" %}
{% load static %}
{% block title %}Scan IN · Inventory{% endblock %}
{% block header_title %}Inventory · Scan In{% endblock %}

{# Inventory pages: scoped notifications, no global search #}
{% block notif_scope %}inventory{% endblock %}
{% block notif_allow %}stock_in,stock_sold,low_stock{% endblock %}

{% block extra_css %}
<style>
  /* ===== Layout ===== */
  .page{margin:0 auto;max-width:1120px;padding:clamp(12px,4vw,24px)}
  .vstack{display:flex;flex-direction:column;gap:.75rem}
  .hstack{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}

  /* ===== Theme (blue accent restored) ===== */
  :root{
    --cc-bg:#ffffff;
    --cc-text:#0f172a;
    --cc-muted:#64748b;
    --cc-border:#e2e8f0;
    --cc-panel:#ffffff;
    --cc-panel-2:#f8fafc;
    --cc-accent:#1f6feb;       /* ← blue */
    --cc-accent-600:#1a5fd4;
    --cc-accent-700:#164fb1;
    --cc-shadow:0 6px 18px rgba(2,6,23,.08);
  }
  body{background:var(--cc-bg);color:var(--cc-text)}

  /* ===== Form layout ===== */
  .form{display:grid;gap:14px;max-width:880px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width: 640px){ .row{grid-template-columns:1fr} }

  /* ===== Field & control styling ===== */
  .field{
    position:relative;background:var(--cc-panel);border:1px solid var(--cc-border);
    border-radius:12px;display:flex;align-items:center;box-shadow:var(--cc-shadow)
  }
  .field > input,.field > select,.field > .form-control{
    flex:1;background:transparent;color:var(--cc-text);border:0;padding:12px 14px;
    outline:none;font-size:16px;width:100%;min-height:44px;
  }
  label{font-weight:700;margin-bottom:6px;display:inline-block}

  /* ===== Buttons (blue) ===== */
  .btn{
    appearance:none;border:1px solid var(--cc-border);color:var(--cc-text);
    background:var(--cc-panel);border-radius:10px;padding:10px 14px;
    cursor:pointer;font-weight:700;font-size:14px;min-height:44px;
    transition:transform .12s ease,box-shadow .2s ease,background .2s ease,border-color .2s ease
  }
  .btn:hover{transform:translateY(-1px);box-shadow:var(--cc-shadow)}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn-primary{background:var(--cc-accent);color:#fff;border-color:var(--cc-accent)}
  .btn-primary:hover{background:var(--cc-accent-600);border-color:var(--cc-accent-600)}
  .btn-secondary{background:var(--cc-panel)}
  .btn-sky{
    background:linear-gradient(135deg,#38bdf8,#0ea5e9);
    color:#052c3b;border-color:#075985
  }

  /* ===== Inputs focus ring in blue ===== */
  input[type="text"], input[type="number"], input[type="date"], select, textarea {
    transition: box-shadow .15s, border-color .15s;
  }
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--cc-accent) !important;
    box-shadow: 0 0 0 .2rem rgba(31,111,235,.25) !important;
  }

  /* ===== Misc UI ===== */
  .hint{font-size:12px;color:var(--cc-muted)}
  .help-error{font-size:12px;color:#ef4444}
  .help-error[hidden]{display:none}
  .pill{font-size:12px;color:var(--cc-accent-700);background:rgba(31,111,235,.10);border:1px solid rgba(31,111,235,.25);padding:4px 8px;border-radius:999px}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:var(--cc-panel);border:1px solid var(--cc-border);color:var(--cc-text);padding:2px 6px;border-radius:6px}

  /* ===== Camera shell + overlay scanline ===== */
  #cameraBox{margin-top:8px;display:none;background:var(--cc-panel);border:1px dashed var(--cc-border);border-radius:14px;padding:12px}
  .scan-shell{position:relative;border-radius:14px;overflow:hidden;background:#000;box-shadow:var(--cc-shadow)}
  #camera{width:100%;max-height:360px;min-height:220px;background:#000}
  .scan-overlay{position:absolute;inset:0;pointer-events:none}
  .scan-frame{
    position:absolute; inset:10% 8%;
    border:2px solid rgba(255,255,255,.25);
    border-radius:12px;
    box-shadow: inset 0 0 0 9999px rgba(0,0,0,.20);
  }
  .scanline{
    position:absolute; left:8%; right:8%; height:2px; border-radius:2px;
    background:linear-gradient(90deg, transparent, #00ff5a, transparent);
    box-shadow:0 0 10px #00ff5a, 0 0 20px rgba(0,255,90,.6);
    animation: sweep 2.0s linear infinite alternate;
  }
  .scanline.paused{ animation-play-state: paused; }
  @keyframes sweep { from{ top:10%; } to{ top:90%; } }

  /* Toast */
  .toast{
    position:fixed;right:18px;bottom:18px;min-width:240px;
    background:var(--cc-panel);border:1px solid var(--cc-border);color:var(--cc-text);
    border-radius:12px;padding:12px 14px;box-shadow:0 10px 25px rgba(0,0,0,.25);
    display:none;z-index:1000
  }
  .toast.ok{border-color:rgba(16,185,129,.45)}
  .toast.err{border-color:rgba(239,68,68,.55)}
</style>
{% endblock %}

{% block body %}
{% include "_topbar.html" %}
<main class="page vstack">
  <section aria-labelledby="scanin" class="vstack">
    <h1 id="scanin" style="margin:0 0 .25rem">Scan IN · Inventory</h1>
    <p class="hint" style="margin:0 0 1rem">
      Paste or scan the <strong>IMEI</strong>. Scanners typically “type” digits then send <span class="kbd">Enter</span>.
    </p>

    {% url 'inventory:stock_list' as stock_url %}
    {# Post back to THIS page; the view handles everything #}
    <form method="post"
          action=""
          novalidate
          class="form"
          data-validate
          data-default-location-id="{{ default_location.id|default:request.user.agent_profile.location.id|default:'' }}"
          data-default-location-name="{{ default_location.name|default:request.user.agent_profile.location.name|default:'' }}">
      {% csrf_token %}
      {% if form.non_field_errors %}<div class="help-error">{{ form.non_field_errors }}</div>{% endif %}

      <!-- IMEI -->
      <div>
        <label for="id_imei">IMEI</label>
        <div class="field">
          <input type="text"
                 id="id_imei"
                 name="imei"
                 maxlength="15"
                 inputmode="numeric"
                 autocomplete="off"
                 placeholder="Enter 15-digit IMEI"
                 style="width:100%;background:transparent;border:0;padding:12px 14px;">
        </div>
        <div id="imeiHelp" class="help-error" hidden>Enter a valid IMEI (exactly 15 digits).</div>
        <div class="hstack" style="margin-top:6px">
          <button type="button" id="pasteBtn" class="btn btn-secondary">Paste from Clipboard</button>
          <button type="button" id="camToggle" class="btn btn-sky">Start Camera</button>
          <span class="pill">Shortcut: <span class="kbd">Enter</span> submits</span>
          <span class="pill">Focus: <span class="kbd">F2</span></span>
        </div>

        <!-- Camera shell (kept minimal; only shown on demand) -->
        <div id="cameraBox">
          <div class="scan-shell">
            <video id="camera" autoplay playsinline></video>
            <div class="scan-overlay">
              <div class="scan-frame"></div>
              <div id="scanline" class="scanline"></div>
            </div>
          </div>
          <div class="hstack" style="margin-top:8px">
            <select id="cameraSelect" class="btn" style="min-width:200px"></select>
            <button type="button" id="camStop" class="btn">Stop Camera</button>
          </div>
        </div>
      </div>

      <!-- Product / Location -->
      <div class="row">
        <div>
          <label for="id_product">
            Product
            {% if request.user.is_staff or request.user.is_superuser %}
              <a class="pill" href="/admin/inventory/product/add/" title="Add new product">+ Add</a>
            {% endif %}
          </label>
          <div class="field">
            {{ form.product }}
          </div>
          {% if form.product.errors %}<div class="help-error">{{ form.product.errors|striptags }}</div>{% endif %}
          <div class="hint">Managers add products; agents pick from this list. <em>Order price auto-fills if set.</em></div>
        </div>
        <div>
          <label for="id_location">
            Location <span class="hint">(defaults to your store)</span>
            {% if request.user.is_staff or request.user.is_superuser %}
              <a class="pill" href="/admin/inventory/location/add/" title="Add new location">+ Add</a>
            {% endif %}
          </label>
          <div class="field">{{ form.location }}</div>
          {% if form.location.errors %}<div class="help-error">{{ form.location.errors|striptags }}</div>{% endif %}
          <div class="hint">Default is your store. Managers can add new locations.</div>
        </div>
      </div>

      <!-- Order price / Received date -->
      <div class="row">
        <div>
          <label for="id_order_price">Order price</label>
          <div class="field">
            <input type="number"
                   id="id_order_price"
                   name="order_price"
                   min="0"
                   step="any"
                   placeholder="0.00"
                   style="width:100%;background:transparent;border:0;padding:12px 14px;">
          </div>
          <div class="hint" id="orderPriceHint">Will auto-fill if a default exists for this model.</div>
        </div>

        <div>
          <label for="id_received_at">Received date</label>
          <div class="field">
            <input type="date"
                   id="id_received_at"
                   name="received_at"
                   style="width:100%;background:transparent;border:0;padding:12px 14px;">
          </div>
          <div class="hint">If empty, we’ll set today automatically.</div>
        </div>
      </div>

      <!-- Assign toggle -->
      <div class="hstack">
        <label style="display:flex;align-items:center;gap:10px;">
          <input type="checkbox" id="id_assigned_to_me" name="assigned_to_me" value="1">
          Assign this device to me
        </label>
        {% if request.user.is_staff or request.user.is_superuser %}
          <span class="pill">Note: admin/staff accounts can’t hold stock — this toggle will be ignored.</span>
        {% endif %}
      </div>

      <!-- Actions -->
      <div class="hstack" style="margin-top:.25rem">
        <button type="submit" id="submitBtn" class="btn btn-primary" disabled>Save</button>
        <a class="btn btn-secondary" href="{{ stock_url|default:'/inventory/' }}">Cancel</a>
      </div>
    </form>
  </section>
</main>

<!-- Toast -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- QuaggaJS (optional) -->
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<script>
(function(){
  // Elements
  const form       = document.querySelector('form[data-validate]');
  const imeiEl     = document.getElementById('id_imei');
  const prodEl     = document.getElementById('id_product');
  const locEl      = document.getElementById('id_location');
  const orderEl    = document.getElementById('id_order_price');
  const recvEl     = document.getElementById('id_received_at');
  const submitBtn  = document.getElementById('submitBtn');
  const pasteBtn   = document.getElementById('pasteBtn');
  const camToggle  = document.getElementById('camToggle');
  const camStop    = document.getElementById('camStop');
  const camBox     = document.getElementById('cameraBox');
  const camNode    = document.getElementById('camera');
  const camSelect  = document.getElementById('cameraSelect');
  const toast      = document.getElementById('toast');
  const scanLine   = document.getElementById('scanline');
  const orderPriceHint = document.getElementById('orderPriceHint');

  // Default location id/name (server embeds both default_location and AgentProfile)
  const defaultLocId = (form && form.dataset.defaultLocationId) ? form.dataset.defaultLocationId : '';

  // Make Location explicitly optional on the client (server enforces if required)
  if (locEl) {
    locEl.removeAttribute('required');
    locEl.removeAttribute('aria-required');
  }

  // Helpers
  function showToast(msg, ok=true){
    toast.textContent = msg;
    toast.className = 'toast ' + (ok ? 'ok' : 'err');
    toast.style.display = 'block';
    setTimeout(()=> toast.style.display = 'none', 3000);
  }
  function digitsOnly(s){ return (s||'').replace(/\D/g,''); }
  function looksLikeIMEI(s){ s = digitsOnly(s); return /^\d{15}$/.test(s); }

  function updateValidity(){
    if (imeiEl){
      const hasValue = (imeiEl.value || '').length > 0;
      const good = looksLikeIMEI(imeiEl.value || '');
      const help = document.getElementById('imeiHelp');
      if (help) help.hidden = (!hasValue || good);
    }
    const imeiOk = looksLikeIMEI((imeiEl && imeiEl.value) || '');
    const prodOk = !!(prodEl && prodEl.value);
    const priceOk = (orderEl && orderEl.value !== '' && !Number.isNaN(Number(orderEl.value)));
    const ok = imeiOk && prodOk && priceOk;
    if (submitBtn) submitBtn.disabled = !ok;
  }

  // Select default location if available in the options
  function applyDefaultLocation(){
    if (!locEl || !defaultLocId) return;
    const opt = Array.from(locEl.options).find(o => String(o.value) === String(defaultLocId));
    if (opt){ locEl.value = opt.value; }
  }

  // Default order price lookup (works if you expose an endpoint; otherwise the hint stays)
  const ORDER_PRICE_ENDPOINTS = ['/inventory/api/order-price/', '/inventory/api/order_price/', '/inventory/order-price/'];
  async function fetchFirstOk(bases, productId){
    for (const b of bases){
      try{
        const r = await fetch(`${b}${productId}/`, {headers:{'Accept':'application/json'}});
        if (r.ok) return await r.json();
      }catch(_){}
    }
    return null;
  }
  let manualPrice = false;
  function setOrderHint(text){ if(orderPriceHint){ orderPriceHint.textContent = text; } }
  async function autofillOrderPrice(force=false){
    if(!prodEl || !prodEl.value) return;
    const data = await fetchFirstOk(ORDER_PRICE_ENDPOINTS, prodEl.value);
    const price = data && data.price != null ? Number(data.price) : null;
    if(price != null){
      if (orderEl){
        const isBlankOrZero = (orderEl.value === '' || Number(orderEl.value) === 0);
        if (force || !manualPrice || isBlankOrZero){
          orderEl.value = price.toFixed(2);
          manualPrice = false;
        }
      }
      setOrderHint('Auto-filled from default order price catalog. You can override.');
    }else{
      setOrderHint('No default price set for this model yet. Enter one manually.');
    }
    updateValidity();
  }

  // Wire up UX
  if (imeiEl) {
    imeiEl.setAttribute('inputmode','numeric');
    imeiEl.setAttribute('maxlength','15');
    imeiEl.setAttribute('autocomplete','off');
    imeiEl.addEventListener('input', (e)=>{
      const v = digitsOnly(e.target.value);
      const pos = e.target.selectionStart;
      e.target.value = v.slice(0, 15);
      try{ e.target.setSelectionRange(pos, pos);}catch(_){}
      updateValidity();
    });
    imeiEl.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); if(submitBtn && !submitBtn.disabled){ form.submit(); } }
    });
  }
  if (orderEl){
    orderEl.setAttribute('inputmode', 'decimal');
    orderEl.addEventListener('input', ()=>{
      manualPrice = true;
      if (Number(orderEl.value) < 0) orderEl.value = '0';
      updateValidity();
    });
  }
  if (recvEl && !recvEl.value){
    try{
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const dd = String(today.getDate()).padStart(2,'0');
      recvEl.value = `${yyyy}-${mm}-${dd}`;
    }catch(_){}
  }
  if (prodEl) {
    prodEl.addEventListener('change', ()=>{
      manualPrice = false;
      autofillOrderPrice(false);
      updateValidity();
    });
  }
  if (locEl){
    locEl.addEventListener('change', updateValidity);
  }

  // Initial sync + defaults
  window.addEventListener('load', ()=>{
    applyDefaultLocation();
    imeiEl && imeiEl.focus();
    updateValidity();
    if (prodEl && prodEl.value){ autofillOrderPrice(false); }
  });

  // Clipboard helper
  pasteBtn && pasteBtn.addEventListener('click', async ()=>{
    try{
      const txt = await navigator.clipboard.readText();
      if(!txt){ showToast('Clipboard is empty.', false); return; }
      if (imeiEl){
        imeiEl.value = digitsOnly(txt).slice(0,15);
        updateValidity();
        if(looksLikeIMEI(imeiEl.value) && submitBtn && !submitBtn.disabled){ form.submit(); }
        else { showToast('Pasted. Press Save to submit.', true); }
      }
    }catch{
      showToast('Clipboard blocked. Paste manually (Ctrl+V).', false);
      imeiEl && imeiEl.focus();
    }
  });

  // Camera (optional)
  let quaggaRunning = false;
  let lastDetected = '';
  async function listCameras(){
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d=> d.kind==='videoinput');
      if (camSelect){
        camSelect.innerHTML = '';
        cams.forEach((c,i)=>{
          const opt = document.createElement('option');
          opt.value = c.deviceId; opt.textContent = c.label || `Camera ${i+1}`;
          camSelect.appendChild(opt);
        });
      }
      return cams;
    }catch{return [];}
  }
  function pauseScanline(ms=900){
    if(!scanLine) return;
    scanLine.classList.add('paused');
    setTimeout(()=> scanLine.classList.remove('paused'), ms);
  }
  function startQuagga(deviceId){
    if(quaggaRunning || !window.Quagga) return;
    Quagga.init({
      inputStream: { type: 'LiveStream', target: camNode,
        constraints: { facingMode: 'environment', deviceId: deviceId || undefined,
          width:{ideal:1280}, height:{ideal:720} } },
      decoder: { readers: ['code_128_reader','ean_reader','ean_8_reader','code_39_reader','upc_reader','upc_e_reader'] },
      locate: true,
      numOfWorkers: navigator.hardwareConcurrency ? Math.min(4, navigator.hardwareConcurrency) : 2
    }, (err)=>{
      if(err){ showToast('Camera init failed. Check permissions / HTTPS.', false); return; }
      Quagga.start(); quaggaRunning = true;
    });
    Quagga.onDetected((result)=>{
      const code = (result && result.codeResult && result.codeResult.code) || '';
      if(!code || code===lastDetected) return;
      lastDetected = code;
      const numeric = digitsOnly(code);
      if(imeiEl){
        imeiEl.value = numeric.slice(0, 15);
        updateValidity();
        pauseScanline();
        if(looksLikeIMEI(imeiEl.value) && submitBtn && !submitBtn.disabled){
          try{ navigator.vibrate && navigator.vibrate(20); }catch(_){}
          showToast('Scanned IMEI: ' + imeiEl.value, true);
          form.submit();
        }else{
          showToast('Scanned, but not a 15-digit IMEI.', false);
        }
      }
    });
  }
  function stopQuagga(){ if(!quaggaRunning || !window.Quagga) return; Quagga.stop(); quaggaRunning=false; }

  camToggle && camToggle.addEventListener('click', async ()=>{
    if(!camBox) return;
    if(camBox.style.display==='none' || camBox.style.display===''){
      camBox.style.display='block';
      const cams = await listCameras();
      startQuagga(cams[0] && cams[0].deviceId);
      camToggle.textContent='Restart Camera';
    }else{
      stopQuagga();
      startQuagga((camSelect && camSelect.value) || undefined);
    }
  });
  camSelect && camSelect.addEventListener('change', ()=>{ if(quaggaRunning){ stopQuagga(); startQuagga(camSelect.value); } });
  camStop && camStop.addEventListener('click', ()=>{ stopQuagga(); if (camBox) camBox.style.display='none'; if (camToggle) camToggle.textContent='Start Camera'; });
  window.addEventListener('beforeunload', stopQuagga);
})();
</script>
{% endblock %}
