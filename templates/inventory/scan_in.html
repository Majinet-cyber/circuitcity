{% extends "base.html" %}
{% load static %}
{% block title %}Scan IN · Inventory{% endblock %}
{% block header_title %}Inventory · Scan In{% endblock %}

{# Inventory pages: scoped notifications, no global search #}
{% block notif_scope %}inventory{% endblock %}
{% block notif_allow %}stock_in,stock_sold,low_stock{% endblock %}

{% block extra_css %}
<style>
  /* ===== Layout ===== */
  .page{margin:0 auto;max-width:1120px;padding:clamp(12px,4vw,24px)}
  .vstack{display:flex;flex-direction:column;gap:.75rem}
  .hstack{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}

  /* ===== Theme (blue accent restored) ===== */
  :root{
    --cc-bg:#ffffff;
    --cc-text:#0f172a;
    --cc-muted:#64748b;
    --cc-border:#e2e8f0;
    --cc-panel:#ffffff;
    --cc-panel-2:#f8fafc;
    --cc-accent:#1f6feb;
    --cc-accent-600:#1a5fd4;
    --cc-accent-700:#164fb1;
    --cc-shadow:0 6px 18px rgba(2,6,23,.08);
  }
  body{background:var(--cc-bg);color:var(--cc-text)}

  /* ===== Form layout ===== */
  .form{display:grid;gap:14px;max-width:880px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width: 640px){ .row{grid-template-columns:1fr} }

  /* ===== Field & control styling ===== */
  .field{
    position:relative;background:var(--cc-panel);border:1px solid var(--cc-border);
    border-radius:12px;display:flex;align-items:center;box-shadow:var(--cc-shadow)
  }
  .field > input,.field > select,.field > .form-control{
    flex:1;background:transparent;color:var(--cc-text);border:0;padding:12px 14px;
    outline:none;font-size:16px;width:100%;min-height:44px;
  }
  label{font-weight:700;margin-bottom:6px;display:inline-block}

  /* ===== Buttons (blue) ===== */
  .btn{
    appearance:none;border:1px solid var(--cc-border);color:var(--cc-text);
    background:var(--cc-panel);border-radius:10px;padding:10px 14px;
    cursor:pointer;font-weight:700;font-size:14px;min-height:44px;
    transition:transform .12s ease,box-shadow .2s ease,background .2s ease,border-color .2s ease
  }
  .btn:hover{transform:translateY(-1px);box-shadow:var(--cc-shadow)}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn-primary{background:var(--cc-accent);color:#fff;border-color:var(--cc-accent)}
  .btn-primary:hover{background:var(--cc-accent-600);border-color:var(--cc-accent-600)}
  .btn-secondary{background:var(--cc-panel)}
  .btn-sky{
    background:linear-gradient(135deg,#38bdf8,#0ea5e9);
    color:#052c3b;border-color:#075985
  }

  /* ===== Inputs focus ring in blue ===== */
  input[type="text"], input[type="number"], input[type="date"], select, textarea {
    transition: box-shadow .15s, border-color .15s;
  }
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--cc-accent) !important;
    box-shadow: 0 0 0 .2rem rgba(31,111,235,.25) !important;
  }

  /* ===== IMEI validity colors (border + badge) ===== */
  .field.state-bad{border-color:#ef4444 !important; box-shadow:0 0 0 .2rem rgba(239,68,68,.15), var(--cc-shadow) !important}
  .field.state-ok {border-color:#10b981 !important; box-shadow:0 0 0 .2rem rgba(16,185,129,.22), var(--cc-shadow) !important}

  /* ===== Misc UI ===== */
  .hint{font-size:12px;color:var(--cc-muted)}
  .help-error{font-size:12px;color:#ef4444}
  .help-error[hidden]{display:none}
  .pill{font-size:12px;color:var(--cc-accent-700);background:rgba(31,111,235,.10);border:1px solid rgba(31,111,235,.25);padding:4px 8px;border-radius:999px}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:var(--cc-panel);border:1px solid var(--cc-border);color:var(--cc-text);padding:2px 6px;border-radius:6px}

  /* ===== Camera shell + overlay scanline ===== */
  #cameraBox{margin-top:8px;display:none;background:var(--cc-panel);border:1px dashed var(--cc-border);border-radius:14px;padding:12px}
  .scan-shell{position:relative;border-radius:14px;overflow:hidden;background:#000;box-shadow:var(--cc-shadow)}
  #camera{width:100%;max-height:360px;min-height:220px;background:#000;display:block;object-fit:cover}
  .scan-overlay{position:absolute;inset:0;pointer-events:none}
  .scan-frame{
    position:absolute; inset:10% 8%;
    border:2px solid rgba(255,255,255,.25);
    border-radius:12px;
    box-shadow: inset 0 0 0 9999px rgba(0,0,0,.20);
  }
  .scanline{
    position:absolute; left:8%; right:8%; height:2px; border-radius:2px;
    background:linear-gradient(90deg, transparent, #00ff5a, transparent);
    box-shadow:0 0 10px #00ff5a, 0 0 20px rgba(0,255,90,.6);
    animation: sweep 2.0s linear infinite alternate;
  }
  .scanline.paused{ animation-play-state: paused; }
  @keyframes sweep { from{ top:10%; } to{ top:90%; } }

  /* Toast */
  .toast{
    position:fixed;right:18px;bottom:18px;min-width:240px;
    background:var(--cc-panel);border:1px solid var(--cc-border);color:var(--cc-text);
    border-radius:12px;padding:12px 14px;box-shadow:0 10px 25px rgba(0,0,0,.25);
    display:none;z-index:1000
  }
  .toast.ok{border-color:rgba(16,185,129,.45)}
  .toast.err{border-color:rgba(239,68,68,.55)}

  /* Warning banner for non-secure origin */
  .warn{
    display:none;margin-top:.5rem;padding:.6rem .8rem;border:1px solid #fbbf24;background:#fffbeb;color:#92400e;border-radius:10px
  }

  /* Picker overlay when multiple codes detected */
  #ccscan-picker{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.55);z-index:9999
  }
  #ccscan-picker .card{
    background:#fff;max-width:90vw;width:520px;padding:16px;border-radius:12px;
    box-shadow:0 10px 40px rgba(0,0,0,.35);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
  }
  #ccscan-picker .list{max-height:55vh;overflow:auto;display:flex;flex-direction:column;gap:8px}
  #ccscan-picker .item{
    text-align:left;padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;
    background:#f9fafb;cursor:pointer;word-break:break-all
  }
  #ccscan-picker .actions{margin-top:12px;display:flex;justify-content:flex-end}
  #ccscan-picker .cancel{padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
</style>
{% endblock %}

{% block body %}
{% include "_topbar.html" %}
<main class="page vstack">
  <section aria-labelledby="scanin" class="vstack">
    <h1 id="scanin" style="margin:0 0 .25rem">Scan IN · Inventory</h1>
    <p class="hint" style="margin:0 0 1rem">
      Paste or scan the <strong>IMEI</strong>. Scanners typically “type” digits then send <span class="kbd">Enter</span>.
    </p>

    <div id="secureWarn" class="warn" role="alert">
      Camera requires a secure connection. Open this page over <strong>HTTPS</strong> (or localhost) and allow camera permission.
      On Android Chrome you may enable the dev flag: <code>chrome://flags/#unsafely-treat-insecure-origin-as-secure</code>.
    </div>

    {% url 'inventory:stock_list' as stock_url %}
    <form method="post"
          action=""
          novalidate
          class="form"
          data-validate
          aria-describedby="imeiHelp"
          data-default-location-id="{{ default_location.id|default:request.user.agent_profile.location.id|default:'' }}"
          data-default-location-name="{{ default_location.name|default:request.user.agent_profile.location.name|default:'' }}"
          {# Optional: have your view set this to "1" for agents to lock their store #}
          data-lock-location="{{ lock_location|default:'' }}">
      {% csrf_token %}
      {% if form.non_field_errors %}<div class="help-error">{{ form.non_field_errors }}</div>{% endif %}

      <!-- IMEI -->
      <div>
        <label for="id_imei">IMEI</label>
        <div class="field" id="imeiField">
          <!-- never more than 15 -->
          <input type="text"
                 id="id_imei"
                 name="imei"
                 inputmode="numeric"
                 autocomplete="off"
                 placeholder="Scan or paste IMEI (15 digits)"
                 aria-required="true"
                 aria-invalid="false"
                 maxlength="15"
                 style="width:100%;background:transparent;border:0;padding:12px 14px;">
          <!-- live counter badge -->
          <span id="imeiLen"
                class="badge rounded-pill"
                style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:#e2e8f0;color:#0f172a;padding:.15rem .5rem;">
            0/15
          </span>
        </div>
        <div id="imeiHelp" class="help-error" hidden>Enter a valid IMEI (exactly 15 digits).</div>
        <div class="hstack" style="margin-top:6px">
          <button type="button" id="pasteBtn" class="btn btn-secondary">Paste from Clipboard</button>
          <button type="button" id="camToggle" class="btn btn-sky">Start Camera</button>
          <button type="button" id="torchBtn" class="btn">Toggle Torch</button>
          <span class="pill">Shortcut: <span class="kbd">Enter</span> submits</span>
          <span class="pill">Focus: <span class="kbd">F2</span></span>
        </div>

        <!-- Camera shell -->
        <div id="cameraBox" aria-live="polite">
          <div class="scan-shell">
            <video id="camera" autoplay playsinline muted></video>
            <div class="scan-overlay" aria-hidden="true">
              <div class="scan-frame"></div>
              <div id="scanline" class="scanline"></div>
            </div>
          </div>
          <div class="hstack" style="margin-top:8px">
            <select id="cameraSelect" class="btn" style="min-width:200px" aria-label="Choose camera"></select>
            <button type="button" id="camStop" class="btn">Stop Camera</button>
          </div>
        </div>
      </div>

      <!-- Product / Location -->
      <div class="row">
        <div>
          <label for="id_product">
            Product
            {% if request.user.is_staff or request.user.is_superuser %}
              <a class="pill" href="/admin/inventory/product/add/" title="Add new product">+ Add</a>
            {% endif %}
          </label>
          <div class="field">
            {{ form.product }}
          </div>
          {% if form.product.errors %}<div class="help-error">{{ form.product.errors|striptags }}</div>{% endif %}
          <div class="hint">Managers add products; agents pick from this list. <em>Order price auto-fills if set.</em></div>
        </div>
        <div>
          <label for="id_location">
            Location <span class="hint">(defaults to your store)</span>
            {% if request.user.is_staff or request.user.is_superuser %}
              <a class="pill" href="/admin/inventory/location/add/" title="Add new location">+ Add</a>
            {% endif %}
          </label>
          <div class="field">{{ form.location }}</div>
          {% if form.location.errors %}<div class="help-error">{{ form.location.errors|striptags }}</div>{% endif %}
          <div class="hint">Default is your store. Managers can add new locations.</div>
        </div>
      </div>

      <!-- Order price / Received date -->
      <div class="row">
        <div>
          <label for="id_order_price">Order price</label>
          <div class="field">
            <input type="number"
                   id="id_order_price"
                   name="order_price"
                   min="0"
                   step="any"
                   placeholder="0.00"
                   aria-describedby="orderPriceHint"
                   style="width:100%;background:transparent;border:0;padding:12px 14px;">
          </div>
          <div class="hint" id="orderPriceHint">Will auto-fill if a default exists for this model.</div>
        </div>

        <div>
          <label for="id_received_at">Received date</label>
          <div class="field">
            <input type="date"
                   id="id_received_at"
                   name="received_at"
                   style="width:100%;background:transparent;border:0;padding:12px 14px;">
          </div>
          <div class="hint">If empty, we’ll set today automatically.</div>
        </div>
      </div>

      <!-- Assign toggle -->
      <div class="hstack">
        <label style="display:flex;align-items:center;gap:10px;">
          <input type="checkbox" id="id_assigned_to_me" name="assigned_to_me" value="1">
          Assign this device to me
        </label>
        {% if request.user.is_staff or request.user.is_superuser %}
          <span class="pill">Note: admin/staff accounts can’t hold stock — this toggle will be ignored.</span>
        {% endif %}
      </div>

      <!-- Actions -->
      <div class="hstack" style="margin-top:.25rem">
        <button type="submit" id="submitBtn" class="btn btn-primary" disabled>Save</button>
        <a class="btn btn-secondary" href="{{ stock_url|default:'/inventory/' }}">Cancel</a>
      </div>
    </form>
  </section>
</main>

<!-- Toast -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- QuaggaJS fallback -->
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<script>
(function(){
  // ===== Element refs =====
  const form       = document.querySelector('form[data-validate]');
  const imeiEl     = document.getElementById('id_imei');
  const imeiField  = document.getElementById('imeiField');
  const imeiLen    = document.getElementById('imeiLen');
  const prodEl     = document.getElementById('id_product');
  const locEl      = document.getElementById('id_location');
  const orderEl    = document.getElementById('id_order_price');
  const recvEl     = document.getElementById('id_received_at');
  const submitBtn  = document.getElementById('submitBtn');
  const pasteBtn   = document.getElementById('pasteBtn');

  const camToggle  = document.getElementById('camToggle');
  const camStop    = document.getElementById('camStop');
  const camBox     = document.getElementById('cameraBox');
  const camNode    = document.getElementById('camera');
  const camSelect  = document.getElementById('cameraSelect');
  const torchBtn   = document.getElementById('torchBtn');

  const toast      = document.getElementById('toast');
  const scanLine   = document.getElementById('scanline');
  const secureWarn = document.getElementById('secureWarn');
  const orderPriceHint = document.getElementById('orderPriceHint');

  // ===== Helpers =====
  const isSecure = window.isSecureContext || location.protocol === 'https:';
  if (!isSecure) secureWarn.style.display = 'block';

  function showToast(msg, ok=true){
    toast.textContent = msg;
    toast.className = 'toast ' + (ok ? 'ok' : 'err');
    toast.style.display = 'block';
    setTimeout(()=> toast.style.display = 'none', 2600);
  }
  const digitsOnly = (s)=> (s||'').replace(/\D/g,'');
  const lenDigits = (s)=> digitsOnly(s).length;

  function setBadgeNeutral(){
    imeiLen.style.background = '#e2e8f0';
    imeiLen.style.color = '#0f172a';
    imeiField.classList.remove('state-ok','state-bad');
  }
  function setBadgeBad(){
    imeiLen.style.background = '#fee2e2';   /* red-100 */
    imeiLen.style.color = '#991b1b';        /* red-800 */
    imeiField.classList.add('state-bad');
    imeiField.classList.remove('state-ok');
  }
  function setBadgeOk(){
    imeiLen.style.background = '#dcfce7';   /* green-100 */
    imeiLen.style.color = '#065f46';        /* green-800 */
    imeiField.classList.add('state-ok');
    imeiField.classList.remove('state-bad');
  }

  // live counter + validity coloring
  function updateImeiCounter(){
    const n = lenDigits(imeiEl.value);
    if (imeiLen){ imeiLen.textContent = `${n}/15`; }
    const help = document.getElementById('imeiHelp');

    if (n === 0){
      setBadgeNeutral();
      imeiEl.setAttribute('aria-invalid','false');
      if (help) help.hidden = true;
    } else if (n < 15){
      setBadgeBad();
      imeiEl.setAttribute('aria-invalid','true');
      if (help) help.hidden = false;
    } else { // n === 15
      setBadgeOk();
      imeiEl.setAttribute('aria-invalid','false');
      if (help) help.hidden = true;
    }
  }

  // ensure we never exceed 15; if pasted/scanned longer, we keep LAST 15
  function clampTo15KeepLast(){
    const d = digitsOnly(imeiEl.value);
    if (d.length > 15){
      imeiEl.value = d.slice(-15);
      return true;
    } else if (d.length !== imeiEl.value.length){
      imeiEl.value = d;
      return true;
    }
    return false;
  }

  function pauseScanline(ms=900){ scanLine?.classList.add('paused'); setTimeout(()=> scanLine?.classList.remove('paused'), ms); }

  // ===== Validation / defaults =====
  const defaultLocId = (form && form.dataset.defaultLocationId) ? form.dataset.defaultLocationId : '';
  const lockLocation = (form && form.dataset.lockLocation === '1');

  if (locEl) { locEl.removeAttribute('required'); locEl.removeAttribute('aria-required'); }

  function updateFormValidity(){
    const okImei = lenDigits(imeiEl.value) === 15; // must be exactly 15
    const hasProduct = !!(prodEl && prodEl.value);
    const priceOk = (orderEl && orderEl.value !== '' && !Number.isNaN(Number(orderEl.value)));
    submitBtn && (submitBtn.disabled = !(okImei && hasProduct && priceOk));
  }

  function applyDefaultLocation(){
    if (!locEl || !defaultLocId) return;
    const opt = Array.from(locEl.options||[]).find(o => String(o.value) === String(defaultLocId));
    if (opt){ locEl.value = opt.value; }
  }

  function ensureLocationEnabled(){
    if (!locEl) return;
    if (!lockLocation) {
      try { locEl.removeAttribute('disabled'); locEl.classList.remove('is-disabled'); } catch(_){}
    }
  }

  function lockLocationIfNeeded(){
    if (!locEl) return;
    const existingHidden = document.querySelector('input[type="hidden"][name="location"]');
    if (lockLocation){
      const val = (locEl.value || defaultLocId || '');
      if (!existingHidden){
        const h = document.createElement('input');
        h.type = 'hidden';
        h.name = 'location';
        h.value = val;
        form.appendChild(h);
      } else {
        existingHidden.value = val;
      }
      locEl.setAttribute('disabled', 'disabled');
      locEl.classList.add('is-disabled');
    } else {
      if (existingHidden) existingHidden.remove();
      try { locEl.removeAttribute('disabled'); locEl.classList.remove('is-disabled'); } catch(_){}
    }
  }

  const ORDER_PRICE_ENDPOINTS = ['/inventory/api/order-price/', '/inventory/api/order_price/', '/inventory/order-price/'];
  async function fetchFirstOk(bases, productId){
    for (const b of bases){
      try{
        const r = await fetch(`${b}${productId}/`, {headers:{'Accept':'application/json'}});
        if (r.ok) return await r.json();
      }catch(_){}
    }
    return null;
  }
  let manualPrice = false;
  function setOrderHint(text){ orderPriceHint && (orderPriceHint.textContent = text); }
  async function autofillOrderPrice(force=false){
    if(!prodEl || !prodEl.value) return;
    const data = await fetchFirstOk(ORDER_PRICE_ENDPOINTS, prodEl.value);
    const price = data && data.price != null ? Number(data.price) : null;
    if(price != null){
      if (orderEl){
        const isBlankOrZero = (orderEl.value === '' || Number(orderEl.value) === 0);
        if (force || !manualPrice || isBlankOrZero){
          orderEl.value = price.toFixed(2);
          manualPrice = false;
        }
      }
      setOrderHint('Auto-filled from default order price catalog. You can override.');
    }else{
      setOrderHint('No default price set for this model yet. Enter one manually.');
    }
    updateFormValidity();
  }

  // ===== Input wiring =====
  if (imeiEl) {
    imeiEl.setAttribute('inputmode','numeric');
    imeiEl.setAttribute('autocomplete','off');

    // keep digits only, never >15 (keep last 15 when overflow/paste)
    imeiEl.addEventListener('input', ()=>{
      const before = imeiEl.value;
      const onlyDigits = digitsOnly(before);
      imeiEl.value = onlyDigits.length > 15 ? onlyDigits.slice(-15) : onlyDigits;
      updateImeiCounter();
      updateFormValidity();
    });

    imeiEl.addEventListener('paste', ()=>{
      setTimeout(()=>{
        clampTo15KeepLast();
        updateImeiCounter();
        updateFormValidity();
      },0);
    });

    // Enter submits when valid
    imeiEl.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){
        e.preventDefault();
        clampTo15KeepLast();
        updateImeiCounter();
        updateFormValidity();
        if (submitBtn && !submitBtn.disabled){ form.submit(); }
      }
      if(e.key==='F2'){ e.preventDefault(); imeiEl.focus(); }
    });
  }

  if (orderEl){
    orderEl.setAttribute('inputmode', 'decimal');
    orderEl.addEventListener('input', ()=>{
      manualPrice = true;
      if (Number(orderEl.value) < 0) orderEl.value = '0';
      updateFormValidity();
    });
  }
  if (recvEl && !recvEl.value){
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    recvEl.value = `${yyyy}-${mm}-${dd}`;
  }
  prodEl && prodEl.addEventListener('change', ()=>{ manualPrice = false; autofillOrderPrice(false); updateFormValidity(); });
  locEl && locEl.addEventListener('change', ()=>{
    const hidden = document.querySelector('input[type="hidden"][name="location"]');
    if (hidden) hidden.value = locEl.value || defaultLocId || '';
    updateFormValidity();
  });

  window.addEventListener('load', ()=>{
    applyDefaultLocation();
    ensureLocationEnabled();
    lockLocationIfNeeded();
    imeiEl && imeiEl.focus();
    updateImeiCounter();
    updateFormValidity();
    if (prodEl && prodEl.value){ autofillOrderPrice(false); }
  });

  // ===== Clipboard =====
  pasteBtn && pasteBtn.addEventListener('click', async ()=>{
    try{
      const txt = await navigator.clipboard.readText();
      if(!txt){ showToast('Clipboard is empty.', false); return; }
      if (imeiEl){
        const d = digitsOnly(txt);
        imeiEl.value = d.length > 15 ? d.slice(-15) : d; // keep LAST 15
        updateImeiCounter();
        updateFormValidity();
        if (lenDigits(imeiEl.value) === 15 && submitBtn && !submitBtn.disabled){
          form.submit();
        } else {
          showToast('Pasted. Need 15 digits.', false);
        }
      }
    }catch{
      showToast('Clipboard blocked. Paste manually (Ctrl+V).', false);
      imeiEl && imeiEl.focus();
    }
  });

  // ===== Scanner: BarcodeDetector → Quagga fallback =====
  let mediaStream = null, videoTrack = null;

  async function listCameras(){
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d=> d.kind==='videoinput');
      if (camSelect){
        camSelect.innerHTML = '';
        cams.forEach((c,i)=>{
          const opt = document.createElement('option');
          opt.value = c.deviceId; opt.textContent = c.label || `Camera ${i+1}`;
          camSelect.appendChild(opt);
        });
      }
      return cams;
    }catch{return [];}
  }

  async function startMedia(deviceId){
    const constraints = {
      audio:false,
      video:{
        facingMode: deviceId ? undefined : { ideal: 'environment' },
        deviceId: deviceId ? { exact: deviceId } : undefined,
        width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:30}
      }
    };
    mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
    camNode.srcObject = mediaStream;
    await camNode.play();
    videoTrack = mediaStream.getVideoTracks()[0];
  }

  async function enableTorch(desired){
    if(!videoTrack) return;
    const caps = videoTrack.getCapabilities?.() || {};
    if (!('torch' in caps)) { showToast('Torch not supported on this camera.', false); return; }
    try{
      await videoTrack.applyConstraints({ advanced:[{ torch: desired }] });
    }catch(_){}
  }

  function stopAll(){
    if (window.Quagga) try{ Quagga.offDetected && Quagga.offDetected(()=>{}); }catch(_){}
    if (window.Quagga) try{ Quagga.stop(); }catch(_){}
    if (mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); }
    mediaStream = null; videoTrack = null;
  }

  function picker(values, onPick){
    document.getElementById('ccscan-picker')?.remove();
    const wrap = document.createElement('div');
    wrap.id = 'ccscan-picker';
    const card = document.createElement('div'); card.className='card';
    const h = document.createElement('div'); h.style.fontWeight='600'; h.style.marginBottom='10px'; h.textContent='Multiple codes found — pick one';
    const list = document.createElement('div'); list.className='list';
    values.forEach(v=>{
      const b = document.createElement('button'); b.type='button'; b.className='item'; b.textContent=v;
      b.onclick = ()=>{ wrap.remove(); onPick(v); };
      list.appendChild(b);
    });
    const actions = document.createElement('div'); actions.className='actions';
    const cancel = document.createElement('button'); cancel.type='button'; cancel.className='cancel'; cancel.textContent='Cancel';
    cancel.onclick = ()=> wrap.remove();
    actions.appendChild(cancel);
    card.append(h,list,actions); wrap.appendChild(card); document.body.appendChild(wrap);
  }

  function handleIMEI(value){
    const codeRaw = digitsOnly(value);
    if (!codeRaw) return;
    const code = (codeRaw.length >= 15) ? codeRaw.slice(-15) : codeRaw;
    if (imeiEl){ imeiEl.value = code; updateImeiCounter(); updateFormValidity(); }
    try{ navigator.vibrate && navigator.vibrate(20);}catch(_){}
    if (code.length === 15 && submitBtn && !submitBtn.disabled){
      showToast('Scanned IMEI: ' + code, true);
      stopAll(); form.submit();
    } else {
      showToast('Scanned, but not a 15-digit IMEI.', false);
    }
  }

  async function startNativeDetector(deviceId){
    await startMedia(deviceId);
    if (!('BarcodeDetector' in window)){ return startQuagga(deviceId); }

    const detector = new window.BarcodeDetector({
      formats: [
        "qr_code","aztec","code_128","code_39","code_93",
        "data_matrix","ean_13","ean_8","itf","pdf417","upc_a","upc_e"
      ]
    });

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    let lastPickShownAt = 0;
    const windowMs = 1200;
    let seen = new Map();   // value -> lastTs

    const loop = async () => {
      if (!mediaStream) return;
      requestAnimationFrame(loop);
      if (camNode.readyState < 2) return;

      canvas.width = camNode.videoWidth; canvas.height = camNode.videoHeight;
      ctx.drawImage(camNode,0,0,canvas.width,canvas.height);

      try{
        const codes = await detector.detect(canvas);
        if (codes?.length){
          const vals = [...new Set(codes.map(c => (c.rawValue||c.rawValueText||"").trim()).filter(Boolean))];
          const now = Date.now();
          vals.forEach(v=> seen.set(v, now));
          for (const [k,t] of [...seen.entries()]) if (now - t > windowMs) seen.delete(k);

          const uniq = [...seen.keys()];
          if (uniq.length === 1){
            handleIMEI(uniq[0]);
          } else if (uniq.length > 1 && now - lastPickShownAt > 600){
            lastPickShownAt = now;
            picker(uniq, (choice)=> handleIMEI(choice));
          }
        }
      }catch(_){}
    };
    loop();
  }

  // ---- Quagga fallback (1-at-a-time) ----
  async function startQuagga(deviceId){
    if (!window.Quagga) { showToast('Quagga not loaded.', false); return; }
    Quagga.init({
      inputStream: { type: 'LiveStream', target: camNode,
        constraints: { facingMode: deviceId ? undefined : 'environment', deviceId: deviceId || undefined,
          width:{ideal:1280}, height:{ideal:720} } },
      decoder: { readers: ['code_128_reader','ean_reader','ean_8_reader','code_39_reader','upc_reader','upc_e_reader','itf_reader','codabar_reader'] },
      locate: true,
      numOfWorkers: navigator.hardwareConcurrency ? Math.min(4, navigator.hardwareConcurrency) : 2
    }, (err)=>{
      if(err){ showToast('Camera init failed. Use HTTPS or Android dev flag & allow camera.', false); return; }
      Quagga.start();
    });
    Quagga.onDetected((result)=>{
      const code = (result && result.codeResult && result.codeResult.code) || '';
      if(!code) return;
      handleIMEI(code);
    });
  }

  // ---- UI buttons ----
  camToggle && camToggle.addEventListener('click', async ()=>{
    camBox.style.display = 'block';
    const cams = await listCameras();
    const firstId = (cams[0] && cams[0].deviceId) || undefined;

    try{
      await startNativeDetector(firstId);
      camToggle.textContent = 'Restart Camera';
    }catch(err){
      showToast('Could not start camera. Check permission / origin.', false);
    }
  });

  camSelect && camSelect.addEventListener('change', async ()=>{
    stopAll();
    if ('BarcodeDetector' in window){
      await startNativeDetector(camSelect.value);
    } else {
      await startQuagga(camSelect.value);
    }
  });

  camStop && camStop.addEventListener('click', ()=>{
    stopAll();
    camBox.style.display='none';
    camToggle.textContent='Start Camera';
  });

  torchBtn && torchBtn.addEventListener('click', ()=> enableTorch(true));

  // Pause camera when tab hidden
  document.addEventListener('visibilitychange', ()=>{ if (document.hidden) { stopAll(); } });

  // ---- Form submit guard: IMEI must be exactly 15 ----
  form.addEventListener('submit', (e)=>{
    clampTo15KeepLast(); // just in case
    updateImeiCounter();
    updateFormValidity();
    if (lenDigits(imeiEl.value) !== 15){
      e.preventDefault();
      showToast('Enter 15-digit IMEI.', false);
    }
  });

  // initial
  updateImeiCounter();
  updateFormValidity();
})();
</script>

<noscript>
  <div class="warn" style="display:block" role="alert">
    JavaScript is required to use the camera scanner and live validation. You can still type the IMEI and submit.
  </div>
</noscript>
{% endblock %}
