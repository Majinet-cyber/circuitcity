{% extends "base.html" %}
{% load static %}

{% block title %}Scan (Web) — Mark SOLD · Circuit City{% endblock %}

{% block extra_css %}
<style>
  :root { --bg:#0f172a;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--accent-2:#38bdf8;--border:#1f2937; }
  .scan-wrap { max-width:960px; margin:0 auto; }
  .scan-card { background:rgba(17,24,39,.85); border:1px solid var(--border); border-radius:16px; padding:20px;
               backdrop-filter: blur(6px); box-shadow:0 10px 30px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.03); }
  .scan-title { font-size:20px; margin:0 0 4px; }
  .scan-sub { color:var(--muted); font-size:13px; margin-bottom:16px; }
  .row { display:grid; grid-template-columns:1fr auto; gap:12px; align-items:center; }
  .field { background:#0b1020; border:1px solid var(--border); border-radius:12px; display:flex; align-items:center; }
  .field input { flex:1; background:transparent; color:var(--text); border:0; padding:14px; outline:none; font-size:18px; letter-spacing:1px; }
  .hint { font-size:12px; color:var(--muted); margin-top:6px; }
  .btn { border:1px solid var(--border); color:white; background:#0a1020; border-radius:10px; padding:12px 14px; cursor:pointer; font-weight:600; font-size:14px; }
  .btn.primary { background: linear-gradient(135deg, var(--accent), #16a34a); }
  .btn.sky { background: linear-gradient(135deg, var(--accent-2), #0ea5e9); }
  .btn.flat { background:#0c1430; }
  .stack { display:grid; gap:10px; }
  .flex { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .pill { font-size:12px; color:#a7f3d0; background:rgba(16,185,129,.12); border:1px solid rgba(16,185,129,.35); padding:4px 8px; border-radius:999px; }
  #cameraBox { margin-top:18px; display:none; background:#060a15; border:1px dashed #1e293b; border-radius:14px; padding:12px; }
  #camera { width:100%; max-height:380px; background:#000; border-radius:10px; overflow:hidden; }
  .sep { height:1px; background:#1f2937; margin:18px 0; border-radius:1px; }
  .toast { position:fixed; right:18px; bottom:18px; min-width:240px; background:#0b1326; border:1px solid #20304a; color:#e5f1ff;
           border-radius:12px; padding:12px 14px; display:none; z-index:50; }
  .toast.ok { border-color: rgba(16,185,129,.45); color:#d1fae5; }
  .toast.err { border-color: rgba(239,68,68,.55); color:#fee2e2; }
  .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .small { font-size:12px; color:var(--muted); }
  .list { margin-top:8px; font-size:13px; color:#cbd5e1; }
  .list li { padding:5px 0; border-bottom:1px dashed #1f2937; }
  .kbd { font-family: ui-monospace, Menlo, Consolas, monospace; background:#0b1020; border:1px solid #1f2937; color:#cbd5e1; padding:2px 6px; border-radius:6px; }
</style>
{% endblock %}

{% block body %}
<div class="scan-wrap">
  <div class="scan-card">
    <h1 class="scan-title">Scan (Web) — Mark SOLD</h1>
    <div class="scan-sub">Paste or scan the <strong>15-digit IMEI</strong>. Press <span class="kbd">Enter</span> to submit.</div>

    <div class="stack" role="form" aria-label="Mark item as SOLD">
      <div class="row">
        <div class="field" style="grid-column:1/-1;">
          <input id="imei" type="text" inputmode="numeric" autocomplete="off" maxlength="20"
                 placeholder="Paste/scan IMEI (15 digits)" aria-label="IMEI input" />
        </div>
      </div>

      <div class="grid2">
        <div class="field"><input id="price" type="number" step="0.01" min="0" placeholder="(Optional) Price" aria-label="Selling price" /></div>
        <div class="field"><input id="location_id" type="number" min="1" step="1" placeholder="(Optional) Location ID" aria-label="Location ID" /></div>
      </div>

      <div class="flex">
        <button id="submitBtn" class="btn primary">Mark SOLD</button>
        <button id="pasteBtn" class="btn flat">Paste from Clipboard</button>
        <button id="camToggle" class="btn sky">Start Camera</button>
        <span class="pill">Shortcut: <span class="kbd">Enter</span></span>
        <span class="pill">Focus: <span class="kbd">F2</span></span>
      </div>
      <div class="hint">Many handheld scanners type digits then press Enter — this page auto-submits.</div>

      <div id="cameraBox">
        <div class="small" style="margin-bottom:8px;">Allow camera access; try rear camera on phones.</div>
        <div id="camera" aria-label="Live camera preview"></div>
        <div class="flex" style="margin-top:10px;">
          <select id="cameraSelect" class="btn" aria-label="Select camera"></select>
          <button id="camStop" class="btn flat">Stop Camera</button>
        </div>
      </div>

      <div class="sep"></div>

      <div>
        <div class="small" style="margin-bottom:8px;">Recently submitted</div>
        <ul id="recent" class="list" aria-live="polite"></ul>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
<script>
  // --- CSRF (for fetch) ---
  function getCookie(name){
    const v = `; ${document.cookie}`; const p = v.split(`; ${name}=`); if(p.length===2) return decodeURIComponent(p.pop().split(';').shift());
  }
  const CSRF = getCookie('csrftoken');

  // --- Elements ---
  const imeiEl     = document.getElementById('imei');
  const priceEl    = document.getElementById('price');
  const locEl      = document.getElementById('location_id');
  const submitBtn  = document.getElementById('submitBtn');
  const pasteBtn   = document.getElementById('pasteBtn');
  const camToggle  = document.getElementById('camToggle');
  const camStop    = document.getElementById('camStop');
  const camBox     = document.getElementById('cameraBox');
  const camNode    = document.getElementById('camera');
  const camSelect  = document.getElementById('cameraSelect');
  const toast      = document.getElementById('toast');
  const recent     = document.getElementById('recent');

  // --- Helpers ---
  function showToast(msg, ok=true){
    toast.textContent = msg;
    toast.className = 'toast ' + (ok ? 'ok' : 'err');
    toast.style.display = 'block';
    setTimeout(()=> toast.style.display='none', 2800);
  }
  function addRecent(text){
    const li=document.createElement('li'); li.textContent=text;
    recent.prepend(li); while(recent.children.length>8) recent.removeChild(recent.lastChild);
  }
  function isValidIMEI(s){ s=(s||'').replace(/\D/g,''); return /^\d{15}$/.test(s); }
  function autoSubmitIfValid(v){ const s=(v||'').replace(/\D/g,''); if(s.length===15){ imeiEl.value=s; submit(); } }
  function beep(){
    try {
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
      o.start(); setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.07); o.stop(ctx.currentTime+0.1); }, 60);
    } catch(_) {}
  }
  function vibrate(ms=40){ if(navigator.vibrate) navigator.vibrate(ms); }

  // --- Submit flow ---
  async function submit(){
    const imei = imeiEl.value.replace(/\D/g,'').trim();
    if(!isValidIMEI(imei)){ showToast('IMEI must be exactly 15 digits.', false); imeiEl.focus(); return; }
    const payload = { imei };
    if(priceEl.value.trim()) payload.price = priceEl.value.trim();
    if(locEl.value.trim())   payload.location_id = locEl.value.trim();

    try{
      const resp = await fetch("{% url 'inventory:api_mark_sold' %}", {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken':CSRF},
        body:JSON.stringify(payload)
      });
      const data = await resp.json().catch(()=> ({}));
      if(!resp.ok || data.ok===false){
        const msg = (data && (data.error || data.detail)) || ('Error '+resp.status);
        showToast(msg, false); addRecent('❌ '+imei+' — '+msg); vibrate(60); return;
      }
      const already = data.already_sold ? ' (already sold)' : '';
      showToast('✅ SOLD: '+imei+already, true); addRecent('✅ '+imei+already);
      beep(); vibrate(20);
      imeiEl.value=''; imeiEl.focus();
    }catch(e){
      showToast('Network error — are you logged in?', false);
      addRecent('❌ '+imei+' — network error'); vibrate(60);
    }
  }

  // --- UI bindings ---
  submitBtn.addEventListener('click', submit);
  pasteBtn.addEventListener('click', async ()=>{
    try {
      const txt = await navigator.clipboard.readText();
      imeiEl.value = txt.trim(); autoSubmitIfValid(imeiEl.value);
      if(!isValidIMEI(imeiEl.value)) showToast('Pasted. Press Enter to submit.', true);
    } catch {
      showToast('Clipboard blocked. Paste manually (Ctrl+V).', false); imeiEl.focus();
    }
  });
  imeiEl.addEventListener('keydown', e=>{ if(e.key==='Enter') submit(); });
  document.addEventListener('keydown', e=>{ if(e.key==='F2'){ e.preventDefault(); imeiEl.focus(); } });
  window.addEventListener('load', ()=> imeiEl.focus());

  // --- Camera / Quagga ---
  let quaggaRunning=false;

  async function listCameras(){
    try{
      const d = await navigator.mediaDevices.enumerateDevices();
      const cams = d.filter(x=>x.kind==='videoinput');
      camSelect.innerHTML='';
      cams.forEach((c,i)=>{ const o=document.createElement('option'); o.value=c.deviceId; o.textContent=c.label||`Camera ${i+1}`; camSelect.appendChild(o); });
      return cams;
    }catch{ return []; }
  }

  function startQuagga(deviceId){
    if(quaggaRunning) return;
    Quagga.init({
      inputStream:{ type:"LiveStream", target:camNode, constraints:{
        facingMode:"environment", deviceId: deviceId || undefined, width:{ideal:1280}, height:{ideal:720}
      }},
      decoder:{ readers:["code_128_reader","ean_reader","ean_8_reader","code_39_reader","upc_reader","upc_e_reader"] },
      locate:true,
      numOfWorkers: navigator.hardwareConcurrency ? Math.min(4, navigator.hardwareConcurrency) : 2
    }, (err)=>{
      if(err){ showToast('Camera init failed. Check permissions.', false); return; }
      Quagga.start(); quaggaRunning=true;
    });

    let last='';
    Quagga.onDetected(r=>{
      const code = (r && r.codeResult && r.codeResult.code) || '';
      if(!code || code===last) return; last=code;
      const numeric = code.replace(/\D/g,'');
      if(numeric.length>=15){
        imeiEl.value = numeric.slice(0,15);
        showToast('Scanned: '+imeiEl.value, true);
        beep(); vibrate(20);
        submit();
      }
    });
  }

  function stopQuagga(){ if(!quaggaRunning) return; Quagga.stop(); quaggaRunning=false; }

  camToggle.addEventListener('click', async ()=>{
    if(camBox.style.display==='none' || camBox.style.display===''){
      camBox.style.display='block';
      const cams = await listCameras();
      startQuagga(cams[0] && cams[0].deviceId);
      camToggle.textContent='Restart Camera';
    } else {
      stopQuagga();
      startQuagga(camSelect.value || undefined);
    }
  });

  camStop.addEventListener('click', ()=>{
    stopQuagga(); camBox.style.display='none'; camToggle.textContent='Start Camera';
  });
</script>
{% endblock %}
