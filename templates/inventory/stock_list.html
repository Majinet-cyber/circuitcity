{% extends "base.html" %}
{% load humanize static %}

{% block title %}Stock List ¬∑ Circuit City{% endblock %}
{% block header_title %}Inventory ¬∑ Stock{% endblock %}

{# --- Inventory page: narrow notifications & no search --- #}
{% block notif_scope %}inventory{% endblock %}
{% block notif_allow %}stock_in,stock_sold,low_stock{% endblock %}

{% block extra_css %}
<style>
  /* ===== Theme / tokens ===== */
  :root{
    --cc-bg:        #0b1220;
    --cc-text:      #0f172a;
    --cc-muted:     #475569;
    --cc-panel:     #ffffff;
    --cc-panel-2:   #f8fafc;
    --cc-border:    #d1d5db;
    --cc-accent:    #2563eb;
    --cc-accent-2:  #1d4ed8;
    --cc-danger:    #dc2626;
    --cc-success:   #16a34a;
    --cc-shadow:    0 6px 18px rgba(2,6,23,.08), 0 2px 6px rgba(2,6,23,.06);
    --chart-grid:   rgba(148,163,184,.28);
  }

  section{max-width:1200px;margin-inline:auto;color:var(--cc-text)}

  /* ===== Glassmorphic buttons ===== */
  .glass-btn,
  .btn-deep{
    --btn-bg: linear-gradient(180deg, rgba(255,255,255,.28), rgba(255,255,255,.12));
    --btn-ring: 0 0 0 2px rgba(37,99,235,.30);
    --btn-shadow: 0 10px 24px rgba(2,6,23,.12), 0 3px 8px rgba(2,6,23,.08);
    --btn-inset: inset 0 1px 0 rgba(255,255,255,.35), inset 0 -1px 0 rgba(2,6,23,.06);
    --btn-border: rgba(255,255,255,.35);
    --btn-tint: transparent;
    --btn-text: var(--cc-text);

    position: relative;
    display: inline-flex;
    align-items: center;
    gap: .55rem;
    min-height: 44px;
    padding: .65rem .95rem;
    border-radius: 14px;
    text-decoration: none;
    font-weight: 800;
    color: var(--btn-text);
    background: var(--btn-bg);
    border: 1px solid var(--btn-border);
    box-shadow: var(--btn-shadow), var(--btn-inset);
    -webkit-backdrop-filter: blur(14px);
    backdrop-filter: blur(14px);
    transition: transform .16s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
  }
  .glass-btn::before,
  .btn-deep::before{
    content:"";
    position:absolute; inset:-2px;
    border-radius:inherit;
    pointer-events:none;
    background: radial-gradient(120% 120% at 50% -20%, var(--btn-tint), transparent 55%);
    opacity:.85;
  }
  .glass-btn:hover, .btn-deep:hover{
    transform: translateY(-1px);
    background: linear-gradient(180deg, rgba(255,255,255,.36), rgba(255,255,255,.16));
    box-shadow: 0 16px 28px rgba(2,6,23,.16), 0 6px 12px rgba(2,6,23,.10), var(--btn-inset);
  }
  .glass-btn:active, .btn-deep:active{ transform: translateY(0) scale(.98); }
  .glass-btn:focus-visible, .btn-deep:focus-visible{
    outline:none; box-shadow: var(--btn-shadow), var(--btn-inset), var(--btn-ring);
  }
  .glass-icon{ width:1.25rem; height:1.25rem; display:inline-grid; place-items:center; }

  .is-primary{ --btn-tint: rgba(37,99,235,.22); --btn-ring: 0 0 0 2px rgba(37,99,235,.35); }
  .is-green  { --btn-tint: rgba(22,163,74,.22);  --btn-ring: 0 0 0 2px rgba(22,163,74,.35); }
  .is-amber  { --btn-tint: rgba(217,119,6,.23);  --btn-ring: 0 0 0 2px rgba(217,119,6,.35); }
  .is-rose   { --btn-tint: rgba(244,63,94,.22);  --btn-ring: 0 0 0 2px rgba(244,63,94,.35); }
  .btn-sm{ min-height:36px; padding:.45rem .7rem; border-radius:12px; }

  .hero-row{ display:flex; flex-wrap:wrap; gap:.6rem; align-items:center; margin-bottom:.6rem }
  .brand-chip{
    font-weight:800; display:inline-flex; align-items:center; gap:.5rem;
    background:var(--cc-panel); border:1px solid var(--cc-border);
    padding:.5rem .8rem; border-radius:.9rem; box-shadow:var(--cc-shadow);
    color:var(--cc-text);
  }

  .kpi-line{ display:flex; flex-wrap:wrap; gap:.75rem; align-items:center; margin:.35rem 0 1rem }
  .kpi-pill{
    display:inline-flex; align-items:center; gap:.5rem; padding:.45rem .7rem; border-radius:.6rem;
    background:var(--cc-panel-2); border:1px solid var(--cc-border); font-weight:700; min-height:40px;
    color:var(--cc-text);
  }
  .kpi-pill b{ font-weight:800 }

  .filters-wrap{ margin:.25rem 0 .85rem }
  .filters-row{ display:flex; gap:.5rem; align-items:center; flex-wrap:wrap }
  .filters-row input[type="text"], .filters-row select, .filters-row input[type="number"]{
    padding:.5rem .6rem; border-radius:.55rem; border:1px solid var(--cc-border); background:var(--cc-panel); color:var(--cc-text);
    min-height:44px;
  }
  @media (min-width: 992px){ .filters-row{ flex-wrap: nowrap; } }
  .filters-row input[name="q"]{ flex:1 1 420px; min-width:260px; }
  .filters-row .status-inline{ display:inline-flex; align-items:center; gap:.35rem; white-space:nowrap; }
  .filters-right{ margin-left:auto; display:flex; gap:.5rem; align-items:center; flex-wrap:wrap }

  .ticker{ background:var(--cc-panel-2); border:1px solid var(--cc-border); border-radius:14px; padding:12px; color:var(--cc-text) }
  .ticker-row{ display:grid; grid-template-columns:1.2fr 1fr .8fr .8fr .8fr 1fr 1fr; gap:12px; align-items:center }
  .ticker-row > div{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
  .ticker-controls{ display:flex; gap:.4rem; margin-top:.6rem; flex-wrap:wrap }

  #stockTable{
    width:100%; border-collapse:separate; border-spacing:0;
    background:var(--cc-panel); border:1px solid var(--cc-border); border-radius:12px; overflow:hidden; box-shadow:var(--cc-shadow)
  }
  #stockTable thead th{
    position:sticky; top:0; z-index:1; font-weight:700; color:#fff;
    background:var(--cc-accent); letter-spacing:.02em;
  }
  #stockTable th,#stockTable td{ padding:.7rem .75rem; border-bottom:1px solid var(--cc-border); vertical-align:middle }
  #stockTable tbody tr:hover td{ background: color-mix(in oklab, var(--cc-accent) 12%, transparent); color:#0b1220 }
  #stockTable td.num{ text-align:right; font-variant-numeric:tabular-nums }

  .table-mobile{ width:100%; border:1px solid var(--cc-border); border-radius:12px; overflow:hidden; background:var(--cc-panel); box-shadow:var(--cc-shadow) }
  .table-mobile tr{ border-bottom:1px solid var(--cc-border) }
  .table-mobile td{ padding:.6rem .65rem }
  .table-mobile td[data-label]::before{
    content: attr(data-label) " ¬∑ "; color:var(--cc-muted); font-weight:700; margin-right:.25rem;
  }

  .badge-chip{ display:inline-block; padding:.22rem .55rem; border-radius:999px; border:1px solid var(--cc-border); font-weight:700 }
  .badge-chip.green{ background:#ecfdf5; color:#065f46; border-color:#a7f3d0 }
  .badge-chip.red{ background:#fef2f2; color:#991b1b; border-color:#fecaca }

  .charts{ display:grid; grid-template-columns:1.4fr 1fr; gap:14px; margin-top:14px }
  .chart-card{ background:var(--cc-panel-2); border:1px solid var(--cc-border); border-radius:14px; padding:12px; position:relative; overflow:hidden; color:var(--cc-text) }
  .chart-card h3{ margin:.25rem 0 .6rem; font-size:.95rem; color:var(--cc-muted) }
  .chart-toolbar{ display:flex; gap:.5rem; align-items:center; justify-content:flex-end }
  .chart-canvas{ width:100% !important; max-width:100%; height:240px !important }
  .chart-canvas--sm{ height:200px !important }

  .chart-note{ font-size:.9rem; color:var(--cc-muted); padding:.25rem 0; }
  .chart-err{ font-size:.9rem; color:#991b1b; background:#fef2f2; border:1px solid #fecaca; border-radius:8px; padding:.4rem .55rem; }

  .battery-card{ background:var(--cc-panel-2); border:1px solid var(--cc-border); border-radius:14px; padding:12px; margin-top:14px }
  .battery-wrap{ display:flex; align-items:center; gap:1rem; flex-wrap:wrap }
  .battery{ position:relative; width:220px; height:68px; border-radius:14px;
            border:4px solid #cbd5e1; padding:6px; background:linear-gradient(180deg,#ffffff,#f8fafc); }
  .battery:after{ content:""; position:absolute; right:-16px; top:18px; width:14px; height:32px; background:#cbd5e1; border-radius:3px }
  .battery-fill{ height:100%; width:0%; border-radius:10px; transition:width .45s ease; background:linear-gradient(90deg,#22c55e,#06b6d4) }
  .battery-label{ font-weight:800 }
  .battery-hint{ color:var(--cc-muted); font-size:.85rem }

  .cc-fab{
    position:fixed; right:18px;
    bottom: calc(var(--tabbar-h,64px) + var(--safe-bottom, 0px) + 18px);
    width:56px; height:56px; border-radius:28px; display:grid; place-items:center;
    background:var(--cc-accent); color:white; box-shadow:0 10px 24px rgba(2,6,23,.35);
    z-index: 1040;
  }
  .cc-fab:active{ transform: translateY(1px) scale(.98); }
  @media (min-width: 768px){ .cc-fab{ display:none; } }

  @media (max-width: 900px){
    .ticker-row{ grid-template-columns:1fr .9fr .7fr .8fr .8fr .9fr 1fr }
    .charts{ grid-template-columns:1fr }
    .chart-canvas{ height:220px !important }
  }

  /* small action chips */
  .act-chip{ display:inline-flex; align-items:center; gap:.4rem; padding:.35rem .6rem; border-radius:10px; font-weight:700; text-decoration:none; }
  .act-edit{ background:#eef2ff; color:#1e40af; border:1px solid #c7d2fe; }
  .act-price{ background:#f0fdf4; color:#166534; border:1px solid #bbf7d0; }
  .act-del{ background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
  .act-wrap{ display:flex; gap:.4rem; flex-wrap:wrap; }
</style>
{% endblock %}

{% block content %}
<section aria-labelledby="stock">
  {# Safe URL resolutions #}
  {% url 'inventory:stock_list'   as stock_url %}
  {% url 'inventory:export_csv'   as export_csv_url %}
  {% url 'inventory:scan_in'      as scan_in_url %}
  {% url 'inventory:scan_sold'    as scan_sold_url %}
  {% url 'inventory:scan_web'     as scan_web_url %}
  {% url 'inventory:place_order_page' as place_order_url %}
  {% if not place_order_url %}{% url 'inventory:place_order' as place_order_url %}{% endif %}
  {% url 'feedback'               as feedback_url %}
  {% url 'inventory:dashboard'    as dash_url %}
  {% url 'settings' as settings_url %}
  {% url 'inventory:settings' as settings_url2 %}

  <!-- Top: brand + quick actions -->
  <div class="hero-row">
    <button class="glass-btn tap is-primary btn-sm" type="button" data-bs-toggle="offcanvas" data-bs-target="#ccMenu" aria-label="Menu" onclick="window.buzz&&buzz(8)">
      <span class="glass-icon">‚â°</span>
    </button>
    <a href="{{ dash_url|default:'/' }}" class="brand-chip tap" onclick="window.buzz&&buzz(6)"><span class="glass-icon">üìä</span> Circuit City</a>

    <a class="glass-btn is-green tap" href="{{ scan_in_url|default:'#' }}" onclick="window.buzz&&buzz(10)"><span class="glass-icon">‚ûï</span> Stock IN</a>
    <a class="glass-btn is-amber tap" href="{{ scan_sold_url|default:'#' }}" onclick="window.buzz&&buzz(10)"><span class="glass-icon">‚úÖ</span> Scan SOLD</a>
    <a class="glass-btn is-primary tap" href="{{ scan_web_url|default:'#' }}" onclick="window.buzz&&buzz(10)"><span class="glass-icon">üåê</span> Scan (Web)</a>

    {% if place_order_url %}
      {% if IS_MANAGER|default:False or request.user.is_staff or request.user.is_superuser or request.user.profile.is_manager %}
        <a class="glass-btn tap is-amber" href="{{ place_order_url }}" onclick="window.buzz&&buzz(8)"><span class="glass-icon">üßæ</span> Place Order</a>
      {% endif %}
    {% endif %}

    <a class="glass-btn tap is-primary" href="{{ feedback_url|default:'/feedback/' }}" onclick="window.buzz&&buzz(6)"><span class="glass-icon">üí¨</span> Feedback</a>

    <span class="ms-auto d-none d-md-inline text-muted fw-bold">
      {% if request.user.is_authenticated %}<i class="bi bi-person-circle me-1"></i>{{ request.user.username }}{% endif %}
      {% if request.user.is_authenticated %} &nbsp; <a href="/logout/">Logout</a>{% endif %}
    </span>
  </div>

  <!-- KPI quick line -->
  <div class="kpi-line">
    <a href="{{ dash_url|default:'/' }}" class="kpi-pill tap" onclick="window.buzz&&buzz(6)"><i class="bi bi-house-door"></i> Home</a>
    <span class="kpi-pill">In stock: <b>{{ in_stock|default:0|intcomma }}</b></span>
    <span class="kpi-pill">Sold: <b>{{ sold_count|default:0|intcomma }}</b></span>
    <span class="kpi-pill">Sum order: <b>{{ sum_order|default:0|floatformat:0|intcomma }}</b></span>
    <span class="kpi-pill">Sum selling: <b>{{ sum_selling|default:0|floatformat:0|intcomma }}</b></span>
  </div>

  <h2 id="stock" style="margin:.25rem 0 0;color:var(--cc-text)">Stock List</h2>

  <!-- Filters -->
  <div class="filters-wrap">
    <button class="glass-btn tap is-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filtersPanel" aria-expanded="true" onclick="window.buzz&&buzz(8)">
      <span class="glass-icon">‚öôÔ∏è</span> Filters
    </button>

    <div id="filtersPanel" class="collapse show mt-2">
      <form class="filters-row" method="get" action="{{ stock_url|default:'/inventory/list/' }}">
        <input type="hidden" name="view" value="{{ request.GET.view|default:'all' }}">
        <input type="text" name="q" placeholder="Search IMEI/brand/model‚Ä¶" value="{{ q|default:'' }}" inputmode="search" autocomplete="off">

        <label class="status-inline">Status:
          <select name="status">
            <option value="all" {% if status == 'all' or not status %}selected{% endif %}>All</option>
            <option value="in_stock" {% if status == 'in_stock' %}selected{% endif %}>In stock</option>
            <option value="sold" {% if status == 'sold' %}selected{% endif %}>Sold</option>
          </select>
        </label>

        <label class="ms-1">
          <input type="checkbox" name="include_archived" value="1" {% if include_archived %}checked{% endif %}> Include archived
        </label>

        <label>Rows/page:
          <input type="number" name="page_size" min="10" max="200" value="{{ rows_per_page|default:50 }}" inputmode="numeric">
        </label>

        <button class="btn-deep tap is-primary" type="submit" onclick="window.buzz&&buzz(8)">Apply</button>
        <a class="btn-deep tap is-rose"
           href="{{ export_csv_url|default:'/inventory/export/' }}?{% for k,v in request.GET.items %}{% if k != 'export' %}{{k}}={{v|urlencode}}&{% endif %}{% endfor %}export=csv"
           onclick="window.buzz&&buzz(8)">Download CSV</a>

        {% if place_order_url %}
          {% if IS_MANAGER|default:False or request.user.is_staff or request.user.is_superuser or request.user.profile.is_manager %}
            <span class="filters-right">
              <a class="btn-deep tap is-amber" href="{{ place_order_url }}" onclick="window.buzz&&buzz(8)">
                <i class="bi bi-clipboard-plus"></i> Place Order
              </a>
            </span>
          {% endif %}
        {% endif %}
      </form>
    </div>
  </div>

  <!-- ========== Ticker / Preview ========== -->
  <div id="ticker" class="ticker" role="region" aria-live="polite" aria-label="Rotating stock">
    <div class="ticker-row" id="tickerRow">
      <div>IMEI</div><div>Product</div><div>Status</div><div>Order Price</div><div>Selling Price</div><div>Location</div><div>Agent</div>
    </div>
    <div class="ticker-controls">
      <button class="btn-deep tap is-primary btn-sm" id="prevRow" type="button" aria-label="Previous" onclick="window.buzz&&buzz(6)">‚óÄ Prev</button>
      <button class="btn-deep tap is-primary btn-sm" id="nextRow" type="button" aria-label="Next" onclick="window.buzz&&buzz(6)">Next ‚ñ∂</button>
      <a class="btn-deep tap is-green" id="viewAllBtn"
         href="{{ stock_url|default:'/inventory/list/' }}?view=all{% if q %}&q={{ q|urlencode }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if include_archived %}&include_archived=1{% endif %}{% if rows_per_page %}&page_size={{ rows_per_page }}{% endif %}"
         onclick="window.buzz&&buzz(6)">
         View all stock
      </a>
    </div>
  </div>

  <!-- ========== Full Table ========== -->
  <div id="stockTableWrap" {% if request.GET.view == 'all' %}{% else %}hidden{% endif %} class="mt-2">
    <div style="display:flex;justify-content:space-between;align-items:center;margin:.5rem 0 .75rem">
      <div style="font-weight:700;color:var(--cc-muted)">All stock</div>
      <a class="btn-deep tap is-primary" href="{{ request.path }}" onclick="window.buzz&&buzz(6)">Hide table</a>
    </div>

    <div class="table-responsive d-none d-lg-block">
      <table id="stockTable" data-kb-table>
        <thead>
          <tr>
            <th>IMEI</th><th>Product</th><th>Status</th><th>Order Price</th><th>Selling Price</th><th>Location</th><th>Agent</th>
            {% if IS_MANAGER|default:False or request.user.is_staff or request.user.is_superuser or request.user.profile.is_manager %}
              <th style="width:220px">Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% if page_obj %}
            {% for it in page_obj.object_list %}
              <tr>
                <td>{{ it.imei|default:"" }}</td>
                <td>{{ it.product }}</td>
                <td>
                  {% if it.status|lower == 'sold' %}
                    <span class="badge-chip red">Sold</span>
                  {% else %}
                    <span class="badge-chip green">In stock</span>
                  {% endif %}
                </td>
                <td class="num">{% if it.order_price is not None %}{{ it.order_price|floatformat:0|intcomma }}{% else %}‚Äî{% endif %}</td>
                <td class="num">{% if it.selling_price is not None %}{{ it.selling_price|floatformat:0|intcomma }}{% else %}‚Äî{% endif %}</td>
                <td>{% if it.current_location_id %}{{ it.current_location.name }}{% else %}‚Äî{% endif %}</td>
                <td>{% if it.assigned_agent_id %}{{ it.assigned_agent.username }}{% else %}‚Äî{% endif %}</td>
                {% if IS_MANAGER|default:False or request.user.is_staff or request.user.is_superuser or request.user.profile.is_manager %}
                  <td>
                    <div class="act-wrap">
                      {# Edit (full edit screen) #}
                      <a class="act-chip act-edit tap" href="/inventory/stock/{{ it.id }}/edit/" title="Edit">
                        <i class="bi bi-pencil-square"></i> Edit
                      </a>

                      {# Edit Price (same edit page, hint tab=price) #}
                      <a class="act-chip act-price tap" href="/inventory/stock/{{ it.id }}/edit/?tab=price" title="Edit Price">
                        <i class="bi bi-currency-exchange"></i> Edit Price
                      </a>

                      {# Delete only when NOT sold #}
                      {% if it.status|lower != 'sold' %}
                        <form method="post" action="/inventory/stock/{{ it.id }}/delete/" onsubmit="return confirm('Delete this in-stock item permanently?');" style="display:inline">
                          {% csrf_token %}
                          <button type="submit" class="act-chip act-del tap">
                            <i class="bi bi-trash"></i> Delete
                          </button>
                        </form>
                      {% endif %}
                    </div>
                  </td>
                {% endif %}
              </tr>
            {% empty %}
              <tr><td colspan="{% if IS_MANAGER|default:False or request.user.is_staff or request.user.is_superuser or request.user.profile.is_manager %}8{% else %}7{% endif %}" style="text-align:center;color:var(--cc-muted)">
                No stock yet. <a href="{{ scan_in_url|default:'#' }}" class="ms-1">Scan IN your first item ‚Üí</a>
              </td></tr>
            {% endfor %}
          {% else %}
            {% for row in rows %}
            <tr>
              <td>{{ row.imei }}</td>
              <td>{{ row.product }}</td>
              <td>
                {% if row.status|lower == 'sold' %}
                  <span class="badge-chip red">Sold</span>
                {% else %}
                  <span class="badge-chip green">In stock</span>
                {% endif %}
              </td>
              <td class="num">{{ row.order_price }}</td>
              <td class="num">{{ row.selling_price|default:"‚Äî" }}</td>
              <td>{{ row.location }}</td>
              <td>{{ row.agent }}</td>
              {# Fallback rows have no guaranteed id ‚Üí omit actions to avoid 500s #}
              {% if IS_MANAGER|default:False or request.user.is_staff or request.user.is_superuser or request.user.profile.is_manager %}
                <td>
                  <div class="text-muted">‚Äî</div>
                </td>
              {% endif %}
            </tr>
            {% empty %}
            <tr>
              <td colspan="{% if IS_MANAGER|default:False or request.user.is_staff or request.user.is_superuser or request.user.profile.is_manager %}8{% else %}7{% endif %}" style="text-align:center;color:var(--cc-muted)">
                No stock yet. <a href="{{ scan_in_url|default:'#' }}" class="ms-1">Scan IN your first item ‚Üí</a>
              </td>
            </tr>
            {% endfor %}
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- Mobile table -->
    <div class="d-lg-none" style="margin-top:8px">
      <table class="table-mobile">
        <tbody>
          {% if page_obj %}
            {% for it in page_obj.object_list %}
            <tr>
              <td data-label="IMEI">{{ it.imei|default:"" }}</td>
              <td data-label="Product">{{ it.product }}</td>
              <td data-label="Status">
                {% if it.status|lower == 'sold' %}
                  <span class="badge-chip red">Sold</span>
                {% else %}
                  <span class="badge-chip green">In stock</span>
                {% endif %}
              </td>
              <td data-label="Order Price" class="num">{% if it.order_price is not None %}{{ it.order_price|floatformat:0|intcomma }}{% else %}‚Äî{% endif %}</td>
              <td data-label="Selling Price" class="num">{% if it.selling_price is not None %}{{ it.selling_price|floatformat:0|intcomma }}{% else %}‚Äî{% endif %}</td>
              <td data-label="Location">{% if it.current_location_id %}{{ it.current_location.name }}{% else %}‚Äî{% endif %}</td>
              <td data-label="Agent">{% if it.assigned_agent_id %}{{ it.assigned_agent.username }}{% else %}‚Äî{% endif %}</td>
              {% if IS_MANAGER|default:False or request.user.is_staff or request.user.is_superuser or request.user.profile.is_manager %}
                <td data-label="Actions">
                  <div class="act-wrap">
                    <a class="act-chip act-edit tap" href="/inventory/stock/{{ it.id }}/edit/" title="Edit">
                      <i class="bi bi-pencil-square"></i> Edit
                    </a>
                    <a class="act-chip act-price tap" href="/inventory/stock/{{ it.id }}/edit/?tab=price" title="Edit Price">
                      <i class="bi bi-currency-exchange"></i> Edit Price
                    </a>
                    {% if it.status|lower != 'sold' %}
                      <form method="post" action="/inventory/stock/{{ it.id }}/delete/" onsubmit="return confirm('Delete this in-stock item permanently?');" style="display:inline">
                        {% csrf_token %}
                        <button type="submit" class="act-chip act-del tap">
                          <i class="bi bi-trash"></i> Delete
                        </button>
                      </form>
                    {% endif %}
                  </div>
                </td>
              {% endif %}
            </tr>
            {% endfor %}
          {% else %}
            {% for row in rows %}
            <tr>
              <td data-label="IMEI">{{ row.imei }}</td>
              <td data-label="Product">{{ row.product }}</td>
              <td data-label="Status">
                {% if row.status|lower == 'sold' %}
                  <span class="badge-chip red">Sold</span>
                {% else %}
                  <span class="badge-chip green">In stock</span>
                {% endif %}
              </td>
              <td data-label="Order Price" class="num">{{ row.order_price }}</td>
              <td data-label="Selling Price" class="num">{{ row.selling_price|default:"‚Äî" }}</td>
              <td data-label="Location">{{ row.location }}</td>
              <td data-label="Agent">{{ row.agent }}</td>
              {% if IS_MANAGER|default:False or request.user.is_staff or request.user.is_superuser or request.user.profile.is_manager %}
                <td data-label="Actions"><div class="text-muted">‚Äî</div></td>
              {% endif %}
            </tr>
            {% endfor %}
          {% endif %}
        </tbody>
      </table>
    </div>

    {% if page_obj %}
      <nav class="mt-2" style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap">
        {% if page_obj.has_previous %}
          <a class="btn-deep tap is-primary" href="{{ stock_url|default:'/inventory/list/' }}?view=all{% if q %}&q={{ q|urlencode }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if include_archived %}&include_archived=1{% endif %}{% if rows_per_page %}&page_size={{ rows_per_page }}{% endif %}&page={{ page_obj.previous_page_number }}" onclick="window.buzz&&buzz(6)">Prev</a>
        {% endif %}
        <span class="text-muted">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
          <a class="btn-deep tap is-primary" href="{{ stock_url|default:'/inventory/list/' }}?view=all{% if q %}&q={{ q|urlencode }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if include_archived %}&include_archived=1{% endif %}{% if rows_per_page %}&page_size={{ rows_per_page }}{% endif %}&page={{ page_obj.next_page_number }}" onclick="window.buzz&&buzz(6)">Next</a>
        {% endif %}
      </nav>
    {% endif %}
  </div>

  <!-- Charts -->
  <div class="charts">
    <div class="chart-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Sales trend (daily)</h3>
        <div class="chart-toolbar">
          <label for="invTrendPeriod" class="visually-hidden">Period</label>
          <select id="invTrendPeriod" class="input">
            <option value="month" selected>This month</option>
            <option value="7d">Last 7 days</option>
          </select>
          <label for="invTrendMetric" class="visually-hidden">Metric</label>
          <select id="invTrendMetric" class="input">
            <option value="amount" selected>Amount</option>
            <option value="count">Count</option>
          </select>
        </div>
      </div>
      <div>
        <canvas id="invSalesTrend" class="chart-canvas" aria-label="Sales trend line chart" role="img"></canvas>
        <div id="invSalesEmpty" class="chart-note d-none">No data</div>
        <div id="invSalesErr" class="chart-err d-none"></div>
      </div>
    </div>

    <div class="chart-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Top models</h3>
        <div class="chart-toolbar">
          <label for="invTopPeriod" class="visually-hidden">Period</label>
          <select id="invTopPeriod" class="input">
            <option value="today" selected>Today</option>
            <option value="month">This month</option>
          </select>
        </div>
      </div>
      <div>
        <canvas id="invTopModels" class="chart-canvas chart-canvas--sm" aria-label="Top models chart" role="img"></canvas>
        <div id="invTopEmpty" class="chart-note d-none">No data</div>
        <div id="invTopErr" class="chart-err d-none"></div>
      </div>
    </div>
  </div>

  <!-- Stock Battery -->
  <div class="battery-card">
    <h3 style="margin:.25rem 0 .6rem;color:var(--cc-muted)">Stock health</h3>
    <div class="battery-wrap">
      <div class="battery">
        <div id="batteryFill" class="battery-fill"></div>
      </div>
      <div>
        <div id="batteryLabel" class="battery-label"></div>
        <div class="battery-hint">100 = full, ‚â§20 = critical</div>
      </div>
    </div>
  </div>
</section>

<!-- Offcanvas Menu -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="ccMenu" aria-labelledby="ccMenuLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="ccMenuLabel">Menu</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <h6 class="text-muted">Control Center</h6>
    <div class="list-group mb-3">
      <a class="list-group-item list-group-item-action" href="{{ dash_url|default:'/' }}"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a>
      <a class="list-group-item list-group-item-action" href="{{ stock_url|default:'/inventory/list/' }}"><i class="bi bi-list me-2"></i> Inventory</a>
      {% url 'inventory:time_checkin_page' as time_in %}
      {% if time_in %}<a class="list-group-item list-group-item-action" href="{{ time_in }}"><i class="bi bi-stopwatch me-2"></i> Time Check-in</a>{% endif %}
      {% url 'inventory:time_logs' as time_logs %}
      {% if time_logs %}<a class="list-group-item list-group-item-action" href="{{ time_logs }}"><i class="bi bi-clock-history me-2"></i> Time Logs</a>{% endif %}
      {% url 'feedback' as feedback %}
      {% if feedback %}<a class="list-group-item list-group-item-action" href="{{ feedback }}"><i class="bi bi-chat-dots me-2"></i> Feedback</a>{% endif %}
      {% url 'settings' as oc_settings_url %}
      {% url 'inventory:settings' as oc_settings_url2 %}
      <a class="list-group-item list-group-item-action" href="{{ oc_settings_url|default:oc_settings_url2|default:'/settings/' }}">
        <i class="bi bi-sliders me-2"></i> Settings
      </a>
    </div>

    {% if IS_MANAGER|default:False or request.user.is_staff or request.user.is_superuser or request.user.profile.is_manager %}
      <h6 class="text-muted">Admin</h6>
      <div class="list-group">
        {% url 'inventory:place_order_page' as place_order_url %}
        {% if not place_order_url %}{% url 'inventory:place_order' as place_order_url %}{% endif %}
        {% if place_order_url %}<a class="list-group-item list-group-item-action" href="{{ place_order_url }}"><i class="bi bi-receipt-cutoff me-2"></i> Place Order</a>{% endif %}
        {% if request.user.is_staff or request.user.is_superuser %}
          <a class="list-group-item list-group-item-action" href="/admin/"><i class="bi bi-gear me-2"></i> Django Admin</a>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>

<!-- Mobile FAB -->
<a href="{{ scan_web_url|default:scan_sold_url|default:'/inventory/scan-sold/' }}" class="cc-fab" onclick="window.buzz&&buzz(10)" aria-label="Scan">
  <i class="bi bi-upc-scan fs-4"></i>
</a>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
(function(){
  const params   = new URLSearchParams(location.search);
  const showAll  = params.get('view') === 'all';
  const tableWrap= document.getElementById('stockTableWrap');
  const ticker   = document.getElementById('ticker');
  if (showAll){ tableWrap.hidden = false; ticker.hidden = true; }

  // Build ticker data from table
  const tbody = document.querySelector('#stockTable tbody');
  const rows  = Array.from((tbody || {}).rows || []).map(tr => {
    const td = tr.querySelectorAll('td');
    return {
      imei: (td[0]?.textContent || '').trim(),
      product: (td[1]?.textContent || '').trim(),
      status: (td[2]?.textContent || '').trim(),
      order_price: (td[3]?.textContent || '').trim(),
      selling_price: (td[4]?.textContent || '').trim(),
      location: (td[5]?.textContent || '').trim(),
      agent: (td[6]?.textContent || '').trim()
    };
  });

  const tickerRow = document.getElementById('tickerRow');
  function renderTicker(i){
    if (!rows.length) {
      tickerRow.innerHTML = '<div style="grid-column:1/-1;color:var(--cc-muted)">No stock yet</div>';
      return;
    }
    const r = rows[i % rows.length];
    tickerRow.innerHTML = `
      <div title="${r.imei}">${r.imei}</div>
      <div title="${r.product}">${r.product}</div>
      <div>${r.status}</div>
      <div class="num">${r.order_price}</div>
      <div class="num">${r.selling_price || '‚Äî'}</div>
      <div>${r.location}</div>
      <div>${r.agent}</div>
    `;
  }
  let idx = 0;
  renderTicker(idx);
  document.getElementById('nextRow')?.addEventListener('click', ()=>{ idx = (idx+1) % (rows.length||1); renderTicker(idx); });
  document.getElementById('prevRow')?.addEventListener('click', ()=>{ idx = (idx-1+rows.length) % (rows.length||1); renderTicker(idx); });
  setInterval(()=>{ idx = (idx+1) % (rows.length || 1); renderTicker(idx); }, 5000);

  // Helper for battery (JSON-first fetch with fallbacks)
  async function fetchFirstOk(urls, query){
    for (const u of urls){
      try{
        const r = await fetch(u + (query||''), {headers:{Accept:'application/json'}});
        if (r.ok) return await r.json();
      }catch(e){}
    }
    return null;
  }

  // Battery
  const STATIC_INSTOCK = Number({{ in_stock|default:0 }});
  const STATIC_TARGET  = Number({{ target_full|default:100 }});
  const HEATMAP_ENDPOINTS = [
    '/inventory/api/restock-heatmap/','/inventory/restock_heatmap_api/','/inventory/restock-heatmap/','/inventory/api/restock_heatmap/'
  ];

  async function loadBattery(){
    const fill  = document.getElementById('batteryFill');
    const label = document.getElementById('batteryLabel');
    if (!fill || !label) return;

    const hm = await fetchFirstOk(HEATMAP_ENDPOINTS, '');
    let pct = 0, on_hand = STATIC_INSTOCK;

    if (hm && typeof hm.battery_pct !== 'undefined'){
      pct = Math.max(0, Math.min(100, Math.round(Number(hm.battery_pct)||0)));
      on_hand = Number(hm.battery_count||STATIC_INSTOCK)||0;
    } else {
      pct = STATIC_TARGET ? Math.max(0, Math.min(100, Math.round((STATIC_INSTOCK/STATIC_TARGET)*100))) : 0;
    }

    fill.style.width = pct + '%';
    if (pct <= 20){ fill.style.background = 'linear-gradient(90deg,#ef4444,#dc2626)'; label.textContent = `${on_hand} in stock ‚Ä¢ ${pct}% ‚Ä¢ Critical`; }
    else if (pct <= 50){ fill.style.background = 'linear-gradient(90deg,#f59e0b,#d97706)'; label.textContent = `${on_hand} in stock ‚Ä¢ ${pct}% ‚Ä¢ Low`; }
    else { fill.style.background = 'linear-gradient(90deg,#22c55e,#06b6d4)'; label.textContent = `${on_hand} in stock ‚Ä¢ ${pct}% ‚Ä¢ OK`; }
  }
  loadBattery();
})();
</script>

{# ===== Charts JS aligned to stock_list.js ===== #}
<script>
/* ---------- Helpers ---------- */
const nf = new Intl.NumberFormat();

const $id   = (id)=>document.getElementById(id);
const show  = (id)=>$id(id)?.classList.remove('d-none');
const hide  = (id)=>$id(id)?.classList.add('d-none');
const cssVar=(name, fb)=> (getComputedStyle(document.documentElement).getPropertyValue(name).trim() || fb);

const GRID_CLR = ()=> cssVar('--chart-grid', '#d8e3ff');
const BRAND    = ()=> cssVar('--cc-accent', '#3b82f6');

/* JSON fetch with legacy fallbacks (so it never returns the login HTML) */
async function fetchJSON(url, {legacy=[]}={}){
  const doFetch = (u)=> fetch(u, {credentials:'same-origin', headers:{Accept:'application/json'}});
  const tryOnce = async (u)=>{
    const r = await doFetch(u);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const ct = (r.headers.get('content-type') || '').toLowerCase();
    if (!ct.includes('application/json')) throw new Error('Not JSON');
    return r.json();
  };
  try { return await tryOnce(url); }
  catch (e) {
    for (const alt of legacy) {
      try { return await tryOnce(alt); } catch(_) {}
    }
    throw e;
  }
}

/* Axis utilities */
function chooseMoneyStep(max){
  const choices = [100000,200000,250000,500000,1000000,2000000,5000000];
  for (const s of choices) if (max / s <= 6) return s;
  return Math.pow(10, Math.max(2, Math.ceil(Math.log10(max||1))-1));
}
function axisMoney(values){
  const m = Math.max(0, ...(values||[0]));
  const step = chooseMoneyStep(m || 100000);
  const niceMax = Math.max(step*2, Math.ceil((m || step*1.5)/step)*step);
  return {min:0, max:niceMax, stepSize:step};
}
function axisCount(values){
  const m = Math.max(0, ...(values||[0]));
  const nice = Math.max(1, Math.ceil(m));
  return {min:0, max:Math.max(1, nice), stepSize:1};
}

/* ---------- Sales Trend (left card) ---------- */
let invSalesChart = null;

async function loadInvSalesTrend(){
  const periodSel = $id('invTrendPeriod');
  const metricSel = $id('invTrendMetric');
  if (!periodSel || !metricSel) return;

  hide('invSalesEmpty'); hide('invSalesErr');

  const period = periodSel.value;           // '7d' | 'month'
  let metric   = metricSel.value;           // 'count' | 'amount'

  const getData = (m)=> fetchJSON(
    `/inventory/api/sales-trend/?period=${encodeURIComponent(period)}&metric=${encodeURIComponent(m)}`,
    { legacy:[`/inventory/api_sales_trend/?period=${encodeURIComponent(period)}&metric=${encodeURIComponent(m)}`] }
  );

  let resp;
  try { resp = await getData(metric); }
  catch (e) { show('invSalesErr'); $id('invSalesErr').textContent = `Sales trend error: ${e.message}`; return; }

  let labels = resp?.labels || [];
  let values = (resp?.values || []).map(v=>Number(v)||0);
  const isAmount = (metric === 'amount');
  const sign     = isAmount ? (resp?.currency?.sign || 'MK') : '';

  // if amount is all zero, automatically switch to count
  if (isAmount && labels.length && values.every(v=>v===0)) {
    try {
      const alt = await getData('count');
      const altVals = (alt?.values||[]).map(v=>Number(v)||0);
      if (alt?.labels?.length && altVals.some(v=>v>0)) {
        labels = alt.labels; values = altVals;
        metric = 'count'; metricSel.value = 'count';
      }
    } catch {}
  }

  const el = $id('invSalesTrend');
  invSalesChart?.destroy();

  if (!labels.length || values.every(v=>v===0)) { show('invSalesEmpty'); return; }

  const yCfg = (metric==='count') ? axisCount(values) : axisMoney(values);
  const blue = BRAND();

  invSalesChart = new Chart(el, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: metric==='count' ? 'Sales (count)' : `Sales (${sign})`,
        data: values,
        borderColor: blue,
        backgroundColor: blue + '20',
        fill: true,
        pointRadius: 2,
        tension: .35
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display:false } },
      animation: { duration: 500, easing: 'easeOutCubic' },
      scales: {
        x: {
          type: 'category',
          grid: { color: GRID_CLR() },
          ticks: { autoSkip:false, maxRotation:0 }
        },
        y: {
          min: yCfg.min, max: yCfg.max,
          grid: { color: GRID_CLR() },
          ticks: {
            stepSize: yCfg.stepSize,
            callback: (v)=> metric==='count' ? v : `${sign} ${nf.format(v)}`
          }
        }
      }
    }
  });
}

/* ---------- Top Models (right card) ---------- */
let invTopChart = null;

async function loadInvTopModels(){
  const pSel = $id('invTopPeriod');
  if (!pSel) return;

  hide('invTopEmpty'); hide('invTopErr');

  const period = pSel.value; // 'today' | 'month'
  let data;
  try {
    data = await fetchJSON(`/inventory/api/top-models/?period=${encodeURIComponent(period)}`,
            { legacy:[`/inventory/api_top_models/?period=${encodeURIComponent(period)}`] });
  } catch (e) {
    show('invTopErr'); $id('invTopErr').textContent = `Top models error: ${e.message}`;
    return;
  }

  const labels = data?.labels || [];
  const values = (data?.values || []).map(v=>Number(v)||0);

  invTopChart?.destroy();
  const el = $id('invTopModels');

  if (!labels.length || values.every(v=>v===0)) { show('invTopEmpty'); return; }

  const y = axisCount(values);
  const blue = BRAND();

  invTopChart = new Chart(el, {
    type: 'bar',
    data: { labels, datasets: [{ label:'Units', data:values, backgroundColor:blue, borderColor:blue }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display:false } },
      animation: { duration: 500, easing: 'easeOutCubic' },
      scales: {
        x: { type:'category', grid:{ display:false }, ticks:{ autoSkip:false, maxRotation:0 } },
        y: { min:y.min, max:y.max, grid:{ color:GRID_CLR() }, ticks:{ stepSize:y.stepSize } }
      }
    }
  });
}

/* ---------- Wire up ---------- */
$id('invTrendPeriod')?.addEventListener('change', loadInvSalesTrend);
$id('invTrendMetric')?.addEventListener('change', loadInvSalesTrend);
$id('invTopPeriod')?.addEventListener('change', loadInvTopModels);

(async function initList(){
  await Promise.allSettled([loadInvSalesTrend(), loadInvTopModels()]);
})();
</script>

{# Toast/messages #}
<script>
(function(){
  {% if messages %}
    {% for message in messages %}
      (window.CCToast?.show ? CCToast.show({
        type: '{% if "error" in message.tags or "danger" in message.tags %}danger{% elif "success" in message.tags %}success{% elif "warning" in message.tags %}warning{% else %}info{% endif %}',
        title: 'Inventory',
        body: "{{ message|escapejs }}"
      }) : window.pushNote?.({
        type: '{% if "error" in message.tags or "danger" in message.tags %}danger{% elif "success" in message.tags %}success{% elif "warning" in message.tags %}warn{% else %}info{% endif %}',
        title: 'Inventory',
        body: "{{ message|escapejs }}",
        dot: true
      }));
    {% endfor %}
  {% endif %}
})();
</script>
{% endblock %}
