{% extends "base.html" %}
{% block title %}Scan Sold ¬∑ Circuit City{% endblock %}

{% block extra_css %}
<style>
  /* ===== Layout helpers ===== */
  .page{margin:0 auto;max-width:1120px;padding:clamp(12px,4vw,24px)}
  .vstack{display:flex;flex-direction:column;gap:.75rem}
  .hstack{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}

  /* ===== Theme-aware tokens (fallbacks if tokens.css not loaded) ===== */
  :root{
    --bg: var(--bg, #ffffff);
    --fg: var(--fg, #0f172a);
    --border: var(--border, #e2e8f0);
    --card: var(--card, #ffffff);
    --accent: var(--accent, #2563eb);
    --onAccent: var(--onAccent, #ffffff);
    --scanline: #00ff5a; /* neon green */
  }
  body{background:var(--bg);color:var(--fg)}

  /* ===== Cards & fields ===== */
  .card{
    background:var(--card);color:var(--fg);
    border:1px solid var(--border);border-radius:16px;padding:1.25rem;
  }
  .row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
  @media (max-width: 640px){ .row{grid-template-columns:1fr} }
  .field{position:relative;background:var(--card);border:1px solid var(--border);border-radius:12px;display:flex;align-items:center}
  .field > input,.field > select,.field > .form-control{
    flex:1;background:transparent;color:var(--fg);border:0;padding:12px 14px;outline:none;font-size:16px;min-height:44px;width:100%;
  }
  label{font-weight:600;margin-bottom:.35rem;display:block}

  /* ===== Buttons ===== */
  .btn{
    appearance:none;border:1px solid var(--border);background:var(--card);color:var(--fg);
    border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600;font-size:14px;min-height:44px;text-decoration:none;display:inline-flex;align-items:center;gap:.4rem;
  }
  .btn:hover{filter:brightness(1.05)}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn-primary{background:var(--accent);color:var(--onAccent);border-color:transparent}
  .btn-secondary{background:var(--card)}
  .btn-muted{background:rgba(148,163,184,.18)}

  /* ===== Alerts (messages) ===== */
  .alert{margin:.5rem 0;padding:.75rem 1rem;border-radius:.75rem;border:1px solid var(--border)}
  .alert-ok{background:rgba(59,130,246,.08)}
  .alert-err{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.5)}

  /* ===== Hints & text bits ===== */
  .hint{font-size:.9rem;opacity:.8}
  .error-text{color:#ef4444;font-size:.95rem;margin-top:.25rem}

  /* ===== Modal ===== */
  #scanModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999}
  #scanModal .modal-card{width:min(95vw,700px);padding:0;overflow:hidden;border-radius:16px}
  #scanModal header, #scanModal footer{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-color:var(--border);border-style:solid}
  #scanModal header{border-width:0 0 1px 0;background:var(--card)}
  #scanModal footer{border-width:1px 0 0 0;background:var(--card)}

  /* Camera shell with animated scanline */
  .cam-shell{position:relative;background:#000}
  #scanVideo{width:100%;height:auto;display:block;background:#000}

  .scan-overlay{position:absolute;inset:0;pointer-events:none}
  .scan-frame{
    position:absolute; inset:10% 8%;
    border:2px solid rgba(255,255,255,.25);
    border-radius:12px;
    box-shadow: inset 0 0 0 9999px rgba(0,0,0,.20);
  }
  .scanline{
    position:absolute; left:8%; right:8%; height:2px; border-radius:2px;
    background:linear-gradient(90deg, transparent, var(--scanline), transparent);
    box-shadow:0 0 10px var(--scanline), 0 0 20px rgba(0,255,90,.6);
    animation: sweep 2.0s linear infinite alternate;
  }
  .scanline.paused{ animation-play-state: paused; }
  @keyframes sweep { from { top: 10%; } to { top: 90%; } }
</style>
{% endblock %}

{% block body %}
{% include "_topbar.html" %}
<main class="page vstack">
  <section class="card vstack" aria-labelledby="sell">
    <h1 id="sell" style="margin:0">Mark Item as SOLD</h1>

    {# Flash messages #}
    {% if messages %}
      {% for message in messages %}
        <div class="alert {% if message.tags == 'error' %}alert-err{% else %}alert-ok{% endif %}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    {# Non-field errors #}
    {% if form.non_field_errors %}
      <div class="alert alert-err">{{ form.non_field_errors }}</div>
    {% endif %}

    <form method="post" novalidate class="vstack" autocomplete="off" style="gap:1rem">
      {% csrf_token %}

      <!-- IMEI -->
      <div>
        <label for="{{ form.imei.id_for_label }}">IMEI / Barcode</label>
        <div class="field">{{ form.imei }}</div>
        <div class="hstack" style="margin-top:.5rem">
          <button class="btn" type="button" id="btnOpenScanner">üì∑ Scan with camera</button>
          <button class="btn" type="button" id="btnPaste">üìã Paste</button>
          <button class="btn btn-muted" type="button" id="btnClear">‚úñ Clear</button>
          <label class="hint" style="display:inline-flex;align-items:center;gap:.4rem;margin-left:auto">
            <input type="checkbox" id="autoSubmit" /> Auto-submit on valid IMEI
          </label>
        </div>
        <div id="imeiHint" class="hint" style="margin-top:.35rem">
          Tip: You can type, paste, or scan. IMEI must be exactly 15 digits. Press <kbd>Enter</kbd> to submit.
        </div>
        {% if form.imei.errors %}<div class="error-text">{{ form.imei.errors|striptags }}</div>{% endif %}
      </div>

      <!-- Sold date / Price -->
      <div class="row">
        <div>
          <label for="{{ form.sold_at.id_for_label }}">Sold date</label>
          <div class="field">{{ form.sold_at }}</div>
          {% if form.sold_at.errors %}<div class="error-text">{{ form.sold_at.errors|striptags }}</div>{% endif %}
        </div>

        <div>
          <label for="{{ form.price.id_for_label }}">Price</label>
          <div class="field">{{ form.price }}</div>
          {% if form.price.errors %}<div class="error-text">{{ form.price.errors|striptags }}</div>{% endif %}
        </div>
      </div>

      <!-- Commission / Location -->
      <div class="row">
        <div>
          <label for="{{ form.commission_pct.id_for_label }}">Commission %</label>
          <div class="field">{{ form.commission_pct }}</div>
          {% if form.commission_pct.errors %}<div class="error-text">{{ form.commission_pct.errors|striptags }}</div>{% endif %}
        </div>

        <div>
          <label for="{{ form.location.id_for_label }}">Location</label>
          <div class="field">{{ form.location }}</div>
          {% if form.location.errors %}<div class="error-text">{{ form.location.errors|striptags }}</div>{% endif %}
        </div>
      </div>

      <!-- Actions -->
      <div class="hstack">
        <button class="btn btn-primary" type="submit">Mark as SOLD</button>
        <a class="btn" href="{% url 'inventory:stock_list' %}">Stock list</a>
        <a class="btn" href="{% url 'inventory:scan_in' %}">‚Üê Back to Scan In</a>
      </div>
    </form>
  </section>
</main>

<!-- Scanner Modal -->
<div id="scanModal" role="dialog" aria-modal="true" aria-labelledby="scanDialogTitle">
  <div class="card modal-card">
    <header>
      <strong id="scanDialogTitle">Scan barcode</strong>
      <button class="btn" id="btnCloseScanner" type="button" aria-label="Close scanner">Close</button>
    </header>

    <!-- Camera shell with overlay -->
    <div class="cam-shell">
      <video id="scanVideo" playsinline></video>
      <div class="scan-overlay" aria-hidden="true">
        <div class="scan-frame"></div>
        <div class="scanline" id="scanline"></div>
      </div>
    </div>

    <footer class="hstack">
      <button class="btn" id="btnSwapCamera" type="button">üîÅ Switch camera</button>
      <span id="scanStatus" class="hint">Align barcode within the frame‚Ä¶</span>
    </footer>
  </div>
</div>

<!-- Quagga2 (barcode scanner) -->
<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.js"></script>
<script>
  // Ensure theme-friendly input class if your widgets don't render with it
  (function ensureInputClasses() {
    const ids = ["id_imei","id_sold_at","id_price","id_commission_pct","id_location"];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el && !el.classList.contains("input")) el.classList.add("input");
    });
  })();

  const formEl    = document.querySelector("form[novalidate]");
  const imeiInput = document.getElementById("id_imei");
  const priceEl   = document.getElementById("id_price");
  const locEl     = document.getElementById("id_location");
  const autoBox   = document.getElementById("autoSubmit");

  // Utility
  const onlyDigits = (s) => (s||"").replace(/\D+/g,"");
  const looksLikeImei = (s) => /^\d{15}$/.test(onlyDigits(s||""));

  function setImei(val){
    const digits = onlyDigits(val).slice(0,15);
    if (imeiInput){
      imeiInput.value = digits;
      imeiInput.setCustomValidity(digits.length === 15 ? "" : "IMEI must be exactly 15 digits.");
    }
    maybeAutoSubmit();
  }

  function readyToSubmit(){
    const imeiOk = imeiInput && looksLikeImei(imeiInput.value);
    const locOk  = !!(locEl && locEl.value);
    return imeiOk && locOk; // server will re-validate everything
  }

  function maybeAutoSubmit(){
    if (autoBox && autoBox.checked && readyToSubmit() && formEl){
      formEl.submit();
    }
  }

  // IMEI normalization & keyboard helpers
  if (imeiInput){
    try{
      imeiInput.setAttribute("inputmode","numeric");
      imeiInput.setAttribute("maxlength","15");
      imeiInput.setAttribute("autocomplete","off");
    }catch(_){}

    const cap15 = (e)=> setImei(e.target.value);
    imeiInput.addEventListener("input", cap15);
    imeiInput.addEventListener("blur", cap15);
    imeiInput.addEventListener("keydown", (e)=>{
      if (e.key === "Enter"){ e.preventDefault(); if (readyToSubmit()) formEl.submit(); }
    });
    // initial cleanup
    setImei(imeiInput.value || "");
  }

  // Global shortcuts
  document.addEventListener("keydown", (e)=>{
    if (e.key === "F2"){ e.preventDefault(); imeiInput && imeiInput.focus(); }
    if (e.key === "Escape" && scanModal.style.display === "flex"){ e.preventDefault(); closeScanner(); }
  });
  window.addEventListener("load", ()=>{ if (imeiInput){ imeiInput.focus(); } });

  // Paste / Clear
  const btnPaste = document.getElementById("btnPaste");
  const btnClear = document.getElementById("btnClear");
  btnPaste && (btnPaste.onclick = async () => {
    try{
      const txt = await navigator.clipboard.readText();
      setImei(txt);
    }catch{
      alert("Clipboard access is blocked by the browser.");
      imeiInput && imeiInput.focus();
    }
  });
  btnClear && (btnClear.onclick = () => setImei(""));

  // Modal + Quagga2
  const scanModal = document.getElementById("scanModal");
  const btnOpen   = document.getElementById("btnOpenScanner");
  const btnClose  = document.getElementById("btnCloseScanner");
  const btnSwap   = document.getElementById("btnSwapCamera");
  const statusEl  = document.getElementById("scanStatus");
  const videoEl   = document.getElementById("scanVideo");
  const scanLine  = document.getElementById("scanline");

  let currentDeviceId = null;
  let devices = [];
  let quaggaActive = false;

  btnOpen && btnOpen.addEventListener("click", openScanner);
  btnClose && btnClose.addEventListener("click", closeScanner);
  btnSwap  && btnSwap.addEventListener("click", async () => {
    if (!devices.length) return;
    const idx = devices.findIndex(d => d.deviceId === currentDeviceId);
    const next = devices[(idx + 1) % devices.length];
    currentDeviceId = next.deviceId;
    await startQuagga();
  });

  function pauseScanline(ms=900){
    if(!scanLine) return;
    scanLine.classList.add('paused');
    setTimeout(()=> scanLine.classList.remove('paused'), ms);
  }

  async function openScanner(){
    scanModal.style.display = "flex";
    statusEl.textContent = "Starting camera‚Ä¶";
    await initDevices();
    await startQuagga();
  }

  async function closeScanner(){
    scanModal.style.display = "none";
    try{ Quagga.stop(); quaggaActive = false; }catch(e){}
  }

  async function initDevices(){
    try{
      const all = await navigator.mediaDevices.enumerateDevices();
      devices = all.filter(d => d.kind === "videoinput");
      if (!devices.length){ statusEl.textContent = "No camera found (permissions/HTTPS)."; return; }
      const back = devices.find(d => /back|rear|environment/i.test(d.label));
      currentDeviceId = (back || devices[0]).deviceId;
    }catch{
      statusEl.textContent = "Could not enumerate cameras (permissions?).";
    }
  }

  async function startQuagga(){
    try{ Quagga.stop(); }catch(e){}
    const constraints = {
      width: { ideal: 1280 },
      height: { ideal: 720 },
      facingMode: "environment",
      deviceId: currentDeviceId ? { exact: currentDeviceId } : undefined
    };
    Quagga.init({
      inputStream: {
        type: "LiveStream",
        target: videoEl,
        constraints
      },
      locator: { patchSize: "medium", halfSample: true },
      numOfWorkers: navigator.hardwareConcurrency ? Math.min(navigator.hardwareConcurrency, 4) : 2,
      frequency: 10,
      decoder: { readers: ["code_128_reader","ean_reader","ean_8_reader","upc_reader","upc_e_reader"] }
    }, (err) => {
      if (err){ statusEl.textContent = "Camera error: " + err; return; }
      Quagga.start(); quaggaActive = true;
      statusEl.textContent = "Align barcode within the frame‚Ä¶";
      Quagga.offDetected(handleDetected);
      Quagga.onDetected(handleDetected);
    });
  }

  function handleDetected(result){
    if(!quaggaActive) return;
    const code = (result && result.codeResult && result.codeResult.code) || "";
    if (!code) return;
    const digits = onlyDigits(code).slice(0,15);
    if (!digits) return;

    setImei(digits);
    statusEl.textContent = "Scanned: " + digits;
    pauseScanline(); // pause the green sweep briefly on success

    // Auto-submit if enabled and form is ready; else close and focus Price for quick entry
    if (autoBox && autoBox.checked && readyToSubmit()){
      try{ Quagga.stop(); quaggaActive=false; }catch(e){}
      scanModal.style.display = "none";
      formEl.submit();
    }else{
      setTimeout(() => {
        try{ Quagga.stop(); quaggaActive=false; }catch(e){}
        scanModal.style.display = "none";
        if (priceEl){ priceEl.focus(); }
      }, 350);
    }
  }
</script>
{% endblock %}
