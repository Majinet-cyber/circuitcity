{% extends "base.html" %}
{% block title %}Scan Sold · Circuit City{% endblock %}
{% block header_title %}Inventory · Sell{% endblock %}
{% block notif_scope %}inventory{% endblock %}
{% block notif_allow %}stock_in,stock_sold,low_stock{% endblock %}

{% block extra_css %}
<style>
  .page{margin:0 auto;max-width:1120px;padding:clamp(12px,4vw,24px)}
  .vstack{display:flex;flex-direction:column;gap:.75rem}
  .hstack{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}

  :root{--cc-bg:#fff;--cc-text:#0f172a;--cc-muted:#64748b;--cc-border:#e2e8f0;--cc-panel:#fff;--cc-shadow:0 6px 18px rgba(2,6,23,.08);--cc-accent:#1f6feb}
  body{background:var(--cc-bg);color:var(--cc-text)}
  .card{background:var(--cc-panel);border:1px solid var(--cc-border);border-radius:16px;padding:1.25rem;box-shadow:var(--cc-shadow)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
  @media (max-width:640px){.row{grid-template-columns:1fr}}

  .field{position:relative;background:var(--cc-panel);border:1px solid var(--cc-border);border-radius:12px;display:flex;align-items:center}
  .field>input,.field>select{flex:1;background:transparent;color:var(--cc-text);border:0;padding:12px 14px;outline:none;font-size:16px;min-height:44px;width:100%}
  label{font-weight:800;margin-bottom:.35rem;display:block}
  input:focus,select:focus{outline:none;border-color:var(--cc-accent)!important;box-shadow:0 0 0 .2rem rgba(31,111,235,.25)!important}

  .btn{appearance:none;border:1px solid var(--cc-border);background:var(--cc-panel);color:var(--cc-text);border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:800;font-size:14px;min-height:44px;text-decoration:none;display:inline-flex;align-items:center;gap:.4rem;transition:transform .12s,box-shadow .2s,background .2s,border-color .2s}
  .btn:hover{transform:translateY(-1px);box-shadow:var(--cc-shadow)}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn-primary{background:var(--cc-accent);color:#fff;border-color:var(--cc-accent)}
  .btn-primary:hover{filter:brightness(.95)}
  .btn-muted{background:rgba(148,163,184,.18)}

  .badge{display:inline-flex;align-items:center;font-weight:800;border-radius:999px;padding:.35rem .6rem;border:1px solid transparent}
  .badge-warn{background:#fff7ed;border-color:#fbbf24;color:#92400e}
  .badge-ok{background:#ecfdf5;border-color:#34d399;color:#065f46}
  .badge-wait{background:#eff6ff;border-color:#93c5fd;color:#1e40af}

  #lenChip{font-weight:800;font-size:.85rem;border:1px solid var(--cc-border);border-radius:999px;padding:.25rem .5rem;color:var(--cc-muted)}

  #toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#fff;padding:.7rem 1rem;border-radius:12px;box-shadow:var(--cc-shadow);z-index:10000;font-weight:800;opacity:.98}
  #toast[hidden]{display:none}
  #toast[data-kind="ok"]{background:#065f46}
  #toast[data-kind="warn"]{background:#92400e}
  #toast[data-kind="error"]{background:#7f1d1d}

  .warn{display:none;margin-top:.5rem;padding:.6rem .8rem;border:1px solid #fbbf24;background:#fffbeb;color:#92400e;border-radius:10px}

  #cameraBox{margin-top:8px;display:none;background:var(--cc-panel);border:1px dashed var(--cc-border);border-radius:14px;padding:12px}
  .scan-shell{position:relative;border-radius:14px;overflow:hidden;background:#000;box-shadow:var(--cc-shadow)}
  #camera{width:100%;max-height:360px;min-height:220px;background:#000;display:block;object-fit:cover}
  .scan-overlay{position:absolute;inset:0;pointer-events:none}
  .scan-frame{position:absolute; inset:10% 8%; border:2px solid rgba(255,255,255,.25); border-radius:12px; box-shadow: inset 0 0 0 9999px rgba(0,0,0,.20)}
  .scanline{position:absolute; left:8%; right:8%; height:2px; border-radius:2px; background:linear-gradient(90deg, transparent, #00ff5a, transparent); box-shadow:0 0 10px #00ff5a, 0 0 20px rgba(0,255,90,.6); animation: sweep 2.0s linear infinite alternate;}
  .scanline.paused{ animation-play-state: paused; }
  @keyframes sweep { from{ top:10%; } to{ top:90%; } }

  #candidates{margin-top:.5rem}
  #candidates .pill{border:1px solid var(--cc-border);border-radius:999px;padding:.25rem .55rem;font-weight:700;cursor:pointer;background:#fff}
  #candidates .pill:hover{box-shadow:var(--cc-shadow)}
  .pill{font-size:12px;color:#164fb1;background:rgba(31,111,235,.10);border:1px solid rgba(31,111,235,.25);padding:4px 8px;border-radius:999px}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:var(--cc-panel);border:1px solid var(--cc-border);color:var(--cc-text);padding:2px 6px;border-radius:6px}

  #ccscan-picker{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:9999}
  #ccscan-picker .card{background:#fff;max-width:90vw;width:520px;padding:16px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.35);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  #ccscan-picker .title{font-weight:600;margin-bottom:10px}
  #ccscan-picker .list{max-height:55vh;overflow:auto;display:flex;flex-direction:column;gap:8px}
  #ccscan-picker .item{text-align:left;padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#f9fafb;cursor:pointer;word-break:break-all}
  #ccscan-picker .actions{margin-top:12px;display:flex;justify-content:flex-end;gap:8px}
  #ccscan-picker .btn{padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
</style>
{% endblock %}

{% block body %}
{% include "_topbar.html" %}
<main class="page vstack">
  <section class="card vstack" aria-labelledby="sell">
    <h1 id="sell" style="margin:0">Mark item as <span style="color:#ef4444">SOLD</span></h1>

    {% if messages %}
      {% for message in messages %}
        <div class="alert {% if 'error' in message.tags or 'danger' in message.tags %}alert-err{% else %}alert-ok{% endif %}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <div id="secureWarn" class="warn">
      Camera requires a secure connection. Open this page over <strong>HTTPS</strong> (or localhost) and allow camera permission.
    </div>

    {% url 'inventory:stock_list' as stock_url %}
    {% url 'inventory:scan_in' as scan_in_url %}
    {% url 'inventory:api_stock_status' as stock_status_url %}

    <form
      method="post"
      action="{% url 'inventory:api_mark_sold' %}"
      id="sellForm"
      class="vstack"
      style="gap:1rem"
      novalidate
      autocomplete="off"
      data-default-location-id="{{ default_location.id|default:request.user.agent_profile.location.id|default:'' }}"
      data-stock-status-url="{{ stock_status_url }}"
      data-lock-location="{{ lock_location|default:'' }}"
    >
      {% csrf_token %}

      <!-- IMEI -->
      <div>
        <label for="id_imei">IMEI / Barcode</label>
        <div class="field">
          <input
            type="text"
            id="id_imei"
            name="imei"
            maxlength="15"
            pattern="\d{15}"
            inputmode="numeric"
            autocomplete="off"
            placeholder="Enter 15-digit IMEI"
            aria-required="true"
            aria-invalid="false">
        </div>

        <div class="hstack" style="margin-top:.5rem">
          <button class="btn" type="button" id="btnPaste">📋 Paste</button>
          <button class="btn" type="button" id="camToggle">📷 Start Camera</button>
          <button class="btn btn-muted" type="button" id="btnStopCam" style="display:none">■ Stop</button>
          <button class="btn" type="button" id="torchBtn">🔦 Toggle Torch</button>
          <button class="btn btn-muted" type="button" id="btnClear">✖ Clear</button>

          <span id="stockBadge" class="badge badge-warn" aria-live="polite">Enter 15 digits</span>
          <span id="lenChip" aria-hidden="true">0/15</span>

          <label class="hstack" style="margin-left:auto;font-weight:600;color:var(--cc-muted)">
            <input type="checkbox" id="autoSubmit"> Auto-submit after scan
          </label>
        </div>

        <!-- Camera shell -->
        <div id="cameraBox">
          <div class="scan-shell">
            <video id="camera" autoplay playsinline muted></video>
            <div class="scan-overlay">
              <div class="scan-frame"></div>
              <div id="scanline" class="scanline"></div>
            </div>
          </div>
          <div class="hstack" style="margin-top:8px">
            <select id="cameraSelect" class="btn" style="min-width:200px"></select>
            <button type="button" id="btnStartCam" class="btn" style="display:none">Restart</button>
          </div>
          <div id="candidates" class="hstack" aria-live="polite"></div>
        </div>

        <div class="hint" style="margin-top:.35rem">
          Scan or paste. IMEI must be exactly 15 digits. If multiple 15-digit barcodes are detected, you’ll be able to choose.
          <span class="pill">Shortcut: <span class="kbd">Enter</span> submits</span>
        </div>
      </div>

      <!-- Sold date / Price -->
      <div class="row">
        <div>
          <label for="id_sold_at">Sold date</label>
          <div class="field"><input type="date" id="id_sold_at" name="sold_date"></div>
        </div>
        <div>
          <label for="id_price">Price</label>
          <div class="field"><input type="number" id="id_price" name="price" min="0" step="any" autocomplete="off" placeholder="Final selling price"></div>
          <div class="hint">Enter final selling price (non-negative).</div>
        </div>
      </div>

      <!-- Commission / Location -->
      <div class="row">
        <div>
          <label for="id_commission_pct">Commission %</label>
          <div class="field"><input type="number" id="id_commission_pct" name="commission" min="0" max="100" step="any" placeholder="Commission %"></div>
        </div>
        <div>
          <label for="id_location">Location</label>
          <div class="field">
            {% if locations %}
              <select id="id_location" name="location">
                <option value="">--------</option>
                {% for l in locations %}
                  <option value="{{ l.id }}"
                          {% if default_location and l.id == default_location.id %}selected{% endif %}>
                    {{ l.name }}
                  </option>
                {% endfor %}
              </select>
            {% else %}
              {{ form.location }}
            {% endif %}
          </div>
        </div>
      </div>

      <input type="hidden" id="id_location_id" name="location_id" value="">
      <div class="hstack">
        <button class="btn btn-primary" type="submit" id="submitBtn" disabled>Mark as SOLD</button>
        <a class="btn" href="{{ stock_url|default:'/inventory/list/' }}">Stock list</a>
        <a class="btn" href="{{ scan_in_url|default:'/inventory/scan-in/' }}">← Back to Scan In</a>
      </div>
    </form>
  </section>
</main>

<div id="ccscan-picker">
  <div class="card">
    <div class="title">Multiple codes found — pick one</div>
    <div class="list" id="ccscan-list"></div>
    <div class="actions">
      <button type="button" class="btn" id="ccscan-pause">Pause camera</button>
      <button type="button" class="btn" id="ccscan-cancel">Cancel</button>
    </div>
  </div>
</div>

<div id="toast" hidden></div>

<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<script>
(function(){
  // ---------- Elements ----------
  const formEl=document.getElementById('sellForm');
  const submitBtn=document.getElementById('submitBtn');
  const imeiInput=document.getElementById('id_imei');
  const priceEl=document.getElementById('id_price');
  const commEl=document.getElementById('id_commission_pct');
  const dateEl=document.getElementById('id_sold_at');
  const locWidget=document.getElementById('id_location')||document.querySelector('[name="location"]');
  const locHidden=document.getElementById('id_location_id');
  const stockBadge=document.getElementById('stockBadge');
  const lenChip=document.getElementById('lenChip');

  const camToggle=document.getElementById('camToggle');
  const btnStopCam=document.getElementById('btnStopCam');
  const torchBtn=document.getElementById('torchBtn');
  const camBox=document.getElementById('cameraBox');
  const camNode=document.getElementById('camera');
  const camSelect=document.getElementById('cameraSelect');
  const scanLine=document.getElementById('scanline');
  const secureWarn=document.getElementById('secureWarn');
  const candidatesEl=document.getElementById('candidates');
  const autoSubmit=document.getElementById('autoSubmit');

  const picker=document.getElementById('ccscan-picker');
  const pickerList=document.getElementById('ccscan-list');
  const pickerCancel=document.getElementById('ccscan-cancel');
  const pickerPause=document.getElementById('ccscan-pause');

  const STOCK_STATUS_URL=formEl.dataset.stockStatusUrl;
  const defaultLocId = formEl.dataset.defaultLocationId || '';
  const lockLocation = formEl.dataset.lockLocation === '1';

  // ---------- Helpers ----------
  const toastEl=document.getElementById('toast');
  function toast(msg, kind='ok', ms=2400){ toastEl.textContent=msg; toastEl.dataset.kind=kind; toastEl.hidden=false; clearTimeout(toast._t); toast._t=setTimeout(()=>toastEl.hidden=true,ms); }
  const digits=s=>String(s||'').replace(/\D+/g,'');
  const isSecure = window.isSecureContext || location.protocol === 'https:';
  if(!isSecure){ secureWarn.style.display='block'; }

  const IMEI_RX=/\b\d{15}\b/g;
  const isIMEI15 = s => /^\d{15}$/.test(digits(s));

  function setAriaValidity(){ imeiInput.setAttribute('aria-invalid', String(!isIMEI15(imeiInput.value))); }
  function validPrice(){ const v=Number(priceEl && priceEl.value); return Number.isFinite(v) && v>=0; }
  function csrf(){ const el=document.querySelector('#sellForm input[name="csrfmiddlewaretoken"]'); return el?el.value:''; }
  function setToday(){
    if(dateEl && !dateEl.value){
      const d=new Date();
      dateEl.value=[d.getFullYear(),String(d.getMonth()+1).padStart(2,'0'),String(d.getDate()).padStart(2,'0')].join('-');
    }
  }
  setToday();

  // ---------- Status badge + submit guard ----------
  let inStockHere=false, inStockElsewhere=false, currentCtrl=null;
  function setBadge(kind, text){ stockBadge.className='badge '+kind; stockBadge.textContent=text; }
  function updateSubmitState(){ submitBtn.disabled = !(isIMEI15(imeiInput.value) && validPrice() && (inStockHere || inStockElsewhere)); }

  function parseInStock(payload){
    if (!payload) return false;
    if (typeof payload.in_stock === 'boolean') return payload.in_stock;
    if (payload.data && typeof payload.data.in_stock === 'boolean') return payload.data.in_stock;
    if (payload.ok === true && payload.exists === true) return true;
    return false;
  }
  function parseMismatch(payload){
    if (!payload) return false;
    if (payload.data && typeof payload.data.location_mismatch === 'boolean') return payload.data.location_mismatch;
    if (typeof payload.location_mismatch === 'boolean') return payload.location_mismatch;
    if (typeof payload.mismatch === 'boolean') return payload.mismatch;
    if (payload.data && typeof payload.data.mismatch === 'boolean') return payload.data.mismatch;
    return false;
  }

  async function checkStock(){
    const code=(imeiInput.value||'').trim();
    const locId=(locWidget?.value||'').trim();
    if (currentCtrl) currentCtrl.abort();

    if (!isIMEI15(code)){
      inStockHere=false; inStockElsewhere=false;
      setBadge('badge-warn','Enter 15 digits');
      updateSubmitState();
      return;
    }

    setBadge('badge-wait','Checking…');
    const params = new URLSearchParams({ code, _:Date.now() });
    if (locId) params.set('location_id', String(locId));

    currentCtrl = new AbortController();
    const timer = setTimeout(()=>currentCtrl.abort(), 2500);

    try{
      const res = await fetch(`${STOCK_STATUS_URL}?${params.toString()}`,{
        signal: currentCtrl.signal, credentials:'same-origin', cache:'no-store',
        headers:{'X-Requested-With':'XMLHttpRequest','Accept':'application/json'}
      });
      clearTimeout(timer);
      if(!res.ok) throw new Error(String(res.status));
      const data = await res.json();

      const here = !!parseInStock(data) && !parseMismatch(data);
      const elsewhere = !!parseInStock(data) && parseMismatch(data);

      inStockHere = here;
      inStockElsewhere = elsewhere;

      if (inStockHere) setBadge('badge-ok','IMEI in stock');
      else if (inStockElsewhere) setBadge('badge-warn','In stock (other location)');
      else setBadge('badge-warn','Not in stock');
    }catch(_e){
      inStockHere=false; inStockElsewhere=false;
      setBadge('badge-warn','Check failed');
    }finally{
      updateSubmitState();
    }
  }

  function renderCandidates(list){
    if (!list || !list.length) { candidatesEl.innerHTML=''; return; }
    candidatesEl.innerHTML = list.map(v=>`<button type="button" class="pill" data-imei="${v}">${v}</button>`).join('');
    candidatesEl.querySelectorAll('.pill').forEach(b=>b.addEventListener('click',()=>setIMEI(b.dataset.imei)));
  }

  function handleIMEIInput(){
    const raw = imeiInput.value;
    const clean = digits(raw).slice(0,15);
    if (clean !== raw) imeiInput.value = clean;
    const len = clean.length;
    lenChip.textContent = `${len}/15`;
    setAriaValidity();
    if (len === 15) { checkStock(); } else { setBadge('badge-warn','Enter 15 digits'); }
    updateSubmitState();
    const many = (raw.match(IMEI_RX) || []);
    renderCandidates(many.length > 1 ? [...new Set(many)] : []);
  }
  imeiInput.addEventListener('input', handleIMEIInput);
  imeiInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); if(!submitBtn.disabled) formEl.submit(); }});
  window.addEventListener('DOMContentLoaded', handleIMEIInput);

  function setIMEI(val){
    imeiInput.value = digits(val).slice(0,15);
    handleIMEIInput();
    if (autoSubmit.checked && isIMEI15(imeiInput.value) && !submitBtn.disabled) {
      formEl.requestSubmit ? formEl.requestSubmit() : formEl.submit();
    }
  }

  // ---------- Location ----------
  function applyDefaultLocation(){
    if (!locWidget) return;
    if (defaultLocId){
      const opt = Array.from(locWidget.options||[]).find(o=>String(o.value)===String(defaultLocId));
      if (opt) locWidget.value = opt.value;
    }
    if (locHidden) locHidden.value = (locWidget.value||'').trim();

    if (lockLocation){
      locWidget.setAttribute('disabled','disabled');
      if (locHidden) locHidden.value = (locWidget.value||'').trim();
    } else {
      locWidget.removeAttribute('disabled');
    }
  }
  applyDefaultLocation();
  locWidget?.addEventListener('change',()=>{ if (locHidden) locHidden.value=(locWidget.value||'').trim(); if (isIMEI15(imeiInput.value)) checkStock(); });

  // ---------- Paste / Clear ----------
  document.getElementById('btnPaste')?.addEventListener('click',async()=>{
    try{
      const t=await navigator.clipboard.readText();
      const candidates = (t.match(IMEI_RX) || []);
      if (candidates.length > 1){ openPicker([...new Set(candidates)], (v)=>setIMEI(v)); }
      setIMEI(candidates[0] || t);
      if(isIMEI15(imeiInput.value)) priceEl?.focus();
    }catch{ toast('Clipboard blocked','warn'); }
  });
  document.getElementById('btnClear')?.addEventListener('click',()=>{ imeiInput.value=''; inStockHere=false; inStockElsewhere=false; handleIMEIInput(); imeiInput.focus(); });

  // ---------- Picker ----------
  function openPicker(values, onPick){
    pickerList.innerHTML='';
    values.forEach(v=>{
      const b=document.createElement('button');
      b.type='button'; b.className='item'; b.textContent=v;
      b.onclick=()=>{ picker.style.display='none'; onPick?.(v); };
      pickerList.appendChild(b);
    });
    picker.style.display='flex';
    pickerCancel.onclick=()=>{ picker.style.display='none'; };
    pickerPause.onclick=()=>{ stopAll(); toast('Camera paused','warn'); };
  }

  // ---------- Camera / Scanner ----------
  const isSecureCtx = isSecure;
  let mediaStream=null, videoTrack=null, rafId=null, scanning=false, usingDetector=false, torchOn=false;
  let quaggaHandler=null, detector=null, lastPickerAt=0;

  function stopRaf(){ if (rafId) cancelAnimationFrame(rafId); rafId=null; }
  function pauseScanline(ms=900){ if(!scanLine) return; scanLine.classList.add('paused'); setTimeout(()=> scanLine.classList.remove('paused'), ms); }

  async function listCameras(){
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d=> d.kind==='videoinput');
      if (camSelect){
        camSelect.innerHTML = '';
        cams.forEach((c,i)=>{
          const opt = document.createElement('option');
          opt.value = c.deviceId; opt.textContent = c.label || `Camera ${i+1}`;
          camSelect.appendChild(opt);
        });
      }
      return cams;
    }catch{return [];}
  }

  async function startMedia(constraints){
    mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
    camNode.srcObject = mediaStream;
    await camNode.play();
    videoTrack = mediaStream.getVideoTracks()[0];
  }

  async function startNativeDetector(deviceId){
    await startMedia({
      audio:false,
      video:{
        facingMode: deviceId ? undefined : { ideal: 'environment' },
        deviceId: deviceId ? { exact: deviceId } : undefined,
        width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:24,max:30},
        focusMode:"continuous", advanced:[{focusMode:"continuous"}]
      }
    });

    if (!('BarcodeDetector' in window)) throw new Error('NoBarcodeDetector');

    try{
      detector = new window.BarcodeDetector({
        formats:['qr_code','aztec','code_128','code_39','code_93','data_matrix','ean_13','ean_8','itf','pdf417','upc_a','upc_e']
      });
    }catch(_){ throw new Error('DetectorInitFailed'); }

    usingDetector = true; scanning = true;
    detectLoop();
  }

  function extractCandidatesFromStrings(arr){
    const set=new Set();
    arr.forEach(s=>{
      (String(s||'').match(IMEI_RX)||[]).forEach(v=>set.add(v));
    });
    return [...set];
  }

  function uniqueStrings(arr){
    const set=new Set(arr.filter(Boolean).map(s=>s.trim()));
    return [...set];
  }

  function now(){ return Date.now(); }

  function shouldShowPicker(){ const t=now(); if (t-lastPickerAt>700){ lastPickerAt=t; return true; } return false; }

  async function detectLoop(){
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    let lastTick=0;
    const tickEveryMs=140; // ~7 fps

    const loop = async () => {
      if (!scanning) return;
      rafId = requestAnimationFrame(loop);
      if (camNode.readyState < 2) return;

      const t=performance.now();
      if (t - lastTick < tickEveryMs) return;
      lastTick = t;

      canvas.width = camNode.videoWidth; canvas.height = camNode.videoHeight;
      ctx.drawImage(camNode,0,0,canvas.width,canvas.height);

      try{
        const codes = await detector.detect(canvas);
        if (!codes || !codes.length) return;

        // Prefer QR payloads for multi-pick
        const qrVals = uniqueStrings(codes.filter(c => (c.format||c.type)==='qr_code').map(c => c.rawValue||c.rawValueText||''));
        if (qrVals.length){
          const imeis = extractCandidatesFromStrings(qrVals);
          if (imeis.length === 1){
            setIMEI(imeis[0]); pauseScanline(); try{ navigator.vibrate?.(20);}catch(_){}
            if (autoSubmit.checked && !submitBtn.disabled) { stopAll(); formEl.submit(); }
          } else if (imeis.length > 1 && shouldShowPicker()){
            pauseScanline();
            openPicker(imeis, choice => { setIMEI(choice); if (autoSubmit.checked && !submitBtn.disabled){ stopAll(); formEl.submit(); } });
          } else if (!imeis.length && qrVals.length === 1){
            // QR text without clean 15-digit IMEI — still try to parse best 15-digit window
            const d = digits(qrVals[0]);
            if (d.length >= 15) { setIMEI(d.slice(-15)); }
          }
          return; // do not process 1D in the same frame if QR present
        }

        // Fallback: any barcode values → 15-digit candidates
        const anyVals = uniqueStrings(codes.map(c => c.rawValue||c.rawValueText||''));
        const cand = extractCandidatesFromStrings(anyVals);
        if (cand.length === 1){
          setIMEI(cand[0]); pauseScanline(); try{ navigator.vibrate?.(20);}catch(_){}
          if (autoSubmit.checked && !submitBtn.disabled) { stopAll(); formEl.submit(); }
        } else if (cand.length > 1 && shouldShowPicker()){
          pauseScanline();
          openPicker(cand, choice => { setIMEI(choice); if (autoSubmit.checked && !submitBtn.disabled){ stopAll(); formEl.submit(); } });
        }
      }catch(_e){
        // If detect fails repeatedly, fallback will be used when starting again
      }
    };
    loop();
  }

  async function startQuagga(deviceId){
    if (!window.Quagga) { toast('Quagga not loaded.', 'warn'); return; }
    await startMedia({
      audio:false,
      video:{
        facingMode: deviceId ? undefined : 'environment',
        deviceId: deviceId || undefined,
        width:{ideal:1280}, height:{ideal:720}
      }
    });

    stopRaf(); usingDetector=false; scanning=true;

    Quagga.init({
      inputStream: { type: 'LiveStream', target: camNode,
        constraints: { facingMode: deviceId ? undefined : 'environment', deviceId: deviceId || undefined,
          width:{ideal:1280}, height:{ideal:720} } },
      decoder: { readers: ['code_128_reader','ean_reader','ean_8_reader','code_39_reader','upc_reader','upc_e_reader','itf_reader','codabar_reader'] },
      locate: true,
      numOfWorkers: navigator.hardwareConcurrency ? Math.min(4, navigator.hardwareConcurrency) : 2
    }, (err)=>{
      if(err){ toast('Camera init failed. Allow camera access.', 'error', 3200); stopAll(); return; }
      Quagga.start();
    });

    // ensure only one active handler
    if (quaggaHandler) try{ Quagga.offDetected(quaggaHandler); }catch(_){}
    quaggaHandler = (result)=>{
      if(!scanning) return;
      const code = (result && result.codeResult && result.codeResult.code) || '';
      if(!code) return;
      const list = extractCandidatesFromStrings([code]);
      if (list.length > 1){ pauseScanline(); openPicker(list, (choice)=> setIMEI(choice)); }
      else { setIMEI(list[0] || code); }
      if (autoSubmit.checked && !submitBtn.disabled){ stopAll(); formEl.submit(); }
    };
    Quagga.onDetected(quaggaHandler);
  }

  async function enableTorch(desired){
    if(!videoTrack) return;
    const caps = videoTrack.getCapabilities?.() || {};
    if (!('torch' in caps)) { toast('Torch not supported on this camera.','warn'); return; }
    try{
      await videoTrack.applyConstraints({ advanced:[{ torch: desired }] });
      torchOn = desired;
    }catch(_){ toast('Torch toggle failed.','warn'); }
  }

  function stopAll(){
    scanning = false;
    stopRaf();
    if (window.Quagga){
      try{
        if (quaggaHandler) { Quagga.offDetected(quaggaHandler); quaggaHandler=null; }
        Quagga.stop();
      }catch(_){}
    }
    if (mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); }
    mediaStream=null; videoTrack=null;
  }

  // ---------- Camera UI ----------
  camToggle?.addEventListener('click', async ()=>{
    if(!isSecureCtx){ toast('Tip: use HTTPS or Android Chrome dev flag to enable camera.','warn'); }
    camBox.style.display='block';
    const cams = await listCameras();
    try{
      if ('BarcodeDetector' in window){
        await startNativeDetector(cams[0] && cams[0].deviceId);
      } else {
        await startQuagga(cams[0] && cams[0].deviceId);
      }
      camToggle.textContent='Restart Camera';
      btnStopCam.style.display='inline-flex';
    }catch(e){
      let hint='Could not access camera';
      if (e && (e.name==='NotAllowedError'||e.name==='SecurityError')) hint='Permission blocked — allow camera access in the address bar.';
      else if (e && e.name==='NotReadableError') hint='Camera is busy in another app. Close it and try again.';
      else if (e && e.name==='NotFoundError') hint='No camera found.';
      toast(hint,'error',3600);
      stopAll();
      camBox.style.display='none';
      camToggle.textContent='Start Camera';
      btnStopCam.style.display='none';
    }
  });

  camSelect?.addEventListener('change', async ()=>{
    stopAll();
    try{
      if ('BarcodeDetector' in window){
        await startNativeDetector(camSelect.value);
      } else {
        await startQuagga(camSelect.value);
      }
      btnStopCam.style.display='inline-flex';
    }catch{ toast('Could not switch camera.','warn'); }
  });

  btnStopCam?.addEventListener('click', ()=>{
    stopAll();
    camBox.style.display='none';
    btnStopCam.style.display='none';
    camToggle.textContent='Start Camera';
  });

  torchBtn?.addEventListener('click', ()=> enableTorch(!(window.torchOn)));

  window.addEventListener('beforeunload', stopAll);
  document.addEventListener('visibilitychange', ()=>{ if (document.hidden) stopAll(); });

  // ---------- Form submission ----------
  function parseSoldResult(resp, data, text){
    const msg=(data&&(data.message||data.msg))||text||'';
    const alreadySold=(data&&(data.status==='already_sold'||data.error_code==='ALREADY_SOLD'))||/already\s*sold/i.test(msg||'');
    const notInStock=(resp&&resp.status===400)||(data&&data.ok===false&&/not.*stock|missing/i.test(msg||''));
    return { alreadySold, notInStock };
  }

  async function pollUntilMoved(code, {tries=12, delay=800}={}){
    for(let i=0;i<tries;i++){
      try{
        const qs=new URLSearchParams({code, _:Date.now()});
        const res=await fetch(`${STOCK_STATUS_URL}?${qs.toString()}`,{cache:'no-store',credentials:'same-origin',headers:{'Accept':'application/json'}});
        const data= res.ok ? await res.json() : null;
        const stillInStock = !!parseInStock(data) && !parseMismatch(data);
        if(!stillInStock){ return true; }
      }catch(_){}
      await new Promise(r=>setTimeout(r,delay));
    }
    return false;
  }

  let submitting=false;
  formEl.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(submitting) return;
    if(!(isIMEI15(imeiInput.value) && validPrice() && (inStockHere || inStockElsewhere))){
      toast('Enter price and make sure IMEI exists in your business','warn');
      return;
    }
    submitting=true; submitBtn.disabled=true; submitBtn.textContent='Marking…';

    const payload={
      imei:imeiInput.value.trim(),
      sold_date:(dateEl?.value||'').trim(),
      price:priceEl?.value?Number(priceEl.value):'',
      commission:commEl?.value?Number(commEl.value):'',
      location_id:(locWidget?.value||'').trim()
    };

    try{
      const resp=await fetch(formEl.action,{
        method:'POST',credentials:'same-origin',
        headers:{
          'Content-Type':'application/json',
          'X-Requested-With':'XMLHttpRequest',
          'X-CSRFToken':csrf(),
          'Accept':'application/json, text/plain, */*'
        },
        body:JSON.stringify(payload)
      });

      let data=null, text=''; try{ data=await resp.json(); }catch{ try{text=await resp.text();}catch{} }
      const verdict=parseSoldResult(resp,data||{},text);

      if (verdict.notInStock){ toast('IMEI not in stock for your business','warn'); setBadge('badge-warn','Not in stock'); return; }
      if (verdict.alreadySold){ toast('IMEI already SOLD','warn'); setBadge('badge-warn','Already sold'); return; }

      toast('Marked as SOLD','ok',1600);

      const justSoldImei = imeiInput.value.trim();
      priceEl.value=''; commEl.value=''; imeiInput.value=''; inStockHere=false; inStockElsewhere=false; handleIMEIInput();

      const moved = await pollUntilMoved(justSoldImei);
      const dest = `/inventory/list/?status=sold&q=${encodeURIComponent(justSoldImei)}`;
      if (moved){ window.location.assign(dest); }
      else { toast('Saved; syncing…','warn',2500); window.location.assign(dest); }
    }catch{
      toast('Network error. Try again.','error',2600);
    }finally{
      submitting=false; submitBtn.disabled=false; submitBtn.textContent='Mark as SOLD';
    }
  });
})();
</script>
{% endblock %}
