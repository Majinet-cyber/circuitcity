{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Purchase Orders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="{% static 'favicon.ico' %}" />

  <style>
    /* =========================
       LIGHT THEME (no dark mode)
       ========================= */
    :root{
      --bg:#ffffff;
      --panel:#f8fafc;
      --panel2:#f1f5f9;
      --border:#e5e7eb;
      --muted:#475569;
      --txt:#0f172a;
      --chip:#eef2ff;
      --primary:#2563eb;
      --primary-600:#1d4ed8;
      --danger:#b91c1c;
    }
    @media (prefers-color-scheme: dark) {
      /* neutralize OS dark mode; keep light */
      :root { color-scheme: light; }
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);
         font:14px/1.45 system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif}
    a{color:var(--primary);text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:1100px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 8px 0;font-weight:800;letter-spacing:.2px}
    p.muted{color:var(--muted);margin:.25rem 0 1rem}
    .bar{display:flex;gap:10px;align-items:center;margin:16px 0 12px}
    .btn{background:#fff;border:1px solid var(--border);padding:10px 14px;border-radius:10px;color:var(--txt);cursor:pointer;text-decoration:none}
    .btn:hover{background:#fafafa}
    .btn.primary{background:var(--primary);border-color:var(--primary-600);color:#fff}
    .btn.ghost{background:#fff}
    .pill{padding:3px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#fff;color:var(--muted)}
    .grid{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .grid header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border);background:var(--panel2)}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{padding:12px 14px;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle}
    th{color:#334155;font-weight:700;background:#fbfbfd}
    tr:last-child td{border-bottom:none}
    .status{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:var(--chip)}
    .s-draft{background:#f8fafc}
    .s-pending{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    .s-approved{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .s-received{background:#eff6ff;border-color:#bfdbfe;color:#1e40af}
    .muted{color:var(--muted)}
    .right{display:flex;gap:8px;align-items:center;margin-left:auto}
    .side{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
    .split{display:grid;grid-template-columns:1fr 300px;gap:16px}
    @media (max-width:900px){.split{grid-template-columns:1fr}}
    .tip{background:#fff;border:1px solid var(--border);padding:12px;border-radius:12px}
    code{background:#f8fafc;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    .empty{padding:28px;text-align:center;color:var(--muted);background:#fff}
    .error{padding:16px;text-align:center;color:#7f1d1d;background:#fee2e2;border-top:1px solid #fecaca}

    /* =========================================================
       SIDEBAR LOCK (never collapse on web / large screens)
       These are safe overrides; they won‚Äôt break mobile.
       Adjust selectors to your layout if different.
       ========================================================= */
    @media (min-width: 900px){
      .sidebar, .app-sidebar, [data-sidebar]{
        width: 260px !important;
        transform: none !important;
        position: sticky; top: 0;
      }
      .sidebar.collapsed, .app-sidebar.collapsed, .nav-collapsed{
        width: 260px !important;
      }
      .layout, .has-sidebar {
        --sidebar-w: 260px;
      }
      .layout .main, .content-with-sidebar {
        margin-left: var(--sidebar-w,260px) !important;
      }
      .sidebar-toggle, .hamburger, [data-action="toggle-sidebar"]{
        display: none !important; /* hide collapse control on web */
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Purchase Orders</h1>
    <p class="muted">Review, import, and track your purchase orders. Press <code>N</code> to start a new one.</p>

    <div class="bar">
      <a class="btn primary" id="newBtn" href="{% url 'inventory:place_order' %}">+ New Order</a>
      <button class="btn" id="demoBtn" title="Seed sample data on screen only">üß™ Demo Mode (D)</button>
      <a class="btn ghost" id="openApi" href="{% url 'inventory:orders_list_api' %}" target="_blank" rel="noreferrer">üìï Open API</a>
      <div class="right">
        <button class="btn" id="refreshBtn">‚Üª Refresh (R)</button>
      </div>
    </div>

    <div class="split">
      <section class="grid" id="ordersBox">
        <header>
          <div><span id="count" class="pill">0 orders</span></div>
          <div class="muted">Showing latest</div>
        </header>
        <div id="tableWrap">
          <div class="empty">Loading‚Ä¶</div>
        </div>
      </section>

      <aside class="side">
        <div class="tip" style="margin-bottom:14px">
          <strong>Quick tips</strong>
          <ul>
            <li>Paste a supplier reference into ‚ÄúNew Order‚Äù.</li>
            <li>Use the API to seed from another system.</li>
            <li>Shortcuts: <code>N</code> new, <code>R</code> refresh, <code>D</code> demo.</li>
          </ul>
        </div>

        <div class="tip">
          <strong>CSV Import</strong>
          <p class="muted">Prepare a CSV with columns: <code>reference,status,total,created_at</code>.</p>
          <button class="btn ghost" disabled>‚§ø Import CSV</button>
          <p class="muted" style="margin-top:8px">Import endpoint is not wired yet. (UI only)</p>
        </div>
      </aside>
    </div>
  </div>

  <script>
    /* ====== keep sidebar open even if app JS tries to collapse ====== */
    (function lockSidebarOpen(){
      const unlock = () => {};
      const forceOpen = () => {
        const s = document.querySelector('.sidebar, .app-sidebar, [data-sidebar]');
        if (s) { s.classList.remove('collapsed'); s.style.width='260px'; }
        document.documentElement.classList.remove('nav-collapsed');
      };
      window.addEventListener('resize', forceOpen);
      document.addEventListener('click', e=>{
        const t = e.target.closest('.sidebar-toggle,[data-action="toggle-sidebar"]');
        if (t) { e.preventDefault(); forceOpen(); }
      });
      forceOpen();
      return unlock;
    })();

    /* ========== API + rendering ========== */
    const API_URL = "{% url 'inventory:orders_list_api' %}?limit=100";

    const fmtMoney = v => {
      if (v === null || v === undefined || isNaN(v)) return "‚Äî";
      try { return Number(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
      catch { return v; }
    };
    const fmtDate = iso => {
      if (!iso) return "‚Äî";
      try { return new Date(iso).toLocaleString(); } catch { return iso; }
    };
    const statusClass = s => {
      s = String(s || "").toLowerCase();
      if (s === "approved") return "s-approved";
      if (s === "received") return "s-received";
      if (s === "pending") return "s-pending";
      return "s-draft";
    };

    function setCount(n){ document.getElementById('count').textContent = `${n} order${n===1?"":"s"}`; }

    function renderTable(rows){
      const wrap = document.getElementById('tableWrap');
      if (!rows || !rows.length){
        wrap.innerHTML = `<div class="empty">
          No orders yet.<br/>
          <button class="btn" style="margin-top:10px" onclick="seedDemo()">Fill demo data</button>
        </div>`;
        setCount(0);
        return;
      }
      wrap.innerHTML = `
        <table>
          <thead><tr><th>ID</th><th>REFERENCE</th><th>STATUS</th><th>TOTAL</th><th>CREATED</th></tr></thead>
          <tbody>
            ${rows.map(o => `
              <tr>
                <td>#${o.id ?? "‚Äî"}</td>
                <td>${o.reference ?? "‚Äî"}</td>
                <td><span class="status ${statusClass(o.status)}">${o.status ?? "Draft"}</span></td>
                <td>${fmtMoney(o.total)}</td>
                <td>${fmtDate(o.created_at)}</td>
              </tr>`).join("")}
          </tbody>
        </table>`;
      setCount(rows.length);
    }

    function renderError(msg){
      document.getElementById('tableWrap').innerHTML = `<div class="error">${msg}</div>`;
    }

    async function loadOrders(){
      try{
        const res = await fetch(API_URL, {headers: {'Accept':'application/json'}});
        if (!res.ok){ renderError(`API error (${res.status}). Click ‚ÄúOpen API‚Äù to inspect.`); return; }
        const data = await res.json();
        // Accept either {"ok":true,"data":[...]} or {"orders":[...]}
        const rows = (Array.isArray(data?.data) && data.data)
                  || (Array.isArray(data?.orders) && data.orders)
                  || [];
        renderTable(rows);
      }catch(e){
        console.error(e);
        renderError("Could not load orders. Check console/network.");
      }
    }

    // Demo data (UI only)
    function seedDemo(){
      const now = Date.now();
      const sample = Array.from({length:8}).map((_,i)=>({
        id: 1000+i,
        reference: `PO-25-${String(1+i).padStart(4,"0")}`,
        status: ["Draft","Pending","Approved","Received"][i%4],
        total: 480 + Math.random()*1400,
        created_at: new Date(now - i*86400000).toISOString()
      }));
      renderTable(sample);
    }
    window.seedDemo = seedDemo;

    // UX shortcuts
    document.getElementById('refreshBtn').addEventListener('click', loadOrders);
    document.getElementById('demoBtn').addEventListener('click', seedDemo);
    document.addEventListener('keydown', (e)=>{
      const tag = (e.target.tagName||"").toLowerCase();
      if (tag === "input" || tag === "textarea") return;
      const k = e.key.toLowerCase();
      if (k === "r"){ e.preventDefault(); loadOrders(); }
      if (k === "d"){ e.preventDefault(); seedDemo(); }
      if (k === "n"){ e.preventDefault(); location.href = "{% url 'inventory:place_order' %}"; }
    });

    loadOrders();
  </script>
</body>
</html>
