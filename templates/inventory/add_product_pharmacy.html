{% extends "base.html" %}
{% load static %}

{% block title %}Add Products · Pharmacy{% endblock %}
{% block header_title %}Add Products (Pharmacy){% endblock %}

{% block content %}
<div class="glass-card p-3 p-md-4">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div>
      <div class="badge bg-primary-subtle text-primary fw-semibold">Pharmacy</div>
      <h3 class="mt-2 mb-0">Add Product</h3>
      <div class="text-muted small">Create a medicine master item your team will use for Stock-IN and Sell.</div>
    </div>
    <a href="{% url 'inventory:dashboard' %}" class="btn btn-light d-none d-md-inline-flex">
      <i class="ti ti-arrow-left me-1"></i> Back to Dashboard
    </a>
  </div>

  <form method="post" novalidate id="pharmacy-add-form" class="mt-3">
    {% csrf_token %}
    <!-- CORE FIELDS -->
    <div class="row g-2 g-md-3">
      <div class="col-12 col-md-6">
        <label class="form-label">Medicine name <span class="text-danger">*</span></label>
        <input type="text" name="medicine_name" class="form-control" placeholder="e.g., Amoxicillin 500mg Capsules" required>
        <div class="form-text">Use clear names with strength & dosage form for easy search.</div>
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label">Units per bulk pack</label>
        <div class="input-group">
          <input type="number" min="1" step="1" name="unit_quantity" id="unit_quantity" class="form-control" value="1">
          <span class="input-group-text">units/pack</span>
        </div>
        <div class="form-text">e.g., 10 tablets per strip, 100 tablets per bottle.</div>
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label">Number of bulk packs</label>
        <div class="input-group">
          <input type="number" min="0" step="1" name="bottle_count" id="bottle_count" class="form-control" value="0">
          <span class="input-group-text">packs</span>
        </div>
        <div class="form-text">How many packs/bottles you currently hold.</div>
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label">Order price (per pack)</label>
        <div class="input-group">
          <span class="input-group-text">MWK</span>
          <input type="number" min="0" step="0.01" name="order_price" id="order_price" class="form-control" placeholder="0.00">
        </div>
        <div class="form-text">Your cost price per bulk pack/bottle.</div>
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label">Selling price (per unit)</label>
        <div class="input-group">
          <span class="input-group-text">MWK</span>
          <input type="number" min="0" step="0.01" name="price_per_unit" id="price_per_unit" class="form-control" placeholder="0.00" required>
        </div>
        <div class="form-text">Price for 1 tablet/capsule/ml/etc.</div>
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label">Selling price (per pack)</label>
        <div class="input-group">
          <span class="input-group-text">MWK</span>
          <input type="number" min="0" step="0.01" name="price_per_bulk" id="price_per_bulk" class="form-control" placeholder="0.00">
        </div>
        <div class="form-text">Auto-fills from unit price × units per pack (editable).</div>
      </div>

      <!-- READ-ONLY CALCS -->
      <div class="col-12 col-md-3">
        <label class="form-label">Computed stock units</label>
        <input type="text" id="computed_units" class="form-control" value="0" readonly>
        <div class="form-text">Packs × units per pack.</div>
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label">Computed cost per unit</label>
        <div class="input-group">
          <span class="input-group-text">MWK</span>
          <input type="text" id="computed_cpu" class="form-control" value="0.00" readonly>
        </div>
        <div class="form-text">Order price ÷ units per pack.</div>
      </div>
    </div>

    <!-- ACTIONS -->
    <div class="d-flex flex-column flex-md-row gap-2 mt-3">
      <button type="submit" class="btn btn-primary">
        <i class="ti ti-device-floppy me-1"></i> Save product
      </button>
      <button type="submit" name="add_another" value="1" class="btn btn-outline-primary">
        <i class="ti ti-plus me-1"></i> Save & add another
      </button>
      <a href="{% url 'inventory:dashboard' %}" class="btn btn-light">
        Cancel
      </a>
    </div>
  </form>
</div>

<!-- Sticky quick tips (mobile friendly) -->
<div class="mt-3">
  <div class="glass-card p-2 p-md-3">
    <div class="d-flex align-items-center">
      <i class="ti ti-bulb me-2"></i>
      <div class="small">
        <strong>Tips:</strong> Set <em>Units per bulk</em> correctly (e.g., 100 tablets per bottle). The <em>Pack price</em> and <em>cost per unit</em> will auto-calculate; you can still override pack price.
      </div>
    </div>
  </div>
</div>

<!-- Tiny helper script (no external deps) -->
<script>
(function () {
  const fmt = (n) => {
    if (isNaN(n) || !isFinite(n)) return "0.00";
    return (Math.round(n * 100) / 100).toFixed(2);
  };

  const unitQtyEl = document.getElementById('unit_quantity');
  const bottleEl  = document.getElementById('bottle_count');
  const orderEl   = document.getElementById('order_price');
  const unitEl    = document.getElementById('price_per_unit');
  const bulkEl    = document.getElementById('price_per_bulk');

  const calcUnitsEl = document.getElementById('computed_units');
  const cpuEl       = document.getElementById('computed_cpu');

  function recalc() {
    const uq = parseFloat(unitQtyEl.value || 0);
    const bc = parseFloat(bottleEl.value || 0);
    const op = parseFloat(orderEl.value || 0);
    const up = parseFloat(unitEl.value || 0);
    const computedUnits = (uq * bc) || 0;
    calcUnitsEl.value = computedUnits;

    // cost per unit from order price / units per pack
    cpuEl.value = fmt(uq > 0 ? (op / uq) : 0);

    // if bulk price empty or equal to previous auto calc, keep it synced
    const autoBulk = up * uq;
    if (!bulkEl.dataset.touched) {
      bulkEl.value = fmt(autoBulk || 0);
    }
  }

  // Mark manual edits to bulk price so we don't overwrite user intent
  ['change','input'].forEach(ev => {
    (unitQtyEl).addEventListener(ev, recalc);
    (bottleEl).addEventListener(ev, recalc);
    (orderEl).addEventListener(ev, recalc);
    (unitEl).addEventListener(ev, recalc);
  });
  bulkEl.addEventListener('input', () => { bulkEl.dataset.touched = '1'; });

  recalc();

  // Guard: simple client validation
  document.getElementById('pharmacy-add-form').addEventListener('submit', function(e){
    const nameOk = (this.querySelector('input[name="medicine_name"]').value || '').trim().length > 1;
    const unitOk = parseFloat(unitQtyEl.value || 0) >= 1;
    const puOk   = parseFloat(unitEl.value || 0) >= 0;

    if (!nameOk || !unitOk || !puOk) {
      e.preventDefault();
      alert('Please provide a medicine name, units per pack (≥1), and unit selling price.');
    }
  });
})();
</script>
{% endblock %}
