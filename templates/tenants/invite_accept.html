{% extends "base.html" %}
{% load static %}
{% block title %}Join as Agent · {{ invite.business.name }}{% endblock %}

{% block sidebar %}{% endblock %}
{% block header %}{% endblock %}
{% block nav %}{% endblock %}
{% block topbar %}{% endblock %}
{% block header_title %}{% endblock %}

{% block extra_head %}
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
{% endblock %}

{% block extra_css %}
<style>
  /* Reset + hard-hide any outer chrome so no top gaps show */
  html, body { height: 100%; margin: 0 !important; background: #eef2f7; }
  body { overflow: hidden !important; } /* lock page scroll */
  .app-header, .appheader, header.navbar, .navbar, .topbar, .layout-topbar,
  .app-sidebar, .sidebar, #sidebar, .cc-sidebar, .layout-sidebar,
  .app-shell, .shell, .layout-shell > aside, .layout-shell > header {
    display: none !important;
  }

  /* Full-screen container */
  .invite-screen {
    position: fixed; inset: 0;
    display: grid; place-items: center;
    background:
      radial-gradient(1200px 600px at 30% -10%, #ffffff 0%, rgba(255,255,255,0) 60%),
      radial-gradient(1200px 600px at 90% 120%, #ffffff 0%, rgba(255,255,255,0) 60%),
      #eef2f7;
    padding: 12px; /* small edge breathing room */
  }

  /* Card sized like your login; inner area scrolls on small screens */
  .invite-card {
    width: 100%;
    max-width: 560px;
    max-height: 100vh;             /* never taller than screen */
    background: #fff;
    border: 0;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(2,6,23,.10);
    display: flex; flex-direction: column;
  }
  .invite-body {
    padding: 24px;
    overflow: auto;                 /* <-- internal scrolling if needed */
    -webkit-overflow-scrolling: touch;
  }

  .invite-title { font-weight: 800; margin: 0 0 4px 0; letter-spacing: .2px; }
  .badge-soft { background:#eef2ff; color:#273a8a; border:1px solid #e5e7eb; border-radius:999px; padding:2px 10px; font-size:12px; }
  .hello { background:#f8fafc; border-radius:12px; padding:12px; }
  .form-label { font-weight:600; }
  .form-control { height:46px; border-radius:12px; }
  .input-group .btn { border-radius:12px; }

  /* Green primary */
  .btn-accept {
    background:#16a34a; border-color:#16a34a; color:#fff;
    height:48px; border-radius:12px; font-weight:700;
  }
  .btn-accept:disabled { opacity:.7; }

  /* Mobile-tidy spacing */
  @media (max-width: 420px){
    .invite-body { padding: 18px; }
  }
</style>
{% endblock %}

{% block content %}
<div class="invite-screen">
  <div class="invite-card">
    <div class="invite-body">
      <div class="d-flex align-items-center gap-2 mb-3">
        <div class="fw-bold text-uppercase small text-secondary">Agent Invite</div>
        <div class="vr"></div>
        <div class="small text-muted">Secure sign-up</div>
        {% if invite.expires_at %}
        <div class="ms-auto">
          <span class="badge-soft" id="expiryBadge" title="{{ invite.expires_at|date:'c' }}">checking expiry…</span>
        </div>
        {% endif %}
      </div>

      <h2 class="invite-title">Join {{ invite.business.name }}</h2>
      <p class="text-muted mb-3">Create your account to start working in this shop.</p>

      {% if error %}<div class="alert alert-danger" role="alert">{{ error }}</div>{% endif %}
      {% if form.non_field_errors %}<div class="alert alert-danger" role="alert">{{ form.non_field_errors|join:", " }}</div>{% endif %}

      <div class="hello mb-3">
        <div class="small text-muted mb-1">Personalized greeting</div>
        <div id="greeting" style="font-weight:600;">Hi {{ invite.invited_name|default:"there" }}, welcome to {{ invite.business.name }}.</div>
      </div>

      <form method="post" novalidate id="inviteForm">
        {% csrf_token %}

        <div class="mb-3">
          <label for="username" class="form-label">Your name</label>
          <input type="text" class="form-control" id="username" name="username"
                 placeholder="e.g. Chris Mwale" value="{{ invite.invited_name|default_if_none:'' }}"
                 autocomplete="name">
          <div class="form-text">Use the name teammates will recognize.</div>
        </div>

        <div class="mb-3">
          <label for="{{ form.email.id_for_label }}" class="form-label">
            Email {% if invite.email %}(from invite){% endif %}
          </label>
          {{ form.email }}
          {% if form.email.errors %}<div class="text-danger small mt-1">{{ form.email.errors|join:", " }}</div>{% endif %}
          <div class="form-text">Used for notifications and password reset.</div>
        </div>

        <div class="mb-3">
          <label for="{{ form.password1.id_for_label }}" class="form-label">Create password</label>
          <div class="input-group">
            {{ form.password1 }}
            <button class="btn btn-outline-secondary" type="button" data-toggle="reveal" data-target="[name='password1']">Show</button>
          </div>
          {% if form.password1.errors %}<div class="text-danger small mt-1">{{ form.password1.errors|join:", " }}</div>{% endif %}
          <div class="form-text">Tip: mix letters and numbers for a stronger password.</div>
          <div id="strengthHint" class="small mt-1"></div>
        </div>

        <div class="mb-4">
          <label for="{{ form.password2.id_for_label }}" class="form-label">Confirm password</label>
          <div class="input-group">
            {{ form.password2 }}
            <button class="btn btn-outline-secondary" type="button" data-toggle="reveal" data-target="[name='password2']">Show</button>
          </div>
          {% if form.password2.errors %}<div class="text-danger small mt-1">{{ form.password2.errors|join:", " }}</div>{% endif %}
          <div class="form-text" id="matchHint" style="display:none;">Passwords match ✔</div>
        </div>

        <button class="btn btn-accept w-100" type="submit" id="submitBtn">Create account</button>

        <div class="text-center mt-2">
          <a href="{% url 'accounts:login' %}" class="small">Already have an account? Sign in</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  const shopName="{{ invite.business.name|escapejs }}";
  const defaultInvitee="{{ invite.invited_name|default:'there'|escapejs }}";
  const form=document.getElementById('inviteForm');
  const nameInput=document.getElementById('username');
  const greeting=document.getElementById('greeting');
  const p1=form?form.querySelector("input[name='password1']"):null;
  const p2=form?form.querySelector("input[name='password2']"):null;
  const emailInput=form?form.querySelector("input[name='email']"):null;
  const matchHint=document.getElementById('matchHint');
  const strengthHint=document.getElementById('strengthHint');
  const expiryBadge=document.getElementById('expiryBadge');
  const submitBtn=document.getElementById('submitBtn');

  [emailInput,p1,p2].forEach(el=>{ if(el && !el.classList.contains('form-control')) el.classList.add('form-control'); });

  function updateGreeting(){
    if(!greeting) return;
    const name=(nameInput && nameInput.value || '').trim() || defaultInvitee || 'there';
    greeting.textContent=`Hi ${name}, welcome to ${shopName}.`;
  }

  function strength(s){let n=0; if(s.length>=8)n++; if(/[a-z]/.test(s)&&/[A-Z]/.test(s))n++; if(/\d/.test(s))n++; if(/[^A-Za-z0-9]/.test(s))n++; return n;}
  function updateStrength(){
    if(!p1||!strengthHint)return;
    const sc=strength(p1.value||"");
    let msg=""; if(!p1.value)msg=""; else if(sc<=1)msg="Strength: weak"; else if(sc===2)msg="Strength: fair"; else if(sc===3)msg="Strength: good"; else msg="Strength: strong";
    strengthHint.textContent=msg;
    strengthHint.className="small mt-1 "+(sc<=1?"text-danger":sc===2?"text-warning":"text-success");
  }

  function updateMatch(){
    if(!p1||!p2||!matchHint)return;
    if(!p1.value||!p2.value){ matchHint.style.display='none'; return; }
    const ok=p1.value===p2.value && p1.value.length>=8;
    matchHint.style.display='block';
    matchHint.className="form-text "+(ok?"text-success":"text-danger");
    matchHint.textContent= ok ? "Passwords match ✔" : "Passwords don't match";
  }

  if(form){
    form.addEventListener('submit', e=>{
      const ok=p1&&p2&&p1.value===p2.value&&p1.value.length>=8;
      if(!ok){ e.preventDefault(); updateMatch(); if(p1&&p1.value.length<8)p1.focus(); else if(p2)p2.focus(); return; }
      if(submitBtn){ submitBtn.disabled=true; submitBtn.innerText="Creating account…"; }
    });
  }

  document.querySelectorAll('button[data-toggle="reveal"]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const sel=btn.getAttribute('data-target'); const input=document.querySelector(sel); if(!input)return;
      const isPwd=input.getAttribute('type')==='password';
      input.setAttribute('type', isPwd?'text':'password');
      btn.textContent=isPwd?'Hide':'Show';
    });
  });

  function renderExpiryBadge(){
    if(!expiryBadge) return; const iso=expiryBadge.title; if(!iso) return;
    const end=new Date(iso); if(isNaN(end.getTime())){ expiryBadge.textContent="expiry unknown"; return; }
    function tick(){
      const now=new Date(); let ms=end-now; const expired=ms<=0; if(expired) ms=Math.abs(ms);
      const sec=Math.floor(ms/1000), m=Math.floor(sec/60), h=Math.floor(m/60), d=Math.floor(h/24);
      let text;
      if(expired){ if(m<1) text="expired just now"; else if(h<1) text=`expired ${m} min ago`; else if(d<1) text=`expired ${h} hr ago`; else text=`expired ${d} d ago`; expiryBadge.classList.add('text-danger'); }
      else { if(h<1) text=`expires in ${m} min`; else if(d<1) text=`expires in ${h} hr`; else text=`expires in ${d} d`; expiryBadge.classList.remove('text-danger'); }
      expiryBadge.textContent=text;
    }
    tick(); setInterval(tick, 30000);
  }

  if(nameInput) nameInput.addEventListener('input', updateGreeting);
  if(p1){ p1.addEventListener('input', updateStrength); p1.addEventListener('input', updateMatch); }
  if(p2) p2.addEventListener('input', updateMatch);
  updateGreeting(); updateStrength(); renderExpiryBadge();
})();
</script>
{% endblock %}
