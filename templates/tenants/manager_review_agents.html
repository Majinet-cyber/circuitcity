{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block content %}

<style>
  .glass{background:linear-gradient(180deg,rgba(255,255,255,.78),rgba(255,255,255,.6));border:1px solid rgba(226,232,240,.9);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:16px;box-shadow:0 10px 30px rgba(2,8,23,.06)}
  .glass-ghost{background:rgba(248,250,252,.5);border:1px dashed rgba(203,213,225,.9);border-radius:14px}
  .section-title{font-weight:800;font-size:1.05rem;color:#0b1220}
  .muted{color:#64748b}
  .small{font-size:.875rem}
  .btn{display:inline-flex;align-items:center;gap:.45rem;border:1px solid rgba(15,23,42,.12);background:#fff;border-radius:10px;padding:.45rem .7rem;font-weight:700;font-size:.85rem;text-decoration:none;color:#0b1220;cursor:pointer}
  .btn-filter{background:#f8fafc}
  .btn-filter.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
  .btn-copy{background:#f8fafc}
  .btn-wa{background:#e8fff1;color:#065f46}
  .btn-mail{background:#f3f7ff;color:#075985}
  .mono-link{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
  .ellipsis{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .table{width:100%;border-collapse:separate;border-spacing:0}
  .table th,.table td{padding:.6rem .75rem;font-size:.9rem;vertical-align:middle}
  .table thead th{background:#f8fafc;border-bottom:1px solid #e2e8f0;font-weight:800}
  .chip{display:inline-flex;align-items:center;padding:.2rem .55rem;border-radius:9999px;font-size:.72rem;font-weight:700}
  .status--sent{background:rgba(2,132,199,.1);color:#0369a1}
  .status--accepted{background:rgba(22,163,74,.15);color:#065f46}
  .status--revoked{background:rgba(148,163,184,.2);color:#334155}
  .status--rejected{background:rgba(234,88,12,.15);color:#9a3412}
  .status--expired{background:rgba(244,63,94,.15);color:#9f1239}
</style>

<div class="container py-4" style="max-width:1100px;">
  <h1 class="h5 fw-bold mb-3">Agents <span class="muted">· {{ tenant.name }}</span></h1>

  <div class="row g-4">
    <!-- Create Invite -->
    <div class="col-12 col-lg-6">
      <div class="glass p-3 p-md-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="section-title">Create an invite</div>
          <span class="small muted">Quick share later</span>
        </div>
        <form method="post" action="{% url 'tenants:create_agent_invite' %}">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label fw-semibold">Invited name</label>
            <input type="text" name="invited_name" class="form-control" placeholder="e.g. Alice" required>
          </div>
          <input type="hidden" name="email" value="">
          <input type="hidden" name="phone" value="">
          <button class="btn">Create Invite</button>
          <div class="small muted mt-2">Share text: “Hi &lt;name&gt;, please click this link to join {{ tenant.name }}.”</div>
        </form>

        <!-- Share-this-link (only when latest_link exists) -->
        <div id="share-box" class="glass-ghost p-3 mt-3" style="{% if not latest_link|default:'' %}display:none{% endif %}">
          <div class="section-title mb-2">Share this link</div>
          <div class="input-group">
            <input id="latest-invite-link" type="text" class="form-control mono-link" readonly value="{{ latest_link|default:'' }}">
            <button id="copy-link" class="btn btn-copy" type="button">Copy</button>

            {% with link=latest_link|default:'' %}
              {% with share_text="Hi there, please click this link to join "|add:tenant.name|add:": "|add:link %}
                <a id="wa-share" class="btn btn-wa" target="_blank" rel="noopener"
                   href="https://wa.me/?text={{ share_text|urlencode }}">WhatsApp</a>
                <a id="mail-share" class="btn btn-mail"
                   href="mailto:?subject={{ 'Join '|add:tenant.name|urlencode }}&body={{ share_text|urlencode }}">Email</a>
              {% endwith %}
            {% endwith %}
          </div>
          {% if latest_share %}
            <small class="text-muted d-block mt-2">{{ latest_share }}</small>
          {% endif %}
        </div>

        <script>
        (function(){
          const btn = document.getElementById('copy-link');
          const inp = document.getElementById('latest-invite-link');
          if(btn && inp){
            btn.addEventListener('click', async function(){
              try { await navigator.clipboard.writeText(inp.value); btn.textContent='Copied'; setTimeout(()=>btn.textContent='Copy', 1000); }
              catch(_) { inp.select(); document.execCommand('copy'); btn.textContent='Copied'; setTimeout(()=>btn.textContent='Copy', 1000); }
            });
          }
        })();
        </script>
      </div>
    </div>

    <!-- Pending Invites -->
    <div class="col-12 col-lg-6">
      <div class="glass p-3 p-md-4">
        <div class="section-title mb-2">Pending invites</div>
        {% if invites_pending %}
          <ul class="mb-0">
            {% for inv in invites_pending %}
              <li class="d-flex justify-content-between align-items-center py-2">
                <div>
                  <strong>{{ inv.display_name|default:"Unnamed" }}</strong>
                  <small class="muted"> • sent {{ inv.created_at|naturaltime }}</small>
                </div>
                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-copy btn-sm" data-copy="{{ inv.share_copy_text }}"
                          onclick="navigator.clipboard.writeText(this.dataset.copy)">Copy</button>
                  <a class="btn btn-wa btn-sm" href="{{ inv.share_wa }}" target="_blank" rel="noopener">WhatsApp</a>
                  <a class="btn btn-mail btn-sm" href="{{ inv.share_mailto }}">Email</a>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="glass-ghost p-3 text-center muted">No pending invites.</div>
        {% endif %}
      </div>
    </div>

    <!-- Active agents -->
    <div class="col-12">
      <div class="glass p-3 p-md-4">
        <div class="section-title mb-2">Active agents</div>
        {% if active_members %}
          <ul class="mb-0">
            {% for m in active_members %}
              <li class="d-flex justify-content-between align-items-center py-1">
                <span>{{ m.user }}</span>
                <span class="muted small">{{ m.created_at|date:"M j, Y H:i" }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="glass-ghost p-3 text-center muted">No active agents yet.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- INVITES (rotator + all) -->
  <div class="glass p-3 p-md-4 mt-4">
    <div class="d-flex justify-content-between align-items-center">
      <div class="section-title">Invites</div>
      <div class="d-flex gap-2 align-items-center">
        <button class="btn btn-filter active" data-filter="unattended">Unattended</button>
        <button class="btn btn-filter" data-filter="all">All</button>
        <button class="btn btn-filter" data-filter="accepted">Accepted</button>
        <button class="btn btn-filter" data-filter="declined">Declined</button>
        <button class="btn btn-filter" data-filter="revoked">Revoked</button>
        <button class="btn btn-filter" data-filter="expired">Expired</button>
        <button class="btn" id="toggleAll">View all</button>
      </div>
    </div>

    {% if invites_all %}
      <div id="inviteSource" class="d-none">
        {% for inv in invites_all %}
          <div
            data-name="{{ inv.display_name|default:'there' }}"
            data-status="{{ inv.status }}"
            data-url="{{ inv.share_url }}"
            data-created="{{ inv.created_at|date:'c' }}"
          ></div>
        {% endfor %}
      </div>

      <div class="p-3 border rounded-3 mt-3">
        <div class="small muted mb-1">Invite</div>
        <div class="fw-bold" id="rotName">—</div>
        <a id="rotLink" href="#" target="_blank" rel="noopener" class="mono-link ellipsis d-inline-block" style="max-width:100%;">—</a>

        <div class="d-flex flex-wrap gap-2 mt-2">
          <button class="btn" id="prevBtn" title="Previous">◀</button>
          <button class="btn" id="nextBtn" title="Next">▶</button>
          <button class="btn" id="pauseBtn" title="Pause/Play">Pause</button>
          <button class="btn btn-copy" id="copyBtn" title="Copy invite link">Copy</button>
          <a class="btn btn-wa" id="waBtn" target="_blank" rel="noopener">WhatsApp</a>
          <a class="btn btn-mail" id="mailBtn">Email</a>
        </div>

        <div class="small muted mt-2" id="rotMeta">—</div>
      </div>

      <div id="allInvites" class="mt-3" style="display:none;">
        <div class="table-responsive">
          <table class="table">
            <thead><tr><th>Name</th><th>Link</th><th>Status</th><th>Created</th><th style="width:220px">Share</th></tr></thead>
            <tbody>
              {% for inv in invites_all %}
              <tr>
                <td>{{ inv.display_name|default:"—" }}</td>
                <td class="mono-link ellipsis"><a href="{{ inv.share_url }}" target="_blank" rel="noopener">{{ inv.share_url }}</a></td>
                <td>
                  {% with s=inv.status|upper %}
                    {% if s == "SENT" or s == "PENDING" %}
                      <span class="chip status--sent">Sent</span>
                    {% elif s == "JOINED" or s == "ACCEPTED" or s == "ACTIVE" %}
                      <span class="chip status--accepted">Accepted</span>
                    {% elif s == "REVOKED" %}
                      <span class="chip status--revoked">Revoked</span>
                    {% elif s == "REJECTED" %}
                      <span class="chip status--rejected">Declined</span>
                    {% elif s == "EXPIRED" or inv.is_expired %}
                      <span class="chip status--expired">Expired</span>
                    {% else %}
                      <span class="chip">{{ inv.status|title }}</span>
                    {% endif %}
                  {% endwith %}
                </td>
                <td class="small muted">{{ inv.created_at|date:"M j, Y H:i" }}</td>
                <td>
                  <div class="d-flex gap-2">
                    <button type="button" class="btn btn-copy btn-sm" data-copy="{{ inv.share_copy_text }}"
                            onclick="navigator.clipboard.writeText(this.dataset.copy)">Copy</button>
                    <a class="btn btn-wa btn-sm" href="{{ inv.share_wa }}" target="_blank" rel="noopener">WhatsApp</a>
                    <a class="btn btn-mail btn-sm" href="{{ inv.share_mailto }}">Email</a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% else %}
      <div class="glass-ghost p-3 text-center muted mt-3">No invites yet.</div>
    {% endif %}
  </div>
</div>

<script>
(function(){
  const enc = s => encodeURIComponent(s);
  const shorten = (s, n=84) => s && s.length>n ? s.slice(0,n-1)+'…' : s;

  const src = document.getElementById('inviteSource');
  if (!src) return;

  const raw = Array.from(src.querySelectorAll('[data-url]')).map(el => {
    const s = (el.dataset.status || '').toUpperCase();
    let bucket = 'all';
    if (s === 'SENT' || s === 'PENDING') bucket = 'unattended';
    else if (s === 'ACCEPTED' || s === 'JOINED' || s === 'ACTIVE') bucket = 'accepted';
    else if (s === 'REVOKED') bucket = 'revoked';
    else if (s === 'REJECTED') bucket = 'declined';
    else if (s === 'EXPIRED') bucket = 'expired';
    return { name: el.dataset.name || 'there', statusRaw: s, bucket, url: el.dataset.url, created: el.dataset.created || '' };
  });

  let filter = 'unattended';
  let idx = 0, timer = null, paused = false;

  const $name = document.getElementById('rotName');
  const $link = document.getElementById('rotLink');
  const $meta = document.getElementById('rotMeta');
  const $copy = document.getElementById('copyBtn');
  const $wa   = document.getElementById('waBtn');
  const $mail = document.getElementById('mailBtn');

  function filtered(){ return filter === 'all' ? raw : raw.filter(x => x.bucket === filter); }

  function setShare(url, name){
    const shop = "{{ tenant.name|escapejs }}";
    const msg = `Hi ${name || 'there'}, please click this link to join ${shop}: ${url}`;
    $copy.onclick = async () => {
      try{ await navigator.clipboard.writeText(msg); $copy.textContent='Copied!'; setTimeout(()=>{$copy.textContent='Copy'},900); }
      catch(_){ alert('Copy failed'); }
    };
    $wa.href = `https://wa.me/?text=${enc(msg)}`;
    $mail.href = `mailto:?subject=${enc('Join ' + shop)}&body=${enc(msg)}`;
  }

  function show(i){
    const list = filtered();
    if (!list.length){
      $name.textContent = '—';
      $link.textContent = 'No invites in this filter';
      $link.removeAttribute('href');
      $meta.textContent = '';
      setShare('', '');
      return;
    }
    const safe = ((i % list.length)+list.length)%list.length;
    idx = safe;
    const item = list[safe];
    $name.textContent = item.name;
    $link.textContent = shorten(item.url);
    $link.href = item.url;
    const label = item.bucket.charAt(0).toUpperCase() + item.bucket.slice(1);
    const when = item.created ? new Date(item.created).toLocaleString() : '';
    $meta.textContent = `${label}${when ? ' • ' + when : ''}`;
    setShare(item.url, item.name);
  }

  function next(){ show(idx+1); }
  function prev(){ show(idx-1); }
  function start(){ stop(); timer = setInterval(next, 5000); }
  function stop(){ if (timer) clearInterval(timer); timer = null; }

  document.getElementById('nextBtn')?.addEventListener('click', next);
  document.getElementById('prevBtn')?.addEventListener('click', prev);
  const pauseBtn = document.getElementById('pauseBtn');
  pauseBtn?.addEventListener('click', () => {
    paused = !paused;
    pauseBtn.textContent = paused ? 'Play' : 'Pause';
    if (paused) stop(); else start();
  });

  document.querySelectorAll('.btn-filter').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.btn-filter').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      filter = btn.dataset.filter || 'unattended';
      idx = 0;
      show(0);
    });
  });

  document.getElementById('toggleAll')?.addEventListener('click', () => {
    const box = document.getElementById('allInvites');
    const visible = box && box.style.display !== 'none';
    if (box){ box.style.display = visible ? 'none' : 'block'; }
    document.getElementById('toggleAll').textContent = visible ? 'View all' : 'Hide';
  });

  show(0);
  start();
})();
</script>

{% endblock %}
