{# templates/dashboard/agent.html #}
{% extends "base.html" %}
{% load static humanize %}
{% block title %}Agent ¬∑ Circuit City{% endblock %}

{% block body %}
<style>
  /* =========================================================
     Agent Dashboard (v2)
     Uses global tokens: --cc-bg, --cc-panel, --cc-panel-2, --cc-border,
     --cc-text, --cc-muted, --cc-accent, --cc-accent-2, --cc-shadow, --radius
     ========================================================= */

  :root{
    --agent-sidebar-w: 240px;
    --agent-sidebar-w-collapsed: 76px;
    --agent-br: var(--radius, 12px);
  }

  html, body { background: var(--cc-bg); color: var(--cc-text); }

  /* ---- Layout ---- */
  .layout{
    display:grid; grid-template-columns: var(--agent-sidebar-w) 1fr;
    min-height:100dvh;
  }
  .layout.collapsed{ grid-template-columns: var(--agent-sidebar-w-collapsed) 1fr; }

  /* ---- Sidebar ---- */
  .sidebar{
    position:sticky; top:0; height:100dvh; overflow:auto;
    display:flex; flex-direction:column;
    background: var(--cc-panel);
    border-right:1px solid var(--cc-border);
    box-shadow: var(--cc-shadow);
  }
  .brandbar{
    display:flex; align-items:center; gap:.6rem; padding:.9rem;
    border-bottom:1px solid var(--cc-border);
    background: color-mix(in oklab, var(--cc-panel-2) 60%, transparent);
    position: sticky; top:0; z-index:1;
  }
  .brandlogo{
    width:32px; height:32px; border-radius:8px;
    background: linear-gradient(135deg, var(--cc-accent), var(--cc-accent-2));
    box-shadow: 0 6px 18px color-mix(in oklab, var(--cc-accent) 28%, transparent);
  }
  .brandname{ font-weight:800; letter-spacing:.3px; white-space:nowrap; }
  .collapse-btn{
    margin-left:auto; width:38px; height:32px; border-radius:10px;
    background: var(--cc-panel-2); border:1px solid var(--cc-border);
    display:grid; place-items:center; cursor:pointer;
  }
  .collapse-btn:hover{ box-shadow: 0 0 0 6px color-mix(in oklab, var(--cc-accent) 28%, transparent); }

  .menu{ padding:.5rem; }
  .menu .section{
    margin:.75rem .5rem .35rem; color:var(--cc-muted);
    font-size:.8rem; text-transform:uppercase; letter-spacing:.12rem;
  }
  .menu a{
    display:flex; align-items:center; gap:.8rem;
    padding:.6rem .7rem; margin:.2rem 0; border-radius:10px;
    color:var(--cc-text); text-decoration:none; font-weight:650;
  }
  .menu a .mi{
    width:22px; height:22px; display:grid; place-items:center; border-radius:8px;
    background: var(--cc-panel-2); border:1px solid var(--cc-border);
    font-size:.9rem;
  }
  .menu a:hover{ background: color-mix(in oklab, var(--cc-accent) 8%, transparent); }
  .menu a.active{
    background: linear-gradient(180deg, var(--cc-panel-2), var(--cc-panel));
    border:1px solid var(--cc-border);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
  }
  .layout.collapsed .label, .layout.collapsed .section{ display:none; }

  /* ---- Main ---- */
  .content{ padding:1.25rem; }
  .container{
    max-width:1100px; margin:auto;
    background: var(--cc-panel);
    border:1px solid var(--cc-border);
    border-radius: var(--agent-br);
    box-shadow: var(--cc-shadow);
  }
  .row{ display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; }
  .muted{ color: var(--cc-muted); }
  .brand{ font-weight:800; letter-spacing:.2px; }

  /* Inputs / controls */
  .toolbar{ display:flex; gap:.5rem; align-items:center; padding:.6rem .75rem;
            background: var(--cc-panel-2); border-radius:12px; border:1px solid var(--cc-border); }
  .input, select, textarea{
    background: var(--cc-panel-2); color: var(--cc-text);
    border:1px solid var(--cc-border);
    padding:.55rem .7rem; border-radius:10px; outline:0;
  }
  .input:focus, select:focus, textarea:focus{
    box-shadow: 0 0 0 6px color-mix(in oklab, var(--cc-accent) 28%, transparent);
    border-color: color-mix(in oklab, var(--cc-accent) 38%, var(--cc-border));
  }

  /* Buttons / badges */
  .btn{
    --b: var(--cc-accent);
    display:inline-flex; align-items:center; gap:.45rem;
    background: var(--b); color:#fff; font-weight:700; border:0;
    padding:.6rem .9rem; border-radius:10px; box-shadow: 0 4px 12px color-mix(in oklab, var(--cc-accent) 30%, transparent);
    text-decoration:none; line-height:1; cursor:pointer;
  }
  .btn:hover{ filter:brightness(1.06); }
  .btn.ghost{
    background: transparent; color: var(--cc-text);
    border:1px solid var(--cc-border); box-shadow:none;
  }
  .badge{
    border-radius:999px; padding:.18rem .55rem; font-weight:800;
    border:1px solid var(--cc-border);
    background: color-mix(in oklab, var(--cc-accent) 8%, transparent);
    color: var(--cc-text);
  }
  .divider{ height:1px; background: var(--cc-border); margin: 1rem 0; }

  /* Tiles / stats */
  .grid{ display:grid; gap:.75rem; }
  .grid-auto{ grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
  .stat{
    padding:1rem; background: linear-gradient(180deg, var(--cc-panel), var(--cc-panel-2));
    border:1px solid var(--cc-border); border-radius:16px;
  }
  .stat h4{ margin:0 0 .25rem; font-size:.9rem; color:var(--cc-muted); font-weight:700; }
  .stat .big{ font-size:1.8rem; font-weight:800; letter-spacing:.3px; }

  /* Table */
  .table-wrap{ overflow:auto; border:1px solid var(--cc-border); border-radius:14px; background: var(--cc-panel-2); }
  table.data{
    width:100%; border-collapse:separate; border-spacing:0; min-width:560px;
    background: linear-gradient(180deg, var(--cc-panel), var(--cc-panel-2));
  }
  .data th, .data td{ padding:.75rem .85rem; border-bottom:1px solid var(--cc-border); text-align:left; white-space:nowrap; }
  .data thead th{
    font-size:.8rem; text-transform:uppercase; letter-spacing:.12rem; color:var(--cc-muted);
    background: color-mix(in oklab, var(--cc-panel-2) 70%, transparent);
  }

  /* Avatars */
  .avatar{ width:36px; height:36px; border-radius:50%; display:inline-grid; place-items:center;
           font-weight:800; color:#fff; overflow:hidden;
           background: linear-gradient(135deg, var(--cc-accent), var(--cc-accent-2)); }
  .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }

  /* Responsive */
  @media(max-width:960px){
    .layout{ grid-template-columns: var(--agent-sidebar-w-collapsed) 1fr; }
  }
</style>

<div id="rootLayout" class="layout">
  <!-- Sidebar -->
  <aside class="sidebar" aria-label="Main">
    <div class="brandbar">
      <div class="brandlogo" aria-hidden="true"></div>
      <div class="brandname label">Circuit City</div>
      <button id="collapseBtn" class="collapse-btn" aria-pressed="false" title="Collapse sidebar">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    {% with current=request.resolver_match.url_name %}
    <nav class="menu">
      <div class="section">General</div>
      <a href="{% url 'agent_dashboard' %}" class="{% if current == 'agent_dashboard' %}active{% endif %}">
        <span class="mi">üè†</span><span class="label">My Dashboard</span>
      </a>
      <a href="{% url 'inventory:stock_list' %}">
        <span class="mi">üìã</span><span class="label">Stock List</span>
      </a>
      <a href="{% url 'inventory:scan_in' %}">
        <span class="mi">‚ûï</span><span class="label">Scan Stock IN</span>
      </a>
      <a href="{% url 'inventory:scan_sold' %}">
        <span class="mi">‚úÖ</span><span class="label">Scan SOLD</span>
      </a>

      <div class="section">Account</div>
      {% url 'logout' as logout_url %}
      <a href="{{ logout_url|default:'/logout/' }}">
        <span class="mi">üö™</span><span class="label">Logout</span>
      </a>
    </nav>
    {% endwith %}
  </aside>

  <!-- Content -->
  <main class="content">
    <div class="container" style="padding:1.1rem">
      <!-- Header -->
      <div class="row" style="justify-content:space-between; margin-bottom:1rem; border-bottom:1px solid var(--cc-border); padding-bottom:.6rem">
        <h2 class="brand" style="margin:0">Agent Dashboard</h2>
        <div class="row">
          <!-- Theme rotate: style-1 ‚Üí style-2 ‚Üí style-3 -->
          <label class="row" style="gap:.4rem">
            <span class="muted">Theme</span>
            <button id="themeRotate" class="btn ghost" type="button" aria-pressed="false" title="Rotate theme">üé®</button>
          </label>
          <span class="avatar" title="{{ request.user.get_username }}">
            {% if request.user.agent_profile and request.user.agent_profile.photo_url %}
              <img src="{{ request.user.agent_profile.photo_url }}" alt="Me">
            {% elif request.user.profile and request.user.profile.avatar %}
              <img src="{{ request.user.profile.avatar.url }}" alt="Me">
            {% else %}
              {{ request.user.first_name|default:request.user.username|first|upper }}
            {% endif %}
          </span>
        </div>
      </div>

      <!-- Tiles -->
      {% with b=agent_battery w=wallet %}
      <div class="grid grid-auto" style="margin-bottom:.9rem">
        <div class="stat">
          <h4>My In Stock</h4>
          <div class="big">{{ b.count|default:0|intcomma }}</div>
        </div>

        <div class="stat">
          <h4>My Sold</h4>
          <div class="big">{{ kpis.mtd_count|default:0|intcomma }}</div>
        </div>

        <div class="stat">
          <h4>My Commission</h4>
          <div class="big">MK {{ w.month.commission|default:0|floatformat:0|intcomma }}</div>
        </div>

        <div class="stat">
          <h4>Stock Status</h4>
          <div class="row">
            <span class="badge">{{ b.label|default:"‚Äî" }}</span>
            <div class="muted">{{ b.count|default:0|intcomma }}/{{ b.max|default:0|intcomma }} ({{ b.pct|default:0 }}%)</div>
          </div>
        </div>

        <div class="stat">
          <h4>My Wallet</h4>
          <div class="big">MK {{ w.balance|default:0|floatformat:0|intcomma }}</div>
          <div class="muted" style="font-size:.85rem;margin-top:.25rem">
            {{ w.month.month_label|default:"This month" }} ¬∑
            Comm {{ w.month.commission|default:0|floatformat:0|intcomma }}
            {% if w.month.advance %} ¬∑ Adv {{ w.month.advance|floatformat:0|intcomma }}{% endif %}
            {% if w.month.adjustment %} ¬∑ Adj {{ w.month.adjustment|floatformat:0|intcomma }}{% endif %}
            ¬∑ <strong>Total {{ w.month.total|default:0|floatformat:0|intcomma }}</strong>
          </div>
        </div>
      </div>
      {% endwith %}

      <!-- Log arrival -->
      <div class="stat" style="margin-bottom:1rem">
        <form method="post" class="grid" style="grid-template-columns:1fr auto; gap:.6rem; align-items:center">
          {% csrf_token %}
          <input type="hidden" name="action" value="log_time">
          {% now "Y-m-d\\TH:i" as _now_val %}
          <input class="input" type="datetime-local" name="logged_at" value="{{ _now_val }}" aria-label="Log time" />
          <button class="btn" type="submit">Log arrival ({% now "M. d, Y" %})</button>
          <textarea class="input" name="note" placeholder="Optional note (e.g., opening)"></textarea>
        </form>
        <div class="muted" style="margin-top:.4rem; font-size:.9rem">
          ‚Ä¢ Sunday logs: +MK15,000 bonus ‚Ä¢ ‚â§08:00: +MK5,000 ‚Ä¢ After 08:00: ‚àíMK5,000 per 30 minutes late.
        </div>
      </div>

      <!-- Wallet tiles -->
      <div class="grid grid-auto" style="margin-bottom:1rem">
        <div class="stat"><h4>Base salary</h4><div class="big">MK {{ base_salary|default:0|floatformat:0|intcomma }}</div></div>
        <div class="stat"><h4>Monthly commission</h4><div class="big">MK {{ wallet.month.commission|default:0|floatformat:0|intcomma }}</div></div>
        <div class="stat"><h4>Bonuses/Deductions (This month)</h4><div class="big">MK {{ month_txn_total|default:0|floatformat:0|intcomma }}</div></div>
        <div class="stat"><h4>Deductions (This month)</h4><div class="big">MK {{ month_deductions|default:0|floatformat:0|intcomma }}</div></div>
      </div>

      <div class="divider"></div>

      <!-- AI Recommendations -->
      <div class="stat" style="margin-bottom:1rem">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h3 class="brand" style="margin:0">AI Recommendations</h3>
          <button id="recoRefresh" class="btn ghost" type="button" aria-label="Refresh recommendations">‚Üª Refresh</button>
        </div>
        <ul id="ai-recos" style="margin:.6rem 0 0 1rem; padding-left:1rem"></ul>
        <div id="recoStatus" class="muted" style="font-size:.9rem; margin-top:.4rem">Loading‚Ä¶</div>
      </div>

      <!-- Recent logs -->
      <h3 class="brand" style="margin:.2rem 0 .6rem">Recent Time Logs</h3>
      <div class="table-wrap">
        <table class="data" role="table" aria-label="Recent time logs">
          <thead>
            <tr><th>Date</th><th>Local Time</th><th>Note</th></tr>
          </thead>
          <tbody>
            {% for l in last_logs %}
              <tr>
                <td>{{ l.logged_at|date:"Y-m-d" }}</td>
                <td>{{ l.logged_at|date:"H:i" }}</td>
                <td class="muted">{{ l.note }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="3" class="muted">No logs yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </main>
</div>

<script>
/* Sidebar collapse (persist) */
(function(){
  const key='cc-sidebar';
  const layout=document.getElementById('rootLayout');
  const btn=document.getElementById('collapseBtn');
  function apply(state){
    layout.classList.toggle('collapsed', state==='collapsed');
    btn.setAttribute('aria-pressed', state==='collapsed' ? 'true' : 'false');
  }
  const saved=localStorage.getItem(key)||'expanded';
  apply(saved);
  btn.addEventListener('click',()=>{
    const next=layout.classList.contains('collapsed')?'expanded':'collapsed';
    localStorage.setItem(key,next); apply(next);
  });
})();

/* Theme rotate (persist, syncs with base) */
(function(){
  const KEY="cc-theme";
  const THEMES=["style-1","style-2","style-3"];
  const root=document.documentElement;
  const btn=document.getElementById('themeRotate');
  function idx(){ return Math.max(0, THEMES.indexOf(root.getAttribute('data-theme') || THEMES[0])); }
  function apply(theme){
    root.setAttribute('data-theme', theme);
    localStorage.setItem(KEY, theme);
    btn.setAttribute('aria-pressed', theme !== THEMES[0] ? 'true' : 'false');
    window.dispatchEvent(new CustomEvent('theme:changed',{detail:{theme}}));
  }
  const saved = localStorage.getItem(KEY) || root.getAttribute('data-theme') || THEMES[0];
  apply(saved);
  btn?.addEventListener('click', ()=>{
    const next = THEMES[(idx()+1)%THEMES.length];
    apply(next);
  });
})();

/* AI Recommendations fetch (robust endpoints) */
(function(){
  const list = document.getElementById('ai-recos');
  const status = document.getElementById('recoStatus');
  const refreshBtn = document.getElementById('recoRefresh');

  function esc(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

  const RECO_ENDPOINTS = [
    '/api/recommendations/', '/recommendations/', '/ai/recommendations/'
  ];

  async function fetchFirstOk(urls){
    for(const u of urls){
      try{
        const res = await fetch(u, { credentials:'same-origin', headers:{Accept:'application/json'} });
        if(res.ok) return await res.json();
      }catch(_){}
    }
    return null;
  }

  async function loadRecos(){
    try{
      status.textContent = 'Loading‚Ä¶';
      list.innerHTML = '';
      const data = await fetchFirstOk(RECO_ENDPOINTS);
      const items = data?.items || [];
      if(!items.length){
        list.innerHTML = '<li class="muted">No recommendations right now.</li>';
      }else{
        list.innerHTML = items.map(i => {
          const pct = (i.confidence!=null) ? ` <small class="muted">${Math.round(i.confidence*100)}%</small>` : '';
          return `<li>${esc(i.message || i.text || '')}${pct}</li>`;
        }).join('');
      }
      status.textContent = 'Updated';
      setTimeout(()=>{ if(status.textContent==='Updated') status.textContent=''; }, 1500);
    }catch(err){
      console.error('reco fetch failed', err);
      status.textContent = 'Could not load predictions';
      list.innerHTML = '<li class="muted">Could not load predictions.</li>';
    }
  }

  refreshBtn?.addEventListener('click', loadRecos);
  loadRecos();
})();
</script>
{% endblock %}
