{# templates/dash/admin_dashboard.html #}
{% extends "base.html" %}
{% load static %}
{% block title %}Admin ¬∑ Circuit City{% endblock %}

{% block body %}
<style>
  /* =========================================================
     Admin Dashboard (v2) ‚Äì SUPERUSER view
     ========================================================= */
  :root{
    --admin-sidebar-w: 240px;
    --admin-sidebar-w-collapsed: 76px;
    --admin-br: var(--radius, 12px);
  }
  html, body { background: var(--cc-bg); color: var(--cc-text); }

  /* ---- Layout ---- */
  .layout{ display:grid; grid-template-columns: var(--admin-sidebar-w) 1fr; min-height:100dvh; }
  .layout.collapsed{ grid-template-columns: var(--admin-sidebar-w-collapsed) 1fr; }

  /* ---- Sidebar ---- */
  .sidebar{
    position:sticky; top:0; height:100dvh; overflow:auto;
    display:flex; flex-direction:column;
    background:var(--cc-panel); border-right:1px solid var(--cc-border); box-shadow:var(--cc-shadow);
  }
  .brandbar{
    display:flex; align-items:center; gap:.6rem; padding:.9rem;
    border-bottom:1px solid var(--cc-border);
    background:color-mix(in oklab, var(--cc-panel-2) 60%, transparent);
    position:sticky; top:0; z-index:1;
  }
  .brandlogo{
    width:32px; height:32px; border-radius:8px;
    background:linear-gradient(135deg, var(--cc-accent), var(--cc-accent-2));
    box-shadow:0 6px 18px color-mix(in oklab, var(--cc-accent) 28%, transparent);
  }
  .brandname{ font-weight:800; letter-spacing:.3px; white-space:nowrap; }
  .collapse-btn{
    margin-left:auto; width:38px; height:32px; border-radius:10px;
    background:var(--cc-panel-2); border:1px solid var(--cc-border);
    display:grid; place-items:center; cursor:pointer;
  }
  .collapse-btn:hover{ box-shadow:0 0 0 6px color-mix(in oklab, var(--cc-accent) 28%, transparent); }

  .menu{ padding:.5rem; }
  .menu .section{ margin:.75rem .5rem .35rem; color:var(--cc-muted); font-size:.8rem; text-transform:uppercase; letter-spacing:.12rem; }
  .menu a{
    display:flex; align-items:center; gap:.8rem;
    padding:.6rem .7rem; margin:.2rem 0; border-radius:10px;
    color:var(--cc-text); text-decoration:none; font-weight:650;
  }
  .menu a .mi{
    width:22px; height:22px; display:grid; place-items:center; border-radius:8px;
    background:var(--cc-panel-2); border:1px solid var(--cc-border); font-size:.9rem;
  }
  .menu a:hover{ background:color-mix(in oklab, var(--cc-accent) 8%, transparent); }
  .menu a.active{
    background:linear-gradient(180deg, var(--cc-panel-2), var(--cc-panel));
    border:1px solid var(--cc-border); box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
  }
  .layout.collapsed .label, .layout.collapsed .section{ display:none; }

  /* ---- Main ---- */
  .content{ padding:1.25rem; }
  .container{
    max-width:1200px; margin:auto;
    background:var(--cc-panel); border:1px solid var(--cc-border);
    border-radius:var(--admin-br); box-shadow:var(--cc-shadow);
  }

  .row{ display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; }
  .muted{ color:var(--cc-muted); }
  .brand{ font-weight:800; letter-spacing:.2px; }

  /* Toolbar / filters */
  .toolbar{
    display:flex; gap:.5rem; align-items:center;
    padding:.6rem .75rem; background:var(--cc-panel-2);
    border-radius:12px; border:1px solid var(--cc-border);
  }
  .input, select{
    background:var(--cc-panel-2); color:var(--cc-text);
    border:1px solid var(--cc-border);
    padding:.55rem .7rem; border-radius:10px; outline:0;
  }
  .input:focus, select:focus{
    box-shadow:0 0 0 6px color-mix(in oklab, var(--cc-accent) 28%, transparent);
    border-color:color-mix(in oklab, var(--cc-accent) 38%, var(--cc-border));
  }

  /* Buttons */
  .btn{
    --b: var(--cc-accent);
    display:inline-flex; align-items:center; gap:.5rem;
    background:var(--b); color:#fff; font-weight:700; border:0;
    padding:.55rem .9rem; border-radius:10px;
    box-shadow:0 4px 12px color-mix(in oklab, var(--cc-accent) 30%, transparent);
    text-decoration:none; line-height:1; cursor:pointer;
  }
  .btn:hover{ filter:brightness(1.06); }
  .btn.ok{ --b:#16a34a; }
  .btn.ghost{ background:transparent; color:var(--cc-text); border:1px solid var(--cc-border); box-shadow:none; }
  .btn.icon svg{ width:18px; height:18px; }
  .btn-group{ display:flex; gap:.5rem; flex-wrap:wrap; }

  /* Chips / toggles */
  .chip{
    background:color-mix(in oklab, var(--cc-accent) 6%, var(--cc-panel));
    border:1px solid var(--cc-border); color:var(--cc-text);
    padding:.35rem .7rem; border-radius:999px; font-weight:600; cursor:pointer;
  }
  .toggle{ width:42px; height:26px; background:var(--cc-panel-2); border-radius:999px; border:1px solid var(--cc-border); position:relative; cursor:pointer; }
  .toggle i{ position:absolute; top:2px; left:2px; width:22px; height:22px; border-radius:999px; background:var(--cc-accent); transition:transform .25s ease; }
  .toggle.on i{ transform:translateX(16px); }

  /* Stats */
  .grid{ display:grid; gap:.75rem; }
  .grid-auto{ grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); }
  .stat{
    padding:1rem; background:linear-gradient(180deg, var(--cc-panel), var(--cc-panel-2));
    border:1px solid var(--cc-border); border-radius:var(--admin-br);
  }
  .stat h4{ margin:0 0 .25rem; font-size:.9rem; color:var(--cc-muted); font-weight:700; }
  .stat .big{ font-size:1.8rem; font-weight:800; letter-spacing:.3px; }

  /* Table */
  .table-wrap{ overflow:auto; border:1px solid var(--cc-border); border-radius:14px; background:var(--cc-panel-2); }
  table.data{ width:100%; border-collapse:separate; border-spacing:0; min-width:720px; background:linear-gradient(180deg, var(--cc-panel), var(--cc-panel-2)); }
  .data th, .data td{ padding:.75rem .85rem; border-bottom:1px solid var(--cc-border); text-align:left; white-space:nowrap; }
  .data thead th{
    font-size:.8rem; text-transform:uppercase; letter-spacing:.12rem; color:var(--cc-muted); cursor:pointer;
    background:color-mix(in oklab, var(--cc-panel-2) 70%, transparent);
  }
  .data tbody tr:hover{ background:color-mix(in oklab, var(--cc-accent) 8%, transparent); }

  .pill{ border-radius:999px; padding:.12rem .55rem; font-size:.85rem; font-weight:700; border:1px solid; }
  .pill.good{ color:#0f5132; background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.35); }
  .pill.mid{  color:#7c3a02; background:rgba(245,158,11,.18); border-color:rgba(245,158,11,.35); }
  .pill.low{  color:#7f1d1d; background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.35); }

  /* Avatars & inline uploader */
  .avatar{ width:36px; height:36px; border-radius:50%; display:inline-grid; place-items:center; font-weight:800; color:#fff; overflow:hidden;
           background:linear-gradient(135deg, var(--cc-accent), var(--cc-accent-2)); }
  .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
  .avatar-lg{ width:48px; height:48px; }
  .avatar-uploader{ position:relative; cursor:pointer; }
  .avatar-uploader input[type=file]{ position:absolute; inset:0; opacity:0; cursor:pointer; }

  .icon-btn{ background:transparent; border:1px solid var(--cc-border); color:var(--cc-text); border-radius:8px; padding:.2rem .45rem;
             font-size:.75rem; line-height:1; display:inline-flex; align-items:center; gap:.35rem; }
  .icon-btn:hover{ box-shadow:0 0 0 6px color-mix(in oklab, var(--cc-accent) 28%, transparent); }
  .name-cell{ display:flex; align-items:center; gap:.5rem }
  .name-extras{ display:flex; align-items:center; gap:.4rem }

  @media (max-width:960px){ .layout{ grid-template-columns: var(--admin-sidebar-w-collapsed) 1fr; } }
</style>

{# ---------- Soft gate: only superusers get the full admin UI ---------- #}
{% if not request.user.is_superuser %}
  <main class="content">
    <div class="container" style="padding:1.25rem">
      <h2 style="margin:0 0 .5rem">Restricted area</h2>
      <p class="muted">This view is for superusers. Your manager/agent dashboards are unaffected.</p>
      <p><a class="btn ghost" href="{% url 'dashboard:home' %}">Go to my dashboard</a></p>
    </div>
  </main>
{% else %}

<div id="rootLayout" class="layout">
  <!-- Sidebar -->
  <aside class="sidebar" aria-label="Main">
    <div class="brandbar">
      <div class="brandlogo" aria-hidden="true"></div>
      <div class="brandname label">Circuit City</div>
      <button id="collapseBtn" class="collapse-btn" aria-pressed="false" title="Collapse sidebar">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    <nav class="menu">
      <div class="section">General</div>
      <a href="{% url 'inventory:inventory_dashboard' %}">
        <span class="mi">üè†</span><span class="label">Inventory Dashboard</span>
      </a>
      <a href="{% url 'inventory:stock_list' %}">
        <span class="mi">üìã</span><span class="label">Stock List</span>
      </a>
      <a href="{% url 'inventory:scan_in' %}">
        <span class="mi">‚ûï</span><span class="label">Scan Stock IN</span>
      </a>
      <a href="{% url 'inventory:scan_sold' %}">
        <span class="mi">‚úÖ</span><span class="label">Scan SOLD</span>
      </a>

      <div class="section">Finance</div>
      <a href="{% url 'dashboard:dashboard_cfo' %}">
        <span class="mi">üíπ</span><span class="label">AI-CFO Panel</span>
      </a>

      <div class="section">Admin</div>
      <a href="{% url 'admin:index' %}">
        <span class="mi">‚öôÔ∏è</span><span class="label">Django Admin</span>
      </a>
      <a href="{% url 'reports:home' %}">
        <span class="mi">üìà</span><span class="label">Reports</span>
      </a>
      {% url 'accounts:settings_home' as settings_url %}
      {% if not settings_url %}{% url 'accounts:settings' as settings_url %}{% endif %}
      <a href="{{ settings_url|default:'/accounts/settings/' }}">
        <span class="mi">üîß</span><span class="label">Settings</span>
      </a>
    </nav>
  </aside>

  <!-- Content -->
  <main class="content">
    <div class="container">
      <!-- Header -->
      <div class="row" style="justify-content:space-between; padding:1rem; border-bottom:1px solid var(--cc-border)">
        <h2 class="brand" style="margin:0">Admin Dashboard</h2>
        <div class="row">
          <!-- Theme rotate -->
          <label class="row" style="gap:.4rem">
            <span class="muted">Theme</span>
            <button id="themeRotate" class="toggle" aria-pressed="false" title="Rotate theme"><i></i></button>
          </label>

          <!-- Period filter -->
          <form id="periodForm" method="get" class="toolbar">
            <label for="period" class="muted" style="font-weight:700">Period</label>
            <select id="period" name="period">
              <option value="month" {% if period == "month" or not period %}selected{% endif %}>This month</option>
              <option value="all" {% if period == "all" %}selected{% endif %}>All time</option>
            </select>
            <button class="btn" type="submit">Apply</button>
          </form>

          {# Current-user avatar uploader (safe fallback) #}
          {% url 'accounts:upload_my_avatar' as upload_my_avatar_url %}
          {% if not upload_my_avatar_url %}{% url 'upload_my_avatar' as upload_my_avatar_url %}{% endif %}
          {% if upload_my_avatar_url %}
            <form action="{{ upload_my_avatar_url }}" method="post" enctype="multipart/form-data" class="row">
              {% csrf_token %}
              <label class="avatar avatar-lg avatar-uploader" title="Click to change photo">
                {% if request.user.profile.avatar %}
                  <img src="{{ request.user.profile.avatar.url }}" alt="Avatar">
                {% else %}
                  {{ request.user.first_name|default:request.user.username|first|upper }}
                {% endif %}
                <input type="file" name="avatar" accept="image/*">
              </label>
              <input type="hidden" name="next" value="{{ request.path }}">
              <button type="submit" class="btn ghost">Upload</button>
            </form>
          {% else %}
            <span class="avatar avatar-lg" title="Avatar">
              {{ request.user.first_name|default:request.user.username|first|upper }}
            </span>
          {% endif %}
        </div>
      </div>

      <!-- Quick chips -->
      <div class="row" style="padding:.75rem 1rem; border-bottom:1px solid var(--cc-border)">
        <button class="chip" data-period="month" type="button">This month</button>
        <button class="chip" data-period="all" type="button">All time</button>
        <span class="muted">Tip: press <span class="kbd">/</span> to focus table search</span>
      </div>

      <!-- ‚úÖ Financial overview (AI-CFO) ‚Äì include with ‚Äòignore missing‚Äô fallbacks -->
      <div class="row" style="padding:1rem; align-items:stretch; gap:1rem;">
        <div style="flex:3 1 560px; min-width:320px;">
          {% include "dash/partials/cfo_tiles.html" ignore missing %}
          {% include "dashboard/partials/cfo_tiles.html" ignore missing %}
        </div>
        <div style="flex:1 1 280px; min-width:280px;">
          {% include "dash/partials/cfo_alerts.html" ignore missing %}
          {% include "dashboard/partials/cfo_alerts.html" ignore missing %}
        </div>
      </div>

      <!-- Business overview (superuser scope) -->
      <div class="grid grid-auto" style="padding:1rem; gap:.9rem;">
        <div class="stat">
          <h4>Active Businesses</h4>
          <div class="big">{{ active_businesses|default:"0" }}</div>
        </div>
        <div class="stat">
          <h4>Signed-up Agents</h4>
          <div class="big">{{ agents_count|default:"0" }}</div>
        </div>
        <div class="stat">
          <h4>MTD Revenue</h4>
          <div class="big">MK {{ revenue_mtd|default:0|floatformat:0 }}</div>
        </div>
        <div class="stat">
          <h4>Projected (AI)</h4>
          <div class="big">MK {{ projected_revenue|default:0|floatformat:0 }}</div>
        </div>
      </div>

      <!-- Inventory KPIs (kept from your earlier version) -->
      <div class="grid grid-auto" style="padding:0 1rem 1rem; gap:.9rem;">
        <div class="stat">
          <h4>In Stock</h4>
          <div class="row" style="gap:.6rem">
            <span class="pill mid">{{ in_stock|default:"0" }}</span>
            <div class="big">{{ in_stock|default:"0" }}</div>
          </div>
        </div>
        <div class="stat">
          <h4>Sold</h4>
          <div class="big">{{ sold|default:"0" }}</div>
        </div>
        <div class="stat">
          <h4>Sales Value</h4>
          <div class="big">MK {{ sales_value|default:0|floatformat:0 }}</div>
        </div>
        <div class="stat">
          <h4>Profit {% if period == "all" %}(All time){% else %}(This month){% endif %}</h4>
          <div class="big">MK {{ profit_value|default:0|floatformat:0 }}</div>
        </div>
      </div>

      <!-- Action bar -->
      <div class="row" style="padding:0 1rem 1rem">
        <div class="btn-group">
          <a class="btn icon" href="{% url 'inventory:inventory_dashboard' %}">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 3h8v8H3zM13 3h8v8h-8zM3 13h8v8H3zM13 13h8v8h-8z" fill="currentColor"/></svg>
            Inventory
          </a>
          <a class="btn icon" href="{% url 'inventory:scan_in' %}">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 6h16M6 12h12M9 18h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            Scan IN
          </a>
          <a class="btn ok icon" href="{% url 'inventory:scan_sold' %}">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><rect x="3" y="4" width="18" height="16" rx="3" stroke="white" stroke-width="2"/></svg>
            Scan SOLD
          </a>
          <a class="btn ghost icon" href="{% url 'inventory:stock_list' %}">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            Stock List
          </a>
          <a class="btn ghost icon" href="{% url 'admin:index' %}">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 21h18M12 3l9 9-9 9-9-9 9-9z" stroke="currentColor" stroke-width="2"/></svg>
            Django Admin
          </a>
          <a class="btn ghost icon" href="{% url 'dashboard:dashboard_cfo' %}">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3c5 0 9 4 9 9s-4 9-9 9-9-4-9-9 4-9 9-9z" stroke="currentColor" stroke-width="2"/></svg>
            Open AI-CFO
          </a>
        </div>
      </div>

      <div style="height:1px; background:var(--cc-border); margin:0 1rem 1rem;"></div>

      <!-- AI Recommendations (Admin) -->
      <div style="padding:1rem; border-top:1px solid var(--cc-border);">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h3 class="brand" style="margin:0">AI Recommendations</h3>
          <button id="recoRefreshAdmin" class="btn ghost" type="button" aria-label="Refresh recommendations">‚Üª Refresh</button>
        </div>
        <ul id="ai-recos-admin" style="margin:.6rem 0 0 1rem; padding-left:1rem"></ul>
        <div id="recoStatusAdmin" class="muted" style="font-size:.9rem; margin-top:.4rem">Loading‚Ä¶</div>
      </div>

      <!-- Agent performance -->
      <div class="row" style="justify-content:space-between; align-items:center; padding:1rem 1rem 0">
        <h3 class="brand" style="margin:0">Agent Performance</h3>
        <div class="row">
          <input id="agentSearch" class="input" placeholder="Search agent‚Ä¶ ( / )" aria-label="Search agents">
          <button id="clearSearch" class="btn ghost" type="button">Clear</button>
        </div>
      </div>

      <div class="table-wrap" style="margin:.75rem 1rem 1.25rem;">
        <table id="agentTable" class="data" role="table" aria-label="Agent performance">
          <thead>
            <tr>
              <th data-sort="text">Agent</th>
              <th data-sort="num">Total Sales</th>
              <th data-sort="num">Current Stock</th>
              <th data-sort="text">Last Arrival Log</th>
            </tr>
          </thead>
          <tbody>
            {% for agent in agents %}
              <tr>
                <td>
                  <div class="name-cell">
                    <span class="avatar">
                      {% if agent.avatar %}
                        <img src="{{ agent.avatar.url }}" alt="{{ agent.name }} avatar">
                      {% else %}
                        {{ agent.name|first|upper }}
                      {% endif %}
                    </span>
                    {% if agent.id %}
                      <a href="{% url 'dashboard:admin_agent_detail' agent.id %}" style="text-decoration:none; color:var(--cc-accent)">{{ agent.name }}</a>
                    {% else %} {{ agent.name }} {% endif %}
                    <span class="name-extras">
                      {% url 'accounts:upload_agent_avatar' agent.id as agent_upload_url %}
                      {% if not agent_upload_url %}{% url 'upload_agent_avatar' agent.id as agent_upload_url %}{% endif %}
                      {% if agent_upload_url %}
                        <form action="{{ agent_upload_url }}" method="post" enctype="multipart/form-data">
                          {% csrf_token %}
                          <label class="icon-btn" title="Upload photo">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                              <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            Upload
                            <input type="file" name="avatar" accept="image/*" style="position:absolute;opacity:0;width:0;height:0">
                          </label>
                          <input type="hidden" name="next" value="{{ request.path }}">
                          <button type="submit" class="sr-only">Save</button>
                        </form>
                      {% endif %}
                    </span>
                  </div>
                </td>
                <td>{{ agent.total_sales|default:"0" }}</td>
                <td>
                  {% if agent.stock_level >= 12 %}
                    <span class="pill good">{{ agent.stock_level }}</span>
                  {% elif agent.stock_level >= 10 %}
                    <span class="pill mid">{{ agent.stock_level }}</span>
                  {% else %}
                    <span class="pill low">{{ agent.stock_level }}</span>
                  {% endif %}
                </td>
                <td class="muted">{{ agent.last_log|default:"‚Äî"|date:"Y-m-d H:i" }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="muted">No agent data available.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {# (Optional) projections/chart area could go here if you want it back later #}
    </div>
  </main>
</div>
{% endif %}

<script>
/* Sidebar collapse (persist) */
(function(){
  const key='cc-sidebar';
  const layout=document.getElementById('rootLayout');
  const btn=document.getElementById('collapseBtn');
  if(!layout || !btn) return;
  function apply(state){
    layout.classList.toggle('collapsed', state==='collapsed');
    btn.setAttribute('aria-pressed', state==='collapsed' ? 'true' : 'false');
  }
  const saved=localStorage.getItem(key)||'expanded';
  apply(saved);
  btn.addEventListener('click',()=>{
    const next=layout.classList.contains('collapsed') ? 'expanded' : 'collapsed';
    localStorage.setItem(key,next); apply(next);
  });
})();

/* Theme rotate (persist) */
(function(){
  const KEY="cc-theme";
  const THEMES=["style-1","style-2","style-3"];
  const root=document.documentElement;
  const btn=document.getElementById('themeRotate');
  if(!btn) return;
  function idx(){ return Math.max(0, THEMES.indexOf(root.getAttribute('data-theme') || THEMES[0])); }
  function apply(theme){
    root.setAttribute('data-theme', theme);
    localStorage.setItem(KEY, theme);
    btn.classList.toggle('on', theme !== THEMES[0]);
    btn.setAttribute('aria-pressed', theme !== THEMES[0] ? 'true' : 'false');
    window.dispatchEvent(new CustomEvent('theme:changed',{detail:{theme}}));
  }
  const saved = localStorage.getItem(KEY) || root.getAttribute('data-theme') || THEMES[0];
  apply(saved);
  btn.addEventListener('click', ()=>{
    const next = THEMES[(idx()+1)%THEMES.length];
    apply(next);
  });
})();

/* Period quick chips */
document.querySelectorAll('[data-period]').forEach(chip=>{
  chip.addEventListener('click',()=>{
    const v=chip.getAttribute('data-period');
    const sel=document.getElementById('period');
    if(!sel) return;
    sel.value=v; document.getElementById('periodForm').submit();
  });
});

/* Agent table: search & sort */
(function(){
  const table=document.getElementById('agentTable');
  const tbody=table?.querySelector('tbody');
  if(!table || !tbody) return;
  const rows=Array.from(tbody.querySelectorAll('tr'));
  const search=document.getElementById('agentSearch');
  const clear=document.getElementById('clearSearch');

  function filter(){
    const q=(search.value||'').trim().toLowerCase();
    rows.forEach(r=>{ r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none'; });
  }
  search?.addEventListener('input', filter);
  clear?.addEventListener('click', ()=>{ search.value=''; filter(); search.focus(); });
  window.addEventListener('keydown',e=>{ if(e.key==='/'){ e.preventDefault(); search.focus(); } });

  let state={idx:0,dir:1};
  table.querySelectorAll('thead th').forEach((th,idx)=>{
    th.title='Click to sort';
    th.addEventListener('click', ()=>{
      const type=th.dataset.sort||'text';
      const dir=(state.idx===idx ? -state.dir : 1);
      state={idx,dir};

      const visible=rows.filter(r=>r.style.display!=='none');
      visible.sort((a,b)=>{
        const A=a.children[idx].innerText.trim();
        const B=b.children[idx].innerText.trim();
        if(type==='num'){
          const nA=parseFloat(A.replace(/[^\d.-]/g,''))||0;
          const nB=parseFloat(B.replace(/[^\d.-]/g,''))||0;
          return (nA-nB)*dir;
        }
        return A.localeCompare(B)*dir;
      });
      visible.forEach(r=>tbody.appendChild(r));
    });
  });
})();

/* AI Recommendations (Admin) */
(function(){
  const list   = document.getElementById('ai-recos-admin');
  const status = document.getElementById('recoStatusAdmin');
  const btn    = document.getElementById('recoRefreshAdmin');
  if (!list || !status || !btn) return;

  function esc(s){return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

  // Try namespaced and non-namespaced endpoints gracefully
  const RECO_ENDPOINTS = ['/api/recommendations/','/recommendations/','/ai/recommendations/'];

  async function fetchFirstOk(urls){
    for(const u of urls){
      try{
        const res = await fetch(u, { credentials: 'same-origin', headers:{Accept:'application/json'} });
        if(res.ok) return await res.json();
      }catch(_){}
    }
    return null;
  }

  async function loadRecos(){
    status.textContent = 'Loading‚Ä¶';
    list.innerHTML = '';
    try{
      const data = await fetchFirstOk(RECO_ENDPOINTS);
      const items = data?.items || [];
      if(!items.length){
        list.innerHTML = '<li class="muted">No recommendations right now.</li>';
      }else{
        list.innerHTML = items.map(i => {
          const msg = esc(i.message || i.text || '');
          const pct = (i.confidence!=null) ? ` <small class="muted">${Math.round(i.confidence*100)}%</small>` : '';
          return `<li>${msg}${pct}</li>`;
        }).join('');
      }
      status.textContent = 'Updated';
      setTimeout(()=>{ if(status.textContent==='Updated') status.textContent=''; }, 1500);
    }catch(err){
      console.error('admin reco fetch failed', err);
      status.textContent = 'Could not load predictions';
      list.innerHTML = '<li class="muted">Could not load predictions.</li>';
    }
  }

  btn.addEventListener('click', loadRecos);
  loadRecos();
})();
</script>
{% endblock %}
