{# templates/manager_dashboard.html #}
{% extends "base.html" %}
{% load static humanize %}

{% block title %}Manager Â· Circuit City{% endblock %}

{% block body %}
<style>
  /* ================================
     Manager Dashboard (v2)
     Uses global tokens from tokens.css
     ================================ */
  .mgr-wrap{max-width:1200px;margin:0 auto;padding:clamp(12px,3vw,24px)}
  .mgr-card{background:var(--cc-panel);border:1px solid var(--cc-border);border-radius:var(--radius,12px);box-shadow:var(--cc-shadow);padding:1.1rem}
  .row{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
  .muted{color:var(--cc-muted)}
  .brand{font-weight:800;letter-spacing:.2px}
  .btn{display:inline-flex;align-items:center;gap:.45rem;background:var(--cc-accent);color:#fff;font-weight:800;border:0;
       padding:.6rem .9rem;border-radius:10px;box-shadow:0 4px 12px color-mix(in oklab,var(--cc-accent) 30%, transparent);text-decoration:none}
  .btn:hover{filter:brightness(1.06)}
  .btn.ghost{background:transparent;color:var(--cc-text);border:1px solid var(--cc-border);box-shadow:none}
  .grid{display:grid;gap:.8rem}
  .grid-auto{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .stat{padding:1rem;background:linear-gradient(180deg,var(--cc-panel),var(--cc-panel-2));border:1px solid var(--cc-border);border-radius:16px}
  .stat h4{margin:0 0 .25rem;font-size:.9rem;color:var(--cc-muted);font-weight:800}
  .stat .big{font-size:1.8rem;font-weight:900;letter-spacing:.3px}
  .toolbar{display:flex;gap:.5rem;align-items:center;padding:.5rem .6rem;background:var(--cc-panel-2);border:1px solid var(--cc-border);border-radius:12px}
  .input,select{background:var(--cc-panel-2);color:var(--cc-text);border:1px solid var(--cc-border);padding:.55rem .7rem;border-radius:10px;outline:0}
  .input:focus,select:focus{box-shadow:0 0 0 6px color-mix(in oklab,var(--cc-accent) 28%, transparent)}
  .divider{height:1px;background:var(--cc-border);margin:1rem 0}
  .chart-card{background:var(--cc-panel);border:1px solid var(--cc-border);border-radius:14px;padding:12px;position:relative}
  .chart-card h3{margin:.25rem 0 .6rem;font-size:.95rem;color:var(--cc-muted);font-weight:800}
  .chart-canvas{width:100% !important;max-width:100%;height:260px !important}
  .chart-skel{position:absolute;inset:46px 12px 12px 12px;border-radius:10px;
              background:linear-gradient(90deg, rgba(148,163,184,.15), rgba(255,255,255,.45), rgba(148,163,184,.15));
              background-size:200% 100%;animation:skel 1.1s linear infinite}
  @keyframes skel{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .alerts{background:var(--cc-panel);border:1px solid var(--cc-border);border-radius:14px}
  .alerts h3{margin:12px 12px 0 12px;font-size:.95rem;color:var(--cc-muted);font-weight:800}
  .alerts ul{list-style:none;margin:0;padding:8px}
  .alerts li{display:flex;align-items:center;gap:.5rem;padding:.55rem .6rem;border-top:1px solid var(--cc-border)}
  .pill{border-radius:999px;padding:.15rem .5rem;font-size:.8rem;font-weight:800;border:1px solid var(--cc-border)}
  .pill.ok{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
  .pill.warn{background:#fffbeb;color:#92400e;border-color:#fde68a}
  .pill.bad{background:#fef2f2;color:#991b1b;border-color:#fecaca}
</style>

<div class="mgr-wrap">
  <div class="mgr-card">
    <!-- Header -->
    <div class="row" style="justify-content:space-between;margin-bottom:.8rem;border-bottom:1px solid var(--cc-border);padding-bottom:.6rem">
      <h2 class="brand" style="margin:0">Manager Dashboard</h2>
      <div class="row">
        <!-- Theme rotate: style-1 â†’ style-2 â†’ style-3 (syncs with base) -->
        <button id="themeRotate" class="btn ghost" type="button" aria-pressed="false" title="Rotate theme">ðŸŽ¨ Theme</button>
        {% if request.user.is_authenticated %}
          <span class="muted" style="font-weight:800"><i class="bi bi-person-circle me-1"></i>{{ request.user.username }}</span>
        {% endif %}
      </div>
    </div>

    <!-- Filters -->
    <form id="mgrFilters" method="get" class="toolbar" style="margin-bottom:.8rem">
      <label class="muted" for="period" style="font-weight:800">Period</label>
      <select id="period" name="period">
        <option value="month" {% if period == "month" or not period %}selected{% endif %}>This month</option>
        <option value="7d" {% if period == "7d" %}selected{% endif %}>Last 7 days</option>
        <option value="all" {% if period == "all" %}selected{% endif %}>All time</option>
      </select>
      <label class="muted" for="agent" style="font-weight:800">Agent</label>
      <select id="agent" name="agent">
        <option value="">All agents</option>
        {% for a in agents|default:[] %}
          <option value="{{ a.id }}" {% if request.GET.agent|default:'' == a.id|stringformat:'s' %}selected{% endif %}>{{ a.name }}</option>
        {% endfor %}
      </select>
      <button class="btn" type="submit"><i class="bi bi-sliders"></i> Apply</button>
      <a class="btn ghost" href="{{ request.path }}"><i class="bi bi-arrow-counterclockwise"></i> Reset</a>
    </form>

    <!-- KPI tiles -->
    <div class="grid grid-auto" style="margin-bottom:.9rem">
      <div class="stat">
        <h4>In Stock</h4>
        <div class="big">{{ in_stock|default:0|intcomma }}</div>
      </div>
      <div class="stat">
        <h4>Sold</h4>
        <div class="big">{{ sold|default:0|intcomma }}</div>
      </div>
      <div class="stat">
        <h4>Sales Value</h4>
        <div class="big">MK {{ sales_value|default:0|floatformat:0|intcomma }}</div>
      </div>
      <div class="stat">
        <h4>Commission (Total)</h4>
        <div class="big">MK {{ commission_total|default:0|floatformat:0|intcomma }}</div>
      </div>
    </div>

    <!-- Quick actions (robust URLs) -->
    <div class="row" style="margin-bottom:.9rem">
      {% url 'inventory:dashboard' as inv_dash %}
      {% url 'inventory:stock_list' as stock_list_url %}
      {% url 'inventory:scan_in' as scan_in_url %}
      {% url 'inventory:scan_sold' as scan_sold_url %}
      <a class="btn" href="{{ inv_dash|default:'/' }}"><i class="bi bi-speedometer2"></i> Inventory</a>
      <a class="btn" href="{{ stock_list_url|default:'/inventory/stock/' }}"><i class="bi bi-list-ul"></i> Stock List</a>
      <a class="btn" href="{{ scan_in_url|default:'/inventory/scan-in/' }}"><i class="bi bi-plus-circle"></i> Scan IN</a>
      <a class="btn" href="{{ scan_sold_url|default:'/inventory/scan-sold/' }}"><i class="bi bi-check2-circle"></i> Scan SOLD</a>
    </div>

    <div class="divider"></div>

    <!-- Charts & Alerts -->
    <div class="grid" style="grid-template-columns: 1.4fr 1fr">
      <!-- Top Agents -->
      <div class="chart-card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3>Top agents (by sales)</h3>
          <div class="row">
            <label for="rankPeriod" class="visually-hidden">Period</label>
            <select id="rankPeriod" class="input" style="min-width:140px">
              <option value="month" selected>This month</option>
              <option value="7d">Last 7 days</option>
              <option value="all">All time</option>
            </select>
          </div>
        </div>
        <div style="position:relative">
          <div id="rankSkel" class="chart-skel" aria-hidden="true"></div>
          <canvas id="topAgents" class="chart-canvas" aria-label="Top agents bar chart" role="img"></canvas>
        </div>
      </div>

      <!-- Alerts -->
      <div class="alerts">
        <h3>Alerts</h3>
        <ul id="mgrAlerts">
          <li class="muted" style="padding:.7rem .6rem">Loadingâ€¦</li>
        </ul>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
(function(){
  // ---------- Theme rotate (sync with base) ----------
  (function(){
    const KEY="cc-theme"; const THEMES=["style-1","style-2","style-3"];
    const root=document.documentElement; const btn=document.getElementById('themeRotate');
    function idx(){ return Math.max(0, THEMES.indexOf(root.getAttribute('data-theme')||THEMES[0])); }
    function apply(theme){ root.setAttribute('data-theme',theme); localStorage.setItem(KEY,theme);
      btn?.setAttribute('aria-pressed', theme!==THEMES[0] ? 'true' : 'false');
      window.dispatchEvent(new CustomEvent('theme:changed',{detail:{theme}}));
    }
    const saved=localStorage.getItem(KEY)||root.getAttribute('data-theme')||THEMES[0]; apply(saved);
    btn?.addEventListener('click',()=> apply(THEMES[(idx()+1)%THEMES.length]));
  })();

  // ---------- Helpers ----------
  const nf = new Intl.NumberFormat();
  const $id = (id)=>document.getElementById(id);
  const BLUE = getComputedStyle(document.documentElement).getPropertyValue('--cc-accent').trim() || '#3b82f6';
  const BLUE_SOFT = BLUE + '33';

  function commonGrid(){ return { color:getComputedStyle(document.documentElement).getPropertyValue('--chart-grid') || 'rgba(148,163,184,.25)' }; }

  async function fetchFirstOk(urls, query){
    for(const u of urls){
      try{
        const r = await fetch(u + (query||''), { credentials:'same-origin', headers:{Accept:'application/json'} });
        if(r.ok) return await r.json();
      }catch(_){}
    }
    return null;
  }

  // ---------- Alerts ----------
  const ALERT_ENDPOINTS = [
    '/inventory/api/alerts/','/inventory/api-alerts/','/inventory/alerts/','/inventory/api/alerts/'
  ];
  async function loadAlerts(){
    const ul=$id('mgrAlerts'); if(!ul) return;
    try{
      const d = await fetchFirstOk(ALERT_ENDPOINTS, `?_=${Date.now()}`) || {};
      const items = (d.alerts||[]).map(a=>{
        const sev = a.severity==='high' ? 'bad' : (a.severity==='warn' ? 'warn' : 'ok');
        const label = a.type || 'Alert';
        const msg = a.message || '';
        return `<li><span class="pill ${sev}">${label}</span><span>${msg}</span></li>`;
      }).join('');
      ul.innerHTML = items || '<li class="muted" style="padding:.7rem .6rem">No alerts ðŸŽ‰</li>';
    }catch{
      ul.innerHTML = '<li class="muted" style="padding:.7rem .6rem">Alerts unavailable</li>';
    }
  }

  // ---------- Top Agents Chart ----------
  const RANK_ENDPOINTS = [
    '/inventory/api/top-agents/','/inventory/api_top_agents/','/inventory/api/top_agents/','/inventory/api-top-agents/'
  ];
  let rankChart=null;
  async function loadTopAgents(){
    const skel=$id('rankSkel'); skel && (skel.style.display='block');
    const sel=$id('rankPeriod'); const period=sel?.value || 'month';
    const data = await fetchFirstOk(RANK_ENDPOINTS, `?period=${encodeURIComponent(period)}`) || {labels:[],values:[]};
    const labels = data.labels||[]; const values = (data.values||[]).map(v=>Number(v)||0);

    const el=$id('topAgents'); const ctx=el?.getContext('2d');
    if(!ctx){ skel && (skel.style.display='none'); return; }
    rankChart?.destroy();

    if(!labels.length){
      // draw "No data"
      skel && (skel.style.display='none');
      ctx.clearRect(0,0,el.width,el.height);
      ctx.fillStyle = '#94a3b8'; ctx.font = '14px system-ui'; ctx.fillText('No data', 12, 22);
      return;
    }

    rankChart = new Chart(ctx, {
      type:'bar',
      data:{ labels, datasets:[{ label:'Units', data:values, backgroundColor:BLUE, borderColor:BLUE }] },
      options:{
        responsive:true, maintainAspectRatio:false,
        animation:{ duration:650, easing:'easeOutQuart' },
        plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=> `${c.parsed.y} units` } } },
        scales:{
          x:{ grid:{ display:false } },
          y:{ beginAtZero:true, grid: commonGrid(), ticks:{ stepSize:1, precision:0, callback:(v)=> Number.isInteger(v)?v:'' } }
        }
      }
    });
    skel && (skel.style.display='none');
  }

  $id('rankPeriod')?.addEventListener('change', loadTopAgents);

  // Init
  loadAlerts(); loadTopAgents();
})();
</script>
{% endblock %}
