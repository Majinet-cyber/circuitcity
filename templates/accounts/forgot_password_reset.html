<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Reset Password · Circuit City (v1.6)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg1:#eef5ff;--bg2:#f9fbff;--card:#fff;--muted:#475569;--text:#0f172a;
      --border:#e2e8f0;
      --glass-bg:rgba(37,99,235,0.12);--glass-brd:rgba(96,165,250,.55);
      --glass-shadow:0 10px 30px rgba(37,99,235,.22);
      --accent:#2563eb;--accent-2:#1d4ed8;
      --danger:#b91c1c;--danger-bg:#fee2e2;--danger-bd:#fecaca;
      --info:#0c4a6e;--info-bg:#e0f2fe;--info-bd:#bae6fd;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
      color:var(--text);
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
    }
    .wrap{min-height:100%;display:grid;place-items:center;padding:clamp(16px,4vw,32px)}
    .card{
      width:min(560px,92vw);
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:24px 22px;
      box-shadow:0 20px 60px rgba(2,8,23,.08);
    }
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:6px}
    .brand .dot{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,#60a5fa,#3b82f6)}
    h1{margin:0 0 8px;font-size:22px;font-weight:800}
    .muted{color:var(--muted);font-size:13px}

    form{display:grid;gap:14px;margin-top:10px}
    label{font-weight:600;font-size:14px}

    .row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    @media (max-width:420px){.row{grid-template-columns:1fr}}

    .field{display:flex;align-items:center;gap:8px;background:#f8fafc;border:1px solid var(--border);
           border-radius:12px;padding:2px 2px 2px 12px}
    .field input{flex:1;background:transparent;border:0;outline:none;padding:12px;font-size:16px;color:var(--text)}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:.5rem;width:100%;
      padding:.9rem 1.1rem;font-weight:800;letter-spacing:.02em;border-radius:14px;
      border:1px solid var(--glass-brd);color:#eaf2ff;
      background:
        radial-gradient(120% 160% at 30% 20%, rgba(255,255,255,.35), transparent 60%),
        linear-gradient(135deg, rgba(96,165,250,.65), rgba(37,99,235,.55)),
        var(--glass-bg);
      box-shadow:var(--glass-shadow);
      backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
      transition:transform .18s, box-shadow .18s, color .18s;cursor:pointer;margin-top:.25rem;
    }
    .btn:hover{transform:translateY(-1px);color:#fff;box-shadow:0 14px 34px rgba(37,99,235,.32)}
    .btn:disabled{opacity:.6;cursor:not-allowed;box-shadow:0 8px 18px rgba(37,99,235,.18)}

    .toggle{
      border:1px solid var(--border);background:#f8fafc;color:#334155;
      border-radius:10px;padding:10px 12px;cursor:pointer;white-space:nowrap;
    }

    .link{color:var(--accent);text-decoration:none}
    .link:hover{text-decoration:underline}

    .alert{background:var(--info-bg);border:1px solid var(--info-bd);color:var(--info);
           padding:10px 12px;border-radius:12px;font-size:14px;margin:8px 0}
    .alert.err{background:var(--danger-bg);border-color:var(--danger-bd);color:var(--danger)}

    .help{font-size:12px;color:var(--muted)}
    .error{font-size:12px;color:var(--danger);margin-top:6px}

    .footer{position:fixed;left:14px;bottom:10px;color:#94a3b8;font-size:12px}
    .footer-r{position:fixed;right:14px;bottom:10px;color:#94a3b8;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="dialog" aria-labelledby="title">
      <div class="brand" aria-hidden="true">
        <div class="dot"></div>
        <div>
          <div style="font-weight:800">Circuit City</div>
          <div class="muted">Staff Portal</div>
        </div>
      </div>

      <h1 id="title">Enter Code & Set New Password</h1>
      <p class="muted">We emailed a 6-digit code (expires in 5 minutes). Paste it below with your new password.</p>

      {% if messages %}
        {% for m in messages %}
          <div class="alert{% if m.tags and 'error' in m.tags %} err{% endif %}">{{ m }}</div>
        {% endfor %}
      {% endif %}
      {% if form.errors or form.non_field_errors %}
        <div class="alert err">Please review the fields and try again.</div>
      {% endif %}

      <form method="post" action="{% url 'accounts:forgot_password_reset' %}" novalidate>
        {% csrf_token %}

        <div>
          <label for="id_identifier">Email or Username</label>
          <div class="field">
            <input id="id_identifier" name="identifier" type="text" autocomplete="username email"
                   value="{{ form.identifier.value|default_if_none:'' }}" required>
          </div>
          {% if form.identifier.errors %}
            <div class="error">{{ form.identifier.errors|striptags }}</div>
          {% endif %}
        </div>

        <div>
          <label for="id_code">Reset code</label>
          <div class="field">
            <input id="id_code" name="code" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="6"
                   placeholder="6-digit code" autocomplete="one-time-code"
                   value="{{ form.code.value|default_if_none:'' }}" required>
          </div>
          {% if form.code.errors %}
            <div class="error">{{ form.code.errors|striptags }}</div>
          {% endif %}
        </div>

        <div>
          <label for="id_new_password1">New password</label>
          <div class="row">
            <div class="field">
              <input id="id_new_password1" name="new_password1" type="password" autocomplete="new-password" required>
            </div>
            <button type="button" class="toggle" data-target="id_new_password1" aria-label="Show password">Show</button>
          </div>
          {% if form.new_password1.errors %}
            <div class="error">{{ form.new_password1.errors|striptags }}</div>
          {% endif %}
        </div>

        <div>
          <label for="id_new_password2">Confirm new password</label>
          <div class="row">
            <div class="field">
              <input id="id_new_password2" name="new_password2" type="password" autocomplete="new-password" required>
            </div>
            <button type="button" class="toggle" data-target="id_new_password2" aria-label="Show password">Show</button>
          </div>
          {% if form.new_password2.errors %}
            <div class="error">{{ form.new_password2.errors|striptags }}</div>
          {% endif %}
        </div>

        <button class="btn" id="submitBtn" type="submit">Update password</button>
      </form>

      <p class="help" style="margin-top:10px">
        Didn’t get a code? <a class="link" href="{% url 'accounts:forgot_password_request' %}">Send another</a> ·
        <a class="link" href="{% url 'accounts:login' %}">Back to sign in</a>
      </p>
    </div>
  </div>

  <div class="footer">v1.6</div>
  <div class="footer-r">© imajinet 2025</div>

  <script>
    // Toggles, OTP cleanliness, and double-submit guard
    (function () {
      // Toggle show/hide for password fields
      document.querySelectorAll(".toggle").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-target");
          const input = document.getElementById(id);
          if (!input) return;
          const isPwd = input.type === "password";
          input.type = isPwd ? "text" : "password";
          btn.textContent = isPwd ? "Hide" : "Show";
          input.focus({preventScroll:true});
        });
      });

      // Keep reset code strictly numeric and 6 chars
      const code = document.getElementById('id_code');
      if (code) {
        code.addEventListener('input', () => {
          code.value = code.value.replace(/\D/g, '').slice(0, 6);
        });
      }

      // Prevent double submit + trim identifier
      const form = document.querySelector('form');
      const submit = document.getElementById('submitBtn');
      if (form && submit) {
        form.addEventListener('submit', () => {
          const idf = document.getElementById('id_identifier');
          if (idf) idf.value = idf.value.trim();
          if (code) code.value = code.value.trim();
          submit.disabled = true;
          submit.textContent = 'Updating…';
        });
      }
    })();
  </script>
</body>
</html>
