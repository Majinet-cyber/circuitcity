{% extends "base.html" %}
{% load humanize %}

{% block title %}My Wallet · Circuit City{% endblock %}
{% block header_title %}<i class="bi bi-wallet2 me-2"></i>My Wallet{% endblock %}

{% block extra_css %}
<style>
  .kpi-card .label{color:var(--muted);font-weight:700}
  .kpi-card .value{font-size:1.25rem;font-weight:900}
  .kpi-card .sub{color:var(--muted)}
  .chart-wrap{position:relative;height:220px}
  .table td,.table th{vertical-align:middle}
</style>
{% endblock %}

{% block body %}
<div class="container-xxl px-0">

  {# ========== KPIs ========== #}
  <div class="row g-3 mb-3">
    <div class="col-6 col-lg-3">
      <div class="card shadow-sm border-0 h-100 kpi-card">
        <div class="card-body">
          <div class="label mb-1">Today Earnings</div>
          <div class="value">MWK {{ agent_summary.today_earnings|default:0|floatformat:0|intcomma }}</div>
          <div class="sub small">Deductions: MWK {{ agent_summary.today_deductions|default:0|floatformat:0|intcomma }}</div>
        </div>
      </div>
    </div>

    <div class="col-6 col-lg-3">
      <div class="card shadow-sm border-0 h-100 kpi-card">
        <div class="card-body">
          <div class="label mb-1">Month to Date</div>
          <div class="value">MWK {{ agent_summary.month_total|default:0|floatformat:0|intcomma }}</div>
          <div class="sub small">Deductions: MWK {{ agent_summary.month_deductions|default:0|floatformat:0|intcomma }}</div>
        </div>
      </div>
    </div>

    <div class="col-6 col-lg-3">
      <div class="card shadow-sm border-0 h-100 kpi-card">
        <div class="card-body">
          <div class="label mb-1">All-Time Earnings</div>
          <div class="value">MWK {{ agent_summary.all_time_total|default:0|floatformat:0|intcomma }}</div>
          <div class="sub small">All-Time Deductions: MWK {{ agent_summary.all_time_deductions|default:0|floatformat:0|intcomma }}</div>
        </div>
      </div>
    </div>

    <div class="col-6 col-lg-3">
      <div class="card shadow-sm border-0 h-100 kpi-card">
        <div class="card-body">
          <div class="label mb-1">Current Balance</div>
          <div class="value {% if agent_summary.balance|default:0 < 0 %}text-danger{% endif %}">
            MWK {{ agent_summary.balance|default:0|floatformat:0|intcomma }}
          </div>
          <div class="sub small">Updated {% now "M j, Y" %}</div>
        </div>
      </div>
    </div>
  </div>

  {# ========== Ranking + Quick Panels ========== #}
  <div class="row g-3 mb-3">
    <div class="col-lg-7">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Earnings Ranking</h5>
            <div class="d-flex align-items-center gap-2">
              <label for="rankPeriod" class="small text-muted mb-0">Period</label>
              <select id="rankPeriod" class="form-select form-select-sm" style="width:160px">
                <option value="month" selected>This month</option>
                <option value="all">All-time</option>
              </select>
            </div>
          </div>
          <div class="chart-wrap">
            <canvas id="rankChart" role="img" aria-label="Earnings ranking bar chart"></canvas>
          </div>
          <small class="text-muted d-block mt-2">
            Note: You only see totals (no private details of other agents).
          </small>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="row g-3">

        {# Payslips #}
        <div class="col-12">
          <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0"><i class="bi bi-receipt me-1"></i>Payslips</h5>
              </div>
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead class="text-muted small">
                    <tr><th>Month</th><th class="text-end">Gross</th><th class="text-end">Deductions</th><th class="text-end">Net</th></tr>
                  </thead>
                  <tbody>
                    {% for p in payslips %}
                      <tr>
                        <td>
                          {{ p.year }}-{{ p.month|stringformat:"02d" }}
                          {% if p.pdf %}
                            <a class="ms-1 small" href="{{ p.pdf.url }}" target="_blank" rel="noopener">
                              <i class="bi bi-file-earmark-pdf"></i>
                            </a>
                          {% endif %}
                        </td>
                        <td class="text-end">MWK {{ p.gross|default:0|floatformat:0|intcomma }}</td>
                        <td class="text-end">MWK {{ p.deductions|default:0|floatformat:0|intcomma }}</td>
                        <td class="text-end fw-semibold">MWK {{ p.net|default:0|floatformat:0|intcomma }}</td>
                      </tr>
                    {% empty %}
                      <tr><td colspan="4" class="text-muted">No payslips yet.</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        {# Budget requests #}
        <div class="col-12">
          <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0"><i class="bi bi-cash-coin me-1"></i>Budget Requests</h5>
                <span class="badge rounded-pill text-bg-light">read-only</span>
              </div>
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead class="text-muted small">
                    <tr><th>Title</th><th class="text-end">Amount</th><th>Status</th><th>Requested</th></tr>
                  </thead>
                  <tbody>
                    {% for b in budgets %}
                      <tr>
                        <td class="text-truncate" style="max-width:220px">{{ b.title }}</td>
                        <td class="text-end">MWK {{ b.amount|default:0|floatformat:0|intcomma }}</td>
                        <td>
                          {% if b.status == 'pending' %}
                            <span class="badge rounded-pill text-bg-warning">Pending</span>
                          {% elif b.status == 'approved' %}
                            <span class="badge rounded-pill text-bg-primary">Approved</span>
                          {% elif b.status == 'paid' %}
                            <span class="badge rounded-pill text-bg-success">Paid</span>
                          {% else %}
                            <span class="badge rounded-pill text-bg-secondary">Rejected</span>
                          {% endif %}
                        </td>
                        <td class="text-muted small">{{ b.created_at|date:"M j, Y" }}</td>
                      </tr>
                    {% empty %}
                      <tr><td colspan="4" class="text-muted">No budget requests yet.</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <div class="small text-muted mt-2">
                You’ll be notified here when a budget is approved or paid.
              </div>
            </div>
          </div>
        </div>

      </div> <!-- /row -->
    </div>
  </div>

  {# ========== Transactions ========== #}
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Recent Transactions</h5>
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'wallet:agent_txns' %}">
          <i class="bi bi-clock-history me-1"></i>View all
        </a>
      </div>
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr class="text-muted small">
              <th style="min-width:110px">Date</th>
              <th>Type</th>
              <th>Note</th>
              <th class="text-end" style="min-width:150px">Amount (MWK)</th>
            </tr>
          </thead>
          <tbody>
            {% for t in txns %}
              <tr>
                <td>{{ t.effective_date }}</td>
                <td class="text-capitalize">{{ t.get_type_display }}</td>
                <td class="text-truncate" style="max-width:520px">{{ t.note }}</td>
                <td class="text-end fw-semibold {% if t.amount < 0 %}text-danger{% else %}text-success{% endif %}">
                  {{ t.amount|default:0|floatformat:0|intcomma }}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-muted">No transactions yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {# Safe profile URL fallback #}
      {% url 'accounts:settings_unified' as profile_url %}
      {% if not profile_url %}{% url 'accounts:settings' as profile_url %}{% endif %}
      {% if not profile_url %}{% url 'accounts:settings_profile' as profile_url %}{% endif %}

      <div class="alert alert-info d-flex align-items-start gap-2 mt-3" role="alert">
        <i class="bi bi-info-circle mt-1"></i>
        <div class="small">
          To receive payments, keep your
          <a href="{{ profile_url|default:'#' }}">Payment Options</a>
          updated (bank / Airtel Money / TNM). Your admin will use these for payslips.
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
(function(){
  const el = document.getElementById('rankChart');

  function withCommas(n){ try{ return Number(n||0).toLocaleString(); }catch(_){ return n; } }

  async function loadRank(period){
    try{
      const url = "{% url 'wallet:api_ranking' %}" + "?period=" + encodeURIComponent(period||'month');
      const res = await fetch(url, {credentials:'same-origin', headers:{'Accept':'application/json'}});
      const data = await res.json();
      const rows = Array.isArray(data.rows) ? data.rows : [];
      const labels = rows.map(r => [r.agent__first_name||"", r.agent__last_name||""].join(" ").trim() || "Agent");
      const totals = rows.map(r => Number(r.total||0));

      if(window.rankChart) window.rankChart.destroy();
      window.rankChart = new Chart(el, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'MWK', data: totals }] },
        options: {
          responsive:true, maintainAspectRatio:false,
          scales:{
            y:{ beginAtZero:true, ticks:{ callback:v => withCommas(v) }, grid:{ drawBorder:false } },
            x:{ grid:{ display:false } }
          },
          plugins:{
            legend:{ display:false },
            tooltip:{ callbacks:{ label:(ctx)=> " MWK " + withCommas(ctx.parsed.y) } }
          }
        }
      });
    }catch(err){
      console.error('Ranking load failed:', err);
      if(el){
        const ctx = el.getContext('2d'); ctx.clearRect(0,0,el.width,el.height);
        ctx.fillStyle = '#64748b'; ctx.font = '14px system-ui'; ctx.fillText('Ranking unavailable', 10, 18);
      }
    }
  }

  document.getElementById('rankPeriod')?.addEventListener('change', e => loadRank(e.target.value));
  loadRank('month');
})();
</script>
{% endblock %}
