{% extends "base.html" %}
{% load humanize %}

{% block title %}Admin Wallet · Circuit City{% endblock %}
{% block header_title %}<i class="bi bi-bank2 me-2"></i>Admin Wallet{% endblock %}

{% block nav_actions %}
  <a class="btn" href="{% url 'inventory:inventory_dashboard' %}">
    <i class="bi bi-speedometer2"></i> Dashboard
  </a>
  <a class="btn" href="{% url 'wallet:admin_budgets' %}">
    <i class="bi bi-cash-coin"></i> Budgets
  </a>
  <a class="btn" href="{% url 'wallet:admin_issue' %}">
    <i class="bi bi-plus-circle-dotted"></i> Manual Txn
  </a>
  <a class="btn" href="{% url 'wallet:admin_payslips' %}">
    <i class="bi bi-receipt"></i> Payslips
  </a>
  <a class="btn" href="{% url 'wallet:admin_schedules' %}">
    <i class="bi bi-calendar2-check"></i> Schedules
  </a>
{% endblock %}

{% block content %}
<div class="container-xxl px-0">

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="text-muted small mb-1">Company Spend (All-Time)</div>
          <div class="fs-4 fw-bold">MWK {{ company_spend|floatformat:2|intcomma }}</div>
          <div class="small text-muted">Includes payouts, budgets, advances & deductions</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body d-flex flex-column justify-content-center">
          <div class="text-muted small mb-1">Pending Budgets</div>
          <div class="fs-4 fw-bold">{{ budgets_pending }}</div>
          <div class="small text-muted">Awaiting approval or payment</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body d-flex flex-column justify-content-center">
          <div class="text-muted small mb-1">Primary Actions</div>
          <div class="d-flex flex-wrap gap-2">
            <a class="btn btn-primary btn-sm" href="{% url 'wallet:admin_payslips' %}">
              <i class="bi bi-receipt me-1"></i> Issue Payslips (Bulk)
            </a>
            <a class="btn btn-outline-primary btn-sm" href="{% url 'wallet:admin_budgets' %}">
              <i class="bi bi-cash-coin me-1"></i> Manage Budgets
            </a>
          </div>
          <div class="d-flex flex-wrap gap-2 mt-2">
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'wallet:admin_issue' %}">
              <i class="bi bi-plus-circle-dotted me-1"></i> Manual Wallet Transaction
            </a>
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'wallet:admin_issue_payslip' %}">
              <i class="bi bi-person-badge me-1"></i> Single Payslip
            </a>
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'wallet:admin_schedules' %}">
              <i class="bi bi-calendar2-check me-1"></i> Payout Schedules
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Agent Lookup -->
  <div class="card shadow-sm border-0 mb-3">
    <div class="card-body">
      <form class="row g-2 align-items-end" action="{% url 'wallet:admin_agent' agent_id=0 %}" onsubmit="return goAgent(event)">
        <div class="col-sm-6 col-md-4">
          <label class="form-label small text-muted">Agent ID</label>
          <input id="agentIdInput" type="number" min="1" class="form-control" placeholder="e.g. 23">
        </div>
        <div class="col-sm-6 col-md-3">
          <button class="btn btn-outline-primary" type="submit">
            <i class="bi bi-search me-1"></i> Open Agent Wallet
          </button>
        </div>
        <div class="col-12 col-md-auto ms-auto text-muted small">
          Tip: you can also browse via <a href="/admin/auth/user/">Django Admin</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Recent Transactions -->
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <h5 class="mb-3">Recent Wallet Transactions</h5>
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr class="text-muted small">
              <th>Date</th>
              <th>Agent</th>
              <th>Type</th>
              <th>Note</th>
              <th class="text-end">Amount (MWK)</th>
            </tr>
          </thead>
          <tbody>
            {% for t in recent %}
              <tr>
                <td>{{ t.created_at|date:"M j, Y" }}</td>
                <td>
                  {% if t.agent %}{{ t.agent.first_name }} {{ t.agent.last_name }}{% else %}<span class="text-muted">—</span>{% endif %}
                </td>
                <td class="text-capitalize">{{ t.get_type_display }}</td>
                <td class="text-truncate" style="max-width:360px">{{ t.note }}</td>
                <td class="text-end fw-semibold {% if t.amount < 0 %}text-danger{% else %}text-success{% endif %}">
                  {{ t.amount|floatformat:2|intcomma }}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="5" class="text-muted">No transactions yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
function goAgent(e){
  e.preventDefault();
  const el = document.getElementById('agentIdInput');
  const id = (el && el.value) ? parseInt(el.value, 10) : NaN;
  if (!id || id <= 0) { el?.focus(); return false; }
  window.location.href = "{% url 'wallet:admin_agent' agent_id=0 %}".replace('/0/', '/' + id + '/');
  return false;
}
</script>
{% endblock %}
{% endblock %}
