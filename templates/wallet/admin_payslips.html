{% extends "base.html" %}
{% load humanize %}

{% block title %}Issue Payslips · Circuit City{% endblock %}
{% block header_title %}<i class="bi bi-receipt me-2"></i>Issue Payslips{% endblock %}

{% block content %}
<div class="container-xxl px-0">

  <div class="alert alert-info d-flex align-items-start gap-2" role="alert">
    <i class="bi bi-info-circle mt-1"></i>
    <div class="small">
      This will compute <strong>base salary + commissions + bonuses</strong>, subtract deductions for the chosen period,
      create a payslip record, and post the net payout to the agent wallet and company ledger.
      You can optionally email payslips immediately.
    </div>
  </div>

  <div class="row g-3">
    <!-- Single -->
    <div class="col-lg-5">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h5 class="mb-3">Single Payslip</h5>
          <form method="post" action="{% url 'wallet:admin_payslips' %}">
            {% csrf_token %}
            <input type="hidden" name="form_kind" value="single">
            <div class="mb-3">
              <label class="form-label">Agent</label>
              <select class="form-select" name="agent_ids">
                {% for a in agents %}
                  <option value="{{ a.id }}">{{ a.first_name }} {{ a.last_name }} ({{ a.username }})</option>
                {% endfor %}
              </select>
            </div>
            <div class="row">
              <div class="col-6 mb-3">
                <label class="form-label">Year</label>
                <input type="number" class="form-control" name="year" value="{{ year }}" min="2000" max="2100" required>
              </div>
              <div class="col-6 mb-3">
                <label class="form-label">Month</label>
                <input type="number" class="form-control" name="month" value="{{ month }}" min="1" max="12" required>
              </div>
            </div>
            <div class="mb-3 form-check">
              <input class="form-check-input" type="checkbox" id="sn1" name="send_now" value="1">
              <label class="form-check-label" for="sn1">Email payslip now</label>
            </div>
            <div class="mb-3">
              <label class="form-label">Payment Method (optional / future)</label>
              <select class="form-select" name="method">
                <option value="">—</option>
                <option value="NB">National Bank</option>
                <option value="SB">Standard Bank</option>
                <option value="AM">Airtel Money</option>
                <option value="MANUAL">Manual</option>
              </select>
            </div>
            <button class="btn btn-primary"><i class="bi bi-send-check me-1"></i>Issue Payslip</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Bulk -->
    <div class="col-lg-7">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h5 class="mb-3">Bulk Payslips</h5>
          <form method="post" action="{% url 'wallet:admin_payslips' %}">
            {% csrf_token %}
            <input type="hidden" name="form_kind" value="bulk">
            <div class="mb-2 d-flex justify-content-between align-items-center">
              <label class="form-label mb-0">Agents</label>
              <button class="btn btn-sm btn-outline-secondary" type="button" id="selectAll">Select all</button>
            </div>
            <select class="form-select" name="agent_ids" id="agentsMulti" multiple size="10" required>
              {% for a in agents %}
                <option value="{{ a.id }}">{{ a.first_name }} {{ a.last_name }} ({{ a.username }})</option>
              {% endfor %}
            </select>

            <div class="row mt-3">
              <div class="col-6 mb-3">
                <label class="form-label">Year</label>
                <input type="number" class="form-control" name="year" value="{{ year }}" min="2000" max="2100" required>
              </div>
              <div class="col-6 mb-3">
                <label class="form-label">Month</label>
                <input type="number" class="form-control" name="month" value="{{ month }}" min="1" max="12" required>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="sn2" name="send_now" value="1">
                  <label class="form-check-label" for="sn2">Email payslips now</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Payment Method (optional / future)</label>
                <select class="form-select" name="method">
                  <option value="">—</option>
                  <option value="NB">National Bank</option>
                  <option value="SB">Standard Bank</option>
                  <option value="AM">Airtel Money</option>
                  <option value="MANUAL">Manual</option>
                </select>
              </div>
            </div>

            <button class="btn btn-primary"><i class="bi bi-send-check me-1"></i>Issue Payslips</button>
            <a class="btn btn-link ms-2" href="{% url 'wallet:admin_schedules' %}">Manage auto-send schedules</a>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
  // simple helper to select all in the multi-select
  document.getElementById('selectAll')?.addEventListener('click', () => {
    const el = document.getElementById('agentsMulti');
    for (const o of el.options) o.selected = true;
  });
</script>
{% endblock %}
{% endblock %}
