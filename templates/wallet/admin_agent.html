{% extends "base.html" %}
{% load humanize %}

{% block title %}Agent Wallet · Circuit City{% endblock %}
{% block header_title %}<i class="bi bi-person-badge me-2"></i>Agent Wallet · {{ agent.first_name }} {{ agent.last_name }}{% endblock %}

{% block content %}
<div class="container-xxl px-0">

  <!-- ===== Agent Summary KPIs ===== -->
  <div class="row g-3 mb-3">
    <div class="col-6 col-lg-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="text-muted small mb-1">Today Earnings</div>
          <div class="fs-4 fw-bold">MWK {{ summary.today_earnings|floatformat:2|intcomma }}</div>
          <div class="text-muted small">Deductions: MWK {{ summary.today_deductions|floatformat:2|intcomma }}</div>
        </div>
      </div>
    </div>

    <div class="col-6 col-lg-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="text-muted small mb-1">Month to Date</div>
          <div class="fs-4 fw-bold">MWK {{ summary.month_total|floatformat:2|intcomma }}</div>
          <div class="text-muted small">Deductions: MWK {{ summary.month_deductions|floatformat:2|intcomma }}</div>
        </div>
      </div>
    </div>

    <div class="col-6 col-lg-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="text-muted small mb-1">All-Time Earnings</div>
          <div class="fs-4 fw-bold">MWK {{ summary.all_time_total|floatformat:2|intcomma }}</div>
          <div class="text-muted small">All-Time Deductions: MWK {{ summary.all_time_deductions|floatformat:2|intcomma }}</div>
        </div>
      </div>
    </div>

    <div class="col-6 col-lg-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="text-muted small mb-1">Current Balance</div>
          <div class="fs-4 fw-bold {% if summary.balance < 0 %}text-danger{% endif %}">
            MWK {{ summary.balance|floatformat:2|intcomma }}
          </div>
          <div class="small text-muted">Agent ID: {{ agent.id }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Actions row ===== -->
  <div class="d-flex flex-wrap gap-2 mb-3">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#issueTxnModal">
      <i class="bi bi-plus-circle me-1"></i> Issue Transaction
    </button>

    <!-- Issue Payslip controls -->
    {% now "Y" as this_year %}{% now "n" as this_month %}
    <form id="payslipForm" class="d-flex align-items-center gap-2">
      <div class="input-group input-group-sm" style="width: 260px;">
        <label class="input-group-text" for="psYear">Payslip</label>
        <select class="form-select" id="psYear" aria-label="Year">
          {% for y in "now"|date:"Y"|add:"0"|make_list %}{% endfor %}
        </select>
        <select class="form-select" id="psMonth" aria-label="Month">
          {% for m in 1|to_int|default_if_none:1 %}{% endfor %}
        </select>
      </div>
      <button type="button" id="btnIssuePayslip" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-receipt me-1"></i> Issue Payslip
      </button>
    </form>
  </div>

  <!-- ===== Two columns: Transactions + Payslips ===== -->
  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Recent Transactions</h5>
            <span class="small text-muted">Last 100</span>
          </div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr class="text-muted small">
                  <th>Date</th>
                  <th>Type</th>
                  <th>Note</th>
                  <th class="text-end">Amount (MWK)</th>
                </tr>
              </thead>
              <tbody>
                {% for t in txns %}
                  <tr>
                    <td>{{ t.effective_date }}</td>
                    <td class="text-capitalize">{{ t.get_type_display }}</td>
                    <td class="text-truncate" style="max-width:420px">{{ t.note }}</td>
                    <td class="text-end fw-semibold {% if t.amount < 0 %}text-danger{% else %}text-success{% endif %}">
                      {{ t.amount|floatformat:2|intcomma }}
                    </td>
                  </tr>
                {% empty %}
                  <tr><td colspan="4" class="text-muted">No transactions.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="alert alert-info mt-3 small">
            <i class="bi bi-info-circle me-1"></i>
            Manual transactions (Bonus / Deduction / Advance) mirror to the Company wallet automatically.
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h5 class="mb-2"><i class="bi bi-receipt me-1"></i>Past Payslips</h5>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead class="text-muted small">
                <tr><th>Month</th><th class="text-end">Gross</th><th class="text-end">Deductions</th><th class="text-end">Net</th></tr>
              </thead>
              <tbody>
                {% for p in payslips %}
                  <tr>
                    <td>{{ p.year }}-{{ p.month|stringformat:"02d" }}</td>
                    <td class="text-end">MWK {{ p.gross|floatformat:2|intcomma }}</td>
                    <td class="text-end">MWK {{ p.deductions|floatformat:2|intcomma }}</td>
                    <td class="text-end fw-semibold">MWK {{ p.net|floatformat:2|intcomma }}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="4" class="text-muted">No payslips yet.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="small text-muted mt-2">
            Issue a payslip to settle the month's balance. The agent’s wallet will be reduced by the net amount.
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ===== Issue Transaction Modal ===== -->
<div class="modal fade" id="issueTxnModal" tabindex="-1" aria-labelledby="issueTxnLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{% url 'wallet:admin_issue' %}">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="issueTxnLabel">Issue Transaction · {{ agent.first_name }} {{ agent.last_name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="agent_id" value="{{ agent.id }}">

        <div class="mb-3">
          <label class="form-label">Type</label>
          <select class="form-select" name="type" id="txnType" required>
            <option value="bonus">Bonus (+)</option>
            <option value="deduction">Deduction (−)</option>
            <option value="advance">Advance (−)</option>
          </select>
          <div class="form-text">Bonuses increase agent balance; deductions/advances reduce it.</div>
        </div>

        <div class="mb-3">
          <label class="form-label">Amount (MWK)</label>
          <input type="number" class="form-control" name="amount" id="txnAmount" step="0.01" placeholder="e.g. 5000" required>
          <div class="form-text">Sign will auto-adjust by type (bonus = +, deduction/advance = −).</div>
        </div>

        <div class="mb-3">
          <label class="form-label">Note</label>
          <input type="text" class="form-control" name="note" placeholder="Reason / details (optional)">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" type="submit"><i class="bi bi-check2-circle me-1"></i>Save Transaction</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // ------- Populate Year/Month selects for payslip -------
  (function initPayslipSelectors(){
    const yearSel  = document.getElementById('psYear');
    const monthSel = document.getElementById('psMonth');
    if(!yearSel || !monthSel) return;

    const now = new Date();
    const thisYear  = now.getFullYear();
    const thisMonth = now.getMonth() + 1;

    // Years: current and previous 4
    for(let y=thisYear; y>=thisYear-4; y--){
      const opt = document.createElement('option');
      opt.value = y; opt.textContent = y;
      if(y===thisYear) opt.selected = true;
      yearSel.appendChild(opt);
    }

    // Months 1..12
    for(let m=1; m<=12; m++){
      const opt = document.createElement('option');
      opt.value = m; opt.textContent = m.toString().padStart(2,'0');
      if(m===thisMonth) opt.selected = true;
      monthSel.appendChild(opt);
    }

    // Issue payslip button -> navigate to URL with params
    const btn = document.getElementById('btnIssuePayslip');
    btn?.addEventListener('click', () => {
      const y = yearSel.value;
      const m = monthSel.value;
      const agentId = "{{ agent.id }}";
      // URL pattern: wallet:issue_payslip (agent_id, year, month)
      const url = "{% url 'wallet:issue_payslip' 0 2000 1 %}"
        .replace('/0/', `/${agentId}/`)
        .replace('/2000/', `/${y}/`)
        .replace('/1/', `/${m}/`);
      window.location.href = url;
    });
  })();

  // ------- Auto sign amount by transaction type -------
  (function autoSign(){
    const typeSel = document.getElementById('txnType');
    const amtInp  = document.getElementById('txnAmount');
    if(!typeSel || !amtInp) return;

    function normalize(){
      let v = parseFloat(amtInp.value || '0');
      if (isNaN(v)) return;
      const t = typeSel.value;
      if (t === 'bonus' && v < 0) v = Math.abs(v);
      if ((t === 'deduction' || t === 'advance') && v > 0) v = -Math.abs(v);
      amtInp.value = v.toFixed(2);
    }
    typeSel.addEventListener('change', normalize);
    amtInp.addEventListener('blur', normalize);
  })();
</script>
{% endblock %}
