{% extends "base.html" %}
{% block title %}Scenario · Circuit City{% endblock %}
{% block header_title %}Scenario Details{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
  <h5 class="mb-0">{{ scenario.name }}</h5>
  <div class="d-flex gap-2">
    <form method="post" action="{% url 'simulator:run' scenario.pk %}">
      {% csrf_token %}
      <button class="btn btn-light"><i class="bi bi-play"></i> Run simulation</button>
    </form>
    <a href="{% url 'simulator:home' %}" class="btn btn-light">Back</a>
  </div>
</div>

<div class="panel p-3">
  <div class="d-flex justify-content-between align-items-center">
    <h6 class="fw-bold mb-0">Latest Result</h6>
    {% if latest %}
      <small class="text-muted">Run at {{ latest.created_at|date:"Y-m-d H:i" }}</small>
    {% else %}
      <small class="text-muted">No run yet — click “Run simulation”.</small>
    {% endif %}
  </div>

  <div class="chart-wrap mt-2">
    <canvas id="simChart"></canvas>
  </div>

  <div id="kpis" class="row g-3 mt-3"></div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .chart-wrap{ position:relative; height:320px; max-height:55vh; min-height:260px; }
  .kpi-card{ border-radius: 1rem; padding:.75rem 1rem; background:var(--bs-body-bg);
             box-shadow:0 1px 0 rgba(2,6,23,.04), 0 0 0 1px rgba(2,6,23,.05) inset; }
  .kpi-title{ font-size:.8rem; text-transform:uppercase; letter-spacing:.03em; color:var(--bs-secondary-color); }
  .kpi-value{ font-weight:700; font-size:1.1rem; }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
/* ========= Initial data from server (provided by the view) ========= */
const INITIAL = {{ latest_payload|default:"{}"|safe }};

const ctx = document.getElementById('simChart').getContext('2d');
let chart = null;
function money(n){ try{ return Number(n).toLocaleString(); }catch(_){ return n; } }

function render(data){
  const series = data?.series || [];
  const labels = series.map(p=>'D'+p.day);
  const sold   = series.map(p=>p.sold ?? 0);
  const stock  = series.map(p=>p.stock ?? 0);
  const cash   = series.map(p=>p.cash_cum ?? 0);
  const gpCum  = series.map(p=>p.gross_profit_cum ?? 0);
  const opCum  = series.map(p=>p.op_profit_cum ?? 0);

  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[
      {label:'Sold (units)',  data:sold,  yAxisID:'y1', tension:.25, borderWidth:2},
      {label:'Stock (units)', data:stock, yAxisID:'y1', tension:.25, borderWidth:2},
      {label:'Cash (cum)',        data:cash,  yAxisID:'y2', tension:.25, borderWidth:2},
      {label:'Gross Profit (cum)',data:gpCum, yAxisID:'y2', tension:.25, borderWidth:2},
      {label:'Op Profit (cum)',   data:opCum, yAxisID:'y2', tension:.25, borderWidth:2},
    ]},
    options:{
      responsive:true, maintainAspectRatio:false, animation:false,
      interaction:{mode:'index', intersect:false},
      plugins:{ legend:{position:'bottom'}, decimation:{enabled:true, algorithm:'lttb', samples:200} },
      scales:{
        y1:{ title:{display:true, text:'Units'} },
        y2:{ position:'right', title:{display:true, text:'Currency'}, grid:{drawOnChartArea:false} }
      }
    }
  });

  // KPIs
  const k = data?.kpis || {};
  const cards = [
    ['Price', k.price],
    ['Unit cost', k.unit_cost],
    ['Revenue', k.revenue_total],
    ['Gross Profit', k.gross_profit_total],
    ['Op Profit', k.op_profit_total],
    ['Tax', k.tax_total],
    ['Ending Cash', k.ending_cash],
    ['Stockout days', k.stockouts_days],
  ];
  const html = cards.map(([t,v])=>`
    <div class="col-6 col-md-3 col-lg-2">
      <div class="kpi-card">
        <div class="kpi-title">${t}</div>
        <div class="kpi-value">${money(v ?? 0)}</div>
      </div>
    </div>
  `).join('');
  document.getElementById('kpis').innerHTML = html || '<div class="text-muted">No KPIs yet.</div>';
}

render(INITIAL);
</script>
{% endblock %}
