{% extends "base.html" %}
{% block title %}Compare Scenarios · Circuit City{% endblock %}
{% block header_title %}Compare Scenarios{% endblock %}

{% block content %}
<div class="glass-card p-3">
  <form class="row g-2 align-items-end" method="get" action="">
    <div class="col-md-8">
      <label class="form-label fw-bold">Scenarios to compare</label>
      <!-- We seed this from the URL via JS so it always reflects ?id=&id=... -->
      <input type="text" class="form-control" id="idsInput"
             placeholder="Enter scenario IDs separated by commas, e.g. 1,2,3">
      <div class="form-text">Tip: copy–paste IDs from the Scenarios page; supports up to 8 at a time.</div>
    </div>
    <div class="col-md-4">
      <label class="form-label fw-bold">Metric to plot</label>
      <select id="metric" class="form-select">
        <optgroup label="Units">
          <option value="sold" selected>Sold (units / day)</option>
          <option value="stock">Stock (units / day)</option>
        </optgroup>
        <optgroup label="Financial (cumulative)">
          <option value="revenue_cum">Revenue (cum)</option>
          <option value="gross_profit_cum">Gross Profit (cum)</option>
          <option value="op_profit_cum">Operating Profit (cum)</option>
          <option value="cash_cum">Cash (cum)</option>
        </optgroup>
      </select>
    </div>
    <div class="col-12 d-flex gap-2">
      <button class="btn primary" type="submit" id="applyBtn"><i class="bi bi-sliders"></i> Apply</button>
      <a class="btn btn-light" href="?"><i class="bi bi-arrow-counterclockwise"></i> Reset</a>
      <button type="button" id="exportCsv" class="btn btn-light"><i class="bi bi-download"></i> Export KPIs (CSV)</button>
    </div>
  </form>
</div>

<div class="panel p-3 mt-3">
  <div class="d-flex align-items-center justify-content-between">
    <h6 class="fw-bold mb-0">Overlay Chart</h6>
    <small class="text-muted">Auto-decimated for large datasets</small>
  </div>

  <!-- Reasonable, responsive height with hard caps -->
  <div class="chart-box mt-2">
    <canvas id="cmpChart"></canvas>
  </div>
  <div id="emptyMsg" class="small text-muted mt-2 {% if payload %}d-none{% endif %}">
    No scenarios selected. Add IDs above and click Apply.
  </div>
</div>

<div class="panel p-3 mt-3">
  <h6 class="fw-bold mb-2">Key Metrics</h6>
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>Scenario</th>
          <th class="text-end">Price</th>
          <th class="text-end">Unit Cost</th>
          <th class="text-end">Revenue</th>
          <th class="text-end">Gross Profit</th>
          <th class="text-end">Op Profit</th>
          <th class="text-end">Tax</th>
          <th class="text-end">Ending Cash</th>
          <th class="text-end">Stockout Days</th>
        </tr>
      </thead>
      <tbody id="kpiBody">
        {% if payload %}
          {% for item in payload %}
            {% with k=item.results.kpis %}
            <tr data-scenario-id="{{ item.scenario_id }}">
              <td class="fw-bold">{{ item.scenario_name }}</td>
              <td class="text-end">{{ k.price|default_if_none:"-" }}</td>
              <td class="text-end">{{ k.unit_cost|default_if_none:"-" }}</td>
              <td class="text-end">{{ k.revenue_total|default:0|floatformat:0 }}</td>
              <td class="text-end">{{ k.gross_profit_total|default:0|floatformat:0 }}</td>
              <td class="text-end">{{ k.op_profit_total|default:0|floatformat:0 }}</td>
              <td class="text-end">{{ k.tax_total|default:0|floatformat:0 }}</td>
              <td class="text-end">{{ k.ending_cash|default:0|floatformat:0 }}</td>
              <td class="text-end">{{ k.stockouts_days|default:0 }}</td>
            </tr>
            {% endwith %}
          {% endfor %}
        {% else %}
          <tr><td colspan="9" class="text-muted">No data.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  /* Keeps chart “reasonable” everywhere */
  .chart-box{
    position:relative;
    height:360px;     /* default desktop */
    max-height:50vh;  /* never taller than half the viewport */
    min-height:260px; /* still readable on tiny screens */
  }
  @media (max-width: 768px){
    .chart-box{ height:300px; }
  }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
/* -------------------- URL <-> UI state -------------------- */
(function seedIds(){
  const url = new URL(location.href);
  const ids = url.searchParams.getAll('id');
  if(ids.length){
    document.getElementById('idsInput').value = ids.join(', ');
  }
  const m = url.searchParams.get('m');
  if (m) document.getElementById('metric').value = m;
})();

document.getElementById('applyBtn')?.addEventListener('click', (e)=>{
  e.preventDefault();
  const raw = document.getElementById('idsInput').value || '';
  const ids = raw.split(',').map(s=>s.trim()).filter(Boolean).slice(0,8);
  const metric = document.getElementById('metric').value;
  const url = new URL(location.href);
  url.search = '';
  if(ids.length){ ids.forEach(id=> url.searchParams.append('id', id)); }
  url.searchParams.set('m', metric);
  location.assign(url.toString());
});

/* -------------------- Data & chart rendering -------------------- */
const PAYLOAD = {{ payload|default:"[]"|safe }};

const COLORS = [
  '#2563eb', '#16a34a', '#f59e0b', '#ef4444',
  '#8b5cf6', '#06b6d4', '#f97316', '#22c55e'
];

let cmpChart = null;

function buildDatasets(metric){
  const sets = [];
  (PAYLOAD || []).forEach((item, idx)=>{
    const name = item.scenario_name || ('Scenario '+item.scenario_id);
    const series = (item.results && item.results.series) || [];
    const data = series.map(p => Number(p?.[metric] ?? 0));
    sets.push({
      label: name,
      data,
      borderColor: COLORS[idx % COLORS.length],
      backgroundColor: COLORS[idx % COLORS.length] + '22',
      fill: false,
      tension: .25,
      pointRadius: 1.5,
      borderWidth: 2,
    });
  });
  const labels = (PAYLOAD[0]?.results?.series || []).map(p => 'D'+p.day);
  return {labels, datasets: sets};
}

function renderChart(){
  const metric = document.getElementById('metric').value;
  const {labels, datasets} = buildDatasets(metric);

  const ctx = document.getElementById('cmpChart').getContext('2d');
  if (cmpChart) cmpChart.destroy();

  cmpChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: {
            label: c => `${c.dataset.label}: ${c.formattedValue}`
          }
        },
        // LTTB decimation keeps performance (and a sane visual) on huge series
        decimation: { enabled: true, algorithm: 'lttb', samples: 200 }
      },
      scales: {
        x: {
          ticks: { autoSkip: true, maxRotation: 0 },
          grid: {
            color: getComputedStyle(document.documentElement)
              .getPropertyValue('--chart-grid') || 'rgba(2,6,23,.08)'
          }
        },
        y: {
          beginAtZero: true,
          ticks: { precision: 0 },
          title: {
            display: true,
            text: (metric.includes('_cum') ? 'Currency (cumulative)' : 'Units per day')
          }
        }
      }
    }
  });

  document.getElementById('emptyMsg')?.classList.toggle('d-none', (datasets.length>0));
}

document.getElementById('metric')?.addEventListener('change', renderChart);
renderChart();

/* -------------------- Export KPIs as CSV -------------------- */
document.getElementById('exportCsv')?.addEventListener('click', ()=>{
  const rows = [];
  rows.push(['Scenario','Price','Unit Cost','Revenue','Gross Profit','Op Profit','Tax','Ending Cash','Stockout Days']);
  (PAYLOAD || []).forEach(item=>{
    const k = (item.results && item.results.kpis) || {};
    rows.push([
      item.scenario_name || ('Scenario '+item.scenario_id),
      k.price ?? '',
      k.unit_cost ?? '',
      k.revenue_total ?? '',
      k.gross_profit_total ?? '',
      k.op_profit_total ?? '',
      k.tax_total ?? '',
      k.ending_cash ?? '',
      k.stockouts_days ?? ''
    ]);
  });
  const csv = rows.map(r => r.map(x=>String(x).replace(/"/g,'""')).map(x=>`"${x}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'scenario_compare_kpis.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});
</script>
{% endblock %}
