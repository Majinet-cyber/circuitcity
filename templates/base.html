{% load static %}
<!doctype html>
<html lang="en" data-theme="blue">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
  <meta name="format-detection" content="telephone=no">
  <title>{% block title %}Circuit City{% endblock %}</title>
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes">

  {# Provide CSRF to JS in a reliable way #}
  <meta name="csrf-token" content="{{ csrf_token }}">
  {# If you ever customize the cookie name in settings, this still works thanks to the shim checking both names below #}

  {% with ASSET_V=BUILD_ID|default:STATIC_VERSION|default:"1" %}

  <!-- Favicon / PWA -->
  <link rel="icon" href="{% static 'favicon.ico' %}">
  <link rel="icon" type="image/png" sizes="32x32" href="{% static 'img/logo-32.png' %}">
  <link rel="apple-touch-icon" sizes="192x192" href="{% static 'icons/icon-192.png' %}">
  <link rel="manifest" href="{% static 'manifest.webmanifest' %}">

  <script>
    (function () {
      try {
        const saved = localStorage.getItem("cc-theme");
        if (saved) document.documentElement.setAttribute("data-theme", saved);
      } catch (_) {}
    })();
  </script>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Core styles (base → app → feature) -->
  <link rel="stylesheet" href="{% static 'css/tokens.css' %}?v={{ ASSET_V }}">
  <link rel="stylesheet" href="{% static 'css/ui.css' %}?v={{ ASSET_V }}">
  <link rel="stylesheet" href="{% static 'css/app.css' %}?v={{ ASSET_V }}">
  <link rel="stylesheet" href="{% static 'css/inventory-glass.css' %}?v={{ ASSET_V }}">
  <link rel="stylesheet" href="{% static 'css/polish.css' %}?v={{ ASSET_V }}">
  <link rel="stylesheet" href="{% static 'css/mobile.css' %}?v={{ ASSET_V }}">
  <link rel="stylesheet" href="{% static 'css/mobile-fixes.css' %}?v={{ ASSET_V }}">

  <!-- FINAL: versioned overrides must load LAST to win the cascade -->
  <link rel="stylesheet" href="{% static 'css/v2-overrides.2025-09-25.css' %}?v={{ ASSET_V }}">
  {% endwith %}

  <style>
    :root{
      --sidebar-w: 270px; --radius: 12px;
      --shadow-sm: 0 2px 10px rgba(2,8,23,.08);
      --shadow-md: 0 6px 18px rgba(16,24,40,.06);

      --bg:#f5f7fe; --ink:#0b1220; --muted:#475569;
      --line:#d9e2ef; --card:#ffffff;

      --cc-accent: var(--cc-brand, #2563eb);

      --font-sans: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans";

      --fs-xl:  clamp(18px, 2.2vw, 20px);
      --fs-md:  clamp(14px, 1.6vw, 16px);
      --fs-sm:  13px;
      --lh-tight: 1.15;

      --elevate: cubic-bezier(.2,.8,.2,1);
      --fast: 140ms;

      /* Midnight Glass Sidebar */
      --mid-bg:#0f172a;
      --mid-ink:#cbd5e1;
      --mid-ink-dim:#94a3b8;
      --mid-sep: rgba(148,163,184,.15);
      --mid-active: rgba(255,255,255,.08);
      --mid-hover: rgba(255,255,255,.06);

      /* Mobile dock */
      --safe-bottom: max(env(safe-area-inset-bottom), 0px);
      --dock-h: 64px;
    }

    @media (prefers-reduced-motion: reduce){
      *{ animation-duration:1ms !important; animation-iteration-count:1 !important; transition-duration:1ms !important; scroll-behavior:auto !important; }
    }

    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:var(--font-sans); -webkit-font-smoothing:antialiased;
      overflow-x:hidden;
      -webkit-text-size-adjust:100%;
      touch-action: manipulation;
    }
    input, select, textarea { font-size:16px; } /* prevent iOS zoom on focus */

    img, svg, canvas, video { max-width:100%; height:auto; }
    table { width:100%; border-collapse:collapse; overflow-x:auto; display:block; }

    .cc-shell{ min-height:100dvh; display:flex; width:100%; }

    /* ===== Sidebar ===== */
    .cc-sidebar{
      position:sticky; top:0; width:var(--sidebar-w); flex:0 0 var(--sidebar-w);
      height:100dvh; overflow:auto; z-index:2000; padding:16px;
      display:flex; flex-direction:column; gap:14px;
      color: var(--mid-ink); color-scheme: dark;
      background:
        radial-gradient(1200px 800px at -10% -10%, rgba(34,211,238,.08), transparent 40%),
        radial-gradient(1000px 600px at 110% 110%, rgba(16,185,129,.06), transparent 45%),
        var(--mid-bg);
      border-right: 1px solid var(--mid-sep);
      -webkit-backdrop-filter: blur(14px) saturate(120%);
      backdrop-filter: blur(14px) saturate(120%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }
    .navlist{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px; }
    .navlink{
      display:flex; align-items:center; gap:.6rem;
      padding:.58rem .72rem; border-radius:12px; font-weight:700; min-height:44px;
      color: var(--mid-ink); background: transparent; border:1px solid transparent;
      transition:transform var(--fast) var(--elevate), box-shadow var(--fast) var(--elevate), background var(--fast) var(--elevate), border-color var(--fast) var(--elevate);
    }
    .navlink:hover{ background: var(--mid-hover); border-color: rgba(34,211,238,.28); }
    .navlink.active{ background: var(--mid-active); border-color: rgba(34,211,238,.35); color:#eaf2ff; }

    .cc-main{ flex:1 1 auto; min-width:0; position:relative; z-index:0; background:var(--bg); color:var(--ink); }
    .cc-page{ max-width:1200px; margin:0 auto; padding:18px; }

    /* Sticky header */
    .cc-header{ position:sticky; top:0; z-index:60; background:rgba(255,255,255,.98); backdrop-filter: blur(10px); border-bottom:1px solid var(--line); }
    .cc-header .topbar{ display:grid; grid-template-columns: 1fr auto auto auto; gap:.75rem; align-items:center; min-height:64px; }
    .cc-header h1{ line-height:var(--lh-tight); font-size:var(--fs-xl); font-weight:900; margin:0; }

    /* Messages */
    .msg { border-radius: 12px; padding: .75rem 1rem; border: 1px solid var(--line); margin-bottom: .75rem; }
    .msg-info { background: #ecfeff; border-color: #bae6fd; color:#0c4a6e; }
    .msg-success { background: #ecfdf5; border-color:#bbf7d0; color:#065f46; }
    .msg-warning { background: #fffbeb; border-color:#fde68a; color:#92400e; }
    .msg-danger  { background: #fef2f2; border-color:#fecaca; color:#991b1b; }

    /* Mobile drawer behavior */
    @media (max-width: 992px){
      .cc-sidebar{
        position:fixed; left:0; top:0; height:100dvh;
        transform:translateX(-100%);
        transition: transform .26s var(--elevate);
        box-shadow: 0 20px 60px rgba(0,0,0,.35);
      }
      body[data-drawer="open"] .cc-sidebar{ transform:translateX(0) !important; }
      .cc-backdrop{ position:fixed; inset:0; background:rgba(2,6,23,.42); backdrop-filter:blur(2px); display:none; z-index:1990; }
      .cc-backdrop.show{ display:block; }
      .mobile-toggle{
        position:fixed; top:12px; left:12px; z-index:2010;
        border:0; border-radius:12px; width:42px; height:42px;
        display:grid; place-items:center; background:var(--cc-accent); color:#fff;
        box-shadow:0 10px 22px rgba(59,130,246,.35);

        /* Better tap target */
        min-width:56px; min-height:56px;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }
      .mobile-toggle i{ pointer-events:none; }
      .mobile-toggle::after{
        content:""; position:absolute; inset:-12px; border-radius:16px;
      }
    }
    @media (min-width: 992px){
      .mobile-toggle{ display:none; }
    }

    /* Bottom dock */
    .mobile-tabbar{
      position:fixed; left:0; right:0; bottom:0; z-index:1200;
      height: calc(var(--dock-h) + var(--safe-bottom));
      padding-bottom: var(--safe-bottom);
      display:flex; gap:0; align-items:center; justify-content:space-around;
      backdrop-filter: blur(10px);
      background:color-mix(in oklab, var(--card) 90%, transparent);
      border-top:1px solid var(--line);
    }
    .mobile-tabbar .tab{ flex:1; text-align:center; padding:8px 4px 6px; font-size:12px; color:var(--muted); min-height:44px; display:flex; flex-direction:column; align-items:center; gap:2px; }
    .mobile-tabbar .tab.active{ color:var(--cc-accent); font-weight:800; }
    @media (min-width: 768px){ .mobile-tabbar{ display:none; } }

    main.cc-page, .cc-page, .content, .page, .container{
      padding-bottom: calc(var(--dock-h) + var(--safe-bottom) + 16px);
    }

    /* Compact mobile spacing */
    @media (max-width: 480px){
      .cc-page, .container, .container-fluid, main.cc-page{padding:12px !important}
      .glass-card, .card{padding:12px !important; margin:10px 0 !important; border-radius:16px}
      .section, .block, .panel{margin:10px 0 !important}
      h1,h2{margin:.35rem 0 .25rem}
      .form-group{margin:.5rem 0}
      .card > .card-body{padding:12px !important}
      .dashboard-grid,.grid,.grid-2{display:grid!important;grid-template-columns:1fr!important;gap:12px!important}
    }

    /* Right→Left utility for Scan/Sold buttons (mobile) */
    .btn-row{display:flex;gap:.5rem;align-items:center;flex-wrap:nowrap}
    .rtl-mobile{flex-direction:row-reverse}
    @media (min-width:640px){ .rtl-mobile{flex-direction:row} }

    /* ========= Polished Mobile Topbar Layout ========= */
    @media (max-width: 576px){
      .cc-header .topbar{
        display:grid;
        grid-template-columns: 1fr auto;
        grid-template-areas:
          "title user"
          "search search"
          "actions actions";
        gap: 8px;
        align-items: center;
      }
      .cc-header .topbar h1{ grid-area: title; font-size:clamp(17px,4.2vw,19px); margin:0; }
      .cc-header .topbar .topbar-user{ grid-area: user; justify-self:end; }
      .cc-header .topbar .cc-search{ grid-area: search; width:100%; max-width:none; gap:6px; }
      .cc-header .topbar .cc-search .input{ min-width:0; width:100%; }
      .cc-header .topbar .cc-actions{ grid-area: actions; display:flex; gap:.5rem; align-items:center; }
      .cc-header .topbar .cc-actions > *{ flex:0 0 auto; }
    }

    /* ========= Presence Dots ========= */
    .topbar-user .user-btn{ position: relative; }
    .topbar-user .presence-dot{
      position:absolute; right:-2px; bottom:-2px;
      width:10px; height:10px; border-radius:999px;
      background:#10b981; box-shadow:0 0 0 2px #fff;
    }
    .topbar-user .presence-dot.offline{ background:#9ca3af; }
    .tenant-dot.offline{
      background:#9ca3af !important;
      box-shadow:0 0 0 3px rgba(156,163,175,.18) inset !important;
    }
  </style>

  {# Pin sidebar on HQ pages #}
  {% with p=request.path|default:'' %}
  {% if p|slice:":4" == "/hq/" %}
  <style>
    .mobile-toggle{ display:none !important; }
    .cc-backdrop{ display:none !important; }
    .cc-sidebar{
      position:sticky !important;
      left:0 !important; top:0 !important;
      transform:none !important;
      height:100dvh !important;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04) !important;
    }
  </style>
  {% endif %}
  {% endwith %}

  {% block extra_head %}{% endblock %}
  {% block extra_css %}{% endblock %}
</head>
<body>

<div class="cc-shell">
  {% block sidebar %}{% include "partials/sidebar.html" %}{% endblock %}

  <!-- Drawer trigger + backdrop -->
  <button class="mobile-toggle tap focus-ring" id="sidebarOpen" aria-label="Open menu" aria-expanded="false" aria-controls="ccSidebar">
    <i class="bi bi-list"></i>
  </button>
  <div class="cc-backdrop" id="ccBackdrop" aria-hidden="true"></div>

  <div class="cc-main">

    {# ------- URLs for routing/helpers ------- #}
    {% url 'inventory:inventory_dashboard' as url_home %}
    {% url 'inventory:scan_in'           as url_scan_in %}
    {% url 'inventory:scan_sold'         as url_sell %}
    {% url 'inventory:stock_list'        as url_stock %}
    {% url 'wallet:agent_wallet'         as url_wallet %}
    {% url 'reports:home'                as url_reports %}
    {% url 'simulator:home'              as url_simulator %}
    {% url 'simulator:new'               as url_simulator_new %}
    {% url 'layby:admin_dashboard'       as url_layby_admin %}
    {% url 'layby:agent_dashboard'       as url_layby_agent %}
    {% url 'layby:customer_portal'       as url_layby_customer %}
    {% url 'tenants:choose_business'     as url_choose_business %}
    {% url 'tenants:manager_review_agents' as url_manager_agents %}
    {% url 'admin:tenants_business_changelist' as url_admin_business %}
    {% url 'inventory:time_checkin'      as url_time_checkin %}
    {% url 'inventory:time_logs'         as url_time_logs %}
    {% url 'inventory:api_geo_ping'      as url_geo_ping %}
    {# Add API time-checkin URL (fallback keeps your failing path working) #}
    {% url 'inventory:api_time_checkin'  as url_time_checkin_api %}
    {% url 'billing:subscribe' as url_billing_sub %}
    {% url 'billing:checkout'  as url_billing_checkout %}

    {% url 'accounts:settings_unified' as url_profile_settings %}
    {% url 'feedback' as url_feedback_form %}
    {% url 'logout' as url_logout %}

    {% with path=request.path|default:'' %}
      {% if 'accounts/settings' not in path %}
        <header class="cc-header">
          <div class="cc-page topbar">
            <h1 class="fw-bold d-flex align-items-center gap-2">
              {% block header_title %}Dashboard{% endblock %}
              {% if request.business and request.business.subscription %}
                {% with sub=request.business.subscription %}
                  {% if sub.status == 'trial' %}
                    <span class="badge rounded-pill text-bg-info">Trial{% if sub.trial_end %} · ends {{ sub.trial_end|date:'M j' }}{% endif %}</span>
                  {% elif sub.status == 'active' %}
                    <span class="badge rounded-pill text-bg-success">Active</span>
                  {% elif sub.status == 'grace' %}
                    <span class="badge rounded-pill text-bg-warning">Grace</span>
                  {% elif sub.status == 'past_due' %}
                    <span class="badge rounded-pill text-bg-warning">Past due</span>
                  {% elif sub.status == 'expired' or sub.status == 'canceled' %}
                    <span class="badge rounded-pill text-bg-danger">Inactive</span>
                  {% endif %}
                {% endwith %}
              {% endif %}
            </h1>

            {% if show_search or "inventory/dashboard" in path %}
              <div class="cc-search d-flex align-items-center gap-2">
                <i class="bi bi-search text-muted"></i>
                <input id="global-search" class="form-control input" type="search" placeholder="Search SKUs, agents, invoices…" autocomplete="off" />
                <button class="btn btn-primary" type="button" id="global-search-go" title="Go">Go</button>
              </div>
            {% else %}
              <div></div>
            {% endif %}

            <div class="cc-actions">
              <div class="position-relative me-1" id="tenantRoot">
                {% if request.business %}
                  <div class="tenant-pill hover-lift tap" role="button" id="tenantBtn" aria-haspopup="true" aria-expanded="false">
                    <span class="tenant-dot" aria-hidden="true"></span>
                    <span class="tenant-name">{{ request.business.name }}</span>
                    {% if request.membership %}
                      <span class="tenant-role">· {{ request.membership.role|title }}</span>
                    {% elif IS_MANAGER %}
                      <span class="tenant-role">· Manager</span>
                    {% elif request.user.is_authenticated and request.user.profile.is_manager %}
                      <span class="tenant-role">· Manager</span>
                    {% endif %}
                    <span class="tenant-caret"><i class="bi bi-chevron-down"></i></span>
                  </div>
                  <div class="tenant-menu" id="tenantMenu" role="menu" aria-label="Business menu">
                    <a class="tenant-item" href="{{ url_choose_business|default:'/tenants/choose/' }}"><i class="bi bi-arrow-left-right"></i> Switch business</a>
                    {% if request.membership and request.membership.role == "MANAGER" or IS_MANAGER or request.user.is_authenticated and request.user.profile.is_manager %}
                      <a class="tenant-item" href="{{ url_manager_agents|default:'/tenants/manager/agents/' }}"><i class="bi bi-people"></i> Agents</a>
                    {% endif %}
                    {% if request.user.is_staff %}
                      <div class="tenant-divider"></div>
                      <a class="tenant-item" href="{{ url_admin_business }}"><i class="bi bi-shield-lock"></i> Staff approvals</a>
                    {% endif %}
                  </div>
                {% elif request.user.is_superuser %}
                  <a class="tenant-pill hover-lift tap" href="/hq/">
                    <span class="tenant-dot" style="background:#60a5fa"></span>
                    <span class="tenant-name">Platform HQ</span>
                    <span class="tenant-role">· Admin</span>
                  </a>
                {% else %}
                  <a class="tenant-pill hover-lift tap" href="{{ url_choose_business|default:'/tenants/choose/' }}">
                    <span class="tenant-dot" style="background:#f59e0b"></span>
                    <span class="tenant-name">No active business</span>
                    <span class="tenant-role">· Set up</span>
                  </a>
                {% endif %}
              </div>

              {# Notifications (Bootstrap dropdown) #}
              <div class="dropdown" id="ccNotifRoot"
                   data-scope="{% block notif_scope %}dashboard{% endblock %}"
                   data-allow="{% block notif_allow %}{% endblock %}">
                <button class="notif-btn focus-ring dropdown-toggle"
                        id="ccNotifBtn"
                        type="button"
                        data-bs-toggle="dropdown"
                        data-bs-auto-close="outside"
                        aria-expanded="false"
                        aria-haspopup="true"
                        aria-controls="ccNotifMenu"
                        title="Notifications">
                  <i class="bi bi-bell"></i>
                  <span class="notif-dot" id="ccNotifDot" aria-hidden="true"></span>
                </button>

                <div class="dropdown-menu dropdown-menu-end p-0 shadow notif-menu"
                     id="ccNotifMenu"
                     aria-labelledby="ccNotifBtn"
                     style="min-width:320px">
                  <div class="p-2 border-bottom d-flex align-items-center justify-content-between">
                    <strong>Notifications</strong>
                    <button class="btn btn-sm btn-light" id="ccNotifRefresh" type="button">
                      <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                  </div>
                  <div id="ccNotifList">
                    <div class="notif-empty p-3 text-muted">No notifications.</div>
                  </div>
                  <div class="p-2 text-end border-top">
                    <a class="text-decoration-underline" href="#" id="ccNotifOpen">Open inbox</a>
                  </div>
                </div>
              </div>
              {# /Notifications #}
            </div>

            {# User menu #}
            <div class="dropdown topbar-user">
              <button class="user-btn dropdown-toggle"
                      id="userMenuBtn"
                      type="button"
                      data-bs-toggle="dropdown"
                      data-bs-auto-close="outside"
                      aria-expanded="false"
                      aria-haspopup="true"
                      aria-controls="userMenu"
                      title="Account">
                <span class="avatar">
                  {% if request.user.is_authenticated %}
                    {{ request.user.first_name|default:request.user.username|slice:":1"|upper }}
                  {% else %}
                    <i class="bi bi-person"></i>
                  {% endif %}
                </span>
                <span class="presence-dot" aria-hidden="true"></span>
              </button>
              <div id="userMenu" class="dropdown-menu dropdown-menu-end p-0 shadow" aria-labelledby="userMenuBtn" style="min-width:260px">
                <div class="px-3 py-2 text-muted">
                  {% if request.user.is_authenticated %}
                    <div class="fw-bold text-dark">{{ request.user.get_full_name|default:request.user.username }}</div>
                    <div class="small">{{ request.user.email }}</div>
                  {% else %}
                    <div class="small">Not signed in</div>
                  {% endif %}
                </div>
                <div class="border-top"></div>
                <a href="{{ url_profile_settings|default:'/accounts/settings/' }}" class="dropdown-item">
                  <i class="bi bi-gear me-2"></i> Profile &amp; Settings
                </a>
                <a href="{{ url_feedback_form|default:'/feedback/' }}" class="dropdown-item">
                  <i class="bi bi-chat-left-text me-2"></i> Feedback
                </a>
                {% if request.user.is_authenticated %}
                  <a href="{{ url_logout|default:'/accounts/logout/' }}" class="dropdown-item text-danger">
                    <i class="bi bi-box-arrow-right me-2"></i> Logout
                  </a>
                {% endif %}
              </div>
            </div>
            {# /User menu #}

          </div>
        </header>
      {% endif %}
    {% endwith %}

    <main id="app-main" class="cc-page">
      {# ===== Billing banners ===== #}
      {% if request.business and request.business.subscription %}
        {% with sub=request.business.subscription %}
          {% if sub.status == 'trial' %}
            <div class="msg msg-info fade-in d-flex align-items-center justify-content-between">
              <div>
                <strong>You're on a free trial.</strong>
                {% if sub.trial_end %} Trial ends on {{ sub.trial_end|date:"M j, Y" }}.{% endif %}
              </div>
              <div class="d-flex gap-2">
                <a class="btn btn-sm btn-primary" href="{{ url_billing_sub|default:'/billing/subscribe/' }}"><i class="bi bi-lightning-charge"></i> Choose plan</a>
                <a class="btn btn-sm btn-outline-primary" href="{{ url_billing_checkout|default:'/billing/checkout/' }}"><i class="bi bi-credit-card"></i> Checkout</a>
              </div>
            </div>
          {% elif sub.status == 'grace' %}
            <div class="msg msg-warning fade-in d-flex align-items-center justify-content-between">
              <div>
                <strong>Payment needed.</strong> You're in a grace period to restore access.
              </div>
              <div class="d-flex gap-2">
                <a class="btn btn-sm btn-warning" href="{{ url_billing_checkout|default:'/billing/checkout/' }}"><i class="bi bi-credit-card"></i> Pay now</a>
                <a class="btn btn-sm btn-outline-secondary" href="{{ url_billing_sub|default:'/billing/subscribe/' }}"><i class="bi bi-gear"></i> Manage plan</a>
              </div>
            </div>
          {% elif sub.status == 'past_due' %}
            <div class="msg msg-warning fade-in d-flex align-items-center justify-content-between">
              <div>
                <strong>Payment is past due.</strong> Some features may be limited.
              </div>
              <div class="d-flex gap-2">
                <a class="btn btn-sm btn-warning" href="{{ url_billing_checkout|default:'/billing/checkout/' }}"><i class="bi bi-credit-card"></i> Retry payment</a>
              </div>
            </div>
          {% elif sub.status == 'expired' or sub.status == 'canceled' %}
            <div class="msg msg-danger fade-in d-flex align-items-center justify-content-between">
              <div>
                <strong>Subscription inactive.</strong> To continue, pick a plan and pay.
              </div>
              <div class="d-flex gap-2">
                <a class="btn btn-sm btn-danger" href="{{ url_billing_sub|default:'/billing/subscribe/' }}"><i class="bi bi-cart-check"></i> Subscribe</a>
              </div>
            </div>
          {% endif %}
        {% endwith %}
      {% endif %}

      {% if messages %}
        {% for message in messages %}
          <div class="msg
              {% if 'error' in message.tags or 'danger' in message.tags %} msg-danger
              {% elif 'success' in message.tags %} msg-success
              {% elif 'warning' in message.tags %} msg-warning
              {% else %} msg-info
              {% endif %} fade-in">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}

      {% block body %}{% endblock %}
      {% block content %}{% endblock %}
      {% block page_content %}{% endblock %}
      {% block main %}{% endblock %}
    </main>

    <!-- Mobile bottom dock -->
    <nav class="mobile-tabbar d-flex d-md-none cc-bottom-nav">
      <a class="tab {% if active_tab == 'home' %}active{% endif %}" href="{{ url_home|default:'/inventory/dashboard/' }}">
        <i class="bi bi-speedometer2 d-block"></i>Home
      </a>
      <a class="tab {% if active_tab == 'scan_in' %}active{% endif %}" href="{{ url_scan_in|default:'/inventory/scan-in/' }}">
        <i class="bi bi-upc-scan d-block"></i>Scan
      </a>
      <a class="tab {% if active_tab == 'sell' %}active{% endif %}" href="{{ url_sell|default:'/inventory/scan-sold/' }}">
        <i class="bi bi-cart-check d-block"></i>Sell
      </a>
      <a class="tab {% if active_tab == 'stock' %}active{% endif %}" href="{{ url_stock|default:'/inventory/list/' }}">
        <i class="bi bi-box-seam d-block"></i>Stock
      </a>
      <a class="tab {% if active_tab == 'wallet' %}active{% endif %}" href="{{ url_wallet|default:'/wallet/' }}">
        <i class="bi bi-wallet2 d-block"></i>Wallet
      </a>
      {% if request.user.is_authenticated %}
        {% if IS_MANAGER or request.user.is_staff or request.user.profile.is_manager %}
          <a class="tab {% if active_tab == 'sim' %}active{% endif %}" href="{{ url_simulator|default:'/simulator/' }}">
            <i class="bi bi-graph-up d-block"></i>Sim
          </a>
        {% endif %}
      {% endif %}
    </nav>
  </div>
</div>

<!-- Inbox Modal (fallback) -->
<div class="modal fade" id="ccInbox" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title cc-inbox-title"><i class="bi bi-bell me-2"></i>Notifications Inbox</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="text-muted">Read-only fallback (server inbox is down)</div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-light" id="ccInboxRefresh"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
          </div>
        </div>
        <div id="ccInboxList" class="cc-inbox-list">
          <div class="notif-empty">Loading…</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

<!-- IMPORTANT: kill legacy sidebar code BEFORE loading your scripts -->
<script>window.CC_DISABLE_LEGACY_MOBILE = 1;</script>

<script src="{% with v=BUILD_ID|default:STATIC_VERSION|default:'1' %}{% static 'js/app.js' %}?v={{ v }}{% endwith %}" defer></script>
<script src="{% with v=BUILD_ID|default:STATIC_VERSION|default:'1' %}{% static 'js/mobile.js' %}?v={{ v }}{% endwith %}" defer></script>

<script>
  /* ============================================================
     CSRF: resilient cookie+meta handling + global fetch shim
     - Ensures we ALWAYS send a valid X-CSRFToken header for POST/PUT/PATCH/DELETE
     - Fixes "incorrect length" by avoiding empty headers
  ============================================================ */
  (function(){
    function readCookie(name){
      const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,'\\$&') + '=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : '';
    }
    function setCookie(name, value, days){
      try{
        const d = new Date(); d.setTime(d.getTime() + (days||1)*864e5);
        document.cookie = name + '=' + encodeURIComponent(value) + '; path=/; SameSite=Lax; expires=' + d.toUTCString();
      }catch(_){}
    }
    function metaToken(){
      const el = document.querySelector('meta[name="csrf-token"]');
      const val = el && el.getAttribute('content');
      if (!val || val === 'NOTPROVIDED') return '';
      return val;
    }
    function ensureCookieFromMeta(){
      // If neither cookie is present, but a meta token exists, seed csrftoken
      const hasCsrftoken = !!readCookie('csrftoken');
      const hasCC = !!readCookie('cc_csrftoken');
      if (!hasCsrftoken && !hasCC){
        const t = metaToken();
        if (t && t.length > 20){
          setCookie('csrftoken', t, 7);
        } else {
          // last resort: no token available yet; don't inject empty headers
          // console.debug('CSRF: token not available yet');
        }
      }
    }
    ensureCookieFromMeta();

    function getCsrfToken(){
      // Prefer cookies; fall back to meta if needed
      return readCookie('cc_csrftoken') || readCookie('csrftoken') || metaToken() || '';
    }

    // Expose helper + URLs + user flags
    window.CC = Object.assign(window.CC || {}, {
      getCsrfToken,
      URLS: Object.assign({
        time_checkin_api: "{{ url_time_checkin_api|default:'/inventory/api/time-checkin/' }}"
      }, window.CC && CC.URLS || {})
    });

    // ---- Global fetch shim: auto-attach CSRF on same-origin unsafe methods ----
    if (!window.__CC_FETCH_SHIM__){
      window.__CC_FETCH_SHIM__ = true;
      const _fetch = window.fetch.bind(window);

      function isSameOrigin(url){
        try{
          const u = new URL(url, location.href);
          return u.origin === location.origin;
        }catch(_){
          return true; // Request objects or relative URLs: treat as same-origin
        }
      }
      function hasHeader(h, name){
        if (!h) return false;
        if (h instanceof Headers) return h.has(name);
        const lower = name.toLowerCase();
        for (const k in h){ if (Object.prototype.hasOwnProperty.call(h,k) && k.toLowerCase() === lower) return true; }
        return false;
      }
      function setHeader(h, name, val){
        if (h instanceof Headers) { h.set(name, val); return h; }
        const clone = Object.assign({}, h || {});
        clone[name] = val;
        return clone;
      }

      window.fetch = function(input, init){
        init = init || {};
        let method = (init.method || (input && input.method) || 'GET').toUpperCase();
        const same = (typeof input === 'string') ? isSameOrigin(input) : true;

        if (same && method !== 'GET' && method !== 'HEAD'){
          // Only attach if we actually have a valid token; never send empty string
          const token = getCsrfToken();
          if (token && token.length > 20){
            if (init.headers){
              if (!hasHeader(init.headers, 'X-CSRFToken')){
                init.headers = setHeader(init.headers, 'X-CSRFToken', token);
              }
            } else {
              init.headers = {'X-CSRFToken': token};
            }
          }
          // Ensure cookies flow for session auth
          if (!('credentials' in init)) init.credentials = 'same-origin';
        }
        return _fetch(input, init);
      };
    }
  })();
</script>

<script>
  /* Helpers (URLs, roles) */
  (function(){
    window.CC = Object.assign(window.CC || {}, {
      URLS: Object.assign({
        home: "{{ url_home|default:'/inventory/dashboard/' }}",
        scan_in: "{{ url_scan_in|default:'/inventory/scan-in/' }}",
        scan_sold: "{{ url_sell|default:'/inventory/scan-sold/' }}",
        stock_list: "{{ url_stock|default:'/inventory/list/' }}",
        wallet: "{{ url_wallet|default:'/wallet/' }}",
        reports: "{{ url_reports|default:'/reports/' }}",
        simulator: "{{ url_simulator|default:'/simulator/' }}",
        simulator_new: "{{ url_simulator_new|default:'/simulator/new/' }}",
        layby_admin: "{{ url_layby_admin|default:'/layby/admin/' }}",
        layby_agent: "{{ url_layby_agent|default:'/layby/agent/' }}",
        layby_customer: "{{ url_layby_customer|default:'/layby/customer/' }}",
        time_checkin: "{{ url_time_checkin|default:'/inventory/time/checkin/' }}",
        time_logs: "{{ url_time_logs|default:'/inventory/time/logs/' }}",
        geo_ping: "{{ url_geo_ping|default:'/inventory/api/geo-ping/' }}",
        billing_subscribe: "{{ url_billing_sub|default:'/billing/subscribe/' }}",
        billing_checkout: "{{ url_billing_checkout|default:'/billing/checkout/' }}"
      }, window.CC && CC.URLS || {}),
      USER: {
        is_staff: {{ request.user.is_staff|yesno:"true,false" }},
        is_superuser: {{ request.user.is_superuser|yesno:"true,false" }},
        is_manager: {% if IS_MANAGER %}true{% elif request.user.is_authenticated and request.user.profile.is_manager %}true{% elif request.user.is_authenticated and request.user.is_staff %}true{% else %}false{% endif %},
        is_agent: {% if request.user.is_authenticated %}{% if IS_MANAGER %}false{% elif request.user.is_staff %}false{% elif request.user.profile.is_manager %}false{% else %}true{% endif %}{% else %}false{% endif %}
      }
    });
  })();

  /* ----- Rock-solid mobile sidebar: single tap open/close, no flash ----- */
  (function(){
    if (window.__CC_SIDEBAR_V3__) return; window.__CC_SIDEBAR_V3__ = true;

    const sidebar = document.querySelector('.cc-sidebar');
    const backdrop = document.getElementById('ccBackdrop');
    const toggleBtn = document.getElementById('sidebarOpen');

    if (!sidebar || !backdrop || !toggleBtn) return;

    if (!sidebar.id) sidebar.id = 'ccSidebar';
    if (!toggleBtn.hasAttribute('aria-controls')) toggleBtn.setAttribute('aria-controls','ccSidebar');

    let openState = false;
    let busy = false;
    let savedY = 0;

    function lockScroll(){
      savedY = window.scrollY || 0;
      Object.assign(document.body.style,{position:'fixed',top:`-${savedY}px`,left:'0',right:'0',width:'100%',overflow:'hidden'});
    }
    function unlockScroll(){
      Object.assign(document.body.style,{position:'',top:'',left:'',right:'',width:'',overflow:''});
      window.scrollTo(0, savedY||0);
    }
    function applyState(){
      if (openState){
        document.body.setAttribute('data-drawer','open');
        toggleBtn.setAttribute('aria-expanded','true');
        backdrop.classList.add('show');
        lockScroll();
      } else {
        document.body.removeAttribute('data-drawer');
        toggleBtn.setAttribute('aria-expanded','false');
        backdrop.classList.remove('show');
        unlockScroll();
      }
    }
    function toggle(){
      if (busy) return;
      busy = true;
      openState = !openState;
      applyState();
      setTimeout(()=>busy=false, 220);
    }
    function close(){ if (openState){ openState=false; applyState(); } }

    const onToggle = (e)=>{ e.preventDefault(); e.stopPropagation(); toggle(); };

    // Debounced cross-input tap binder
    function bindTap(el, handler){
      let locked = false, timer = null;
      function fire(e){
        e.preventDefault(); e.stopPropagation();
        if (locked) return;
        locked = true;
        handler(e);
        clearTimeout(timer);
        timer = setTimeout(()=> locked=false, 220);
      }
      el.addEventListener('pointerup', fire, {passive:false});
      el.addEventListener('touchend', fire, {passive:false});
      el.addEventListener('click', fire, {passive:false});
      el.addEventListener('keydown', e=>{
        if (e.key === 'Enter' || e.key === ' ') fire(e);
      }, {passive:false});
    }
    bindTap(toggleBtn, onToggle);

    ['click','pointerdown','touchstart','mousedown'].forEach(ev=>{
      sidebar.addEventListener(ev, e=>e.stopPropagation(), {passive:true});
    });

    backdrop.addEventListener('click', (e)=>{ e.preventDefault(); close(); }, {passive:false});
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') close(); }, {passive:true});

    sidebar.querySelectorAll('a[href]').forEach(a=>{
      a.addEventListener('click', ()=> close(), {passive:true});
    });

    new MutationObserver(()=>{}).observe(document.body, {attributes:true,attributeFilter:['data-drawer']});
  })();

  /* ===== Tenant menu: clean toggle ===== */
  (function(){
    const btn  = document.getElementById('tenantBtn');
    const menu = document.getElementById('tenantMenu');
    if (!btn || !menu) return;

    let open = false;
    function set(state){
      open = state;
      menu.style.display = open ? 'block' : 'none';
      btn.setAttribute('aria-expanded', open ? 'true' : 'false');
    }
    function toggle(e){ e && e.preventDefault(); e && e.stopPropagation(); set(!open); }
    function close(){ if (open) set(false); }

    set(false);
    btn.addEventListener('click', toggle, {passive:false});
    menu.addEventListener('click', (e)=> e.stopPropagation(), {passive:true});
    document.addEventListener('click', close, {passive:true});
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') close(); }, {passive:true});
  })();

  /* Scan/Sold action row right→left on phones */
  (function(){
    const isScanPage = /\/inventory\/(scan-in|scan-sold)\//.test(location.pathname);
    if (!isScanPage) return;
    document.querySelectorAll('.btn-row').forEach(el=> el.classList.add('rtl-mobile'));
  })();

  /* Nav highlight */
  (function(){
    const path = location.pathname.replace(/\/+$/,'/') || '/';
    document.querySelectorAll('.cc-sidebar a[href]').forEach(a=>{
      const href = (a.getAttribute('href')||'').replace(/\/+$/,'/') || '/';
      if (path === href || (href !== '/' && path.startsWith(href))){
        a.classList.add('active'); a.setAttribute('aria-current','page');
      }
    });
  })();

  /* ===== Global Search: Go button + Enter key ===== */
  (function(){
    const input = document.getElementById('global-search');
    const goBtn = document.getElementById('global-search-go');
    if (!input || !goBtn) return;

    function run(){
      const q = (input.value || '').trim();
      if (!q) return;
      const dest = (window.CC && CC.URLS && CC.URLS.stock_list) || '/inventory/list/';
      const url  = new URL(dest, location.origin);
      url.searchParams.set('q', q);
      location.href = url.toString();
    }
    goBtn.addEventListener('click', run, {passive:false});
    input.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){ e.preventDefault(); run(); }
    }, {passive:false});
  })();

  /* Bottom dock safe-area sync */
  (function(){
    function syncDockVar(){
      const dock = document.querySelector('.cc-bottom-nav') || document.querySelector('.mobile-tabbar');
      const root = document.documentElement;
      const h = dock ? Math.round(dock.getBoundingClientRect().height) : 0;
      if(h) root.style.setProperty('--cc-nav-h', h+'px');
    }
    ['load','orientationchange','resize'].forEach(ev =>
      window.addEventListener(ev, syncDockVar, {passive:true})
    );
    new MutationObserver(syncDockVar).observe(document.body || document.documentElement, {childList:true,subtree:true});
    syncDockVar();
  })();

  /* Mobile enablement: add class, vh var, keyboard awareness */
  document.addEventListener('DOMContentLoaded', () => {
    document.body.classList.add('has-bottomnav');
  });
  (function setVH(){
    function apply(){
      const vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
      document.documentElement.style.setProperty('--vh', (vh/100) + 'px');
    }
    apply();
    window.addEventListener('resize', apply, {passive:true});
    window.addEventListener('orientationchange', apply, {passive:true});
  })();
  (function keyboardAware(){
    const vv = window.visualViewport;
    if (!vv) return;
    const THRESH = 140;
    let baseHeight = vv.height;
    function onChange(){
      const kbOpen = (baseHeight - vv.height) > THRESH;
      document.body.classList.toggle('kb-open', kbOpen);
    }
    vv.addEventListener('resize', onChange, {passive:true});
    vv.addEventListener('scroll', onChange, {passive:true});
  })();

  /* Presence dots: user + tenant → online/ offline */
  (function(){
    const userDot   = document.querySelector('.topbar-user .presence-dot');
    const tenantDot = document.querySelector('.tenant-dot');
    function apply(){
      const on = navigator.onLine;
      if (userDot){ userDot.classList.toggle('offline', !on); userDot.title = on ? 'Online' : 'Offline'; }
      if (tenantDot){ tenantDot.classList.toggle('offline', !on); tenantDot.title = on ? 'Online' : 'Offline'; }
    }
    window.addEventListener('online',  apply, {passive:true});
    window.addEventListener('offline', apply, {passive:true});
    apply();
  })();
</script>

{# ===== Geo-ping ===== #}
{% if request.user.is_authenticated %}
<script>
(function () {
  const ENDPOINT = (window.CC && CC.URLS && CC.URLS.geo_ping) || "{{ url_geo_ping|default:'/inventory/api/geo-ping/' }}";
  const onTimeLogs = location.pathname.indexOf('/inventory/time/logs/') !== -1;
  const force = localStorage.getItem('cc_ping_force') === '1';
  const isAgent = !!(window.CC && CC.USER && CC.USER.is_agent === true);
  const shouldPing = isAgent || onTimeLogs || force;
  if (!shouldPing) return;

  function getCSRF() {
    // Always uses the unified helper (now robust)
    return (window.CC && CC.getCsrfToken && CC.getCsrfToken()) || '';
  }

  let watchId = null;
  let lastSent = 0;

  async function sendPing(lat, lon, accuracy) {
    try {
      await fetch(ENDPOINT, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
          // X-CSRFToken is now injected by the global fetch shim if token exists
        },
        credentials: "same-origin",
        body: JSON.stringify({ lat, lon, accuracy })
      });
    } catch (_) {}
  }

  function onPos(pos) {
    const now = Date.now();
    if (now - lastSent < 30000) return; // throttle 30s
    lastSent = now;
    const { latitude, longitude, accuracy } = pos.coords || {};
    if (latitude != null && longitude != null) {
      sendPing(latitude, longitude, accuracy ?? 0);
    }
  }

  function onErr(){}

  function startWatch() {
    if (!navigator.geolocation) return;
    stopWatch();

    navigator.geolocation.getCurrentPosition(onPos, onErr, {
      enableHighAccuracy: true, maximumAge: 5000, timeout: 10000
    });

    watchId = navigator.geolocation.watchPosition(onPos, onErr, {
      enableHighAccuracy: true,
      maximumAge: 5000,
      timeout: 10000
    });
  }

  function stopWatch() {
    if (watchId) navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }

  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") startWatch();
    else stopWatch();
  });

  startWatch();
})();
</script>
{% endif %}

{% block extra_js %}{% endblock %}
</body>
</html>
