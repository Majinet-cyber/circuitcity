{% load static %}
<!doctype html>
<html lang="en" data-theme="style-2">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>{% block title %}Circuit City{% endblock %}</title>
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#0b1220" />

  <script>
    (function () { try {
      const saved = localStorage.getItem("cc-theme");
      if (saved) document.documentElement.setAttribute("data-theme", saved);
    } catch(_){} })();
  </script>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Core design tokens / base styles -->
  <link rel="stylesheet" href="{% static 'css/tokens.css' %}?v={{ STATIC_VERSION|default:'1' }}">
  <link rel="stylesheet" href="{% static 'css/ui.css' %}?v={{ STATIC_VERSION|default:'1' }}">
  <link rel="stylesheet" href="{% static 'css/app.css' %}?v={{ STATIC_VERSION|default:'1' }}">

  <!-- v2 minimal overrides for cards, tables, badges -->
  <link rel="stylesheet" href="{% static 'css/v2-overrides.css' %}?v={{ STATIC_VERSION|default:'1' }}">

  <style>
    :root{
      --sidebar-w: 270px;
      --radius: 12px;
      --shadow-sm: 0 2px 10px rgba(2,8,23,.08);
      --shadow-md: 0 6px 18px rgba(16,24,40,.06);

      /* Page (light) – bumped contrast */
      --bg:#f5f7fe;
      --ink:#0b1220;
      --muted:#475569;
      --line:#d9e2ef;
      --card:#ffffff;

      /* Sidebar (dark – fixed) */
      --sb-bg:#0b1220; --sb-ink:#e6edf7; --sb-line:#20324d;

      /* Brand */
      --cc-accent:#3b82f6; --cc-accent-2:#60a5fa;
      --chart-grid: rgba(2,6,23,.10);

      /* Type scale + motion tokens */
      --font-sans: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      --fs-2xl: clamp(20px, 2.7vw, 24px);
      --fs-xl:  clamp(18px, 2.2vw, 20px);
      --fs-lg:  clamp(16px, 1.9vw, 18px);
      --fs-md:  clamp(14px, 1.6vw, 16px);
      --fs-sm:  13px;
      --lh-tight: 1.15; --lh-normal: 1.4;

      --elevate: cubic-bezier(.2,.8,.2,1);
      --pop:     cubic-bezier(.17,.67,.25,1.35);
      --fast: 140ms; --med: 220ms; --slow: 360ms;

      /* Glass touches */
      --glass-bg: color-mix(in oklab, var(--card) 78%, transparent);
      --glass-br: 12px;
      --glass-bd: 1px solid var(--line);
      --glass-shadow: 0 6px 24px rgba(0,0,0,.06);
    }

    @media (prefers-reduced-motion: reduce){
      *{ animation-duration:1ms !important; animation-iteration-count:1 !important; transition-duration:1ms !important; scroll-behavior:auto !important; }
    }

    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:var(--font-sans);
      -webkit-font-smoothing:antialiased;
    }
    a{text-decoration:none}

    /* ---------- App shell ---------- */
    .cc-shell{ min-height:100dvh; display:flex; align-items:stretch; width:100%; }

    /* Sidebar (always dark) */
    .cc-sidebar{
      position:sticky; top:0;
      width:var(--sidebar-w); flex:0 0 var(--sidebar-w);
      height:100dvh; overflow:auto; z-index:10;
      padding:16px; display:flex; flex-direction:column; gap:10px;
      background:var(--sb-bg); color:var(--sb-ink); border-right:1px solid var(--sb-line);
      color-scheme: dark;
    }
    .brand{ display:flex; align-items:center; gap:.6rem; font-weight:800; font-size:1.25rem; margin:2px 2px 10px; }
    .brand .logo{ display:grid; place-items:center; width:36px; height:36px; border-radius:10px; background:#132036; color:#8fb5ff; }

    .menu-group{ font-size:.76rem; opacity:.9; font-weight:800; letter-spacing:.02em; margin:8px 6px 6px; }
    .navlist{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:6px; }
    .navlink{ display:flex; align-items:center; gap:.6rem; padding:.58rem .72rem; border-radius:10px; font-weight:700; color:var(--sb-ink); border:1px solid transparent; min-height:44px; }
    .navlink .bi{ font-size:1.05rem; }
    .navlink:hover{ background:#121b2d; border-color:#1a2742; }
    .navlink.active{ background:var(--cc-accent); color:#fff; box-shadow:0 8px 24px rgba(59,130,246,.28); }
    .navlink.active .bi{ color:#fff; }
    .side-footer{ margin-top:auto; display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .side-footer .logout{ padding:.45rem .6rem; }

    /* Main */
    .cc-main{ flex:1 1 auto; min-width:0; position:relative; z-index:0; background:var(--bg); color:var(--ink); }
    .cc-page{ max-width:1200px; margin:0 auto; padding:18px; }

    /* Header – sticky, crisp, compact */
    .cc-header{
      position:sticky; top:0; z-index:2;
      background:rgba(255,255,255,.98);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .cc-header h1{ line-height:var(--lh-tight); letter-spacing:.01em; font-size:var(--fs-xl); font-weight:900; }

    .cc-actions{ display:flex; gap:.5rem; align-items:center; }

    /* Messages */
    .msg { border-radius: 12px; padding: .75rem 1rem; border: 1px solid var(--line); margin-bottom: .75rem; }
    .msg-info { background: #ecfeff; border-color: #bae6fd; color:#0c4a6e; }
    .msg-success { background: #ecfdf5; border-color:#bbf7d0; color:#065f46; }
    .msg-warning { background: #fffbeb; border-color:#fde68a; color:#92400e; }
    .msg-danger  { background: #fef2f2; border-color:#fecaca; color:#991b1b; }

    /* Global button style */
    .btn.primary{ background:var(--cc-accent); color:#fff; border:0; font-weight:800; min-height:44px; }
    .btn.muted{ background:#e2e8f0; color:#0b1220; border:0; font-weight:700; min-height:44px; }
    .btn.icon{ background:#eef2ff; color:#1d4ed8; border:1px solid #c7d2fe; font-weight:800; min-height:44px; }

    /* Micro-interactions */
    .hover-lift{ transition: transform var(--med) var(--elevate), box-shadow var(--med) var(--elevate); }
    .hover-lift:where(:hover,:focus-visible){ transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,.12); }
    .tap{ transition: transform var(--fast) var(--elevate); }
    .tap:active{ transform: scale(.98); }
    .focus-ring:focus-visible{ outline: 3px solid color-mix(in oklab, var(--cc-accent) 35%, transparent); outline-offset:2px; }
    .fade-in{ animation: fadeIn var(--slow) var(--elevate); }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)} }

    /* Compact glass card */
    .glass-card{ border-radius:var(--glass-br); border:var(--glass-bd); background:var(--glass-bg); box-shadow:var(--glass-shadow); }

    /* Mobile drawer */
    @media (max-width: 992px){
      .cc-sidebar{
        position:fixed; left:0; top:0; height:100dvh; transform:translateX(-100%);
        transition: transform .26s var(--elevate); box-shadow: 0 20px 60px rgba(0,0,0,.35);
      }
      .cc-sidebar.open{ transform:translateX(0); }
      .cc-backdrop{ position:fixed; inset:0; background:rgba(2,6,23,.42); backdrop-filter:blur(2px); display:none; z-index:9; }
      .cc-backdrop.show{ display:block; }
      .mobile-toggle{
        position:fixed; top:12px; left:12px; z-index:11;
        border:0; border-radius:12px; width:42px; height:42px;
        display:grid; place-items:center; background:var(--cc-accent); color:#fff;
        box-shadow:0 10px 22px rgba(59,130,246,.35);
      }
    }
    @media (min-width: 992px){
      .mobile-toggle{ display:none; }
      .offcanvas, [data-legacy-menu]{ display:none !important; }
    }

    /* Bottom mobile tab bar */
    .mobile-tabbar{ position:sticky; bottom:0; left:0; right:0; z-index:1030; backdrop-filter: blur(10px); background:color-mix(in oklab, var(--card) 85%, transparent); border-top:1px solid var(--line); }
    .mobile-tabbar .tab{ flex:1; text-align:center; padding:10px 4px; font-size:12px; color:var(--muted); min-height:44px; }
    .mobile-tabbar .tab.active{ color:var(--cc-accent); font-weight:800; }
    @media (min-width: 768px){ .mobile-tabbar{ display:none; } }

    /* Touch-friendly table cells */
    .table td, .table th{ vertical-align: middle; }
  </style>

  {% block extra_head %}{% endblock %}
  {% block extra_css %}{% endblock %}
</head>
<body>

<div class="cc-shell">
  {% block sidebar %}
    {% include "includes/_sidebar.html" %}
  {% endblock %}

  <button class="mobile-toggle tap focus-ring" id="sidebarOpen" aria-label="Open menu"><i class="bi bi-list"></i></button>
  <div class="cc-backdrop" id="ccBackdrop" aria-hidden="true"></div>

  <div class="cc-main">
    <header class="cc-header">
      <div class="cc-page d-flex align-items-center justify-content-between gap-2">
        <h1 class="m-0 fw-bold">{% block header_title %}Dashboard{% endblock %}</h1>
        <div class="cc-actions">{% block nav_actions %}{% endblock %}</div>
      </div>
    </header>

    <main class="cc-page">
      {% if messages %}
        {% for message in messages %}
          <div class="msg
              {% if 'error' in message.tags or 'danger' in message.tags %} msg-danger
              {% elif 'success' in message.tags %} msg-success
              {% elif 'warning' in message.tags %} msg-warning
              {% else %} msg-info
              {% endif %} fade-in">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}

      {# Compatibility: render whichever block a template uses #}
      {% block body %}{% endblock %}
      {% block content %}{% endblock %}
      {% block page_content %}{% endblock %}
      {% block main %}{% endblock %}
    </main>

    {# ------- SAFE URL CAPTURE (never raises) ------- #}
    {% url 'inventory:inventory_dashboard' as url_home %}
    {% url 'inventory:scan_in' as url_scan_in %}
    {% url 'inventory:scan_sold' as url_sell %}
    {% url 'inventory:stock_list' as url_stock %}
    {% url 'inventory:wallet' as url_wallet %}
    {% url 'reports:home' as url_reports %}

    {# Floating Primary Action – mobile #}
    <a href="{{ url_sell|default:'/inventory/scan-sold/' }}"
       class="btn btn-primary position-fixed d-md-none tap focus-ring"
       style="right:16px; bottom:76px; border-radius:999px; padding:.8rem 1rem; box-shadow:0 10px 20px rgba(0,0,0,.18);"
       aria-label="Sell or Scan">
      <i class="bi bi-lightning-charge"></i>
    </a>

    {# Bottom Tab Bar – mobile primary navigation #}
    <nav class="mobile-tabbar d-flex d-md-none">
      <a class="tab {% if active_tab == 'home' %}active{% endif %}" href="{{ url_home|default:'/inventory/dashboard/' }}">
        <i class="bi bi-speedometer2 d-block"></i>Home
      </a>
      <a class="tab {% if active_tab == 'scan_in' %}active{% endif %}" href="{{ url_scan_in|default:'/inventory/scan-in/' }}">
        <i class="bi bi-upc-scan d-block"></i>Scan
      </a>
      <a class="tab {% if active_tab == 'sell' %}active{% endif %}" href="{{ url_sell|default:'/inventory/scan-sold/' }}">
        <i class="bi bi-cart-check d-block"></i>Sell
      </a>
      <a class="tab {% if active_tab == 'stock' %}active{% endif %}" href="{{ url_stock|default:'/inventory/list/' }}">
        <i class="bi bi-box-seam d-block"></i>Stock
      </a>
      <a class="tab {% if active_tab == 'wallet' %}active{% endif %}" href="{{ url_wallet|default:'/wallet/' }}">
        <i class="bi bi-wallet2 d-block"></i>Wallet
      </a>
    </nav>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
<script src="{% static 'js/app.js' %}?v={{ STATIC_VERSION|default:'1' }}" defer></script>
<script>
  // Mobile drawer
  const sidebar  = document.querySelector('.cc-sidebar');
  const backdrop = document.getElementById('ccBackdrop');
  const openBtn  = document.getElementById('sidebarOpen');
  function openSidebar(){ sidebar?.classList.add('open'); backdrop?.classList.add('show'); }
  function closeSidebar(){ sidebar?.classList.remove('open'); backdrop?.classList.remove('show'); }
  openBtn?.addEventListener('click', openSidebar);
  backdrop?.addEventListener('click', closeSidebar);
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeSidebar(); });
  document.querySelectorAll('.cc-sidebar a').forEach(a=>{
    a.addEventListener('click', () => {
      if (window.matchMedia('(max-width: 992px)').matches) closeSidebar();
    });
  });

  // Active nav highlight
  (function(){
    const path = location.pathname.replace(/\/+$/,'/') || '/';
    document.querySelectorAll('.cc-sidebar a.navlink[href]').forEach(a=>{
      const href = (a.getAttribute('href')||'').replace(/\/+$/,'/') || '/';
      if (path === href || (href !== '/' && path.startsWith(href))){
        a.classList.add('active'); a.setAttribute('aria-current','page');
      }
    });
  })();

  // Keyboard shortcuts (guarded)
  (function(){
    const map = {};
    {% if url_home %}     map['g d'] = '{{ url_home }}'; {% endif %}
    {% if url_stock %}    map['g s'] = '{{ url_stock }}'; {% endif %}
    {% if url_reports %}  map['g r'] = '{{ url_reports }}'; {% endif %}
    {% if url_sell %}     map['s s'] = '{{ url_sell }}'; {% endif %}
    {% if url_scan_in %}  map['s i'] = '{{ url_scan_in }}'; {% endif %}

    let buffer=''; let timer=null;
    document.addEventListener('keydown', (e)=>{
      if (e.target.closest('input,textarea,[contenteditable=true]')) return;
      const key = e.key.length===1 ? e.key.toLowerCase() : ' ';
      if ((e.ctrlKey||e.metaKey) && key==='k'){ e.preventDefault(); document.querySelector('#global-search')?.focus(); return; }
      buffer += key;
      clearTimeout(timer); timer=setTimeout(()=>buffer='', 700);
      if(map[buffer]){ window.location = map[buffer]; buffer=''; }
    });
  })();
</script>

{% block extra_js %}{% endblock %}
</body>
</html>
