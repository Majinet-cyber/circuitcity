{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>{% block title %}Circuit City{% endblock %}</title>

  <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- CSS bundles -->
  <link rel="stylesheet" href="{% static 'css/tokens.css' %}?v={% now 'U' %}">
  <link rel="stylesheet" href="{% static 'css/app.css' %}?v={% now 'U' %}">
  <!-- NEW: Polished buttons/cards/mobile styles -->
  <link rel="stylesheet" href="{% static 'css/polish.css' %}?v={% now 'U' %}">

  <meta name="color-scheme" content="dark light">
  <meta name="theme-color" content="#0b5bd3">
  <meta name="robots" content="noindex, nofollow">

  {% block extra_css %}{% endblock %}

  <!-- Fallback tokens/layout if CSS isn't loaded (keeps UI usable) -->
  <style>
    :root[data-theme="light"]{
      --cc-bg:#f7fbff; --cc-panel:#ffffff; --cc-panel-2:#f2f7ff; --cc-border:#d6e4ff;
      --cc-text:#0b1533; --cc-muted:#4c5e85; --cc-accent:#0b5bd3;
    }
    :root[data-theme="dark"]{
      --cc-bg:#0b1220; --cc-panel:#0e1629; --cc-panel-2:#0f1b33; --cc-border:#20324d;
      --cc-text:#e5e7eb; --cc-muted:#a8b3cf; --cc-accent:#76a9ff;
    }

    html, body { height:100%; max-width:100%; overflow-x:hidden; } /* no sideways scroll */
    body.cc-body {
      margin:0; background:var(--cc-bg); color:var(--cc-text);
      font:14px/1.45 "Inter", system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }

    /* Prevent mobile auto-zoom; comfy tap targets */
    input, select, textarea, button { font-size:16px }
    button, .btn, .touch { min-height:44px }

    a { color:var(--cc-accent); text-decoration:none }
    a:hover { text-decoration:underline }

    /* Utilities / a11y */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    :focus-visible { outline:2px solid var(--cc-accent); outline-offset:2px; border-radius:.4rem; }

    /* Buttons (fallback only; polished styles come from polish.css) */
    .btn{display:inline-flex;align-items:center;gap:.45rem;padding:.6rem .9rem;border:1px solid var(--cc-border);
         border-radius:.65rem;background:var(--cc-panel);color:var(--cc-text);font-weight:700;cursor:pointer;text-decoration:none}
    .btn:hover{background:var(--cc-panel-2)}
    .btn-primary{background:#e7f0ff}
    .btn-green{background:#eafff7;border-color:#88e0c1}
    .cc-topbtn{white-space:nowrap}

    /* Alerts */
    .cc-alert{border:1px solid transparent;border-radius:.6rem;padding:.75rem 1rem;margin:.5rem 0;display:flex;gap:.6rem;align-items:flex-start}
    .cc-alert-success{background:#0a3323;color:#c7f0da;border-color:#187a54}
    .cc-alert-error{background:#3a0a0a;color:#ffd7d7;border-color:#a33a3a}
    .cc-alert-info{background:#0b2638;color:#cfe9ff;border-color:#2a6ea7}
    .cc-alert .close{margin-left:auto;opacity:.7;cursor:pointer;border:0;background:transparent;color:inherit}

    /* Topbar / shell */
    .cc-topnav{position:sticky;top:0;z-index:30;background:var(--cc-panel);border-bottom:1px solid var(--cc-border)}
    /* NEW: grid layout fills width and kills the ‚Äúempty right‚Äù look */
    .topbar{
      display:grid; grid-template-columns:auto 1fr auto; align-items:center;
      gap:.75rem; padding:.6rem 1rem; max-width:1200px; margin:0 auto;
      padding-right:calc(1rem + env(safe-area-inset-right)); /* notch-friendly */
    }
    .cc-brand{display:flex;align-items:center;gap:.5rem;color:var(--cc-text);font-weight:800;text-decoration:none}
    .cc-logo{font-size:1.2rem}

    .cc-shell{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 56px)}
    .cc-shell.no-sidebar{grid-template-columns:1fr}
    .cc-sidebar{background:var(--cc-panel);border-right:1px solid var(--cc-border);padding:1rem .75rem}
    .cc-sidebar-group{font-size:.8rem;color:var(--cc-muted);text-transform:uppercase;letter-spacing:.05em;margin:.75rem .25rem}
    .cc-sideitem{display:block;padding:.55rem .65rem;border-radius:.5rem;color:var(--cc-text);text-decoration:none}
    .cc-sideitem:hover{background:var(--cc-panel-2)}
    .cc-sideitem.active{background:#e7f0ff;border:1px solid var(--cc-border)}
    [data-theme="dark"] .cc-sideitem.active{background:#142447;border-color:#2a4a9c}
    .cc-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35)}
    .cc-main{padding:1rem}
    .cc-container{max-width:1200px;margin:0 auto}

    /* NEW: actions row scroll on small screens (no need to zoom out) */
    .cc-topnav-actions{display:flex;gap:.5rem;align-items:center;justify-content:flex-end;overflow-x:auto;max-width:100%;}
    .cc-topnav-actions::-webkit-scrollbar{display:none}
    .cc-topnav-actions .cc-topbtn{flex:0 0 auto}
    /* burger sized better for touch */
    #ccBurger{min-width:44px;min-height:44px;padding:.25rem .6rem}

    /* Tables (fallback) */
    table{width:100%;border-collapse:collapse}
    th,td{padding:.6rem .65rem;border-bottom:1px solid var(--cc-border);color:var(--cc-text)}
    thead th{font-weight:700;color:var(--cc-muted)}
    tbody tr:hover td{background:var(--cc-panel-2)}
    .table-wrap{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
    .table-wrap table{min-width:720px}

    /* Responsive charts (fallback) */
    .cc-chart-wrap{position:relative;width:100%;aspect-ratio:16/9}
    .cc-chart{display:block;width:100%;height:100%}
    @media (max-width:768px){ .cc-chart-wrap{aspect-ratio:4/3} }

    /* Mobile shell behavior */
    @media (max-width:1024px){
      .cc-shell{grid-template-columns:1fr}
      .cc-sidebar{position:fixed;left:0;top:56px;bottom:0;width:280px;transform:translateX(-102%);transition:transform .2s ease;box-shadow:0 10px 30px rgba(0,0,0,.25);z-index:40}
      .cc-sidebar.open{transform:translateX(0)}
      .cc-overlay[aria-hidden="true"]{display:none}
      .no-scroll{overflow:hidden}
    }

    /* === NEW: Mobile bottom nav + FAB (pure CSS, no Bootstrap) === */
    .cc-bottom-nav{
      position:fixed;left:0;right:0;bottom:0;z-index:32;
      display:none; /* enabled by JS on phones when auth */
      background:color-mix(in oklab, var(--cc-panel) 92%, transparent);
      border-top:1px solid var(--cc-border);
      backdrop-filter:blur(10px);
      padding:.35rem .5rem calc(.35rem + env(safe-area-inset-bottom));
    }
    .cc-bottom-row{display:flex;align-items:center;gap:.25rem}
    .cc-bottom-tab{
      flex:1;text-align:center;font-size:.8rem;color:var(--cc-text);text-decoration:none;
      padding:.35rem .25rem;border-radius:.65rem;transition:background .15s ease, transform .05s ease;
      display:flex;flex-direction:column;gap:.2rem;align-items:center;justify-content:center;
    }
    .cc-bottom-tab:active{ transform:translateY(1px) }
    .cc-bottom-tab .ico{font-size:1.2rem;line-height:1}
    .cc-bottom-tab.active{background:var(--cc-panel-2);font-weight:700}
    .cc-fab{
      position:fixed;right:16px;bottom:76px;z-index:33;
      display:none; /* enabled by JS on phones when auth */
      width:56px;height:56px;border-radius:16px;border:0;
      background:var(--cc-accent);color:#fff;box-shadow:0 10px 25px rgba(0,0,0,.15);
      font-size:1.35rem;cursor:pointer;
    }

    /* Ensure main content isn't hidden behind bottom nav on phones */
    body.has-bottom-nav .cc-main{ padding-bottom:calc(80px + env(safe-area-inset-bottom)); }

    /* Compact buttons on very small screens (keeps everything fitting) */
    @media (max-width:420px){
      .cc-topbtn{padding:.5rem .6rem;font-size:.9rem}
    }
  </style>
</head>
<body class="cc-body">
  <a href="#main" class="sr-only">Skip to content</a>

  <!-- Hidden CSRF token for JS -->
  <form id="__csrf__" style="display:none">{% csrf_token %}</form>

  <!-- Top Nav -->
  <header class="cc-topnav" role="banner">
    <div class="actions-row topbar">
      {% if request.user.is_authenticated %}
        <button class="cc-burger btn" id="ccBurger"
                aria-label="Toggle menu" aria-controls="ccSidebar" aria-expanded="false">‚ò∞</button>
      {% endif %}

      <a class="cc-brand" href="{% url 'inventory:stock_list' %}">
        <span class="cc-logo" aria-hidden="true">üì±</span>
        <span>Circuit City</span>
      </a>

      {% if request.user.is_authenticated %}
        <nav class="cc-topnav-actions actions-row" aria-label="Primary actions" style="display:flex;gap:.5rem;align-items:center">
          <a class="cc-topbtn btn btn-primary" href="{% url 'inventory:scan_in' %}">+ Stock IN</a>
          <a class="cc-topbtn btn btn-green"   href="{% url 'inventory:scan_sold' %}">‚úî Scan SOLD</a>
          <a class="cc-topbtn btn"             href="{% url 'inventory:scan_web' %}">üì∑ Scan (Web)</a>
          <a class="cc-topbtn btn"             href="{% url 'inventory:time_checkin_page' %}">‚è± Time Check-in</a>

          <a class="cc-topbtn btn"
             aria-label="Send beta feedback"
             href="mailto:beta@circuitcity.example?subject=Beta%20Feedback%20on%20Circuit%20City
&body=User:%20{{ request.user.username|default:'anon' }}
%0APath:%20{{ request.path }}
%0AUA:%20{{ request.META.HTTP_USER_AGENT|default:'n/a' }}
%0ATime:%20{% now 'c' %}">‚úâ Feedback</a>

          <div class="cc-user" style="display:flex;align-items:center;gap:.5rem">
            <button id="ccTheme" class="cc-topbtn btn cc-theme-toggle" title="Toggle theme" aria-label="Toggle theme">üåì</button>
            <span class="cc-user-name">{{ request.user.username }}</span>
            <a class="cc-logout" href="{% url 'logout' %}">Logout</a>
          </div>
        </nav>
      {% else %}
        <nav class="cc-topnav-actions" aria-label="Session" style="display:flex;gap:.5rem;align-items:center">
          <a class="cc-topbtn btn"
             aria-label="Send beta feedback"
             href="mailto:beta@circuitcity.example?subject=Beta%20Feedback%20on%20Circuit%20City
&body=User:%20anon
%0APath:%20{{ request.path }}
%0AUA:%20{{ request.META.HTTP_USER_AGENT|default:'n/a' }}
%0ATime:%20{% now 'c' %}">‚úâ Feedback</a>
          <a class="cc-topbtn btn" href="{% url 'login' %}">Sign in</a>
          <button id="ccTheme" class="cc-topbtn btn cc-theme-toggle" title="Toggle theme" aria-label="Toggle theme">üåì</button>
        </nav>
      {% endif %}
    </div>
  </header>

  <!-- Shell -->
  <div class="cc-shell{% if not request.user.is_authenticated %} no-sidebar{% endif %}">
    {% if request.user.is_authenticated %}
      <!-- Sidebar -->
      <aside class="cc-sidebar" id="ccSidebar" role="navigation" aria-label="Sidebar">
        <div class="cc-sidebar-group">Inventory</div>
        {% with n=request.resolver_match.url_name %}
          <a class="cc-sideitem {% if n == 'stock_list' %}active{% endif %}"
             {% if n == 'stock_list' %}aria-current="page"{% endif %}
             href="{% url 'inventory:stock_list' %}">üì¶ Stock List</a>

          <a class="cc-sideitem {% if n == 'scan_in' %}active{% endif %}"
             {% if n == 'scan_in' %}aria-current="page"{% endif %}
             href="{% url 'inventory:scan_in' %}">‚ûï Scan IN</a>

          <a class="cc-sideitem {% if n == 'scan_sold' %}active{% endif %}"
             {% if n == 'scan_sold' %}aria-current="page"{% endif %}
             href="{% url 'inventory:scan_sold' %}">‚úî Scan SOLD</a>

          <a class="cc-sideitem {% if n == 'scan_web' %}active{% endif %}"
             {% if n == 'scan_web' %}aria-current="page"{% endif %}
             href="{% url 'inventory:scan_web' %}">üì∑ Scan (Web)</a>

          <a class="cc-sideitem {% if n == 'time_checkin_page' %}active{% endif %}"
             {% if n == 'time_checkin_page' %}aria-current="page"{% endif %}
             href="{% url 'inventory:time_checkin_page' %}">‚è± Time Check-in</a>

          <a class="cc-sideitem {% if n == 'time_logs' %}active{% endif %}"
             {% if n == 'time_logs' %}aria-current="page"{% endif %}
             href="{% url 'inventory:time_logs' %}">üóì Time Logs</a>

          <!-- Unified Dashboard link -->
          <a class="cc-sideitem {% if n == 'inventory_dashboard' %}active{% endif %}"
             {% if n == 'inventory_dashboard' %}aria-current="page"{% endif %}
             href="{% url 'inventory:inventory_dashboard' %}">üìä Dashboard</a>
        {% endwith %}

        {% if request.user.is_staff %}
          <div class="cc-sidebar-group">Admin</div>
          <a class="cc-sideitem" href="{% url 'admin:index' %}">‚öôÔ∏è Django Admin</a>
          <a class="cc-sideitem" href="#">üßæ Reports (soon)</a>
          <a class="cc-sideitem" href="#">üîß Settings (soon)</a>
        {% endif %}
      </aside>

      <!-- Backdrop for mobile -->
      <div class="cc-overlay" id="ccOverlay" aria-hidden="true" hidden></div>
    {% endif %}

    <!-- Main -->
    <main id="main" class="cc-main" role="main" tabindex="-1" aria-live="polite">
      <div class="cc-container">
        {% if messages %}
          <div role="region" aria-live="polite" aria-label="Notifications">
            {% for message in messages %}
              <div class="cc-alert
                          {% if message.tags == 'success' %}cc-alert-success
                          {% elif message.tags == 'error' %}cc-alert-error
                          {% else %}cc-alert-info{% endif %}">
                <div>{{ message }}</div>
                <button class="close" aria-label="Dismiss">‚úï</button>
              </div>
            {% endfor %}
          </div>
        {% endif %}

        {% block body %}{% block content %}{% endblock %}{% endblock %}
      </div>
    </main>
  </div>

  {% if request.user.is_authenticated %}
  <!-- === NEW: Mobile Bottom Tabs & FAB (shown on phones) === -->
  {% with n=request.resolver_match.url_name %}
  <nav class="cc-bottom-nav" id="ccBottomNav" aria-label="Primary">
    <div class="cc-bottom-row">
      <a class="cc-bottom-tab {% if n == 'inventory_dashboard' %}active{% endif %}" href="{% url 'inventory:inventory_dashboard' %}" {% if n == 'inventory_dashboard' %}aria-current="page"{% endif %}>
        <span class="ico" aria-hidden="true">üè†</span>
        <span>Home</span>
      </a>
      <a class="cc-bottom-tab {% if n == 'stock_list' %}active{% endif %}" href="{% url 'inventory:stock_list' %}" {% if n == 'stock_list' %}aria-current="page"{% endif %}>
        <span class="ico" aria-hidden="true">üì¶</span>
        <span>Stock</span>
      </a>
      <a class="cc-bottom-tab {% if n == 'scan_in' %}active{% endif %}" href="{% url 'inventory:scan_in' %}" {% if n == 'scan_in' %}aria-current="page"{% endif %}>
        <span class="ico" aria-hidden="true">‚ûï</span>
        <span>Scan IN</span>
      </a>
      <a class="cc-bottom-tab {% if n == 'scan_sold' %}active{% endif %}" href="{% url 'inventory:scan_sold' %}" {% if n == 'scan_sold' %}aria-current="page"{% endif %}>
        <span class="ico" aria-hidden="true">‚úÖ</span>
        <span>SOLD</span>
      </a>
      <a class="cc-bottom-tab" href="/inventory/wallet/">
        <span class="ico" aria-hidden="true">üëõ</span>
        <span>Wallet</span>
      </a>
    </div>
  </nav>
  {% endwith %}

  <button class="cc-fab" id="ccFab" aria-label="Scan SOLD">üî≥</button>
  {% endif %}

  <!-- Sidebar + Theme + Alerts + CSRF-safe fetch + NEW: gestures/haptics -->
  <script>
    (function () {
      const root = document.documentElement;
      const key  = 'cc-theme';
      const saved = localStorage.getItem(key);
      const initial = saved || 'light';
      root.setAttribute('data-theme', initial);

      const themeMeta = document.querySelector('meta[name="theme-color"]');
      function setTheme(t){
        root.setAttribute('data-theme', t);
        localStorage.setItem(key, t);
        if (themeMeta) themeMeta.setAttribute('content', t === 'dark' ? '#0f172a' : '#0b5bd3');
      }
      const btn = document.getElementById('ccTheme');
      if (btn){ btn.addEventListener('click', () => setTheme(root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark')); }

      const burger  = document.getElementById('ccBurger');
      const sidebar = document.getElementById('ccSidebar');
      const overlay = document.getElementById('ccOverlay');
      function openSidebar(){
        if(!sidebar) return;
        sidebar.classList.add('open');
        if (overlay){ overlay.hidden=false; overlay.setAttribute('aria-hidden','false'); }
        document.body.classList.add('no-scroll');
        if (burger) burger.setAttribute('aria-expanded','true');
      }
      function closeSidebar(){
        if(!sidebar) return;
        sidebar.classList.remove('open');
        if (overlay){ overlay.hidden=true; overlay.setAttribute('aria-hidden','true'); }
        document.body.classList.remove('no-scroll');
        if (burger) burger.setAttribute('aria-expanded','false');
      }
      if (burger && sidebar){
        burger.addEventListener('click', ()=> sidebar.classList.contains('open') ? closeSidebar() : openSidebar());
        if (overlay) overlay.addEventListener('click', closeSidebar);
        sidebar.addEventListener('click', (e)=>{ if (e.target.closest('a')) closeSidebar(); });
        document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeSidebar(); });
        const mq = window.matchMedia('(min-width: 1025px)');
        mq.addEventListener('change', closeSidebar);
      }

      // Dismiss alerts
      document.querySelectorAll('.cc-alert .close').forEach(btn=>btn.addEventListener('click', ()=> btn.parentElement.remove()));
      setTimeout(()=>{ document.querySelectorAll('.cc-alert').forEach(el=>el.remove()); }, 4500);

      // CSRF wrapper for same-origin POST/PUT/PATCH/DELETE
      const csrfEl = document.querySelector('#__csrf__ input[name=csrfmiddlewaretoken]');
      const CSRF_TOKEN = csrfEl ? csrfEl.value : null;
      const SAFE_METHODS = new Set(['GET','HEAD','OPTIONS','TRACE']);
      const origFetch = window.fetch;
      window.fetch = function(input, init){
        init = init || {};
        const method = (init.method || 'GET').toUpperCase();
        const url = (typeof input === 'string') ? input : input.url;
        const sameOrigin = url.startsWith('/') || url.startsWith(location.origin);
        if (!SAFE_METHODS.has(method) && sameOrigin){
          const headers = new Headers(init.headers || {});
          if (CSRF_TOKEN && !headers.has('X-CSRFToken')) headers.set('X-CSRFToken', CSRF_TOKEN);
          init.headers = headers;
        }
        return origFetch(input, init);
      };

      // === NEW: enable bottom nav & FAB on small screens when authenticated ===
      const bottomNav = document.getElementById('ccBottomNav');
      const fab = document.getElementById('ccFab');
      if (bottomNav) {
        const isPhone = matchMedia('(max-width: 1024px)').matches;
        if (isPhone) {
          bottomNav.style.display = 'block';
          document.body.classList.add('has-bottom-nav');
          if (fab) {
            fab.style.display = 'inline-block';
            fab.addEventListener('click', () => { location.href = "{% url 'inventory:scan_sold' %}"; });
          }
        }
      }

      // === NEW: swipe from left edge to open sidebar (mobile) ===
      (function swipeToOpen(){
        if(!sidebar) return;
        let startX=null, startY=null, t0=0;
        const EDGE=24, MIN=60, MAX_ANGLE=25;
        window.addEventListener('touchstart', (e)=>{
          const t=e.touches[0]; if(!t) return;
          if (t.clientX <= EDGE) { startX=t.clientX; startY=t.clientY; t0=Date.now(); }
        }, {passive:true});
        window.addEventListener('touchend', (e)=>{
          if(startX==null) return;
          const t=e.changedTouches[0]; if(!t) return;
          const dx=t.clientX-startX, dy=Math.abs(t.clientY-startY);
          const angle=Math.atan2(dy, Math.abs(dx))*180/Math.PI;
          if(dx>MIN && angle<MAX_ANGLE && (Date.now()-t0)<600){ openSidebar(); }
          startX=startY=null;
        }, {passive:true});
      })();

      // === NEW: soft haptics (if supported) for key taps ===
      function vibrate(ms=12){ if('vibrate' in navigator){ try{ navigator.vibrate(ms); }catch{} } }
      ['ccBurger','ccFab'].forEach(id=>{
        const el=document.getElementById(id); if(el) el.addEventListener('click', ()=>vibrate(10), {passive:true});
      });
      document.querySelectorAll('.cc-bottom-tab, .cc-topbtn, .cc-sideitem, .btn').forEach(el=>{
        el.addEventListener('click', ()=>vibrate(8), {passive:true});
      });
    })();
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>
