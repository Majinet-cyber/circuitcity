{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard · Circuit City{% endblock %}
{% block header_title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
  /* --- Mobile-first tuning --- */
  :root{
    --chart-h: 220px;         /* default phone height */
    --chart-h-sm: 180px;
  }
  @media (min-width: 576px){
    :root{ --chart-h: 240px; --chart-h-sm: 200px; }
  }
  @media (min-width: 992px){
    :root{ --chart-h: 260px; --chart-h-sm: 210px; }
  }

  .panel{
    border-radius:var(--radius,12px);
    border:1px solid var(--cc-border);
    background:var(--cc-panel);
    box-shadow:var(--cc-shadow);
    padding:1rem;
  }
  .panel h5,.card-head>div{ font-weight:900; letter-spacing:.01em }

  /* KPIs → 2-cols on phones, 4 on desktops */
  .kpi-row{
    display:grid; gap:12px; grid-template-columns:1fr 1fr; margin-bottom:12px;
  }
  @media (min-width: 992px){
    .kpi-row{ grid-template-columns:repeat(4,1fr); }
  }
  .kpi .label{ color:var(--cc-muted); font-weight:800 }
  .kpi .value{ font-size:clamp(1.2rem, 3.4vw, 1.6rem); font-weight:900 }

  /* Charts */
  .chart-canvas{ width:100% !important; height:var(--chart-h) !important }
  .chart-canvas--sm{ height:var(--chart-h-sm) !important }

  /* Main grids: stack on phones */
  .dash-grid{
    display:grid; gap:12px; grid-template-columns:1fr; grid-auto-rows:minmax(0,auto);
  }
  .dash-grid .left{ order:-1; }
  @media (min-width: 992px){
    .dash-grid{
      grid-template-columns:2fr 1fr;
      grid-template-rows:minmax(0,1fr) minmax(0,1fr);
      height:clamp(540px,62vh,760px);
    }
    .dash-grid .left{ grid-row:1 / span 2; }
  }

  .equal-grid{ display:grid; gap:12px; grid-template-columns:1fr; align-items:stretch; }
  @media (min-width: 992px){
    .equal-grid{ grid-template-columns:7fr 5fr; }
  }

  .ai-item{ display:flex; gap:.5rem; align-items:flex-start; }
  .ai-item .badge{ margin-top:.15rem }
  .empty-hint{ color:var(--cc-muted); font-weight:700; padding:.5rem 0 .2rem }

  /* Filters: phone-friendly line wrap */
  .filters .form-select{ min-width:min(160px, 45vw); }
  .filters .btn{ min-height:44px; }

  /* CFO band layout */
  .cfo-band{ display:grid; gap:12px; grid-template-columns:1fr; margin-bottom:12px; }
  @media (min-width: 992px){ .cfo-band{ grid-template-columns: 2fr 1fr; } }

  /* Simulation quick actions */
  .sim-actions .btn{ min-width: 160px; }
  .muted-note{ color:var(--cc-muted); }

  /* Mobile FAB for primary action (Scan) */
  .cc-fab{
    position:fixed; right:18px;
    bottom: calc(var(--tabbar-h,64px) + var(--safe-bottom, 0px) + 18px);
    width:56px; height:56px; border-radius:28px; display:grid; place-items:center;
    background:var(--cc-accent); color:white; box-shadow:0 10px 24px rgba(0,0,0,.35);
    z-index: 1040;
  }
  .cc-fab:active{ transform: translateY(1px) scale(.98); }
  @media (min-width: 768px){ .cc-fab{ display:none; } }
</style>
{% endblock %}

{% block content %}

  {# Resolve URLs we need here #}
  {% url 'inventory:scan_in' as url_scan_in %}

  {# Derive a boolean for “manager-like” (admin/staff OR manager) #}
  {% with is_mgr=(request.user.is_staff or request.user.profile.is_manager) %}

  <!-- KPI band -->
  <section class="kpi-row">
    <div class="kpi panel">
      <div class="label">Revenue ({{ period|default:"month"|title }})</div>
      <div class="value">MK {{ total_revenue|default:0|floatformat:0|intcomma }}</div>
      {% if revenue_delta is not None %}
        <span class="delta {% if revenue_delta >= 0 %}up{% else %}down{% endif %}">{{ revenue_delta|floatformat:1 }}%</span>
      {% endif %}
    </div>
    <div class="kpi panel">
      <div class="label">Units Sold</div>
      <div class="value">{{ total_units|default:0|intcomma }}</div>
      {% if units_delta is not None %}
        <span class="delta {% if units_delta >= 0 %}up{% else %}down{% endif %}">{{ units_delta|floatformat:1 }}%</span>
      {% endif %}
    </div>
    <div class="kpi panel">
      <div class="label">Stock Value</div>
      <div class="value">MK {{ stock_value|default:0|floatformat:0|intcomma }}</div>
    </div>
    <div class="kpi panel">
      <div class="label">Low / Out Items</div>
      <div class="value">{{ low_items|default:0|intcomma }}</div>
    </div>
  </section>

  {# ✅ Financial Overview (AI-CFO) — managers/admins only #}
  {% if is_mgr %}
  <section class="cfo-band">
    <div class="panel">
      {% include "dashboard/partials/cfo_tiles.html" %}
    </div>
    <div class="panel">
      {% include "dashboard/partials/cfo_alerts.html" %}
    </div>
  </section>
  {% endif %}

  <!-- Band 1 -->
  <section class="dash-grid mb-3">
    <!-- Sales Trend -->
    <div class="panel card header left" id="salesCard">
      <div class="card-head d-flex justify-content-between align-items-center">
        <div>Sales Trend</div>
        <div class="d-flex gap-2 align-items-center">
          <label class="visually-hidden" for="trendPeriod">Trend period</label>
          <select id="trendPeriod" class="form-select" style="width:auto">
            <option value="7d">Last 7 days</option>
            <option value="month" selected>This month</option>
            <option value="all">All time</option>
            <option value="date">Choose date…</option>
          </select>
          <input type="date" id="trendDate" class="form-control" style="width:auto; display:none;">
          <label class="visually-hidden" for="trendMetric">Trend metric</label>
          <select id="trendMetric" class="form-select" style="width:auto">
            <option value="count" selected>Count</option>
            <option value="amount">Amount</option>
          </select>
        </div>
      </div>
      <div class="card-body">
        <canvas id="salesTrend" class="chart-canvas" aria-label="Sales trend"></canvas>
        <div id="salesEmpty" class="empty-hint d-none">No sales yet for this selection. Try switching the metric/period.</div>
        <div id="errSales" class="text-danger small mt-2 d-none"></div>
      </div>
    </div>

    <!-- AI Insights (agent-safe: copy clarifies scope) -->
    <div class="panel card header" id="aiCard">
      <div class="card-head d-flex justify-content-between align-items-center">
        <div>
          AI-Driven Insights
          {% if not is_mgr %}
            <span class="small text-muted">· for your stock &amp; sales</span>
          {% endif %}
        </div>
        <button id="ai-recs-refresh" type="button" class="btn icon tap" onclick="window.buzz&&buzz(8)"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
      </div>
      <div class="card-body">
        <div id="ai-viewport" class="small"></div>
        <div class="d-flex justify-content-between align-items-center mt-2">
          <div id="ai-recs-overall" class="small" style="color:var(--cc-muted)"></div>
          <div class="small" style="color:var(--cc-muted)">Auto-rotates every 5s</div>
        </div>
        <div id="errAI" class="text-danger small mt-2 d-none"></div>
      </div>
    </div>

    <!-- Value Trend -->
    <div class="panel card header" id="valueCard">
      <div class="card-head d-flex justify-content-between align-items-center">
        <div>Value Trend</div>
        <div class="d-flex gap-2 align-items-center">
          <label class="visually-hidden" for="vtMetric">Value metric</label>
          <select id="vtMetric" class="form-select" style="width:auto">
            <option value="revenue" selected>Revenue</option>
            <option value="cost">Cost</option>
            <option value="profit">Profit</option>
          </select>
          <label class="visually-hidden" for="vtPeriod">Value period</label>
          <select id="vtPeriod" class="form-select" style="width:auto">
            <option value="today">Today</option>
            <option value="7d" selected>Last 7 days</option>
            <option value="all">All time</option>
            <option value="date">Choose date…</option>
          </select>
          <input type="date" id="vtDate" class="form-control" style="width:auto; display:none;">
        </div>
      </div>
      <div class="card-body">
        <canvas id="valueTrend" class="chart-canvas chart-canvas--sm" aria-label="Value trend"></canvas>
        <div id="valueEmpty" class="empty-hint d-none">No values to plot.</div>
        <div id="errValue" class="text-danger small mt-2 d-none"></div>
      </div>
    </div>
  </section>

  <!-- Band 2 -->
  <section class="equal-grid mb-3">
    <div>
      <div class="panel card header h-100" id="topCard">
        <div class="card-head d-flex justify-content-between align-items-center">
          <div>Top-Selling Models</div>
          <div class="d-flex gap-2 align-items-center">
            <label class="visually-hidden" for="topPeriod">Top models period</label>
            <select id="topPeriod" class="form-select" style="width:auto">
              <option value="today">Today</option>
              <option value="month" selected>This month</option>
              <option value="date">Choose date…</option>
            </select>
            <input type="date" id="topDate" class="form-control" style="width:auto; display:none;">
          </div>
        </div>
        <div class="card-body">
          <canvas id="topModels" class="chart-canvas chart-canvas--sm" aria-label="Top models"></canvas>
          <div id="topEmpty" class="empty-hint d-none">No model sales yet.</div>
          <div id="errTop" class="text-danger small mt-2 d-none"></div>
        </div>
      </div>
    </div>

    <div>
      <div class="panel card h-100" id="alertCard">
        <h5 class="m-0 mb-2">Stock Alerts</h5>
        <ul id="alertsList" class="list-group list-group-flush">
          <li class="list-group-item" style="color:var(--cc-muted)">Loading…</li>
        </ul>
      </div>
    </div>
  </section>

  {# ✅ Simulation & Scenarios — managers/admins only (agents don’t see this) #}
  {% if is_mgr %}
  <section class="mb-3">
    <div class="panel card">
      <div class="card-head d-flex justify-content-between align-items-center">
        <div>Simulation &amp; Scenarios</div>
        <span class="small muted-note">Model growth, profit, and breakeven with saved scenarios</span>
      </div>
      <div class="card-body sim-actions">
        <div class="d-flex flex-wrap gap-2">
          <a class="btn btn-outline-primary tap" href="/simulator/new/" onclick="window.buzz&&buzz(8)">
            <i class="bi bi-magic me-1"></i> New Scenario
          </a>
          <a class="btn btn-primary tap" href="/simulator/" onclick="window.buzz&&buzz(8)">
            <i class="bi bi-graph-up me-1"></i> Open Simulator
          </a>
          <a class="btn btn-outline-secondary tap" href="/simulator/compare/?id=1&id=2" onclick="window.buzz&&buzz(8)">
            <i class="bi bi-bar-chart-line me-1"></i> Compare (sample)
          </a>
        </div>
        <div class="small mt-2 muted-note">
          Tip: Use “Compare” like <code>/simulator/compare/?id=12&amp;id=15</code> to overlay Net Profit curves across scenarios.
        </div>
      </div>
    </div>
  </section>
  {% endif %}

  <!-- Mobile FAB: quick Scan (safe URL) -->
  <a href="{{ url_scan_in|default:'/inventory/scan-in/' }}" class="cc-fab" onclick="window.buzz&&buzz(8)" aria-label="Scan">
    <i class="bi bi-upc-scan fs-4"></i>
  </a>

  {% endwith %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
  const nf = new Intl.NumberFormat();
  const CURRENT_MODEL = {{ model_id|default:"null" }};
  const MODEL_QS = (CURRENT_MODEL !== null) ? `&model=${encodeURIComponent(CURRENT_MODEL)}` : '';

  // helpers
  const $id = (id)=>document.getElementById(id);
  const show = (id)=>$id(id)?.classList.remove('d-none');
  const hide = (id)=>$id(id)?.classList.add('d-none');
  const cssVar=(name,fb)=> (getComputedStyle(document.documentElement).getPropertyValue(name).trim() || fb);
  const GRID_CLR=()=> cssVar('--chart-grid','#d8e3ff');
  const BRAND  =()=> cssVar('--cc-accent','#3b82f6');

  // axis helpers
  function chooseMoneyStep(max){
    const c=[100000,200000,250000,500000,1000000,2000000,5000000];
    for(const s of c){ if(max/s<=6) return s; }
    return Math.pow(10, Math.max(2, Math.ceil(Math.log10(max||1))-1));
  }
  function axisMoney(values){
    const m=Math.max(0,...(values||[0]));
    const step=chooseMoneyStep(m||100000);
    const niceMax=Math.max(step*2, Math.ceil((m||(step*1.5))/step)*step);
    return {min:0, max:niceMax, stepSize:step};
  }
  function axisCount(values){
    const m=Math.max(0,...(values||[0]));
    const nice=Math.max(1, Math.ceil(m));
    return {min:0, max:Math.max(1,nice), stepSize:1};
  }

  async function fetchJSON(url,{legacy=[]}={}){
    const doFetch = (u)=> fetch(u,{credentials:'same-origin', headers:{Accept:'application/json'}});
    const tryOnce = async (u)=>{
      const r = await doFetch(u);
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const ct=(r.headers.get('content-type')||'').toLowerCase();
      if(!ct.includes('application/json')) throw new Error('Not JSON');
      return r.json();
    };
    try{ return await tryOnce(url); }
    catch(e){ for(const alt of legacy){ try{ return await tryOnce(alt); }catch(_){} } throw e; }
  }

  // ---- date toggles (show input when "Choose date…" is picked) ----
  function bindDateToggle(selectId, inputId){
    const sel=$id(selectId), input=$id(inputId);
    if(!sel || !input) return;
    const ensureToday=()=>{ const t=new Date(); const mm=String(t.getMonth()+1).padStart(2,'0'); const dd=String(t.getDate()).padStart(2,'0'); return `${t.getFullYear()}-${mm}-${dd}`; };
    function toggle(){
      if(sel.value==='date'){
        input.style.display='inline-block';
        if(!input.value) input.value = ensureToday();
        input.focus();
      } else {
        input.style.display='none';
      }
    }
    sel.addEventListener('change', toggle);
    toggle();
  }
  bindDateToggle('trendPeriod','trendDate');
  bindDateToggle('vtPeriod','vtDate');
  bindDateToggle('topPeriod','topDate');

  // ---------- Sales Trend ----------
  let salesChart=null;
  async function loadTrend(){
    const metricSel=$id('trendMetric'); const periodSel=$id('trendPeriod'); const dateInp=$id('trendDate');
    if(!metricSel||!periodSel) return;

    hide('errSales'); hide('salesEmpty');

    let period=periodSel.value;
    const metric=metricSel.value;
    let dateQS='';

    if(period==='date'){
      if(!dateInp.value){ alert('Pick a date'); return; }
      dateQS = `&date=${encodeURIComponent(dateInp.value)}`;
    }

    const getData=(m)=> fetchJSON(
      // underscore FIRST (works on your server), hyphen as fallback
      `/inventory/api_sales_trend/?period=${encodeURIComponent(period)}&metric=${encodeURIComponent(m)}${dateQS}${MODEL_QS}`,
      { legacy:[`/inventory/api/sales-trend/?period=${encodeURIComponent(period)}&metric=${encodeURIComponent(m)}${dateQS}${MODEL_QS}`] }
    );

    let data;
    try{ data=await getData(metric); }
    catch(e){ show('errSales'); $id('errSales').textContent=`Sales trend error: ${e.message}`; return; }

    let labels=data?.labels||[];
    let values=(data?.values||[]).map(v=>Number(v)||0);
    const isAmount=(metric==='amount');
    const sign=isAmount?(data?.currency?.sign||'MK'):''; // MK default

    // If "amount" is all zeros, auto-switch to "count"
    if(isAmount && labels.length && values.every(v=>v===0)){
      try{
        const alt=await getData('count'); const altVals=(alt?.values||[]).map(v=>Number(v)||0);
        if(alt?.labels?.length && altVals.some(v=>v>0)){ labels=alt.labels; values=altVals; }
      }catch{}
    }

    const el=$id('salesTrend'); salesChart?.destroy();
    if(!labels.length || values.every(v=>v===0)){ show('salesEmpty'); return; }

    const yCfg=(metric==='count')?axisCount(values):axisMoney(values);
    const ctx=el.getContext('2d');
    const blue=BRAND();
    salesChart = new Chart(ctx,{
      type:'line',
      data:{ labels, datasets:[{ label: metric==='count'?'Sales (count)':`Sales (${sign})`, data:values, borderColor:blue, backgroundColor:blue+'20', fill:true, pointRadius:2, tension:.35 }]},
      options:{
        responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},
        animation:{ duration:500, easing:'easeOutCubic' },
        scales:{ x:{ grid:{ color:GRID_CLR() }}, y:{ min:yCfg.min, max:yCfg.max, grid:{ color:GRID_CLR() }, ticks:{ stepSize:yCfg.stepSize, callback:(v)=> metric==='count'?v:`${sign} ${nf.format(v)}` } } }
      }
    });
  }

  // ---------- Top Models ----------
  let topChart=null;
  async function loadTop(){
    const periodSel=$id('topPeriod'); const dateInp=$id('topDate'); if(!periodSel) return;
    hide('errTop'); hide('topEmpty');

    let p=periodSel.value;
    let dateQS='';
    if(p==='date'){
      p='today'; // API uses 'today' or 'month'; use today when a specific date is chosen
      if(!dateInp.value){ alert('Pick a date'); return; }
      dateQS=`&date=${encodeURIComponent(dateInp.value)}`;
    }

    let data=null;
    try{
      // underscore FIRST, hyphen fallback
      data=await fetchJSON(`/inventory/api_top_models/?period=${encodeURIComponent(p)}${dateQS}${MODEL_QS}`,
              { legacy:[`/inventory/api/top-models/?period=${encodeURIComponent(p)}${dateQS}${MODEL_QS}`] });
    }catch(e){ show('errTop'); $id('errTop').textContent=`Top models error: ${e.message}`; return; }

    const labels=data?.labels||[], values=(data?.values||[]).map(v=>Number(v)||0);
    topChart?.destroy();
    const el=$id('topModels');
    if(!labels.length || values.every(v=>v===0)){ show('topEmpty'); return; }

    const y=axisCount(values); const blue=BRAND();
    topChart = new Chart(el,{
      type:'bar',
      data:{ labels, datasets:[{ label:'Units', data:values, backgroundColor:blue, borderColor:blue }]},
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } },
        animation:{ duration:500, easing:'easeOutCubic' },
        scales:{ x:{ grid:{ display:false }}, y:{ min:y.min, max:y.max, grid:{ color:GRID_CLR() }, ticks:{ stepSize:y.stepSize } } }
      }
    });
  }

  // ---------- Alerts ----------
  async function loadAlerts(){
    const ul=$id('alertsList'); if(!ul) return;
    try{
      const d=await fetchJSON(`/inventory/api/alerts/?_=${Date.now()}${MODEL_QS}`);
      const items=(d.alerts||[]).map(a=>{
        const sev=a.severity==='high'?'danger':(a.severity==='warn'?'warning':'secondary');
        return `<li class="list-group-item d-flex align-items-center gap-2">
                  <span class="badge text-bg-${sev}">${a.type||'Alert'}</span>
                  <span>${a.message||''}</span>
                </li>`;
      }).join('');
      ul.innerHTML = items || '<li class="list-group-item" style="color:var(--cc-muted)">No alerts 🎉</li>';
    }catch{ ul.innerHTML = `<li class="list-group-item" style="color:var(--cc-muted)">Alerts unavailable</li>`; }
  }

  // ---------- AI (rotating) ----------
  let aiSlides=[]; let aiTimer=null; let aiIdx=0;
  const renderAISlide=(i)=>{ const vp=$id('ai-viewport'); if(vp) vp.innerHTML=aiSlides[i] || '<div class="text-muted">No insights</div>'; };
  const startAIRotation=()=>{ stopAIRotation(); if(aiSlides.length<=1) return; aiTimer=setInterval(()=>{ aiIdx=(aiIdx+1)%aiSlides.length; renderAISlide(aiIdx); },5000); };
  const stopAIRotation =()=>{ if(aiTimer){ clearInterval(aiTimer); aiTimer=null; } };

  async function loadAI(){
    const viewport=$id('ai-viewport'); const overallEl=$id('ai-recs-overall'); if(!viewport) return;
    hide('errAI'); viewport.innerHTML='<span class="text-muted">Loading…</span>'; if(overallEl) overallEl.textContent='';
    try{
      const data=await fetchJSON(`/inventory/api/predictions/?_=${Date.now()}${MODEL_QS}`,
        { legacy:[`/inventory/api/predictions?_=${Date.now()}${MODEL_QS}`, `/inventory/api-predictions/?_=${Date.now()}${MODEL_QS}`, `/inventory/api_predictions/?_=${Date.now()}${MODEL_QS}`] });

      const risky=(data.risky||[]);
      aiSlides = risky.length ? risky.map(x=>`
          <div class="ai-item">
            <span class="badge text-bg-danger">Risk</span>
            <div><b>${x.product}</b> likely stockout by ${x.stockout_date}. On-hand ${x.on_hand}. Restock <b>${x.suggested_restock}</b>.</div>
          </div>`)
        : [`<div class="ai-item"><span class="badge text-bg-success">OK</span><div>All good — no stockouts predicted.</div></div>`];

      aiIdx=0; renderAISlide(aiIdx); startAIRotation();

      if(overallEl){
        const total=(data.overall||[]).reduce((s,x)=>s+(x.predicted_units||0),0);
        const rev=(data.overall||[]).reduce((s,x)=>s+(+x.predicted_revenue||0),0);
        const sign=data?.currency?.sign||'MK';
        overallEl.innerHTML = `Next 7 days: <b>${nf.format(total)}</b> units • <b>${sign} ${nf.format(Math.round(rev))}</b>`;
      }
    }catch(e){
      show('errAI'); $id('errAI').textContent=`Insights error: ${e.message}`;
      aiSlides=['<div class="text-danger">No insights</div>']; renderAISlide(0); stopAIRotation();
    }
  }

  // ---------- Value Trend ----------
  let vtChart=null;

  function mergeByLabel(aLabels, aVals, bLabels, bVals){
    const mapA=new Map(aLabels.map((l,i)=>[l, Number(aVals[i])||0]));
    const lbls=[...new Set([...aLabels, ...bLabels])].sort();
    const outA=lbls.map(l=>mapA.get(l)||0);
    const mapB=new Map(bLabels.map((l,i)=>[l, Number(bVals[i])||0]));
    const outB=lbls.map(l=>mapB.get(l)||0);
    return {labels:lbls, A:outA, B:outB};
  }
  function mapVtToSalesPeriod(vt){ return (vt==='7d'||vt==='today') ? '7d' : 'month'; }

  async function tryValueTrend(metric, period, dateQS){
    try{
      // underscore FIRST (prevents 501), hyphen fallback
      return await fetchJSON(`/inventory/api_value_trend/?metric=${encodeURIComponent(metric)}&period=${encodeURIComponent(period)}${dateQS}${MODEL_QS}`,
        { legacy:[`/inventory/api/value-trend/?metric=${encodeURIComponent(metric)}&period=${encodeURIComponent(period)}${dateQS}${MODEL_QS}`] });
    }catch(_){}

    if(metric==='profit'){
      try{
        const d = await fetchJSON(`/inventory/api_profit_bar/?period=${encodeURIComponent(period)}${dateQS}${MODEL_QS}`,
                                   { legacy:[`/inventory/api/profit-bar/?period=${encodeURIComponent(period)}${dateQS}${MODEL_QS}`] });
        if(d?.labels?.length) return { labels:d.labels, values:(d.values||[]), currency:{sign:d?.currency?.sign||'MK'} };
      }catch(_){}
    }

    if(metric==='revenue' || metric==='cost'){
      let rev=null;
      try{
        const p = mapVtToSalesPeriod(period);
        // underscore FIRST, hyphen fallback
        rev = await fetchJSON(`/inventory/api_sales_trend/?period=${encodeURIComponent(p)}&metric=amount${dateQS}${MODEL_QS}`,
                              { legacy:[`/inventory/api/sales-trend/?period=${encodeURIComponent(p)}&metric=amount${dateQS}${MODEL_QS}`] });
      }catch(_){}

      if(metric==='revenue' && rev?.labels?.length) return { labels:rev.labels, values:(rev.values||[]), currency:{sign:rev?.currency?.sign||'MK'} };

      try{
        const pr = await fetchJSON(`/inventory/api_profit_bar/?period=${encodeURIComponent(period)}${dateQS}${MODEL_QS}`,
                                    { legacy:[`/inventory/api/profit-bar/?period=${encodeURIComponent(period)}${dateQS}${MODEL_QS}`] });
        if(rev?.labels?.length && pr?.labels?.length){
          const merged=mergeByLabel(rev.labels, rev.values, pr.labels, pr.values);
          const cost=merged.labels.map((_,i)=> (merged.A[i]||0) - (merged.B[i]||0));
          return { labels:merged.labels, values:cost, currency:{sign:rev?.currency?.sign||'MK'} };
        }
      }catch(_){}
    }
    return null;
  }

  async function loadValueTrend(){
    const mSel=$id('vtMetric'); const pSel=$id('vtPeriod'); const dInp=$id('vtDate'); if(!mSel||!pSel) return;
    hide('errValue'); hide('valueEmpty');

    let period=pSel.value;
    let dateQS='';
    if(period==='date'){
      if(!dInp.value){ alert('Pick a date'); return; }
      dateQS=`&date=${encodeURIComponent(dInp.value)}`;
    }

    let data=null;
    try{ data = await tryValueTrend(mSel.value, period, dateQS); }catch{}

    const el=$id('valueTrend'); vtChart?.destroy();
    const labels=data?.labels||[]; const values=(data?.values||[]).map(v=>Number(v)||0);
    const sign = data?.currency?.sign || 'MK';

    if(!labels.length || values.every(v=>v===0)){ show('valueEmpty'); return; }

    const y=axisMoney(values);
    const ctx=el.getContext('2d');
    const blue=BRAND();

    vtChart = new Chart(ctx,{
      type:'line',
      data:{ labels, datasets:[{ label:(mSel.value.charAt(0).toUpperCase()+mSel.value.slice(1))+` (${sign})`, data:values, borderColor:blue, backgroundColor:blue+'20', fill:true, pointRadius:2, tension:.35 }]},
      options:{ responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ display:true }, tooltip:{ callbacks:{ label:(c)=> `${sign} ${nf.format(c.parsed.y||0)}` } } },
        animation:{ duration:500, easing:'easeOutCubic' },
        scales:{ x:{ grid:{ color:GRID_CLR() }}, y:{ min:y.min, max:y.max, grid:{ color:GRID_CLR() }, ticks:{ stepSize:y.stepSize, callback:(v)=> `${sign} ${nf.format(v)}` } } }
      }
    });
  }

  // Wire up
  $id('trendPeriod')?.addEventListener('change', loadTrend);
  $id('trendMetric')?.addEventListener('change', loadTrend);
  $id('topPeriod')?.addEventListener('change', loadTop);
  $id('ai-recs-refresh')?.addEventListener('click', loadAI);
  $id('vtMetric')?.addEventListener('change', loadValueTrend);
  $id('vtPeriod')?.addEventListener('change', loadValueTrend);
  $id('trendDate')?.addEventListener('change', loadTrend);
  $id('vtDate')?.addEventListener('change', loadValueTrend);
  $id('topDate')?.addEventListener('change', loadTop);

  (async function init(){
    await Promise.allSettled([loadTrend(), loadTop(), loadAlerts(), loadAI(), loadValueTrend()]);
  })();
</script>
{% endblock %}
