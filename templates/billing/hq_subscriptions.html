{# hq/templates/hq_subscriptions.html #}
{% extends "hq/base.html" %}
{% load humanize %}

{% block title %}Subscriptions{% endblock %}

{# ========= COMPAT: your base defines "head", so we mirror extra_head here ========= #}
{% block head %}
  {{ block.super }}
  <style>
    :root { color-scheme: light; }
    body { background:#f8fafc !important; color:#0f172a !important; }

    /* Keep sidebar visible on desktop */
    @media (min-width: 992px){
      .sidebar, .cc-sidebar, .app-sidebar{
        display:block !important; visibility:visible !important; opacity:1 !important; transform:none !important;
      }
    }

    .card{background:#fff;border:1px solid #e5e7eb;box-shadow:0 1px 2px rgba(16,24,40,.05)}
    .table thead th{background:#f3f4f6 !important;color:#0f172a !important;border-bottom-color:#e5e7eb}

    /* Rectangular (no circles) */
    .label{display:inline-block;padding:.35rem .6rem;font-size:.875rem;line-height:1;font-weight:700;border-radius:6px;color:#fff}
    .label-info{background:#06b6d4}
    .label-success{background:#16a34a}
    .label-warn{background:#f59e0b}
    .label-muted{background:#64748b}

    .actions .btn{margin-inline-end:.4rem;margin-block:.15rem}
  </style>
{% endblock %}

{# Keep your original block for future compatibility with other bases #}
{% block extra_head %}
<style>
  :root { color-scheme: light; }
  body { background:#f8fafc !important; color:#0f172a !important; }

  /* Keep sidebar visible on desktop */
  @media (min-width: 992px){
    .sidebar, .cc-sidebar, .app-sidebar{
      display:block !important; visibility:visible !important; opacity:1 !important; transform:none !important;
    }
  }

  .card{background:#fff;border:1px solid #e5e7eb;box-shadow:0 1px 2px rgba(16,24,40,.05)}
  .table thead th{background:#f3f4f6 !important;color:#0f172a !important;border-bottom-color:#e5e7eb}

  /* Rectangular (no circles) */
  .label{display:inline-block;padding:.35rem .6rem;font-size:.875rem;line-height:1;font-weight:700;border-radius:6px;color:#fff}
  .label-info{background:#06b6d4}
  .label-success{background:#16a34a}
  .label-warn{background:#f59e0b}
  .label-muted{background:#64748b}

  .actions .btn{margin-inline-end:.4rem;margin-block:.15rem}
</style>
{% endblock %}

{# ---------- PAGE BODY (used by both `main` and `content`) ---------- #}
{% block main %}
<div class="container-xl my-4">
  <div class="d-flex align-items-center gap-2 mb-3">
    <h1 class="h4 mb-0">Subscriptions</h1>

    {# safe count #}
    {% if page_obj %}
      <span class="badge text-bg-light border">{{ page_obj.paginator.count }}</span>
    {% elif rows %}
      <span class="badge text-bg-light border">{{ rows|length }}</span>
    {% elif subs %}
      <span class="badge text-bg-light border">{{ subs|length }}</span>
    {% else %}
      <span class="badge text-bg-light border">0</span>
    {% endif %}
  </div>

  <form class="row g-2 align-items-center mb-3" method="get">
    <div class="col">
      <input name="q" value="{{ q|default:'' }}" class="form-control" placeholder="Search business or plan…">
    </div>
    <div class="col-auto">
      <select name="status" class="form-select">
        <option value="">Any status</option>
        <option value="trial"   {% if status == 'trial' %}selected{% endif %}>Trial</option>
        <option value="active"  {% if status == 'active' %}selected{% endif %}>Active</option>
        <option value="grace"   {% if status == 'grace' %}selected{% endif %}>Grace</option>
        <option value="expired" {% if status == 'expired' %}selected{% endif %}>Expired</option>
        <option value="canceled"{% if status == 'canceled' %}selected{% endif %}>Canceled</option>
      </select>
    </div>
    <div class="col-auto">
      <button class="btn btn-primary" type="submit">Go</button>
    </div>
  </form>

  <div class="card">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Business</th>
            <th>Plan</th>
            <th>Cycle</th>
            <th>Status</th>
            <th>Plan amount</th>
            <th>Started</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {# pick whichever list the view provided #}
          {% if page_obj %}
            {% for s in page_obj.object_list %}
              {% include "billing/partials/_sub_row.html" %}
            {% empty %}
              <tr><td colspan="7" class="text-muted text-center py-4">No subscriptions.</td></tr>
            {% endfor %}
          {% elif rows %}
            {% for s in rows %}
              {% include "billing/partials/_sub_row.html" %}
            {% empty %}
              <tr><td colspan="7" class="text-muted text-center py-4">No subscriptions.</td></tr>
            {% endfor %}
          {% elif subs %}
            {% for s in subs %}
              {% include "billing/partials/_sub_row.html" %}
            {% empty %}
              <tr><td colspan="7" class="text-muted text-center py-4">No subscriptions.</td></tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="7" class="text-muted text-center py-4">No subscriptions.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {% if page_obj and page_obj.paginator.num_pages > 1 %}
    <div class="p-3 border-top">
      <nav>
        <ul class="pagination mb-0">
          {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q|urlencode }}&status={{ status|urlencode }}">«</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">«</span></li>
          {% endif %}
          {% for i in page_obj.paginator.page_range %}
            {% if page_obj.number == i %}
              <li class="page-item active"><span class="page-link">{{ i }}</span></li>
            {% else %}
              <li class="page-item"><a class="page-link" href="?page={{ i }}&q={{ q|urlencode }}&status={{ status|urlencode }}">{{ i }}</a></li>
            {% endif %}
          {% endfor %}
          {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q|urlencode }}&status={{ status|urlencode }}">»</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">»</span></li>
          {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %}
  </div>
</div>

<!-- Date Picker Modal -->
<div class="modal fade" id="trialDateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Set trial end date</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <label for="trialDate" class="form-label">Trial end</label>
        <input id="trialDate" type="date" class="form-control">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitDate()">Save</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{# If your base uses `content` instead of `main`, render the same body #}
{% block content %}
  {{ block.super }}
  <div class="d-none"></div>
{% endblock %}

{# ========= COMPAT: your base defines "body", so we also render the same markup there ========= #}
{% block body %}
  {{ block.super }}
  {# Reuse the same content by including `main`'s HTML: simplest is to duplicate for compatibility. #}
  <div class="container-xl my-4">
    <div class="d-flex align-items-center gap-2 mb-3">
      <h1 class="h4 mb-0">Subscriptions</h1>

      {% if page_obj %}
        <span class="badge text-bg-light border">{{ page_obj.paginator.count }}</span>
      {% elif rows %}
        <span class="badge text-bg-light border">{{ rows|length }}</span>
      {% elif subs %}
        <span class="badge text-bg-light border">{{ subs|length }}</span>
      {% else %}
        <span class="badge text-bg-light border">0</span>
      {% endif %}
    </div>

    <form class="row g-2 align-items-center mb-3" method="get">
      <div class="col">
        <input name="q" value="{{ q|default:'' }}" class="form-control" placeholder="Search business or plan…">
      </div>
      <div class="col-auto">
        <select name="status" class="form-select">
          <option value="">Any status</option>
          <option value="trial"   {% if status == 'trial' %}selected{% endif %}>Trial</option>
          <option value="active"  {% if status == 'active' %}selected{% endif %}>Active</option>
          <option value="grace"   {% if status == 'grace' %}selected{% endif %}>Grace</option>
          <option value="expired" {% if status == 'expired' %}selected{% endif %}>Expired</option>
          <option value="canceled"{% if status == 'canceled' %}selected{% endif %}>Canceled</option>
        </select>
      </div>
      <div class="col-auto">
        <button class="btn btn-primary" type="submit">Go</button>
      </div>
    </form>

    <div class="card">
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Business</th>
              <th>Plan</th>
              <th>Cycle</th>
              <th>Status</th>
              <th>Plan amount</th>
              <th>Started</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if page_obj %}
              {% for s in page_obj.object_list %}
                {% include "billing/partials/_sub_row.html" %}
              {% empty %}
                <tr><td colspan="7" class="text-muted text-center py-4">No subscriptions.</td></tr>
              {% endfor %}
            {% elif rows %}
              {% for s in rows %}
                {% include "billing/partials/_sub_row.html" %}
              {% empty %}
                <tr><td colspan="7" class="text-muted text-center py-4">No subscriptions.</td></tr>
              {% endfor %}
            {% elif subs %}
              {% for s in subs %}
                {% include "billing/partials/_sub_row.html" %}
              {% empty %}
                <tr><td colspan="7" class="text-muted text-center py-4">No subscriptions.</td></tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="7" class="text-muted text-center py-4">No subscriptions.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      {% if page_obj and page_obj.paginator.num_pages > 1 %}
      <div class="p-3 border-top">
        <nav>
          <ul class="pagination mb-0">
            {% if page_obj.has_previous %}
              <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q|urlencode }}&status={{ status|urlencode }}">«</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">«</span></li>
            {% endif %}
            {% for i in page_obj.paginator.page_range %}
              {% if page_obj.number == i %}
                <li class="page-item active"><span class="page-link">{{ i }}</span></li>
              {% else %}
                <li class="page-item"><a class="page-link" href="?page={{ i }}&q={{ q|urlencode }}&status={{ status|urlencode }}">{{ i }}</a></li>
              {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
              <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q|urlencode }}&status={{ status|urlencode }}">»</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">»</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Date Picker Modal -->
  <div class="modal fade" id="trialDateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Set trial end date</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label for="trialDate" class="form-label">Trial end</label>
          <input id="trialDate" type="date" class="form-control">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="submitDate()">Save</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  // CSRF
  function getCookie(name){
    const m=document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.$?*|{}()[\\]\\/\\+^])/g,'\\$1')+'=([^;]*)'));
    return m?decodeURIComponent(m[1]):'';
  }
  const CSRF=getCookie('cc_csrftoken')||getCookie('csrftoken');

  async function postJSON(url,payload){
    const res=await fetch(url,{
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken':CSRF,'X-Requested-With':'XMLHttpRequest'},
      body:JSON.stringify(payload||{})
    });
    if(!res.ok){
      let t='';try{t=await res.text()}catch(_){}
      throw new Error('HTTP '+res.status+(t?(': '+t):''));
    }
    try{return await res.json()}catch{return {ok:true}};
  }
  function refresh(){window.location.reload();}

  function extendDays(id,days){
    postJSON(`/hq/subscriptions/${id}/extend/`,{days})
      .then(refresh).catch(e=>alert('Could not extend trial.\n'+(e?.message||'')));
  }

  let modalSubId=null,dateModal=null;
  document.addEventListener('DOMContentLoaded',function(){
    const el=document.getElementById('trialDateModal');
    if(window.bootstrap&&el){
      dateModal=new bootstrap.Modal(el);
      el.addEventListener('shown.bs.modal',()=>{
        const inp=document.getElementById('trialDate');
        const today=new Date();
        const iso=new Date(today.getTime()-today.getTimezoneOffset()*60000).toISOString().slice(0,10);
        if(!inp.value) inp.value=iso;
        if(typeof inp.showPicker==='function'){try{inp.showPicker()}catch(_){}} else {inp.focus();}
      });
    }
  });
  function openDateModal(subId){modalSubId=subId;dateModal&&dateModal.show();}
  function submitDate(){
    const val=document.getElementById('trialDate').value;
    if(!val){alert('Pick a date.');return;}
    postJSON(`/hq/subscriptions/${modalSubId}/extend/`,{trial_end:val})
      .then(refresh).catch(e=>alert('Could not set date.\n'+(e?.message||'')));
  }
  function revoke(id){
    if(!confirm('Revoke trial now?')) return;
    postJSON(`/hq/subscriptions/${id}/revoke/`,{})
      .then(refresh).catch(e=>alert('Could not revoke.\n'+(e?.message||'')));
  }
  function activateNow(id){
    if(!confirm('Activate paid period starting now?')) return;
    postJSON(`/hq/subscriptions/${id}/activate-now/`,{})
      .then(refresh).catch(e=>alert('Could not activate.\n'+(e?.message||'')));
  }
</script>
{% endblock %}

{# ========= COMPAT: your base defines "foot", so we mirror extra_js there ========= #}
{% block foot %}
  {{ block.super }}
  <script>
    // (same JS as extra_js to ensure execution when base expects "foot")
    function getCookie(name){
      const m=document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.$?*|{}()[\\]\\/\\+^])/g,'\\$1')+'=([^;]*)'));
      return m?decodeURIComponent(m[1]):'';
    }
    const CSRF=getCookie('cc_csrftoken')||getCookie('csrftoken');

    async function postJSON(url,payload){
      const res=await fetch(url,{
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken':CSRF,'X-Requested-With':'XMLHttpRequest'},
        body:JSON.stringify(payload||{})
      });
      if(!res.ok){
        let t='';try{t=await res.text()}catch(_){}
        throw new Error('HTTP '+res.status+(t?(': '+t):''));
      }
      try{return await res.json()}catch{return {ok:true}};
    }
    function refresh(){window.location.reload();}

    function extendDays(id,days){
      postJSON(`/hq/subscriptions/${id}/extend/`,{days})
        .then(refresh).catch(e=>alert('Could not extend trial.\n'+(e?.message||'')));
    }

    let modalSubId=null,dateModal=null;
    document.addEventListener('DOMContentLoaded',function(){
      const el=document.getElementById('trialDateModal');
      if(window.bootstrap&&el){
        dateModal=new bootstrap.Modal(el);
        el.addEventListener('shown.bs.modal',()=>{
          const inp=document.getElementById('trialDate');
          const today=new Date();
          const iso=new Date(today.getTime()-today.getTimezoneOffset()*60000).toISOString().slice(0,10);
          if(!inp.value) inp.value=iso;
          if(typeof inp.showPicker==='function'){try{inp.showPicker()}catch(_){}} else {inp.focus();}
        });
      }
    });
    function openDateModal(subId){modalSubId=subId;dateModal&&dateModal.show();}
    function submitDate(){
      const val=document.getElementById('trialDate').value;
      if(!val){alert('Pick a date.');return;}
      postJSON(`/hq/subscriptions/${modalSubId}/extend/`,{trial_end:val})
        .then(refresh).catch(e=>alert('Could not set date.\n'+(e?.message||'')));
    }
    function revoke(id){
      if(!confirm('Revoke trial now?')) return;
      postJSON(`/hq/subscriptions/${id}/revoke/`,{})
        .then(refresh).catch(e=>alert('Could not revoke.\n'+(e?.message||'')));
    }
    function activateNow(id){
      if(!confirm('Activate paid period starting now?')) return;
      postJSON(`/hq/subscriptions/${id}/activate-now/`,{})
        .then(refresh).catch(e=>alert('Could not activate.\n'+(e?.message||'')));
    }
  </script>
{% endblock %}
