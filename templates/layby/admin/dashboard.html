{% extends "base.html" %}
{% load humanize static %}

{% block title %}Admin ¬∑ Laybys{% endblock %}
{% block header_title %}Admin ¬∑ Laybys{% endblock %}

{% block extra_css %}
<style>
  :root{
    --ly-bg:#0b2545;
    --ly-panel:#13315c;
    --ly-panel-2:#1b3b6f;
    --ly-ink:#e6eefc;
    --ly-muted:#9fb4d9;
    --ly-border:#294a84;
    --ly-radius:14px;
    --ly-accent:#4f8cff;
    --ly-warn:#f59e0b;
    --ly-danger:#ef4444;
    --shadow:0 6px 18px rgba(0,0,0,.35);
  }
  section.panel{background:var(--ly-panel);border:1px solid var(--ly-border);
    border-radius:var(--ly-radius);box-shadow:var(--shadow);padding:1rem;margin:1rem}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
  .title{font-size:1.4rem;font-weight:900;color:var(--ly-ink)}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1rem}
  .kpi{background:var(--ly-panel-2);border:1px solid var(--ly-border);border-radius:12px;padding:.8rem}
  .kpi .label{color:var(--ly-muted);font-weight:700}
  .kpi .val{font-size:1.4rem;font-weight:900}
  .chip{display:inline-flex;align-items:center;padding:.25rem .6rem;border-radius:999px;font-weight:800;font-size:.85rem}
  .chip.success{background:rgba(34,197,94,.15);color:#22c55e}
  .chip.warn{background:rgba(245,158,11,.15);color:#f59e0b}
  .chip.danger{background:rgba(239,68,68,.15);color:#ef4444}
  .chip.neutral{background:rgba(255,255,255,.08);color:var(--ly-ink)}
  table{width:100%;border-collapse:separate;border-spacing:0 .6rem}
  th{color:var(--ly-muted);text-align:left;padding:.5rem .8rem;font-weight:800}
  td{padding:.6rem .8rem;background:var(--ly-panel-2);border:1px solid var(--ly-border)}
  tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .actions a{margin-right:.4rem;text-decoration:none;padding:.4rem .7rem;border-radius:8px;border:1px solid var(--ly-border);font-weight:700}
  .actions a.view{background:rgba(255,255,255,.06);color:var(--ly-ink)}
  .actions a.pay{background:linear-gradient(180deg,#4f8cff,#3b6ed9);color:#fff}
  .searchbox{display:flex;gap:.5rem;margin-bottom:.8rem}
  .input{padding:.5rem .7rem;border-radius:8px;border:1px solid var(--ly-border);background:rgba(255,255,255,.08);color:var(--ly-ink)}
</style>
{% endblock %}

{% block content %}
<section class="panel">
  <div class="header">
    <div class="title">Layby Dashboard</div>
    <div class="searchbox">
      <input id="q" class="input" placeholder="Search customer/ref‚Ä¶" oninput="filterRows()">
      <select id="alertFilter" class="input" onchange="filterRows()">
        <option value="">All</option>
        <option value="Unpaid">Unpaid</option>
        <option value="Overdue">Overdue</option>
        <option value="OK">OK</option>
      </select>
    </div>
  </div>

  <div class="kpis">
    <div class="kpi">
      <div class="label">Total Outstanding</div>
      <div class="val">{{ total_outstanding|floatformat:2|intcomma }}</div>
    </div>
    <div class="kpi">
      <div class="label">Active Laybys</div>
      <div class="val">{{ count_active }}</div>
    </div>
    <div class="kpi">
      <div class="label">Paid This Week</div>
      <div class="val">{{ paid_this_week|floatformat:2|intcomma }}</div>
    </div>
  </div>

  <table id="laybyTable">
    <thead>
      <tr>
        <th>ID</th><th>Ref</th><th>Customer</th><th>Product</th>
        <th>Status</th><th>Paid</th><th>Balance</th><th>Alert</th><th></th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ r.ref }}</td>
        <td><a href="{% url 'layby:admin_customer' %}?phone={{ r.phone|urlencode }}">{{ r.customer }}</a></td>
        <td>{{ r.product }}</td>
        <td>
          {% if r.status == 'active' %}
            <span class="chip success">Active</span>
          {% else %}
            <span class="chip neutral">{{ r.status }}</span>
          {% endif %}
        </td>
        <td>{{ r.paid|floatformat:2|intcomma }}</td>
        <td>{{ r.balance|floatformat:2|intcomma }}</td>
        <td>
          {% if r.overdue %}
            <span class="chip danger">Overdue</span>
          {% elif r.unpaid %}
            <span class="chip warn">Unpaid</span>
          {% else %}
            <span class="chip neutral">OK</span>
          {% endif %}
        </td>
        <td class="actions">
          <a href="{% url 'layby:record_payment' r.ref %}" class="pay">‚ûï Pay</a>
          <a href="{% url 'layby:admin_customer' %}?phone={{ r.phone|urlencode }}" class="view">üëÅ View</a>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="9" class="muted">No laybys yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<script>
function filterRows(){
  const q = (document.getElementById('q').value || '').toLowerCase();
  const af = document.getElementById('alertFilter').value;
  document.querySelectorAll('#laybyTable tbody tr').forEach(tr=>{
    const text = tr.innerText.toLowerCase();
    const alert = tr.querySelector('td:nth-child(8)')?.innerText.trim();
    const passQ = !q || text.includes(q);
    const passA = !af || alert === af;
    tr.style.display = (passQ && passA) ? '' : 'none';
  });
}
</script>
{% endblock %}
