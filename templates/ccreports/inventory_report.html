{% extends "base.html" %}
{% load humanize static %}

{% block title %}Inventory Report · Circuit City{% endblock %}

{% block content %}
<div class="container my-4">

  <!-- Header / nav -->
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
      <h2 class="fw-bold m-0">Inventory Report</h2>
      <div class="text-muted">Live view of stock health, ageing, and turnover.</div>
    </div>
    <div class="btn-group">
      <a class="btn btn-outline-secondary" href="/"><i class="bi bi-house-door me-1"></i> Home</a>
      <a class="btn btn-outline-secondary" href="{% url 'inventory:stock_list' %}"><i class="bi bi-list me-1"></i> Inventory</a>
      <a class="btn btn-primary" href="{% url 'reports:home' %}"><i class="bi bi-graph-up me-1"></i> Reports Home</a>
    </div>
  </div>

  <!-- Snapshot cards -->
  <div class="row g-3 mb-4">
    {% if snapshot %}
      {% for m in snapshot %}
      <div class="col-6 col-md-3">
        <div class="card h-100 shadow-sm">
          <div class="card-body">
            <div class="text-muted small text-uppercase fw-bold">{{ m.metric }}</div>
            <div class="fs-4 fw-bold mt-1">
              {% if m.value is not None %}{{ m.value|intcomma }}{% else %}—{% endif %}
            </div>
            {% if m.hint %}<div class="small text-muted">{{ m.hint }}</div>{% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <!-- Graceful empty snapshot -->
      <div class="col-12">
        <div class="alert alert-info mb-0">
          No snapshot metrics available yet.
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Two-column layout: Low stock + Ageing -->
  <div class="row g-4">
    <!-- Low stock -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white">
          <strong>Low-stock items</strong>
        </div>
        <div class="card-body p-0">
          {% if low_stock %}
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>SKU</th>
                  <th>Product</th>
                  <th class="text-end">Qty</th>
                  <th class="text-end">Threshold</th>
                </tr>
              </thead>
              <tbody>
                {% for row in low_stock %}
                <tr>
                  <td class="text-nowrap">{{ row.sku|default:"—" }}</td>
                  <td>{{ row.name|default:"—" }}</td>
                  <td class="text-end">{{ row.qty|default:0|intcomma }}</td>
                  <td class="text-end">{{ row.threshold|default:0|intcomma }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
            <div class="p-3 text-muted">No low-stock alerts.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Ageing -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white">
          <strong>Ageing buckets</strong>
        </div>
        <div class="card-body">
          {% if ageing %}
            {% comment %}
              We’ll render simple rows with count/value. We don’t know total to compute %
              here, so keep it readable without a progress bar.
            {% endcomment %}
            <div class="list-group list-group-flush">
              {% for a in ageing %}
              <div class="list-group-item d-flex align-items-center justify-content-between">
                <div class="fw-semibold">{{ a.bucket|default:"—" }}</div>
                <div class="text-end">
                  <div class="small text-muted">Units</div>
                  <div class="fw-bold">{{ a.count|default:0|intcomma }}</div>
                </div>
                <div class="text-end">
                  <div class="small text-muted">Value</div>
                  <div class="fw-bold">MK {{ a.value|default:0|floatformat:0|intcomma }}</div>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-muted">No ageing data.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Turnover + Groups -->
  <div class="row g-4 mt-1">
    <!-- Turnover -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white">
          <strong>Turnover rate</strong>
        </div>
        <div class="card-body p-0">
          {% if turnover %}
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>SKU</th>
                  <th>Product</th>
                  <th class="text-end">Turnover</th>
                </tr>
              </thead>
              <tbody>
                {% for t in turnover %}
                <tr>
                  <td class="text-nowrap">{{ t.sku|default:"—" }}</td>
                  <td>{{ t.name|default:"—" }}</td>
                  <td class="text-end">
                    {% if t.rate is not None %}{{ t.rate|floatformat:2 }}{% else %}—{% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
            <div class="p-3 text-muted">No turnover metrics.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Groups -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white">
          <strong>By group</strong>
        </div>
        <div class="card-body p-0">
          {% if groups %}
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Group</th>
                  <th class="text-end">Items</th>
                  <th class="text-end">Value</th>
                </tr>
              </thead>
              <tbody>
                {% for g in groups %}
                <tr>
                  <td>{{ g.name|default:"—" }}</td>
                  <td class="text-end">{{ g.count|default:0|intcomma }}</td>
                  <td class="text-end">MK {{ g.value|default:0|floatformat:0|intcomma }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
            <div class="p-3 text-muted">No grouping breakdowns.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}
