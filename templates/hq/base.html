{% extends "base.html" %}
{% load static %}

{# ============== Metadata / title ============== #}
{% block title %}{% block page_title %}HQ{% endblock %} · Circuit City{% endblock %}
{% block header_title %}{% block header %}HQ{% endblock %}{% endblock %}

{# Let notifications know our scope; sidebar comes from base.html #}
{% block notif_scope %}hq{% endblock %}

{# If you want the global header to show the search box even off inventory pages, set this: #}
{% block extra_head %}
  <meta name="cc-scope" content="hq">
  <script>
    /* Make base.html render the global search in the header while on HQ pages */
    window.__CC_FORCE_SEARCH__ = true;
  </script>
{% endblock %}

{% block extra_css %}
<style>
  /* =========================
     Mobile-first baseline
     ========================= */
  :root {
    --hq-gap: .5rem;
    --hq-chip-pad-y: .45rem;
    --hq-chip-pad-x: .8rem;
    --hq-radius: 999px;
    --hq-min-tap: 44px; /* iOS/Android tap target */
  }

  /* Fluid type that never gets tiny */
  html { font-size: clamp(14px, 3.2vw, 16px); }

  /* -------- Toolbar wrapper -------- */
  .hq-toolbar {
    display: grid;
    grid-template-columns: 1fr auto;
    grid-template-rows: auto auto;
    align-items: center;
    gap: var(--hq-gap);
    margin-bottom: .75rem;
  }

  /* Chip row becomes a horizontal scroller on small screens */
  .hq-chiprow {
    display: flex;
    gap: var(--hq-gap);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: x proximity;
    padding-bottom: .25rem; /* make room for scrollbar if shown */
  }
  .hq-chiprow::-webkit-scrollbar { height: 6px; }
  .hq-chiprow::-webkit-scrollbar-thumb { background: var(--line); border-radius: 8px; }

  /* Chips */
  .hq-chip {
    border: 1px solid var(--line);
    background: var(--card, #fff);
    color: var(--text, #111827);
    padding: var(--hq-chip-pad-y) var(--hq-chip-pad-x);
    border-radius: var(--hq-radius);
    font-weight: 600;
    font-size: .9rem;
    line-height: 1;
    white-space: nowrap;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: .35rem;
    scroll-snap-align: start;
  }
  .hq-chip:is(a,button){ cursor: pointer; }
  .hq-chip.is-active {
    background: color-mix(in oklab, var(--brand,#2757d8) 12%, white);
    box-shadow: inset 0 0 0 2px color-mix(in oklab, var(--brand,#2757d8) 22%, transparent);
    color: color-mix(in oklab, var(--brand,#2757d8) 85%, black);
  }

  /* Status chip keeps its tone but uses same sizing */
  .hq-status { background:#f2f6ff; color:#1e3a8a; }

  /* Divider auto-hides on narrow screens */
  .hq-sep {
    width:1px; height:22px; background:var(--line);
    display:none;
  }

  /* Actions: drop under the chips on phones */
  .hq-actions {
    display:flex; gap: var(--hq-gap);
    justify-content: flex-end; align-items: center;
  }

  /* Buttons inside actions should be thumb-friendly */
  .hq-actions .btn, .hq-actions .btn-ghost, .hq-actions .chip, .hq-chiprow .btn {
    min-height: var(--hq-min-tap);
    padding: .6rem .9rem;
    font-weight: 600;
  }

  /* Card stays soft and breathable */
  .hq-card {
    background: var(--card,#fff);
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 14px;
    box-shadow: var(--shadow-sm);
  }

  /* Layout placement for the grid:
     Row 1: chips (left) + actions (right)
     Row 2: filters (full width)
  */
  .hq-toolbar .slot-chips   { grid-column: 1 / -1; }
  .hq-toolbar .slot-actions { grid-column: 1 / -1; }
  .hq-toolbar .slot-filters { grid-column: 1 / -1; }

  /* Medium+ screens: put chips and actions on one row, filters below */
  @media (min-width: 720px) {
    .hq-toolbar {
      grid-template-columns: 1fr auto;
      grid-template-rows: auto auto;
    }
    .hq-toolbar .slot-chips   { grid-column: 1 / 2; }
    .hq-toolbar .slot-actions { grid-column: 2 / 3; }
    .hq-toolbar .slot-filters { grid-column: 1 / -1; }
    .hq-sep { display:inline-block; margin: 0 .25rem; }
  }

  /* Edge cases: very narrow screens */
  @media (max-width: 360px){
    .hq-actions { flex-wrap: wrap; }
  }

  /* Respect user color scheme if your base sets variables */
  @media (prefers-color-scheme: dark){
    .hq-chip.is-active {
      background: color-mix(in oklab, var(--brand,#6ea8ff) 16%, black);
      box-shadow: inset 0 0 0 2px color-mix(in oklab, var(--brand,#6ea8ff) 32%, transparent);
      color: white;
    }
  }
</style>
{% endblock %}

{# ================= BODY (inside base.html main.cc-page) ================= #}
{% block body %}

  {# ---------- Top toolbar row (chips, filters, actions). Override blocks as needed. ---------- #}
  <div class="hq-toolbar" role="toolbar" aria-label="HQ toolbar">

    <div class="slot-chips">
      <div class="hq-chiprow" aria-label="Quick ranges and status">
        {% block hq_range %}
          {% with q=request.GET.range|default:'' %}
            <a class="hq-chip {% if q == 'all' or not q %}is-active{% endif %}" href="?range=all">All time</a>
            <a class="hq-chip {% if q == '7d' %}is-active{% endif %}" href="?range=7d">Last 7d</a>
            <a class="hq-chip {% if q == '30d' %}is-active{% endif %}" href="?range=30d">Last 30d</a>
            <a class="hq-chip {% if q == 'custom' %}is-active{% endif %}" href="?range=custom">Custom</a>
          {% endwith %}
        {% endblock %}

        <span class="hq-sep" aria-hidden="true"></span>

        {% block hq_status %}
          {% if request.user.is_authenticated %}
            <span class="hq-chip hq-status" title="You’re staff: HQ access">{{ request.user.is_staff|yesno:"Staff,User" }}</span>
          {% endif %}
        {% endblock %}
      </div>
    </div>

    <div class="slot-actions">
      <div class="hq-actions">
        {# Right-aligned actions (override in child templates) #}
        {% block hq_actions %}{% endblock %}
      </div>
    </div>

    <div class="slot-filters">
      {# Per-page quick filters (override in child templates) #}
      {% block hq_filters %}{% endblock %}
    </div>
  </div>

  {# Optional info row above content #}
  {% block hq_notices %}{% endblock %}

  {# ------------------- MAIN PAGE CONTENT (override) ------------------- #}
  {% block page_content %}
    <div class="hq-card">
      <div class="text-muted">This is the HQ base. Extend this template and fill <code>block page_content</code>.</div>
    </div>
  {% endblock %}

{% endblock %}

{# ================= Helpers / Scripts just for HQ pages ================= #}
{% block extra_js %}
<script>
  // ----- POST helper with CSRF (usable from any button/link via data-post-url) -----
  (function(){
    function getCookie(name){
      const m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : '';
    }
    window.hqPost = async function(url, payload){
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('cc_csrftoken') || getCookie('csrftoken') || '',
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify(payload || {})
      });
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      const data = ct.includes('application/json') ? await res.json() : ({ ok:false, error:'Non-JSON' });
      if (!res.ok) throw new Error(data.error || ('HTTP '+res.status));
      return data;
    };

    // Any element with data-post-url acts as a POST action.
    document.addEventListener('click', async (e)=>{
      const el = e.target.closest('[data-post-url]');
      if (!el) return;
      e.preventDefault();
      try{
        const payload = el.dataset.payload ? JSON.parse(el.dataset.payload) : {};
        const redirectTo = el.dataset.redirect || '';
        await window.hqPost(el.dataset.postUrl, payload);
        if (redirectTo) location.assign(redirectTo); else location.reload();
      }catch(err){
        alert('Action failed: ' + (err && err.message || err));
        console.error(err);
      }
    }, {passive:false});
  })();

  // ---- (Optional) Force-show global search box on HQ routes ----
  (function(){
    try{
      const path = location.pathname || '';
      if (path.startsWith('/hq/')) {
        // base.html checks window.__CC_FORCE_SEARCH__ above; nothing else needed
      }
    }catch(_){}
  })();
</script>
{% endblock %}
