{% load static %}
<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Wallet</title>
<style>
  body{font:500 15px/1.45 system-ui;background:#f7fbff;margin:0;color:#0b1b3a}
  .shell{max-width:1200px;margin:20px auto;padding:0 14px}
  h1{margin:0 0 10px}
  .kpis{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 12px}
  .card{padding:12px 14px;border:1px solid #d8e4ff;border-radius:14px;background:#fff;box-shadow:0 10px 30px rgba(12,36,97,.06)}
  .filters{display:flex;gap:8px;align-items:center;margin:12px 0 16px;flex-wrap:wrap}
  .pill{padding:8px 12px;border-radius:999px;border:1px solid #d8e4ff;background:#ffffffaa}
  .pill.active{background:#e9f2ff;border-color:#bcd0ff;color:#2757d8}
  input[type="date"]{padding:8px 10px;border-radius:10px;border:1px solid #d8e4ff}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  th{font-size:12px;color:#476aa0;text-align:left;padding:0 10px}
  td{background:#fff;border:1px solid #e7eeff;border-left:none;border-right:none;padding:14px 10px}
  tr{box-shadow:0 6px 18px rgba(12,36,97,.08)}
  canvas{width:100%;height:180px}
</style>
</head><body>
<div class="shell">
  <h1>Wallet</h1>

  <div class="kpis">
    <div class="card">Income: <b>{{ income }}</b></div>
    <div class="card">Expense: <b>{{ expense }}</b></div>
    <div class="card">Balance: <b>{{ balance }}</b></div>
    <a class="card" href="#">Issue payslips (scheduler)</a>
  </div>

  <form class="filters" method="get">
    <div class="pill {% if range == 'all' %}active{% endif %}" onclick="setRange('all')">All time</div>
    <div class="pill {% if range == '7d' %}active{% endif %}"  onclick="setRange('7d')">Last 7d</div>
    <div class="pill {% if range == 'custom' %}active{% endif %}">
      Custom <input type="date" name="start" value="{{ start|date:'Y-m-d' }}"> <input type="date" name="end" value="{{ end|date:'Y-m-d' }}">
      <button>Apply</button>
    </div>
    <input type="hidden" name="range" id="range" value="{{ range|default:'all' }}">
  </form>

  <div class="card">
    <strong>Income trajectory</strong>
    <canvas id="chart"></canvas>
  </div>

  {% if tx_page %}
  <h3>Recent transactions</h3>
  <table>
    <thead><tr><th>Type</th><th>Amount</th><th>Ref</th><th>Date</th></tr></thead>
    <tbody>
      {% for t in tx_page %}
      <tr>
        <td>{{ t.type }}</td><td>{{ t.amount }}</td><td>{{ t.reference|default:"â€”" }}</td>
        <td>{{ t.created_at|date:"Y-m-d H:i" }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
</div>
<script>
function setRange(r){document.getElementById('range').value=r;document.forms[0].submit();}
(async function(){
  const qs = new URLSearchParams(window.location.search);
  const start = qs.get('start'), end = qs.get('end');
  const r = await fetch(`/hq/api/wallet/income?start=${start||''}&end=${end||''}`);
  const rows = r.ok ? await r.json() : [];
  const c=document.getElementById('chart'), ctx=c.getContext('2d');
  function draw(){
    const w=c.width=c.clientWidth*devicePixelRatio, h=c.height=c.clientHeight*devicePixelRatio;
    ctx.clearRect(0,0,w,h);
    if(!rows.length) return;
    const pad={l:48,t:10,r:12,b:26}, innerW=w-pad.l-pad.r, innerH=h-pad.t-pad.b;
    const xs=rows.map(r=>+new Date(r.date)), ys=rows.map(r=>+r.amount||0);
    const xMin=Math.min(...xs), xMax=Math.max(...xs), yMax=Math.max(10, Math.max(...ys)*1.2);
    ctx.strokeStyle='rgba(39,87,216,.25)'; ctx.lineWidth=1*devicePixelRatio;
    ctx.beginPath(); ctx.moveTo(pad.l,pad.t); ctx.lineTo(pad.l,pad.t+innerH); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(pad.l,pad.t+innerH); ctx.lineTo(pad.l+innerW,pad.t+innerH); ctx.stroke();
    ctx.beginPath();
    rows.forEach((r,i)=>{ const x=pad.l+((+new Date(r.date)-xMin)/(xMax-xMin||1))*innerW; const y=pad.t+innerH-(r.amount/yMax)*innerH; i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
    ctx.strokeStyle='#2563eb'; ctx.lineWidth=2*devicePixelRatio; ctx.stroke();
  }
  draw(); new ResizeObserver(draw).observe(c);
})();
</script>
</body></html>
