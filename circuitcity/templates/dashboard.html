{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard · Circuit City{% endblock %}
{% block header_title %}Dashboard{% endblock %}

{% block nav_actions %}
  <a class="btn btn-outline-secondary btn-sm" href="{% url 'inventory:stock_list' %}">
    <i class="bi bi-house"></i> <span class="d-none d-sm-inline">Home</span>
  </a>
{% endblock %}

{% block extra_css %}
<style>
  :root{
    --blue-700:#1d4ed8; --blue-600:#2563eb; --blue-500:#3b82f6; --blue-400:#60a5fa;
    --emerald:#10b981; --rose:#ef4444; --amber:#f59e0b;
    --muted:#64748b; --line:#e2e8f0;
  }

  .kpi{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:16px;
    padding:1rem 1.1rem;
    box-shadow:0 8px 22px rgba(2,6,23,.06);
    display:flex; gap:.9rem; align-items:center;
  }
  .kpi .icon{
    width:42px; height:42px; border-radius:12px; display:grid; place-items:center;
    background:linear-gradient(135deg, rgba(37,99,235,.12), rgba(59,130,246,.08));
    color:var(--blue-600);
  }
  .kpi .label{ font-size:.9rem; color:var(--muted); font-weight:700; letter-spacing:.01em }
  .kpi .value{ font-size:1.6rem; font-weight:800 }
  .health.good{ color:var(--emerald) } .health.warn{ color:var(--amber) } .health.bad{ color:var(--rose) }

  .panel.surface{ border-radius:16px; padding:1rem; }
  .panel h5{ font-weight:800; margin-bottom:.75rem }

  .chart-canvas{ width:100% !important; height:260px !important }
  .chart-canvas--sm{ height:210px !important }
  .list-group-item{ background:transparent }
  .tag{ padding:.22rem .6rem; border:1px solid var(--line); border-radius:999px; font-size:.8rem; background:#eef2ff; }

  @media (max-width: 992px){ .chart-canvas{ height:220px !important } }
</style>
{% endblock %}

{% block content %}

  <!-- KPI Bar -->
  <div class="row g-3 mb-3">
    <div class="col-6 col-md-3">
      <div class="kpi">
        <div class="icon"><i class="bi bi-graph-up-arrow"></i></div>
        <div>
          <div class="label">Total Sales</div>
          <div class="value">MK {{ today_total|default:0|floatformat:0|intcomma }}</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="kpi">
        <div class="icon"><i class="bi bi-bag-check"></i></div>
        <div>
          <div class="label">Units Sold</div>
          <div class="value">{{ today_count|default:0|intcomma }}</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="kpi">
        <div class="icon"><i class="bi bi-currency-dollar"></i></div>
        <div>
          <div class="label">Profit Margin</div>
          <div class="value">{{ profit_margin|default:"24"|floatformat:0 }}%</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="kpi">
        <div class="icon"><i class="bi bi-lightning-charge"></i></div>
        <div>
          <div class="label">Stock Health</div>
          <div class="value health {% if stock_health == 'Good' %}good{% elif stock_health == 'Low' %}warn{% else %}bad{% endif %}">
            {{ stock_health|default:"Good" }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <form method="get" class="d-flex gap-2 align-items-center flex-wrap mb-3">
    <select name="period" class="form-select form-select-sm" style="width:auto">
      <option value="month" {% if period == "month" %}selected{% endif %}>This month</option>
      <option value="all" {% if period == "all" %}selected{% endif %}>All time</option>
    </select>
    <select name="model" class="form-select form-select-sm" style="min-width:240px">
      <option value="">All models</option>
      {% for p in products %}
        <option value="{{ p.id }}" {% if model_id == p.id %}selected{% endif %}>{{ p.brand }} {{ p.model }}{% if p.variant %} {{ p.variant }}{% endif %}</option>
      {% endfor %}
    </select>
    <button class="btn btn-primary btn-sm" type="submit"><i class="bi bi-sliders"></i> Apply</button>
  </form>

  <!-- Sales Trend + AI insights + Value Trend -->
  <div class="row g-3 mb-3">
    <div class="col-lg-7">
      <div class="panel surface">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="m-0">Sales Trend</h5>
          <div class="d-flex gap-2">
            <select id="trendPeriod" class="form-select form-select-sm" style="width:auto">
              <option value="month" selected>This month</option>
              <option value="7d">Last 7 days</option>
            </select>
            <select id="trendMetric" class="form-select form-select-sm" style="width:auto">
              <option value="amount" selected>Amount</option>
              <option value="count">Count</option>
            </select>
          </div>
        </div>
        <canvas id="salesTrend" class="chart-canvas" aria-label="Sales trend"></canvas>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="panel surface">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="m-0">AI-Driven Insights</h5>
          <button id="ai-recs-refresh" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
        <div id="ai-recos" class="small">Loading…</div>
        <hr class="my-2">
        <div class="small text-muted" id="ai-recs-overall"></div>
      </div>

      <!-- Value Trend Card -->
      <div class="panel surface mt-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="m-0">Value Trend</h5>
          <div class="d-flex gap-2">
            <select id="vtMetric" class="form-select form-select-sm" style="width:auto">
              <option value="revenue" selected>Revenue</option>
              <option value="cost">Cost</option>
              <option value="profit">Profit</option>
            </select>
            <select id="vtPeriod" class="form-select form-select-sm" style="width:auto">
              <option value="today">Today</option>
              <option value="7d" selected>Last 7 days</option>
              <option value="all">All time</option>
            </select>
          </div>
        </div>
        <canvas id="valueTrend" class="chart-canvas chart-canvas--sm" aria-label="Value trend"></canvas>
      </div>
    </div>
  </div>

  <!-- Top models + Alerts -->
  <div class="row g-3 mb-3">
    <div class="col-lg-7">
      <div class="panel surface">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="m-0">Top-Selling Models</h5>
          <select id="topPeriod" class="form-select form-select-sm" style="width:auto">
            <option value="today">Today</option>
            <option value="month" selected>This month</option>
          </select>
        </div>
        <canvas id="topModels" class="chart-canvas chart-canvas--sm" aria-label="Top models"></canvas>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="panel surface">
        <h5 class="m-0 mb-2">Stock Alerts</h5>
        <ul id="alertsList" class="list-group list-group-flush">
          <li class="list-group-item text-muted">Loading alerts…</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Agent performance -->
  <div class="panel surface mb-3">
    <h5>Agent Performance</h5>
    {% if agent_rank %}
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th>Agent</th>
            <th class="text-end">Earnings</th>
            <th class="text-end">Sales</th>
            <th class="text-end">Revenue</th>
            <th class="text-end">Wallet</th>
          </tr>
        </thead>
        <tbody>
        {% for r in agent_rank %}
          <tr>
            <td>{{ r.agent__username }}</td>
            <td class="text-end">MK {{ r.earnings|default:0|floatformat:0|intcomma }}</td>
            <td class="text-end">{{ r.total_sales|default:0|intcomma }}</td>
            <td class="text-end">MK {{ r.revenue|default:0|floatformat:0|intcomma }}</td>
            <td class="text-end"><span class="tag wallet-chip loading" data-user-id="{{ r.agent_id }}" data-username="{{ r.agent__username }}">…</span></td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <div class="text-muted">No agent data for this period.</div>
    {% endif %}
  </div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const nf = new Intl.NumberFormat();
  const CURRENT_MODEL = {{ model_id|default:"null" }};
  const MODEL_QS = (CURRENT_MODEL !== null) ? `&model=${encodeURIComponent(CURRENT_MODEL)}` : '';
  const C = { blue:'#3b82f6', grid:'rgba(2,6,23,.08)' };

  /* Wallet chips */
  (async function(){
    const chips = document.querySelectorAll('.wallet-chip');
    for(const chip of chips){
      try{
        const uid = chip.getAttribute('data-user-id');
        const r = await fetch(`/inventory/api/wallet-summary/?user_id=${encodeURIComponent(uid)}`);
        const d = await r.json();
        const bal = Number(d?.balance||0);
        chip.textContent = 'MK ' + nf.format(Math.round(bal));
        chip.classList.toggle('text-success', bal>=0);
        chip.classList.toggle('text-danger', bal<0);
      }catch{ chip.textContent='—'; }
      chip.classList.remove('loading');
    }
  })();

  // Nicely-rounded axis helper
  function niceAxis(maxVal, steps=5, emptyBaseline=100000){
    const max = Number(maxVal) || 0;
    if (max <= 0) {
      const step = Math.max(1, Math.round(emptyBaseline/steps));
      return { max: emptyBaseline, stepSize: step };
    }
    const pow = Math.pow(10, Math.floor(Math.log10(max)));
    const scaled = max / pow;
    let niceUnit = (scaled <= 1) ? 1 : (scaled <= 2) ? 2 : (scaled <= 5) ? 5 : 10;
    const niceMax = niceUnit * pow;
    const step = Math.max(1, Math.round(niceMax / steps));
    return { max: niceMax, stepSize: step };
  }

  // Sales Trend
  let salesChart=null;
  async function loadTrend(){
    const p=document.getElementById('trendPeriod').value;
    const m=document.getElementById('trendMetric').value;
    let data=null, err='';
    try{
      const res = await fetch(`/inventory/api_sales_trend/?period=${p}&metric=${m}${MODEL_QS}`);
      if(res.ok) data = await res.json(); else err = `HTTP ${res.status}`;
    }catch(e){ err = String(e); }

    const labels = data?.labels || [];
    let values = (data?.values||[]).map(v=>Number(v)||0);
    const sign = (m==='amount' ? (data?.currency?.sign || 'MK') : '');

    // Count = integers
    const isCount = (m === 'count');
    if(isCount) values = values.map(v => Math.round(v));

    const el = document.getElementById('salesTrend');
    if(salesChart) salesChart.destroy();

    if(!labels.length){
      const ctx = el.getContext('2d'); ctx.clearRect(0,0,el.width,el.height);
      ctx.fillStyle = '#94a3b8'; ctx.font='14px system-ui';
      ctx.fillText(err?`No data (${err})`:'No data yet', 12, 22);
      return;
    }

    const maxValue = Math.max(0, ...values);
    const yOpts = isCount
      ? {
          min: 0,
          max: Math.max(1, Math.ceil(maxValue)),
          grid:{ color:C.grid },
          ticks:{ stepSize:1, callback:(v)=> Number.isInteger(v) ? v : '' }
        }
      : (() => {
          const na = niceAxis(maxValue, 5, 100000);
          return {
            min: 0,
            max: na.max,                       // <-- force a big max when empty
            grid:{ color:C.grid },
            ticks:{ stepSize: na.stepSize,
                    callback:(v)=> `${sign} ${nf.format(v)}` }
          };
        })();

    salesChart = new Chart(el, {
      type:'line',
      data:{ labels, datasets:[{ label:isCount?'Sales (count)':`Sales (${sign})`,
        data:values, borderColor:C.blue, backgroundColor:'rgba(59,130,246,.16)', fill:true, pointRadius:2, tension:.35 }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},
        scales:{ x:{ grid:{ color:C.grid }}, y: yOpts } }
    });
  }

  // Top Models
  let topChart=null;
  async function loadTop(){
    const p=document.getElementById('topPeriod').value;
    let data=null, err='';
    try{
      const r=await fetch(`/inventory/api_top_models/?period=${p}${MODEL_QS}`);
      if(r.ok) data=await r.json(); else err=`HTTP ${r.status}`;
    }catch(e){ err=String(e); }
    const labels=data?.labels||[], values=(data?.values||[]).map(v=>Number(v)||0);
    const el=document.getElementById('topModels');
    if(topChart) topChart.destroy();

    if(!labels.length){
      const ctx = el.getContext('2d'); ctx.clearRect(0,0,el.width,el.height);
      ctx.fillStyle = '#94a3b8'; ctx.font='14px system-ui';
      ctx.fillText(err?`No data (${err})`:'No data yet', 12, 22);
      return;
    }
    topChart = new Chart(el, {
      type:'bar',
      data:{ labels, datasets:[{ label:'Units', data:values, backgroundColor:C.blue, borderColor:C.blue }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } },
        scales:{ x:{ grid:{ display:false }},
                 y:{ min:0, grid:{ color:C.grid },
                     ticks:{ stepSize:1, callback:(v)=>Number.isInteger(v)?v:'' },
                     max: Math.max(1, Math.ceil(Math.max(0, ...values))) } } }
    });
  }

  // Alerts
  async function loadAlerts(){
    const ul=document.getElementById('alertsList');
    try{
      const r=await fetch(`/inventory/api/alerts/?_=${Date.now()}${MODEL_QS}`);
      if(!r.ok) throw new Error('HTTP '+r.status);
      const d=await r.json();
      const items=(d.alerts||[]).map(a=>{
        const badge = a.severity==='high' ? 'danger' : (a.severity==='warn'?'warning':'secondary');
        return `<li class="list-group-item d-flex align-items-center gap-2">
                  <span class="badge text-bg-${badge}">${a.type||'Alert'}</span>
                  <span>${a.message||''}</span>
                </li>`;
      }).join('');
      ul.innerHTML = items || '<li class="list-group-item text-muted">No alerts 🎉</li>';
    }catch{
      ul.innerHTML = `<li class="list-group-item text-muted">Alerts unavailable</li>`;
    }
  }

  // AI Insights
  async function loadAI(){
    const box=document.getElementById('ai-recos');
    const overallEl=document.getElementById('ai-recs-overall');
    box.textContent='Loading…'; if(overallEl) overallEl.textContent='';
    const tries=[
      `/inventory/api/predictions/?_=${Date.now()}${MODEL_QS}`,
      `/inventory/api/predictions?_=${Date.now()}${MODEL_QS}`,
      `/inventory/api-predictions/?_=${Date.now()}${MODEL_QS}`,
      `/inventory/api_predictions/?_=${Date.now()}${MODEL_QS}`
    ];
    let data=null, err='';
    for(const u of tries){
      try{ const r=await fetch(u); if(r.ok){ data=await r.json(); break; } err=`HTTP ${r.status}`; }catch(e){ err=String(e); }
    }
    if(!data){ box.innerHTML=`<span class="text-danger">No insights (${err||'unavailable'})</span>`; return; }
    const risky=(data.risky||[]);
    const html = risky.length
      ? risky.map(x=>`<div class="mb-1"><span class="badge text-bg-danger me-1">Risk</span> <b>${x.product}</b> likely stockout by ${x.stockout_date}. On-hand ${x.on_hand}. Restock <b>${x.suggested_restock}</b>.</div>`).join('')
      : '<div class="text-success">All good — no stockouts predicted.</div>';
    box.innerHTML = html;
    if(overallEl){
      const total=(data.overall||[]).reduce((s,x)=>s+(x.predicted_units||0),0);
      const rev=(data.overall||[]).reduce((s,x)=>s+(+x.predicted_revenue||0),0);
      const sign = data?.currency?.sign || 'MK';
      overallEl.innerHTML = `Next 7 days: <b>${nf.format(total)}</b> units • <b>${sign} ${nf.format(Math.round(rev))}</b>`;
    }
  }

  // Value Trend
  let vtChart = null;
  async function loadValueTrend(){
    const metric = document.getElementById('vtMetric').value;
    const period = document.getElementById('vtPeriod').value;
    let data=null, err='';
    try{
      const r = await fetch(`/inventory/api/value_trend/?metric=${encodeURIComponent(metric)}&period=${encodeURIComponent(period)}${MODEL_QS}`);
      if(r.ok) data = await r.json(); else err = `HTTP ${r.status}`;
    }catch(e){ err = String(e); }

    const el = document.getElementById('valueTrend');
    if(vtChart) vtChart.destroy();

    const labels = data?.labels || [];
    const values = (data?.values || []).map(v => Number(v) || 0);
    const sign   = data?.currency?.sign || 'MK';

    if(!labels.length){
      const ctx = el.getContext('2d'); ctx.clearRect(0,0,el.width,el.height);
      ctx.fillStyle = '#94a3b8'; ctx.font='14px system-ui';
      ctx.fillText(err?`No data (${err})`:'No data yet', 12, 22);
      return;
    }

    const na = niceAxis(Math.max(0, ...values), 5, 100000);

    vtChart = new Chart(el, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: (metric.charAt(0).toUpperCase()+metric.slice(1)) + ` (${sign})`,
          data: values,
          borderColor: C.blue,
          backgroundColor: 'rgba(59,130,246,.16)',
          fill: true,
          pointRadius: 2,
          tension: .35
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: true },
          tooltip: { callbacks: { label: (ctx) => `${sign} ${nf.format(ctx.parsed.y||0)}` } } },
        scales: { x: { grid:{ color:C.grid }},
                  y: { min:0, max:na.max, grid:{ color:C.grid },
                       ticks:{ stepSize:na.stepSize, callback:(v)=> `${sign} ${nf.format(v)}` } } }
      }
    });
  }

  // Wire up + initial loads
  document.getElementById('trendPeriod').addEventListener('change', loadTrend);
  document.getElementById('trendMetric').addEventListener('change', loadTrend);
  document.getElementById('topPeriod').addEventListener('change', loadTop);
  document.getElementById('ai-recs-refresh').addEventListener('click', loadAI);
  document.getElementById('vtMetric').addEventListener('change', loadValueTrend);
  document.getElementById('vtPeriod').addEventListener('change', loadValueTrend);

  loadTrend(); loadTop(); loadAlerts(); loadAI(); loadValueTrend();
</script>
{% endblock %}
