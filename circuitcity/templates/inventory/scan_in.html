{% extends "base.html" %}
{% load static %}
{% block title %}Scan IN · Inventory{% endblock %}

{# Minimal fallback styles in case app.css doesn't have these #}
{% block extra_css %}
<style>
  .form{display:grid;gap:14px;max-width:720px}
  .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  .field{position:relative;background:#0b1020;border:1px solid var(--border,#1f2937);border-radius:12px;display:flex;align-items:center}
  .input, .field input, .field select{flex:1;background:transparent;color:var(--text,#e5e7eb);border:0;padding:12px 14px;outline:none;font-size:16px}
  label{font-weight:600;margin-bottom:4px;display:inline-block}
  .btn{appearance:none;border:1px solid var(--border,#1f2937);color:#fff;background:#0a1020;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600;font-size:14px}
  .btn:hover{border-color:#2a364d}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn-primary{background:linear-gradient(135deg,#22c55e,#16a34a);border-color:#065f46}
  .btn-secondary{background:#0c1430}
  .btn-sky{background:linear-gradient(135deg,#38bdf8,#0ea5e9);border-color:#075985}
  .hint,.help-error{font-size:12px;color:#94a3b8}
  .help-error[hidden]{display:none}
  .pill{font-size:12px;color:#a7f3d0;background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.35);padding:4px 8px;border-radius:999px}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0b1020;border:1px solid #1f2937;color:#cbd5e1;padding:2px 6px;border-radius:6px}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  #cameraBox{margin-top:8px;display:none;background:#060a15;border:1px dashed #1e293b;border-radius:14px;padding:12px}
  #camera{width:100%;max-height:360px;background:#000;border-radius:10px;overflow:hidden}
  .toast{position:fixed;right:18px;bottom:18px;min-width:240px;background:#0b1326;border:1px solid #20304a;color:#e5f1ff;border-radius:12px;padding:12px 14px;box-shadow:0 10px 25px rgba(0,0,0,.35);display:none;z-index:1000}
  .toast.ok{border-color:rgba(16,185,129,.45);color:#d1fae5}
  .toast.err{border-color:rgba(239,68,68,.55);color:#fee2e2}
</style>
{% endblock %}

{% block body %}
<section aria-labelledby="scanin">
  <h1 id="scanin" style="margin:0 0 .25rem">Scan IN · Inventory</h1>
  <p class="hint" style="margin:0 0 1rem">
    Paste or scan the <strong>IMEI</strong>. Scanners typically “type” digits then send <span class="kbd">Enter</span>.
  </p>

  <form method="post" novalidate class="form" data-validate>
    {% csrf_token %}

    <div>
      <label for="id_imei">IMEI</label>
      <div class="field">
        <input id="id_imei" name="imei" inputmode="numeric" autocomplete="off"
               required minlength="12" maxlength="18" pattern="[0-9]{12,18}"
               placeholder="Paste/scan IMEI (12–18 digits)" />
      </div>
      <div id="imeiHelp" class="help-error" hidden>Enter a valid IMEI (12–18 digits, digits only)</div>
      <div class="flex" style="margin-top:6px">
        <button type="button" id="pasteBtn" class="btn btn-secondary">Paste from Clipboard</button>
        <button type="button" id="camToggle" class="btn btn-sky">Start Camera</button>
        <span class="pill">Shortcut: <span class="kbd">Enter</span> submits</span>
        <span class="pill">Focus: <span class="kbd">F2</span></span>
      </div>

      <!-- Camera / barcode area (optional helper) -->
      <div id="cameraBox" aria-live="polite">
        <div class="hint" style="margin-bottom:8px">Allow camera access if prompted.</div>
        <div id="camera"></div>
        <div class="flex" style="margin-top:10px">
          <select id="cameraSelect" class="btn"></select>
          <button type="button" id="camStop" class="btn">Stop Camera</button>
        </div>
      </div>
    </div>

    <div>
      <label for="id_product">Product</label>
      <select id="id_product" name="product" class="input" required>
        <option value="">Choose product</option>
        {% for p in products %}
          <option value="{{ p.id }}">{{ p.name }}</option>
        {% endfor %}
      </select>
      <div class="help-error" hidden>Product is required.</div>
    </div>

    <div class="flex" style="margin-top:.25rem">
      <button type="submit" id="submitBtn" class="btn btn-primary" disabled>Save</button>
      <a class="btn btn-secondary" href="{% url 'inventory:stock_list' %}">Cancel</a>
    </div>
  </form>
</section>

<!-- Toast -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

{# QuaggaJS: optional barcode scanning for IMEI labels #}
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<script>
  // --- Elements
  const form      = document.querySelector('form[data-validate]');
  const imeiEl    = document.getElementById('id_imei');
  const prodEl    = document.getElementById('id_product');
  const submitBtn = document.getElementById('submitBtn');
  const pasteBtn  = document.getElementById('pasteBtn');
  const camToggle = document.getElementById('camToggle');
  const camStop   = document.getElementById('camStop');
  const camBox    = document.getElementById('cameraBox');
  const camNode   = document.getElementById('camera');
  const camSelect = document.getElementById('cameraSelect');
  const toast     = document.getElementById('toast');

  // --- Helpers
  function showToast(msg, ok=true){
    toast.textContent = msg;
    toast.className = 'toast ' + (ok ? 'ok' : 'err');
    toast.style.display = 'block';
    setTimeout(()=> toast.style.display = 'none', 3000);
  }
  function digitsOnly(s){ return (s||'').replace(/\\D/g,''); }
  function isValidIMEI(s){
    s = digitsOnly(s);
    return /^\\d{12,18}$/.test(s);
  }
  function updateValidity(){
    const imeiValid = isValidIMEI(imeiEl.value);
    document.getElementById('imeiHelp').hidden = imeiValid;
    const prodValid = !!prodEl.value;
    submitBtn.disabled = !(imeiValid && prodValid);
  }

  // --- Events (inline validation + keyboard UX)
  imeiEl.addEventListener('input', (e)=>{
    const v = digitsOnly(e.target.value);
    e.target.value = v; // keep digits only
    updateValidity();
  });
  prodEl.addEventListener('change', updateValidity);

  // Submit on Enter when focused in IMEI
  imeiEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); if(!submitBtn.disabled) form.submit(); }});
  document.addEventListener('keydown', (e)=>{ if(e.key==='F2'){ e.preventDefault(); imeiEl.focus(); }});
  window.addEventListener('load', ()=>{ imeiEl.focus(); updateValidity(); });

  // Clipboard helper
  pasteBtn.addEventListener('click', async ()=>{
    try{
      const txt = await navigator.clipboard.readText();
      imeiEl.value = digitsOnly(txt);
      updateValidity();
      if(isValidIMEI(imeiEl.value) && !submitBtn.disabled){ form.submit(); }
      else { showToast('Pasted. Press Save to submit.', true); }
    }catch{
      showToast('Clipboard blocked. Paste manually (Ctrl+V).', false);
      imeiEl.focus();
    }
  });

  // --- Camera / QuaggaJS (optional)
  let quaggaRunning = false;

  async function listCameras(){
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d=> d.kind==='videoinput');
      camSelect.innerHTML = '';
      cams.forEach((c,i)=>{
        const opt = document.createElement('option');
        opt.value = c.deviceId; opt.textContent = c.label || \`Camera \${i+1}\`;
        camSelect.appendChild(opt);
      });
      return cams;
    }catch{return [];}
  }

  function startQuagga(deviceId){
    if(quaggaRunning) return;
    Quagga.init({
      inputStream: {
        type: 'LiveStream',
        target: camNode,
        constraints: { facingMode: 'environment', deviceId: deviceId || undefined, width:{ideal:1280}, height:{ideal:720} }
      },
      decoder: {
        readers: ['code_128_reader','ean_reader','ean_8_reader','code_39_reader','upc_reader','upc_e_reader']
      },
      locate: true,
      numOfWorkers: navigator.hardwareConcurrency ? Math.min(4, navigator.hardwareConcurrency) : 2
    }, (err)=>{
      if(err){ showToast('Camera init failed. Check permissions.', false); return; }
      Quagga.start(); quaggaRunning = true;
    });

    let lastDetected = '';
    Quagga.onDetected((result)=>{
      const code = (result && result.codeResult && result.codeResult.code) || '';
      if(!code || code===lastDetected) return;
      lastDetected = code;
      const numeric = digitsOnly(code);
      if(numeric.length >= 12){
        imeiEl.value = numeric.slice(0, 18); // accept up to 18
        showToast('Scanned: ' + imeiEl.value, true);
        updateValidity();
        if(isValidIMEI(imeiEl.value) && !submitBtn.disabled){ form.submit(); }
      }
    });
  }

  function stopQuagga(){
    if(!quaggaRunning) return;
    Quagga.stop(); quaggaRunning=false;
  }

  camToggle.addEventListener('click', async ()=>{
    if(camBox.style.display==='none' || camBox.style.display===''){
      camBox.style.display='block';
      const cams = await listCameras();
      startQuagga(cams[0] && cams[0].deviceId);
      camToggle.textContent='Restart Camera';
    }else{
      // restart with selected camera
      stopQuagga();
      startQuagga(camSelect.value || undefined);
    }
  });

  camStop.addEventListener('click', ()=>{
    stopQuagga();
    camBox.style.display='none';
    camToggle.textContent='Start Camera';
  });
</script>
{% endblock %}
