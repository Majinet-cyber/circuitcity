{% comment %}
Inventory list with filters, CSV export, and server-side pagination (cap 200).
Works with context from stock_list:
- items (full queryset) or page_obj.object_list
- q, status, show_archived, is_admin, can_edit
- totals: in_stock, sold_count, sum_order, sum_selling
- page_obj, url_for (optional helper to build page links)
Requires the 'request' context processor.
{% endcomment %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    header { display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
    .metrics { display: flex; gap: 16px; flex-wrap: wrap; font-size: 14px; }
    .metric { background: #f6f7f8; border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 12px; }
    form.filters { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin: 12px 0; }
    form.filters input[type="text"] { padding: 6px 8px; }
    form.filters select, form.filters input[type="number"] { padding: 6px 8px; }
    .btn { padding: 6px 10px; border-radius: 8px; border: 1px solid #d1d5db; background: #fff; cursor: pointer; }
    .btn.primary { background: #111827; color: #fff; border-color: #111827; }
    .btn.link { background: transparent; border: none; color: #2563eb; padding: 0; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
    th { text-align: left; background: #fafafa; position: sticky; top: 0; z-index: 1; }
    .right { text-align: right; }
    .muted { color: #6b7280; }
    .actions { display: flex; gap: 8px; align-items: center; }
    nav.pager { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    .tag { padding: 2px 6px; border-radius: 6px; border: 1px solid #e5e7eb; font-size: 12px; }
  </style>
</head>
<body>

<header>
  <h1 style="margin:0">Inventory</h1>
  <div class="metrics">
    <div class="metric">In stock: <strong>{{ in_stock|default:total_in_stock }}</strong></div>
    <div class="metric">Sold: <strong>{{ sold_count|default:total_sold }}</strong></div>
    <div class="metric">Order MK: <strong>{{ sum_order|default:sum_order_price|floatformat:0 }}</strong></div>
    <div class="metric">Selling MK: <strong>{{ sum_selling|default:sum_selling_price|floatformat:0 }}</strong></div>
  </div>
</header>

<form class="filters" method="get">
  <input type="text" name="q" placeholder="Search IMEI/brand/model…" value="{{ q }}">
  <label>Status:
    <select name="status">
      <option value="" {% if not status %}selected{% endif %}>All</option>
      <option value="in_stock" {% if status == "in_stock" %}selected{% endif %}>In stock</option>
      <option value="sold" {% if status == "sold" %}selected{% endif %}>Sold</option>
    </select>
  </label>
  <label class="muted">
    <input type="checkbox" name="archived" value="1" {% if show_archived %}checked{% endif %}>
    Include archived
  </label>
  <label>Rows/page:
    <input type="number" name="page_size" min="1" max="200"
           value="{% if page_obj %}{{ page_obj.paginator.per_page }}{% else %}50{% endif %}">
  </label>
  <button class="btn primary" type="submit">Apply</button>

  {# CSV export preserves filters #}
  <a class="btn" href="{% url 'inventory:export_csv' %}?{% for k,v in request.GET.items %}{% if k != 'export' %}{{k}}={{v|urlencode}}&{% endif %}{% endfor %}export=csv">Export CSV</a>
</form>

<table>
  <thead>
    <tr>
      <th>IMEI</th>
      <th>Product</th>
      <th>Status</th>
      <th class="right">Order</th>
      <th class="right">Selling</th>
      <th>Location</th>
      <th>Agent</th>
      <th>Received</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
  {% with page_items=page_obj.object_list|default:items %}
    {% for it in page_items %}
      <tr>
        <td>{{ it.imei|default:"" }}</td>
        <td>{{ it.product }}</td>
        <td>
          {% if it.status == "SOLD" %}
            <span class="tag">SOLD</span>
          {% else %}
            <span class="tag">In stock</span>
          {% endif %}
        </td>
        <td class="right">{% if it.order_price is not None %}{{ it.order_price|floatformat:0 }}{% endif %}</td>
        <td class="right">{% if it.selling_price is not None %}{{ it.selling_price|floatformat:0 }}{% endif %}</td>
        <td>
          {% if it.current_location_id %}
            {{ it.current_location.name }}
          {% else %}
            —
          {% endif %}
        </td>
        <td>
          {% if it.assigned_agent_id %}
            {{ it.assigned_agent.username }}
          {% else %}
            —
          {% endif %}
        </td>
        <td>{{ it.received_at|date:"Y-m-d" }}</td>
        <td class="actions">
          {% if can_edit %}
            <a class="btn link" href="{% url 'inventory:update_stock' it.pk %}">Edit</a>
          {% endif %}
          {% if is_admin %}
            {% if it.is_active %}
              <form method="post" action="{% url 'inventory:delete_stock' it.pk %}" style="display:inline">{% csrf_token %}
                <button class="btn link" onclick="return confirm('Delete this item?')">Delete</button>
              </form>
            {% else %}
              <form method="post" action="{% url 'inventory:restore_stock' it.pk %}" style="display:inline">{% csrf_token %}
                <button class="btn link">Restore</button>
              </form>
            {% endif %}
          {% endif %}
        </td>
      </tr>
    {% empty %}
      <tr><td colspan="9" class="muted">No items match your filters.</td></tr>
    {% endfor %}
  {% endwith %}
  </tbody>
</table>

{% if page_obj %}
  <nav class="pager">
    {% if url_for %}
      {% if page_obj.has_previous %}
        <a class="btn" href="{{ url_for(page_obj.previous_page_number) }}">Prev</a>
      {% endif %}
      <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a class="btn" href="{{ url_for(page_obj.next_page_number) }}">Next</a>
      {% endif %}
    {% else %}
      <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
    {% endif %}
  </nav>
{% endif %}

</body>
</html>
