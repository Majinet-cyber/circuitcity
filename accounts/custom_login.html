{% extends "base.html" %}
{% block title %}Sign in · Circuit City{% endblock %}

{% block body %}
{% url 'accounts:login' as login_url %}
{% url 'login' as auth_login_url %}

<style>
  /* ---------- Tokens ---------- */
  :root{
    --bg1:#eef5ff; --bg2:#f9fbff; --card:#ffffff; --ink:#0f172a; --muted:#475569; --line:#e2e8f0;
    --blue-1:#2563eb; --blue-2:#60a5fa;
    --glass-bg: rgba(37,99,235,0.12);
    --glass-brd: rgba(96,165,250,.55);
    --glass-shadow: 0 10px 30px rgba(37,99,235,.22);
  }

  /* ---------- Page Loader (overlays entire page until 'load') ---------- */
  #page-loader{
    position: fixed; inset: 0; z-index: 3000;
    display: grid; place-items: center;
    background: radial-gradient(1200px 800px at 50% 40%, rgba(15,23,42,0.12), transparent 60%);
    backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
    transition: opacity .35s ease, visibility .35s ease;
  }
  #page-loader.hidden{ opacity:0; visibility:hidden; }
  .loader-ring{
    width:66px; height:66px; border-radius:50%;
    border:4px solid rgba(96,165,250,.25);
    border-top-color: var(--blue-1);
    animation: ccspin 1s linear infinite;
    box-shadow: 0 0 0 4px rgba(37,99,235,.06) inset;
  }
  @keyframes ccspin { to { transform: rotate(360deg); } }
  @media (prefers-reduced-motion: reduce){ .loader-ring{ animation:none; } }

  /* ---------- Layout ---------- */
  .bg{
    min-height: 100dvh;
    background:
      radial-gradient(1200px 600px at 20% -10%, #e0edff 0%, transparent 60%),
      radial-gradient(1000px 500px at 110% 10%, #dbeafe 0%, transparent 60%),
      linear-gradient(180deg,var(--bg1),var(--bg2));
  }
  .card{
    background: var(--card);
    color: var(--ink);
    border: 1px solid var(--line);
    border-radius: 16px;
    box-shadow: 0 18px 60px rgba(2,8,23,.08), 0 2px 8px rgba(2,8,23,.04);
  }
  .brand{
    font-weight: 800;
    display:flex; align-items:center; gap:.5rem;
  }
  .input{
    width:100%;
    border:1px solid var(--line);
    border-radius:12px;
    padding: .9rem 1rem;
    background:#f8fafc;
    color: var(--ink);
    outline: none;
    transition: border .15s, box-shadow .15s;
  }
  .input:focus{
    border-color:#93c5fd;
    box-shadow: 0 0 0 4px rgba(147,197,253,.35);
  }

  /* ---------- Glassmorphic Blue Button (stays blue while hovering) ---------- */
  .btn{
    --_bg: var(--glass-bg);
    --_brd: var(--glass-brd);
    --_txt: #eaf2ff;
    --_txt-strong: #ffffff;

    width: 100%;
    display: inline-flex; align-items: center; justify-content: center; gap: .5rem;
    padding: .9rem 1.15rem;
    font-weight: 800; letter-spacing: .02em;
    border-radius: 14px;
    border: 1px solid var(--_brd);
    color: var(--_txt);
    background:
      radial-gradient(120% 160% at 30% 20%, rgba(255,255,255,.35), transparent 60%),
      linear-gradient(135deg, rgba(96,165,250,.65), rgba(37,99,235,.55)),
      var(--_bg);
    box-shadow: var(--glass-shadow);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    cursor: pointer;
    transition: transform .18s ease, box-shadow .18s ease, background .18s ease, color .18s ease, opacity .18s ease;
    border-color: var(--glass-brd);
  }
  .btn:hover, .btn:focus{
    transform: translateY(-1px);
    color: var(--_txt-strong);
    box-shadow: 0 14px 34px rgba(37,99,235,.32);
    background:
      radial-gradient(140% 160% at 30% 20%, rgba(255,255,255,.5), transparent 60%),
      linear-gradient(135deg, rgba(96,165,250,.75), rgba(37,99,235,.65)),
      var(--_bg);
  }
  .btn:active{ transform:none; box-shadow:0 8px 22px rgba(37,99,235,.28); }
  .btn:disabled{ opacity:.65; cursor:not-allowed; box-shadow:0 8px 18px rgba(37,99,235,.18); }

  /* Small helper text & error box */
  .muted{ color:#64748b; font-size:.9rem; }
  .errbox{
    background:#fee2e2; color:#991b1b; border:1px solid #fecaca;
    padding:.75rem 1rem; border-radius:.75rem; margin-bottom:1rem;
  }
  .row{ display:grid; gap: 1rem; }
</style>

<!-- Page Loader -->
<div id="page-loader" aria-hidden="true">
  <div class="loader-ring" role="status" aria-label="Loading"></div>
</div>

<div class="bg" style="display:grid;place-items:center;padding:2rem">
  <div class="card" style="width:min(460px,92vw);padding:2rem">
    <h1 class="brand" style="margin:0 0 .35rem">
      <span style="display:inline-grid;place-items:center;width:32px;height:32px;border-radius:9px;background:linear-gradient(135deg,#60a5fa,#3b82f6)"></span>
      Sign in
    </h1>
    <p class="muted" style="margin:0 0 1rem">Welcome back. Enter your credentials to continue.</p>

    {% if form.non_field_errors %}
      <div class="errbox">{{ form.non_field_errors }}</div>
    {% endif %}

    <form method="post"
          action="{{ login_url|default:auth_login_url|default:request.path }}"
          novalidate>
      {% csrf_token %}
      <div class="row">
        <div>
          <label for="id_username" style="display:block;margin:0 0 .35rem;font-weight:600">Username</label>
          <input class="input" id="id_username" name="username" type="text"
                 autocomplete="username" required autofocus
                 value="{{ form.username.value|default_if_none:'' }}">
        </div>
        <div>
          <label for="id_password" style="display:block;margin:0 0 .35rem;font-weight:600">Password</label>
          <div style="position:relative">
            <input class="input" id="id_password" name="password" type="password"
                   autocomplete="current-password" required style="padding-right:2.5rem">
            <button type="button" id="toggle-pass"
                    aria-controls="id_password" aria-pressed="false" title="Show/Hide password"
                    style="position:absolute;right:.55rem;top:50%;transform:translateY(-50%);background:transparent;border:0;color:#64748b;cursor:pointer;width:1.75rem;height:1.75rem;display:grid;place-items:center;">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M2.1 12.6c2.2-4 5.4-6 9.9-6s7.7 2 9.9 6c-2.2 4-5.4 6-9.9 6s-7.7-2-9.9-6z"/>
                <circle cx="12" cy="12" r="3" stroke-width="2"/>
              </svg>
            </button>
          </div>
        </div>

        <input type="hidden" name="next" value="{{ next|default:'/' }}">

        <button class="btn" id="submitBtn" type="submit">Sign in</button>

        <div class="muted" style="display:flex;justify-content:space-between;gap:.5rem;flex-wrap:wrap">
          <a class="muted" href="{% url 'accounts:forgot_password_request' %}" style="text-decoration:none">Forgot password?</a>
          <span>You’ll be redirected after sign in.</span>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  // Hide page loader after full load
  window.addEventListener('load', function(){
    const el = document.getElementById('page-loader');
    if (el) el.classList.add('hidden');
  });
  // Optional hooks if using Turbo/HTMX (safe no-ops otherwise)
  document.addEventListener('turbo:visit', () => {
    const el = document.getElementById('page-loader');
    if (el) el.classList.remove('hidden');
  });
  document.addEventListener('turbo:load', () => {
    const el = document.getElementById('page-loader');
    if (el) el.classList.add('hidden');
  });

  // Password show/hide + caps lock hint
  (function(){
    const btn = document.getElementById('toggle-pass');
    const input = document.getElementById('id_password');
    if (!btn || !input) return;
    btn.addEventListener('click', function(){
      const isPwd = input.type === 'password';
      input.type = isPwd ? 'text' : 'password';
      btn.setAttribute('aria-pressed', String(isPwd));
      input.focus({preventScroll:true});
    });
    input.addEventListener('keyup', (e)=>{
      if (!('getModifierState' in e)) return;
      input.title = e.getModifierState('CapsLock') ? 'Caps Lock is ON' : '';
    });
  })();

  // Inline spinner on submit (button stays blue)
  (function(){
    const form = document.querySelector('form[method="post"]');
    const btn  = document.getElementById('submitBtn');
    if(!form || !btn) return;
    form.addEventListener('submit', function(){
      btn.disabled = true;
      const sp = document.createElement('span');
      sp.style.display='inline-block';
      sp.style.width='1em'; sp.style.height='1em'; sp.style.marginLeft='.5rem';
      sp.style.border='2px solid rgba(255,255,255,.35)';
      sp.style.borderTopColor='#fff'; sp.style.borderRadius='50%';
      sp.style.animation='ccspin .9s linear infinite';
      btn.appendChild(sp);
    });
  })();
</script>
{% endblock %}
